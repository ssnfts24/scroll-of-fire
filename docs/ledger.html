<!doctype html>
<html lang="en" dir="ltr">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <meta charset="utf-8" />
  <title>Witness Ledger — Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f"><meta name="color-scheme" content="dark">
  <meta name="description" content="Private, device-local witness log: intentions, carriers, Ξ quality, and micro-edits (ΔΣ) with export/import and weekly signal." />
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/ledger.html" />
  <meta property="og:title" content="Witness Ledger — Scroll of Fire">
  <meta property="og:description" content="Log your runs, track coherence (Ξ), and export your remnant evidence.">
  <meta property="og:image" content="assets/img/og-teach-lab.jpg">
  <meta property="og:type" content="website">

  <link rel="icon" href="assets/icons/favicon.ico">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-19">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-19" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-19"></noscript>
  <style>
    .wrap{max-width:1180px;margin:0 auto;padding:20px 16px 80px}
    .title{font-family:"Crimson Pro",serif;font-weight:800;text-align:center;font-size:clamp(28px,3.6vw,44px);margin:8px 0 4px;
      background:linear-gradient(180deg,#fff 0%,#cfefff 60%,#a7f6ff 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{text-align:center;color:#b8b3a6;font-style:italic;margin:0 0 12px}
    .cta{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #2a2a33;text-decoration:none}
    .ledger-top{display:grid;grid-template-columns:2fr 140px 120px 1fr auto;gap:8px}
    .table-wrap{overflow:auto;border:1px solid #2a2a33;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    thead th{background:#15151c;border-bottom:1px solid #2a2a33;padding:10px 12px;text-align:left}
    tbody td{border-top:1px solid #2a2a33;padding:10px 12px;vertical-align:top}
    .badge{opacity:.35}.badge.lit{opacity:1}
    .note{border:1px solid #2a2a33;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <header class="page-head fancy-head">
      <h1 class="title">📒 Witness Ledger</h1>
      <p class="subtitle">Evidence of change — device-local, exportable, aligned with Eq.Ω (ΔΣ micro-edits) and Ξ.</p>
      <nav class="crumbs" aria-label="Breadcrumb" style="display:flex;gap:8px;justify-content:center">
        <a class="cta" href="index.html">← Back to Codex</a>
        <a class="cta" href="theory.html">Open Theory</a>
        <a class="cta" href="teach.html">Open Teaching Lab</a>
      </nav>
    </header>

    <section class="card">
      <h2>New Entry</h2>
      <p class="meta">Keep it specific and small: what you did, what shifted, what lingered.</p>
      <div class="ledger-top" role="group" aria-label="New entry">
        <input id="iInt" placeholder="Intention (𝓘) — one clean line…" autocomplete="off">
        <input id="iCarrier" placeholder="Carrier (432/528/369)" inputmode="numeric" pattern="[0-9]*">
        <select id="iXi" aria-label="Ξ quality"><option value="">Ξ…</option><option>Low</option><option>Medium</option><option>High</option></select>
        <input id="iTags" placeholder="Tags (comma, e.g. morning,work)">
        <button id="btnAdd" class="cta">Add</button>
      </div>
      <textarea id="iWitness" rows="3" style="margin-top:8px;width:100%" placeholder="Witness notes (what changed, what lingered)…"></textarea>

      <div class="lab-row" style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <button id="btnExport" class="cta" title="Download ledger as JSON">Export .json</button>
        <input type="file" id="fileImport" accept="application/json" hidden>
        <button id="btnImport" class="cta" title="Load entries from a JSON file">Import .json</button>
        <input id="filter" placeholder="Filter by tag or text…" autocomplete="off" style="margin-left:auto">
      </div>

      <div class="lab-row" style="display:flex;gap:16px;align-items:center;margin-top:10px">
        <span class="meta">🗓️ Streak: <b id="streakDays">0</b> days</span>
        <span class="meta">Ξ High rate (7d): <b id="hiRate">—</b></span>
        <span class="meta">Entries (7d): <b id="weekCount">—</b></span>
      </div>

      <canvas id="spark" width="900" height="90" aria-label="Weekly signal" style="margin-top:8px;width:100%;max-width:100%"></canvas>

      <div class="table-wrap" style="margin-top:10px">
        <table id="tab">
          <colgroup><col style="width:16ch"><col><col style="width:10ch"><col style="width:8ch"><col style="width:18ch"><col><col style="width:4ch"></colgroup>
          <thead><tr><th>Date</th><th>Intention</th><th>Carrier</th><th>Ξ</th><th>Tags</th><th>Witness</th><th></th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="badges" style="margin-top:12px;display:flex;gap:10px">
        <span id="b7" class="badge" title="7-Day Seed">🌱 ×7</span>
        <span id="b33" class="badge" title="33-Day Orbit">🛰️ ×33</span>
        <span id="b144" class="badge" title="144 Closure">🜚 ×144</span>
      </div>
    </section>

    <section class="card note" style="margin-top:12px">
      <h3>Anchors</h3>
      <p class="meta"><b>Eq.Ω</b> — ledger entries are ΔΣ micro-edits; <b>Ξ</b> trends indicate stability; follow <b>Eq.9</b> stop rule if coherence worsens.</p>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p>“Trends beat anecdotes.”</p>
      <p>© <span id="yr">2025</span> Aaron Paul Laird — Scroll of Fire • BY-NC 4.0</p>
    </footer>
  </main>

  <script>
    (function(){
      const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
      const storeKey="codex_ledger_v1";
      const rows=$("#rows"), filter=$("#filter"), streakEl=$("#streakDays");
      const hiRate=$("#hiRate"), weekCount=$("#weekCount"), spark=$("#spark");
      const ctx=spark.getContext("2d");
      const b7=$("#b7"), b33=$("#b33"), b144=$("#b144");
      const todayISO = ()=>new Date().toISOString();

      function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)||"[]"); }catch{ return []; } }
      function save(list){ localStorage.setItem(storeKey, JSON.stringify(list)); }

      function add(){
        const e={
          id: crypto.randomUUID(),
          t: todayISO(),
          int: $("#iInt").value.trim(),
          car: $("#iCarrier").value.trim(),
          xi: $("#iXi").value,
          tags: $("#iTags").value.trim(),
          wit: $("#iWitness").value.trim()
        };
        if(!e.int && !e.wit) return;
        const L=load(); L.unshift(e); save(L);
        $("#iWitness").value=""; render();
      }

      function del(id){
        const L=load().filter(x=>x.id!==id); save(L); render();
      }

      function render(){
        const q=(filter.value||"").toLowerCase();
        const L=load();
        const list = q ? L.filter(x=>JSON.stringify(x).toLowerCase().includes(q)) : L;
        rows.innerHTML = list.map(e=>{
          const d = new Date(e.t); const ds = d.toLocaleString();
          return `<tr>
            <td>${ds}</td><td>${escapeHTML(e.int)}</td><td>${escapeHTML(e.car||"—")}</td>
            <td>${escapeHTML(e.xi||"—")}</td><td>${escapeHTML(e.tags||"—")}</td><td>${escapeHTML(e.wit)}</td>
            <td><button class="cta" data-del="${e.id}" title="Delete entry">✕</button></td>
          </tr>`;
        }).join("");

        // attach dels
        $$("#rows [data-del]").forEach(b=>b.addEventListener("click",()=>del(b.dataset.del)));

        // metrics
        renderMetrics(L);
      }

      function renderMetrics(L){
        // Streak (days with >=1 entry)
        const byDay = new Map();
        for(const e of L){
          const key = new Date(e.t).toISOString().slice(0,10);
          byDay.set(key, (byDay.get(key)||0)+1);
        }
        let streak=0, d=new Date();
        for(;;){
          const key=d.toISOString().slice(0,10);
          if(byDay.has(key)){ streak++; d.setDate(d.getDate()-1); } else break;
        }
        streakEl.textContent = String(streak);
        b7.classList.toggle("lit", streak>=7);
        b33.classList.toggle("lit", streak>=33);
        b144.classList.toggle("lit", streak>=144);

        // 7-day window
        const now = Date.now(), day=86400000;
        const last7 = L.filter(e=>now - Date.parse(e.t) < 7*day);
        weekCount.textContent = String(last7.length);
        const highs = last7.filter(e=>String(e.xi).toLowerCase().startsWith("h")).length;
        hiRate.textContent = last7.length ? Math.round(100*highs/last7.length)+"%" : "—";

        // Sparkline (last 28 days; map Low/Med/High to 0/0.5/1)
        const n=28, points=[];
        for(let i=n-1;i>=0;i--){
          const key=new Date(now - i*day).toISOString().slice(0,10);
          const dayEntries = L.filter(e=>e.t.slice(0,10)===key);
          const score = dayEntries.length
            ? dayEntries.reduce((s,e)=>s+scoreXi(e.xi),0)/dayEntries.length
            : null;
          points.push(score);
        }
        drawSpark(points);
      }

      function scoreXi(x){
        x=(x||"").toLowerCase();
        if(x.startsWith("h")) return 1;
        if(x.startsWith("m")) return 0.5;
        if(x.startsWith("l")) return 0;
        return 0.33;
      }

      function drawSpark(arr){
        const w=spark.width, h=spark.height;
        ctx.clearRect(0,0,w,h);
        ctx.globalAlpha=0.15; ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h); ctx.globalAlpha=1;
        // grid
        ctx.strokeStyle="rgba(122,243,255,.25)";
        ctx.beginPath(); ctx.moveTo(0,h*0.25); ctx.lineTo(w,h*0.25); ctx.moveTo(0,h*0.5); ctx.lineTo(w,h*0.5); ctx.moveTo(0,h*0.75); ctx.lineTo(w,h*0.75); ctx.stroke();
        // line
        const xs = w/(arr.length-1||1);
        ctx.beginPath(); ctx.strokeStyle="rgba(243,201,122,.85)"; ctx.lineWidth=2;
        let started=false;
        arr.forEach((v,i)=>{
          if(v==null) return;
          const x=i*xs, y=h*(1-v*0.9-0.05);
          if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
        }); ctx.stroke();
      }

      function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

      // export / import
      $("#btnExport").addEventListener("click",()=>{
        const blob = new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="codex_ledger.json"; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      });
      $("#btnImport").addEventListener("click",()=>$("#fileImport").click());
      $("#fileImport").addEventListener("change",async e=>{
        const f=e.target.files[0]; if(!f) return;
        try{ const txt=await f.text(); const data=JSON.parse(txt); if(Array.isArray(data)){ save(data.concat(load())); render(); } }catch(_){}
        e.target.value="";
      });

      // wiring
      $("#btnAdd").addEventListener("click",add);
      $("#iWitness").addEventListener("keydown",e=>{ if((e.ctrlKey||e.metaKey)&&e.key==="Enter") add(); });
      filter.addEventListener("input",render);
      $("#yr").textContent = String(new Date().getFullYear());
      render();
    })();
  </script>
</body>
</html>
