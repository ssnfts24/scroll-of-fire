/* ==========================================================================
   Scroll of Fire — Moons UI (base + astro)
   Layers: tokens → base → components → astrology → utilities
   v2025.11.02-e “Clean Rim & Clear Sky+”
   ========================================================================== */

/* ============================== TOKEN FAILSAFES =========================== */
@layer tokens{
  :root{
    /* If your tokens.css defines these, these act as fallbacks only */
    --bg:#0b0b0f; --bg-elev:#0e0e12; --card:#121219;
    --ink:#eae7df; --muted:#b8b3a6; --line:#2a2a33;
    --accent:#7af3ff; --accent-2:#7aa8ff; --gold:#f3c97a;
    --radius:14px; --pad:14px;
    --rim: 0 10px 30px rgba(0,0,0,.22);
  }
}

/* ================================ BASE =================================== */
@layer base{
  *{box-sizing:border-box}
  html,body{height:100%}
  html{
    color-scheme:dark light;
    /* fluid type with sane bounds */
    font-size: clamp(15px, 0.55vw + 13px, 18px);
  }
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:400 16px/1.6 Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
  }

  img,svg,canvas{max-width:100%;height:auto;vertical-align:middle}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  a:focus-visible{outline:2px solid color-mix(in oklch, var(--accent) 80%, transparent);outline-offset:2px;border-radius:8px}

  /* safe-area top spacer for notches */
  .top-safe{ height:calc(env(safe-area-inset-top, 0px) + 8px) }

  .wrap{
    max-width:min(1200px, 100%);
    margin-inline:auto;
    padding-inline: clamp(12px, 4vw, 24px);
  }

  .card{
    background:
      linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%),
      var(--bg-elev);
    border-radius:var(--radius);
    box-shadow:var(--rim);
    padding:var(--pad);
    border:1px solid color-mix(in oklab, var(--line) 92%, transparent);
  }
  .shine{
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0) 55%),
      var(--bg-elev);
  }
  .divider{height:1px;background:var(--line);opacity:.65}

  .meta{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums;letter-spacing:.02em}
  .kbd{
    font-family:ui-monospace, Menlo, Consolas, monospace;
    background:rgba(127,127,127,.12);border-radius:8px;padding:.08rem .35rem;border:1px solid var(--line)
  }
  .tag{
    display:inline-flex;gap:.35rem;align-items:center;
    border:1px solid var(--line);border-radius:999px;padding:.15rem .55rem;
    background:color-mix(in oklab, var(--bg-elev) 96%, transparent);
    white-space:nowrap;
  }
  .pill{
    display:inline-flex;gap:.35rem;align-items:center;border-radius:999px;
    background:rgba(127,127,127,.12);padding:.25rem .6rem
  }

  .lab-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .lab-btn{
    display:inline-flex;align-items:center;gap:.5rem;
    border:1px solid var(--line);padding:.55rem .85rem;border-radius:10px;background:transparent;
    transition:transform .06s ease, background-color .12s ease, border-color .12s ease;
    text-decoration:none;color:inherit; min-height:44px; /* touch target */
  }
  .lab-btn:hover{background:rgba(127,127,127,.10);border-color:color-mix(in oklab, var(--line) 70%, var(--accent) 30%)}
  .lab-btn:active{transform:translateY(1px)}
  .lab-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .lab-btn.ghost{background:transparent}

  .lab-input{
    border:1px solid var(--line);border-radius:10px;background:transparent;color:inherit;
    padding:.55rem .6rem;min-height:44px; /* touch target */
  }
  .lab-input:focus{outline:none;border-color:color-mix(in oklch, var(--accent) 60%, var(--line))}
  .lab-input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

  /* Grid (2-col → 1-col) */
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:clamp(10px, 2vw, 16px)}
  .col-12{grid-column:1/-1}
  .col-8{grid-column:1/2}
  .col-4{grid-column:2/3}
  .col-6{grid-column:span 1}
  @media (max-width:960px){
    .grid{grid-template-columns:1fr}
    .col-8,.col-6,.col-4{grid-column:1/-1}
  }
  /* Ultra-wide gentle widen */
  @media (min-width:1600px){ .wrap{max-width:1320px} }

  /* Header block */
  .fancy-head .title{margin:.2rem 0; font-size:clamp(1.25rem,4.0vw,1.85rem); line-height:1.1}
  .subtitle{margin:.2rem 0 1rem 0; max-width:70ch}

  /* Crumbs */
  .crumbs{
    display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
    padding-bottom:.25rem; mask-image:linear-gradient(90deg,transparent,black 10%,black 90%,transparent)
  }
  .crumbs::-webkit-scrollbar{display:none}

  /* Footer */
  .footer{max-width:1200px;margin:.8rem auto;padding:10px 16px}
  .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

  /* Panels (compare, astro) */
  .panel{background:var(--bg-elev);border:1px solid var(--line);border-radius:var(--radius)}
  .panel__head{display:flex;justify-content:space-between;align-items:baseline;padding:var(--pad);border-bottom:1px solid var(--line)}
  .panel__title{margin:0}
  .panel__meta{color:var(--muted)}

  /* Tables (year-map, aspects) */
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;z-index:1;background:var(--bg-elev);
    color:var(--muted);font-weight:600;text-align:left;border-bottom:1px solid var(--line);padding:.6rem .65rem;
    box-shadow:0 6px 12px rgba(0,0,0,.06);
    backdrop-filter:saturate(110%) blur(2px);
  }
  tbody td{padding:.58rem .65rem;border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent)}
  tbody tr:hover{background:rgba(127,127,127,.06)}
  tbody tr:nth-child(odd){background:color-mix(in oklab, var(--card) 88%, transparent)}
  tbody tr:last-child td{border-bottom:none}

  /* Dots (week & legend) */
  .dot{display:inline-block;width:.55rem;height:.55rem;border-radius:999px;background:rgba(127,127,127,.25)}
  .dot.on{background:var(--accent)}
  .legend{display:flex;flex-wrap:wrap;gap:8px}

  /* Hints / keys */
  .hint{color:var(--muted);font-size:.95rem}
  .keys .kbd{margin-left:.25rem}

  /* Motion/Data/Contrast safety */
  @media (prefers-reduced-motion: reduce){
    *{animation-duration:.001s!important;animation-iteration-count:1!important;transition:none!important;scroll-behavior:auto!important}
  }
  @media (prefers-reduced-data: reduce){
    img[loading="lazy"],img[decoding="async"]{filter:saturate(.9) contrast(.98)}
  }
  @media (forced-colors: active){
    .card, .lab-btn, .lab-input, .tag, .pill, table, thead th, tbody td {outline:1px solid CanvasText}
  }

  /* Print */
  @media print{
    .crumbs, .lab-row, .footer{display:none!important}
    .card{box-shadow:none}
    body{background:white;color:black}
  }
}

/* ============================== ASTROLOGY ================================ */
@layer astrology{
  /* Local tokens */
  .astro{
    --moon-accent: var(--accent);
    --moon-accent-2: var(--gold);
    --astro-bg: var(--bg-elev);
    --astro-rim: var(--line);
    --astro-muted: var(--muted);
    --astro-halo-1: color-mix(in oklch, var(--moon-accent) 60%, transparent);
    --astro-halo-2: color-mix(in oklch, var(--moon-accent-2) 60%, transparent);
    --astro-radius: 14px;
    --astro-pad: 14px;
  }

  /* Header */
  .astro-head{
    display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:.6rem
  }
  .astro-head .seal{
    display:inline-flex;gap:.45rem;align-items:center;
    padding:.25rem .55rem;border-radius:999px;border:1px solid var(--astro-rim);
    background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);
    white-space:nowrap;
    font-size:clamp(.85rem, 1.6vw, .95rem);
    line-height:1.1;
  }

  /* Grid (chips + wheel) */
  .astro-grid{
    display:grid;grid-template-columns:1.05fr .95fr;gap:clamp(10px, 2vw, 16px)
  }
  @media (max-width:1024px){ .astro-grid{grid-template-columns:1fr} }

  /* Planet chips */
  .astro-chips{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start}
  .chip{
    border:1px solid var(--astro-rim);border-radius:999px;padding:.5rem .8rem;
    background:linear-gradient(180deg,rgba(255,255,255,.035),transparent);
    display:inline-flex;align-items:center;gap:.55rem;line-height:1.1;
    transition:background-color .12s ease,border-color .12s ease,transform .06s ease,box-shadow .12s ease;
    color:inherit;text-decoration:none;box-shadow:0 0 0 0 rgba(0,0,0,0);
    white-space:nowrap; min-height:40px;
    font-size:clamp(.85rem, 1.6vw, .95rem);
  }
  .chip:hover{
    background:rgba(127,127,127,.10);
    border-color:color-mix(in oklch,var(--astro-rim) 60%, var(--moon-accent) 40%);
    box-shadow:0 0 0 1px color-mix(in oklch, var(--moon-accent) 38%, transparent) inset;
  }
  .chip:active{transform:translateY(1px)}
  .chip:focus-visible{outline:2px solid var(--moon-accent);outline-offset:2px}
  .chip[aria-pressed="true"], .chip.active{
    background:color-mix(in oklch,var(--moon-accent) 12%, transparent);
    border-color:color-mix(in oklch,var(--moon-accent) 65%, var(--astro-rim));
    box-shadow:0 0 0 2px color-mix(in oklch, var(--moon-accent) 30%, transparent) inset;
  }
  .chip .pos{opacity:.9;font-variant-numeric:tabular-nums}
  .chip .dot{display:inline-block;width:.8em;height:.8em;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}

  /* Element colors */
  .el-fire{background:#ff8a73}
  .el-water{background:#6fc6ff}
  .el-air{background:#a2b1ff}
  .el-earth{background:#a8e7b2}
  .el-aether{background:#e7d1ff}

  /* Compact chips on very small screens */
  @media (max-width:420px){
    .chip{gap:.4rem; padding:.45rem .65rem}
    .chip b{display:none}
  }

  /* Wheel */
  .astro-wheel{display:block;max-width:min(560px,100%);margin-inline:auto}
  .astro-wheel svg{width:100%;height:auto;display:block}
  #signLabels text{
    fill:#b7c2de;font-weight:600;letter-spacing:.02em;
    paint-order:stroke;stroke:#0b0b0f;stroke-width:.9;
    user-select:none;
  }
  #houseLines{opacity:.9;stroke:#2a3242}
  #planetDots .dot{
    transition:transform .12s ease, r .12s ease, filter .12s ease;
    filter:drop-shadow(0 0 .75px rgba(0,0,0,.7)) drop-shadow(0 0 6px var(--astro-halo-1));
  }
  #planetDots .dot:hover{
    transform:scale(1.18);
    filter:drop-shadow(0 0 1px rgba(0,0,0,.75)) drop-shadow(0 0 9px var(--astro-halo-2));
  }
  @media (prefers-reduced-motion: reduce){
    #planetDots .dot{transition:none}
  }

  /* Caption under wheel */
  .astro figcaption.meta{
    display:flex;flex-wrap:wrap;gap:.45rem;justify-content:center;
    margin-top:.5rem;color:var(--astro-muted);
    font-size:clamp(.82rem, 1.4vw, .9rem);
  }
  .astro figcaption .sep{opacity:.35}

  /* Aspects legend + badges */
  .astro-aspects .legend{display:flex;flex-wrap:wrap;gap:10px;margin:.55rem 0}
  .badge.asp{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
    border:1px solid var(--astro-rim);border-radius:10px;padding:.25rem .55rem;
    white-space:nowrap; font-size:clamp(.8rem, 1.5vw, .9rem);
  }
  .asp.conj{border-color:#b9b9b9}
  .asp.sext{border-color:#7ccfff}
  .asp.sqr{border-color:#ff9a7b}
  .asp.tri{border-color:#8be39f}
  .asp.opp{border-color:#c69bff}

  /* Aspects table (supports wrapper div OR table.asp-table) */
  .asp-table{
    display:block;max-width:100%;overflow:auto;border:1px solid var(--astro-rim);
    border-radius:12px;background:var(--astro-bg);
    box-shadow:0 10px 30px rgba(0,0,0,.22);
    -webkit-overflow-scrolling:touch;
  }
  .asp-table table{width:100%;min-width:560px;border-collapse:separate;border-spacing:0}
  table.asp-table{min-width:560px;border-collapse:separate;border-spacing:0}

  .asp-table thead th{
    position:sticky;top:0;z-index:1;background:
      linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%),
      var(--astro-bg);
    color:var(--astro-muted);font-weight:700;text-align:left;
    padding:.58rem .68rem;border-bottom:1px solid var(--astro-rim);
    backdrop-filter:saturate(110%) blur(2px);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .asp-table tbody td{
    padding:.58rem .68rem;border-bottom:1px solid color-mix(in oklch,var(--astro-rim) 82%, transparent)
  }
  .asp-table tbody tr:nth-child(odd){background:color-mix(in oklch, var(--astro-bg) 88%, transparent)}
  .asp-table tbody tr:hover{background:rgba(127,127,127,.07)}
  .asp-table tbody tr:last-child td{border-bottom:none}
  .asp-table td:nth-child(3){text-align:right;font-variant-numeric:tabular-nums}

  /* High-contrast assist / forced colors */
  @media (prefers-contrast: more){
    #signLabels text{stroke-width:1.1}
    .chip{border-color:color-mix(in oklch,var(--astro-rim) 55%, white)}
    .asp-table{box-shadow:0 0 0 1px color-mix(in oklch,var(--astro-rim) 60%, white) inset}
  }
  @media (forced-colors: active){
    .chip, .asp-table, .badge.asp{border:1px solid CanvasText}
    #planetDots .dot{filter:none}
  }

  /* Print tidy */
  @media print{
    .astro-head, .astro-chips button, .astro-aspects .legend{filter:grayscale(1)}
    .asp-table{box-shadow:none}
  }

  .astro .meta{color:var(--astro-muted)}
  .astro .mono{font-variant-numeric:tabular-nums}
}