/* ==========================================================================
   Scroll of Fire — Moons UI (consolidated)
   Layers: tokens → base → components → astrology → utilities
   v2025.11.02-f (all-screens polish)
   ========================================================================== */

/* ============================== TOKEN FALLBACKS ========================== */
@layer tokens{
  :root{
    /* Used only if tokens.css isn’t present */
    --bg:#0b0b0f; --bg-elev:#10131b; --card:#121622;
    --ink:#eae7df; --muted:#b8b3a6; --line:#202738;
    --accent:#7af3ff; --accent-2:#7aa8ff; --gold:#f3c97a;
    --radius:14px; --pad:14px;
    --rim: 0 0 0 1px color-mix(in oklch, var(--line) 60%, transparent),
           0 10px 30px rgba(0,0,0,.28);
  }
}

/* ============================== BASE ==================================== */
@layer base{
  *{box-sizing:border-box}
  html,body{height:100%}
  html{color-scheme:dark light; font-size:clamp(15px,0.55vw + 13px,18px)}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:400 16px/1.6 Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  img,svg,canvas{max-width:100%;height:auto}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  .wrap{
    max-width:min(1200px,100%);
    margin-inline:auto;
    padding-inline:clamp(12px,4vw,24px);
  }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent), var(--bg-elev);
    border-radius:var(--radius); box-shadow:var(--rim); padding:var(--pad);
    border:1px solid color-mix(in oklab, var(--line) 92%, transparent);
  }
  .shine{
    background:linear-gradient(180deg,rgba(255,255,255,.035),transparent 36%), var(--bg-elev);
  }
  .divider{height:1px;background:var(--line);opacity:.65}

  .meta{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums;letter-spacing:.02em}
  .kbd{
    font-family:ui-monospace, Menlo, Consolas, monospace;
    background:rgba(127,127,127,.14);border-radius:8px;padding:.08rem .35rem;border:1px solid var(--line)
  }
  .tag{
    display:inline-flex;gap:.35rem;align-items:center;border:1px solid var(--line);
    border-radius:999px;padding:.15rem .55rem;background:color-mix(in oklab,var(--bg-elev) 96%, transparent)
  }
  .pill{display:inline-flex;gap:.35rem;align-items:center;border-radius:999px;background:rgba(127,127,127,.10);padding:.25rem .6rem}

  .lab-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .lab-btn{
    display:inline-flex;align-items:center;gap:.5rem; min-height:44px;
    border:1px solid var(--line);padding:.55rem .85rem;border-radius:11px;background:transparent;
    transition:transform .08s ease, background-color .12s ease, border-color .12s ease;
    color:inherit; text-decoration:none;
  }
  .lab-btn:hover{background:rgba(127,127,127,.10);border-color:color-mix(in oklch,var(--line) 70%, var(--accent))}
  .lab-btn:active{transform:translateY(1px)}
  .lab-btn.ghost{background:transparent}

  .lab-input{
    border:1px solid var(--line);border-radius:11px;background:transparent;color:inherit;
    padding:.55rem .6rem; min-height:44px;
  }
  .lab-input:focus{outline:none;border-color:color-mix(in oklch, var(--accent) 60%, var(--line))}
  .lab-input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

  /* Grid */
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:clamp(10px,2vw,16px)}
  .col-12{grid-column:1/-1} .col-8{grid-column:1/2} .col-4{grid-column:2/3} .col-6{grid-column:span 1}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} .col-8,.col-6,.col-4{grid-column:1/-1} }
  @media (min-width:1600px){ .wrap{max-width:1320px} }

  /* Header block */
  .fancy-head .title{margin:.15rem 0; font-size:clamp(1.28rem,4.0vw,1.9rem); line-height:1.1}
  .subtitle{margin:.2rem 0 1rem; max-width:70ch}

  /* Crumbs */
  .crumbs{
    display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
    padding-bottom:.25rem; mask-image:linear-gradient(90deg,transparent,black 10%,black 90%,transparent)
  }
  .crumbs::-webkit-scrollbar{display:none}

  /* Footer */
  .footer{max-width:1200px;margin:.9rem auto;padding:12px 16px}
  .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

  /* Tables (year-map, aspects) */
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;z-index:1;background:var(--bg-elev);
    color:var(--muted);font-weight:600;text-align:left;border-bottom:1px solid var(--line);
    padding:.6rem .65rem; box-shadow:0 6px 12px rgba(0,0,0,.06);
    backdrop-filter:saturate(110%) blur(2px);
  }
  tbody td{padding:.58rem .65rem;border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent)}
  tbody tr:hover{background:rgba(127,127,127,.06)}
  tbody tr:nth-child(odd){background:color-mix(in oklab, var(--card) 88%, transparent)}
  tbody tr:last-child td{border-bottom:none}

  /* Motion/Data/Contrast/Forced colors */
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation:none!important;transition:none!important;scroll-behavior:auto!important}
  }
  @media (prefers-reduced-data: reduce){
    img[loading="lazy"],img[decoding="async"]{filter:saturate(.9) contrast(.98)}
  }
  @media (prefers-contrast: more){
    .card{box-shadow:0 0 0 1px color-mix(in oklch,var(--line) 60%, white) inset}
  }
  @media (forced-colors: active){
    .card,.lab-btn,.lab-input,.tag,.pill,table,thead th,tbody td{outline:1px solid CanvasText}
  }

  /* Print */
  @media print{
    .crumbs,.lab-row,.footer{display:none!important}
    .card{box-shadow:none}
    body{background:white;color:black}
  }
}

/* ============================ COMPONENTS ================================= */
@layer components{
  /* -------- Header badge -------- */
  .moon-badge{display:flex;align-items:center;gap:14px;flex-wrap:wrap;row-gap:10px}
  .ring{width:clamp(116px,30vw,144px);position:relative;flex:0 0 auto}
  .ring .label{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .ring .ring-bg{stroke:#152033;stroke-width:11;fill:none}
  .ring .ring-fg{
    stroke:url(#rg), var(--accent);stroke-linecap:round;stroke-width:13;fill:none;stroke-dasharray:0 316;
    filter:drop-shadow(0 0 10px color-mix(in oklch, var(--accent) 55%, transparent));
  }

  /* -------- Week dots -------- */
  .weekrow{display:flex;gap:10px;align-items:center;margin-top:10px}
  .weeklabel{opacity:.7;white-space:nowrap}
  .week{
    display:grid;grid-template-columns:repeat(28,minmax(8px,1fr));gap:6px;min-width:min(560px,100%);
  }
  .week .dot{height:8px;width:8px;border-radius:999px;background:#2a3242;box-shadow:0 1px 0 rgba(0,0,0,.35)}
  .week .dot.on{background:color-mix(in oklab,var(--accent) 82%, transparent)}
  @media (max-width:720px){ .week{grid-template-columns:repeat(14,minmax(8px,1fr))} }

  /* -------- Dual calendars -------- */
  .compare{display:grid;gap:14px;grid-template-columns:1fr}
  @media (min-width:960px){ .compare{grid-template-columns:1fr 1fr} }
  .panel{background:var(--bg-elev);border-radius:var(--radius);box-shadow:var(--rim)}
  .panel__head{display:flex;justify-content:space-between;align-items:end;gap:10px;padding:var(--pad)}
  .panel .calendar,.panel .gregorian{padding:var(--pad)}
  .legend{display:flex;flex-wrap:wrap;gap:10px;padding:0 var(--pad) var(--pad)}

  /* -------- Year map -------- */
  .year-map{border-collapse:separate;border-spacing:0;min-width:760px;width:100%}
  .year-map thead th{position:sticky;top:0;background:var(--bg-elev);z-index:1;border-bottom:1px solid var(--line)}
  .year-map tbody tr:nth-child(odd){background:color-mix(in oklab,var(--card) 85%, transparent)}
  .year-map td,.year-map th{padding:.58rem .7rem;vertical-align:middle}
  .year-map td:nth-child(4),.year-map td:nth-child(5){white-space:nowrap;font-variant-numeric:tabular-nums}
  .year-map .tz{opacity:.75;font-size:.925em}

  /* -------- Mini moonbar -------- */
  .moonbar{
    display:flex;align-items:center;gap:10px;padding:.55rem .7rem;border-radius:999px;
    background:rgba(127,127,127,.09);border:1px solid var(--line);isolation:isolate
  }
  .moonbar svg{width:44px;height:44px;min-height:38px;flex:0 0 auto}
  .moonbar .mb-bg{stroke:#142233;stroke-width:9.5;opacity:.95}
  .moonbar .mb-fg{
    stroke:url(#mbGrad), var(--accent);stroke-width:10.5;stroke-linecap:round;
    filter:drop-shadow(0 0 7px color-mix(in oklch,var(--accent) 55%, transparent))
  }
  .moonbar-info{display:flex;flex-direction:column;gap:2px;min-width:0}
  .moonbar-line{display:flex;gap:8px;align-items:center;min-width:0}
  .moonbar-line #mbName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58vw}
  .moonbar-actions{margin-left:auto;display:flex;gap:6px;align-items:center}
  .moonbar .moonbar-share{padding:.36rem .62rem;border:1px solid var(--line);border-radius:10px;background:transparent}

  /* -------- Calendar grid primitives -------- */
  .calendar,.gregorian{ --cell:clamp(36px,8.5vw,48px); display:grid; gap:8px }
  .calendar .head,.gregorian .head{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
  .calendar .row,.gregorian .row{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }

  /* -------- Day cells + states -------- */
  .daycell{
    min-height:var(--cell); background:var(--bg-elev); border:1px solid var(--line); border-radius:11px;
    display:flex; align-items:flex-start; justify-content:flex-start; padding:.45rem .5rem; position:relative;
  }
  .daycell .n{ font:600 .97rem/1 Inter,system-ui; opacity:.92 }
  .daycell .evt{ position:absolute; right:.5rem; bottom:.38rem; width:6px; height:6px; border-radius:999px; background:transparent }
  .daycell.is-dim{ opacity:.35 }
  .daycell.is-today{ outline:2px solid var(--accent); outline-offset:1px; box-shadow:0 0 0 2px rgba(0,0,0,.12) inset }
  .daycell.is-doot{ border-color: color-mix(in oklab, var(--gold) 62%, var(--line)) }
  .daycell.is-doot .evt{ background: var(--gold) }
  .daycell.is-leap{ border-color: color-mix(in oklab, var(--accent-2) 62%, var(--line)) }
  .daycell.is-leap .evt{ background: var(--accent-2) }

  /* -------- Legend dots -------- */
  #calLegend .k-dot{ display:inline-block; width:.72em; height:.72em; border-radius:50%; vertical-align:middle; margin-right:.35rem }
  #calLegend .k-evt1{ background: var(--accent) }
  #calLegend .k-evt2{ background: var(--accent-2) }
  #calLegend .k-doot{ background: var(--gold) }
  #calLegend .k-leap{ background: var(--accent-2) }
  #calLegend .k-today{ background: color-mix(in oklab, var(--accent) 60%, var(--ink)) }

  /* -------- Inputs / Notes -------- */
  #noteText{
    width:100%;min-height:130px;resize:vertical;
    border:1px solid var(--line);border-radius:12px;background:rgba(127,127,127,.05);color:inherit;
    padding:.65rem .75rem;
  }
  .prompts{counter-reset:p}
  .prompts li{list-style:none;position:relative;padding-left:1.6rem;margin:.35rem 0}
  .prompts li::before{
    counter-increment:p;content:counter(p) ".";
    position:absolute;left:0;top:0;color:var(--muted);font-variant-numeric:tabular-nums
  }
}

/* ========================== LUNAR SIM POLISH ============================ */
@layer components{
  .sim{display:grid;grid-template-columns:280px 1fr;gap:12px;align-items:center}
  @media (max-width:520px){ .sim{grid-template-columns:1fr} }
  #simMoon{
    background:
      radial-gradient(120px 120px at 50% 45%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%);
    border-radius:16px;border:1px solid var(--line);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02), 0 10px 28px rgba(0,0,0,.25);
  }
}

/* ============================= ASTROLOGY ================================ */
@layer astrology{
  .astro{
    --moon-accent:var(--accent); --moon-accent-2:var(--gold);
    --astro-bg:var(--bg-elev); --astro-rim:var(--line); --astro-muted:var(--muted);
    --astro-halo-1: color-mix(in oklch, var(--moon-accent) 60%, transparent);
    --astro-halo-2: color-mix(in oklch, var(--moon-accent-2) 60%, transparent);
  }

  .astro-head{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:.55rem}
  .astro-head .seal{display:inline-flex;gap:.4rem;align-items:center;white-space:nowrap}

  /* Grid (chips + wheel) */
  .astro-grid{display:grid;grid-template-columns:1.05fr .95fr;gap:clamp(10px,2vw,16px)}
  @media (max-width:1024px){ .astro-grid{grid-template-columns:1fr} }

  /* Planet chips */
  .astro-chips{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start}
  .chip{
    border:1px solid var(--astro-rim);border-radius:999px;padding:.5rem .8rem;
    background:linear-gradient(180deg,rgba(255,255,255,.035),transparent);
    display:inline-flex;align-items:center;gap:.55rem;line-height:1.1;white-space:nowrap;
    transition:background-color .12s ease,border-color .12s ease,transform .06s ease,box-shadow .12s ease;
    color:inherit; min-height:40px; font-size:clamp(.85rem,1.6vw,.95rem);
  }
  .chip:hover{
    background:rgba(127,127,127,.10);
    border-color:color-mix(in oklch,var(--astro-rim) 60%, var(--moon-accent) 40%);
    box-shadow:0 0 0 1px color-mix(in oklch, var(--moon-accent) 38%, transparent) inset;
  }
  .chip:active{transform:translateY(1px)}
  .chip:focus-visible{outline:2px solid var(--moon-accent);outline-offset:2px}
  .chip[aria-pressed="true"], .chip.active{
    background:color-mix(in oklch,var(--moon-accent) 12%, transparent);
    border-color:color-mix(in oklch,var(--moon-accent) 65%, var(--astro-rim));
    box-shadow:0 0 0 2px color-mix(in oklch, var(--moon-accent) 30%, transparent) inset;
  }
  .chip .pos{opacity:.9;font-variant-numeric:tabular-nums}
  .chip .dot{display:inline-block;width:.8em;height:.8em;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}

  /* Element colors */
  .el-fire{background:#ff8a73}
  .el-water{background:#6fc6ff}
  .el-air{background:#a2b1ff}
  .el-earth{background:#a8e7b2}
  .el-aether{background:#e7d1ff}

  /* Compact chips on tiny phones */
  @media (max-width:420px){
    .chip{gap:.4rem; padding:.45rem .65rem}
    .chip b{display:none}
  }

  /* Wheel + labels + dots */
  .astro-wheel{display:block;max-width:min(560px,100%);margin-inline:auto}
  .astro-wheel svg{width:100%;height:auto;display:block}
  #astroWheel circle[stroke="#1b2231"]{stroke:#182235}
  #astroWheel circle[stroke-opacity]{stroke-opacity:.52}
  #signLabels text{
    fill:#b7c2de;font-weight:600;letter-spacing:.02em;
    paint-order:stroke;stroke:#0b0b0f;stroke-width:.9; user-select:none;
  }
  #houseLines{opacity:.9;stroke:#2a3242}
  #planetDots .dot{
    transition:transform .12s ease, r .12s ease, filter .12s ease;
    filter:drop-shadow(0 0 .75px rgba(0,0,0,.7)) drop-shadow(0 0 6px var(--astro-halo-1));
  }
  #planetDots .dot:hover{
    transform:scale(1.18);
    filter:drop-shadow(0 0 1px rgba(0,0,0,.75)) drop-shadow(0 0 9px var(--astro-halo-2));
  }
  @media (prefers-reduced-motion: reduce){ #planetDots .dot{transition:none} }

  /* Caption under wheel */
  .astro figcaption.meta{
    display:flex;flex-wrap:wrap;gap:.45rem;justify-content:center;
    margin-top:.5rem;color:var(--astro-muted);
    font-size:clamp(.82rem, 1.4vw, .9rem);
  }
  .astro figcaption .sep{opacity:.35}

  /* Aspects legend + badges */
  .astro-aspects .legend{display:flex;flex-wrap:wrap;gap:10px;margin:.55rem 0}
  .badge.asp{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
    border:1px solid var(--astro-rim);border-radius:10px;padding:.25rem .55rem;
    white-space:nowrap; font-size:clamp(.8rem, 1.5vw, .9rem);
  }
  .asp.conj{border-color:#b9b9b9}
  .asp.sext{border-color:#7ccfff}
  .asp.sqr{border-color:#ff9a7b}
  .asp.tri{border-color:#8be39f}
  .asp.opp{border-color:#c69bff}

  /* Aspects table */
  .asp-table{
    display:block;max-width:100%;overflow:auto;border:1px solid var(--astro-rim);
    border-radius:12px;background:var(--astro-bg); -webkit-overflow-scrolling:touch;
    box-shadow:0 10px 30px rgba(0,0,0,.22);
  }
  .asp-table table{width:100%;min-width:560px;border-collapse:separate;border-spacing:0}
  .asp-table thead th{
    position:sticky;top:0;background:
      linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%),
      var(--astro-bg);
    color:var(--astro-muted);font-weight:700;text-align:left;
    padding:.58rem .68rem;border-bottom:1px solid var(--astro-rim);
    backdrop-filter:saturate(110%) blur(2px);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .asp-table tbody td{
    padding:.58rem .68rem;border-bottom:1px solid color-mix(in oklch,var(--astro-rim) 82%, transparent)
  }
  .asp-table tbody tr:nth-child(odd){background:color-mix(in oklch, var(--astro-bg) 88%, transparent)}
  .asp-table tbody tr:hover{background:rgba(127,127,127,.07)}
  .asp-table tbody tr:last-child td{border-bottom:none}
  .asp-table td:nth-child(3){text-align:right;font-variant-numeric:tabular-nums}

  /* High-contrast / forced colors */
  @media (prefers-contrast: more){
    #signLabels text{stroke-width:1.1}
    .chip{border-color:color-mix(in oklch,var(--astro-rim) 55%, white)}
    .asp-table{box-shadow:0 0 0 1px color-mix(in oklch,var(--astro-rim) 60%, white) inset}
  }
  @media (forced-colors: active){
    .chip,.asp-table,.badge.asp{border:1px solid CanvasText}
    #planetDots .dot{filter:none}
  }

  /* Print tidy */
  @media print{
    .astro-head,.astro-chips button,.astro-aspects .legend{filter:grayscale(1)}
    .asp-table{box-shadow:none}
  }
}

/* ============================== UTILITIES =============================== */
@layer utilities{
  .badge{display:inline-flex;gap:.35rem;align-items:center;padding:.22rem .52rem;border:1px solid var(--line);border-radius:9px}
  .pull{font-style:italic;border-left:3px solid var(--gold);padding-left:.8rem;opacity:.93}
  .goldline{height:1px;background:linear-gradient(90deg,var(--gold),transparent)}
  .dl{display:inline-flex;align-items:center;gap:.35rem;border:1px dashed var(--line);padding:.48rem .78rem;border-radius:11px}

  /* Global focus ring */
  :is(a,button,[tabindex],.lab-input):focus-visible{
    outline:2px solid color-mix(in oklch,var(--accent) 75%, white);
    outline-offset:2px;border-radius:12px;
  }

  /* Notch-safe top spacer (use when needed) */
  .top-safe{ height: calc(env(safe-area-inset-top, 0px) + 8px) }

  /* Motion safety */
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation:none!important;transition:none!important}
  }
}