<!doctype html>
<html lang="en" dir="ltr" class="sof">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <meta charset="utf-8" />
  <title>13 Moons · Living Clock — Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f"><meta name="color-scheme" content="dark">
  <meta name="description" content="Living 13 Moons clock with a lunar simulation: 28-day moons, Day Out of Time, lunar phase, illumination, numerology, and daily energy notes — time-zone aware." />

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-24">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-24" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-24"></noscript>

  <style>
    :root{
      --maxw:1180px;
      --ink:#e6f0ff; --muted:#9aa4be; --line:#2a3242; --panel:rgba(255,255,255,.03);
      --a:#7af3ff; --b:#f3c97a; --c:#ffb674;
      --glow:0 8px 24px rgba(122,243,255,.14), 0 2px 10px rgba(243,201,122,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);background:
      radial-gradient(1000px 700px at 50% 20%, rgba(12,18,28,.65), transparent 65%),
      linear-gradient(180deg,#05060a 0%, #0b0e14 82%) fixed;
      overflow-x:hidden}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:20px 16px 90px}
    a{color:inherit;text-decoration:none}
    .title{
      font-family:"Crimson Pro",serif;font-weight:800;text-align:center;
      font-size:clamp(28px,3.6vw,44px);margin:8px 0 4px;letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#cfefff 60%,#a7f6ff);
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .subtitle{text-align:center;color:var(--muted);margin:0 0 12px}

    /* Layout grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}
    .col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    @media (max-width:980px){.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-12{grid-column:span 12}}

    /* Cards & inputs */
    .card{border:1px solid var(--line);border-radius:14px;padding:14px;background:var(--panel);box-shadow:var(--glow)}
    .lab-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .lab-btn{padding:.6rem .85rem;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);font-weight:700;cursor:pointer}
    .lab-btn[disabled]{opacity:.5;cursor:not-allowed}
    .lab-btn.primary{box-shadow:0 8px 24px rgba(122,243,255,.12)}
    .lab-input{padding:.6rem;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:inherit}
    .hint,.meta{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .pill{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .7rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    .chip{display:inline-flex;align-items:center;gap:.45rem;padding:.2rem .55rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:.88rem}
    .big{font-size:clamp(22px,3vw,30px);font-weight:800}

    .spark{height:8px;border-radius:999px;background:
      linear-gradient(90deg,
        var(--a) 0%,
        #a7f6ff 35%,
        var(--b) 70%,
        var(--c) 100%)}

    /* Simulation stage */
    .stage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#080d13}
    #sky{display:block;width:100%;height:420px;background:
      radial-gradient(400px 240px at 50% 30%, rgba(122,243,255,.08), transparent 60%),
      radial-gradient(1200px 800px at 50% 120%, rgba(243,201,122,.05), transparent 65%),
      linear-gradient(180deg,#05070b 0%, #081018 100%)}
    .hud{position:absolute;inset:auto 10px 10px 10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
    .hud .chip{pointer-events:auto}

    /* YHWH source bar */
    .sourcebar{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0 14px}
    .yhwh{font-weight:800;letter-spacing:.12em}
    .seal{background:linear-gradient(180deg,rgba(255,255,255,.06),transparent);border:1px solid var(--line);padding:.25rem .6rem;border-radius:999px}

    /* Timeline scrubber */
    .scrub{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-top:8px}
    input[type="range"]{accent-color:#91f0ff}

    /* Table overflow safety */
    .table-wrap{overflow:auto}

    /* Gentle reveal */
    .visible{opacity:1;transform:none}
    .card{opacity:.96;transform:translateY(6px);transition:opacity .25s ease-out, transform .25s ease-out}

    /* Reduced motion respect */
    @media (prefers-reduced-motion: reduce){
      .card{transition:none}
    }
  </style>
</head>

<body class="stars">
  <main class="wrap" id="main" role="main">
    <header class="page-head fancy-head">
      <h1 class="title">🌗 13 Moons — <em>Living Clock</em></h1>
      <p class="subtitle">28-day moons · Day Out of Time · lunar phase + simulation · numerology · daily energy notes — time-zone aware.</p>

      <!-- Return Navigation -->
      <nav class="crumbs" aria-label="Breadcrumb" style="display:flex;gap:8px;justify-content:center;margin-top:10px;margin-bottom:14px">
        <a class="lab-btn" href="index.html">← Back to Codex</a>
        <a class="lab-btn" href="theory.html">📘 Theory</a>
      </nav>

      <!-- YHWH source alignment surface -->
      <div class="sourcebar">
        <span class="chip">Eq.9 · Stop if clarity falls</span>
        <span class="chip">Seal: <span class="yhwh">י־ה־ו־ה</span> <span class="meta">(Source)</span></span>
        <span id="sourceChip" class="chip" style="display:none">⟡ Source aligned (י־ה־ו־ה)</span>
      </div>
    </header>

    <section class="grid">
      <!-- Simulation + Today -->
      <article class="card col-8">
        <h2 style="display:flex;align-items:center;gap:.6rem"><span>Orbital Simulation</span><span class="meta">Sun → Earth • Moon (phase/terminator)</span></h2>
        <div class="stage" aria-label="Moon–Earth–Sun simulation">
          <canvas id="sky" aria-label="Lunar simulation"></canvas>
          <div class="hud">
            <div class="lab-row">
              <span class="chip mono" id="simUTC">—</span>
              <span class="chip" id="simPhase">Phase: —</span>
              <span class="chip" id="simIllum">Illum: —</span>
              <span class="chip" id="simAge">Age: —</span>
              <span class="chip" id="simAngle">Angle: —</span>
            </div>
            <div class="lab-row">
              <button class="chip" id="simPlay" type="button">▶︎ Auto</button>
              <button class="chip" id="simSnap" type="button">Now</button>
              <button class="chip" id="simPNG"  type="button">PNG</button>
            </div>
          </div>
        </div>

        <!-- Scrub timeline -->
        <div class="scrub">
          <input id="timeRange" type="range" min="0" max="24" step="0.25" value="0" aria-label="Time scrub hours">
          <div class="pill"><span class="mono" id="scrubRead">—:—</span> <span class="meta" id="scrubTZ">—</span></div>
        </div>

        <div class="spark" style="margin:12px 0"></div>

        <!-- Today panel -->
        <div class="grid" style="margin-top:6px">
          <div class="col-6">
            <h3 style="margin:.2rem 0">13-Moon Count</h3>
            <p class="big" id="moonLine">—</p>
            <p class="meta" id="moonMeta">—</p>
          </div>
          <div class="col-6">
            <h3 style="margin:.2rem 0">Lunar Phase</h3>
            <p class="big" id="phaseLine">—</p>
            <p class="meta" id="phaseMeta">—</p>
          </div>
        </div>

        <div class="grid" style="margin-top:6px">
          <div class="col-6">
            <h3 style="margin:.2rem 0">Numerology</h3>
            <p class="big" id="numLine">—</p>
            <p class="meta" id="numMeta">—</p>
          </div>
          <div class="col-6">
            <h3 style="margin:.2rem 0">Energy Note</h3>
            <p id="energyNote">—</p>
            <p class="meta" id="energyQuote">—</p>
          </div>
        </div>
      </article>

      <!-- Controls -->
      <aside class="card col-4">
        <h2>Controls</h2>
        <div class="lab-row">
          <label>Time Zone
            <select id="tzPick" class="lab-input" style="min-width:260px"></select>
          </label>
        </div>
        <div class="lab-row" style="margin-top:6px">
          <label>Date
            <input type="date" id="datePick" class="lab-input">
          </label>
          <button class="lab-btn" id="btnToday" type="button">Today</button>
        </div>
        <div class="lab-row" style="margin-top:6px">
          <label>Hour (local)
            <input type="number" id="hourPick" class="lab-input" min="0" max="23" step="1" value="0" style="width:92px">
          </label>
          <label>Auto
            <input type="checkbox" id="autoPlay">
          </label>
          <button class="lab-btn" id="prevDay" type="button">← Previous</button>
          <button class="lab-btn" id="nextDay" type="button">Next →</button>
        </div>
        <div class="lab-row" style="margin-top:6px">
          <button class="lab-btn" id="shareLink" type="button">Copy Link</button>
          <span class="meta" id="nowTZ">—</span>
        </div>

        <div class="card" style="margin-top:10px">
          <h3 style="margin-top:0">Today</h3>
          <div class="lab-row">
            <span class="pill"><b id="nowDate">—</b></span>
            <span class="pill mono" id="nowClock">—:—:—</span>
          </div>
          <p class="hint" style="margin-top:6px">
            Year anchor: <b>New Year = July 26</b>. Day Out of Time = July 25. Leap Day (Feb 29) is outside the 13×28 count.
          </p>
        </div>
      </aside>

      <!-- Reference -->
      <article class="card col-12">
        <h2>Naming Keys</h2>
        <div class="grid">
          <div class="col-6">
            <h3>Moons (1–13)</h3>
            <ol class="list" id="moonList"></ol>
          </div>
          <div class="col-6">
            <h3>Phase Names</h3>
            <p class="meta">New • Waxing Crescent • First Quarter • Waxing Gibbous • Full • Waning Gibbous • Last Quarter • Waning Crescent</p>
            <p class="meta">Phase ≈ synodic age / 29.5306… days; illumination = (1 − cos(2π·phase)) / 2.</p>
          </div>
        </div>
        <blockquote class="meta" style="margin-top:10px">
          “Teach us to number our days, that we may apply our hearts unto wisdom.” — Psalm 90:12
        </blockquote>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="meta">© <span id="yr">2025</span> Aaron Paul Laird — Scroll of Fire • BY-NC 4.0</p>
    </footer>
  </main>

  <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);

    $("#yr").textContent=new Date().getFullYear();

    /* -------------------- Data -------------------- */
    const MOONS = [
      "Magnetic","Lunar","Electric","Self-Existing","Overtone","Rhythmic","Resonant",
      "Galactic","Solar","Planetary","Spectral","Crystal","Cosmic"
    ];
    const MOON_ESSENCE = [
      "Attract purpose","Stabilize challenge","Activate service","Define form",
      "Empower radiance","Balance equality","Channel inspiration",
      "Harmonize integrity","Pulse intention","Perfect manifestation",
      "Dissolve release","Dedicate cooperation","Endure presence"
    ];
    const ENERGY_NOTES = [
      "Small moves. True aim.",
      "Clarity before speed.",
      "Let the exhale do the work.",
      "We finish one helpful thing today.",
      "See one undeniable detail.",
      "Speak simply. Act kindly.",
      "Steady breath, steady hand.",
      "Return to the line.",
      "Finish clean, thank gently."
    ];
    const QUOTES = [
      "“Teach us to number our days, that we may apply our hearts unto wisdom.” — Psalm 90:12",
      "“For everything there is a season… a time to plant, and a time to uproot.” — Ecclesiastes 3:1-2",
      "“The light shines in the darkness, and the darkness has not overcome it.” — John 1:5",
      "“Mark the blameless and behold the upright, for there is a future for the man of peace.” — Psalm 37:37",
      "“In quietness and trust is your strength.” — Isaiah 30:15"
    ];

    /* -------------------- Timezone -------------------- */
    const TZ_KEY="sof_moons_tz";
    const tzPick = $("#tzPick");
    const defaultTZ = localStorage.getItem(TZ_KEY) || Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    const COMMON_TZ = [
      "UTC","America/Los_Angeles","America/Denver","America/Chicago","America/New_York",
      "Europe/London","Europe/Berlin","Europe/Helsinki","Africa/Johannesburg",
      "Asia/Dubai","Asia/Kolkata","Asia/Shanghai","Asia/Tokyo","Australia/Sydney"
    ];
    const ALL_TZ = Intl.supportedValuesOf ? Intl.supportedValuesOf("timeZone") : COMMON_TZ;
    const merged = [...new Set([...COMMON_TZ, ...ALL_TZ])];
    tzPick.innerHTML = merged.map(z=>`<option value="${z}">${z}</option>`).join("");
    tzPick.value = defaultTZ;

    /* -------------------- Helpers -------------------- */
    function dateInTZ(baseDate, tz){
      // Construct a new Date that reflects the wall time in tz.
      const opts={timeZone:tz, hour12:false, year:"numeric", month:"2-digit", day:"2-digit",
                  hour:"2-digit", minute:"2-digit", second:"2-digit"};
      const parts=new Intl.DateTimeFormat("en-CA",opts).formatToParts(baseDate);
      const m=Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return new Date(`${m.year}-${m.month}-${m.day}T${m.hour}:${m.minute}:${m.second}Z`);
    }
    function formatDate(d, tz){
      const f=new Intl.DateTimeFormat(undefined,{dateStyle:"full", timeZone:tz});
      return f.format(d);
    }
    function formatClock(d, tz){
      const f=new Intl.DateTimeFormat(undefined,{timeStyle:"medium", timeZone:tz});
      return f.format(d);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }

    /* -------------------- 13-Moon math -------------------- */
    // New Year = July 26; Day Out of Time = July 25 (outside count)
    function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
    function isLeapDay(d){ return d.getUTCMonth()===1 && d.getUTCDate()===29; } // Feb 29 (UTC basis)
    function isDayOutOfTime(d, tz){
      const dt = dateInTZ(d, tz);
      return (dt.getUTCMonth()===6 && dt.getUTCDate()===25); // July 25 in tz
    }
    function startOfYear13(d, tz){
      const dt = dateInTZ(d, tz);
      const y = dt.getUTCFullYear();
      const anchorThis = new Date(Date.UTC(y,6,26)); // Jul 26
      const anchorPrev = new Date(Date.UTC(y-1,6,26));
      return dt >= anchorThis ? anchorThis : anchorPrev;
    }
    function dayIndexSinceStart(d, tz){
      const start = startOfYear13(d, tz);
      const dt = dateInTZ(d, tz);
      let count = Math.floor((Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate()) -
                              Date.UTC(start.getUTCFullYear(),start.getUTCMonth(),start.getUTCDate()))/86400000);
      // Subtract the Day Out of Time after start
      const doy = new Date(Date.UTC(start.getUTCFullYear()+1,6,25)); // next Jul 25
      if (Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate()) >= Date.UTC(doy.getUTCFullYear(),doy.getUTCMonth(),doy.getUTCDate())) count -= 1;
      // Subtract Feb 29 if it occurred between
      for (let y=start.getUTCFullYear(); y<=dt.getUTCFullYear(); y++){
        if(isLeapYear(y)){
          const feb29=Date.UTC(y,1,29);
          if (Date.UTC(start.getUTCFullYear(),start.getUTCMonth(),start.getUTCDate())<=feb29 &&
              Date.UTC(dt.getUTCFullYear(),dt.getUTCMonth(),dt.getUTCDate())>=feb29) count -= 1;
        }
      }
      return count;
    }
    function calc13Moon(d, tz){
      const start = startOfYear13(d, tz);
      if(isDayOutOfTime(d, tz)) return { special:"Day Out of Time", moon:null, day:null, year:start.getUTCFullYear() + "/" + (start.getUTCFullYear()+1) };
      if(isLeapDay(dateInTZ(d, tz))) return { special:"Leap Day", moon:null, day:null, year:start.getUTCFullYear() + "/" + (start.getUTCFullYear()+1) };
      const idx = dayIndexSinceStart(d, tz); // 0..363
      const moon = Math.floor(idx/28)+1; // 1..13
      const day = (idx%28)+1; // 1..28
      const yearStr = start.getUTCFullYear() + "/" + (start.getUTCFullYear()+1);
      return {special:null, moon, day, year:yearStr};
    }

    /* -------------------- Moon phase (approx) -------------------- */
    // Synodic approx (29.530588853 days), base epoch: 2000-01-06 18:14 UTC new moon
    function moonPhase(d){
      const synodic = 29.530588853;
      const epoch = Date.UTC(2000,0,6,18,14,0);
      const days = (d.getTime() - epoch)/86400000;
      const age = ((days % synodic) + synodic) % synodic;
      const frac = age / synodic; // 0..1
      const names = [
        {n:"New Moon", r:[0.00, 0.03]},
        {n:"Waxing Crescent", r:[0.03, 0.22]},
        {n:"First Quarter", r:[0.22, 0.28]},
        {n:"Waxing Gibbous", r:[0.28, 0.47]},
        {n:"Full Moon", r:[0.47, 0.53]},
        {n:"Waning Gibbous", r:[0.53, 0.72]},
        {n:"Last Quarter", r:[0.72, 0.78]},
        {n:"Waning Crescent", r:[0.78, 0.97]},
        {n:"New Moon", r:[0.97, 1.01]},
      ];
      const phase = names.find(x=> frac>=x.r[0] && frac<x.r[1])?.n || "—";
      const illum = (1 - Math.cos(2*Math.PI*frac))/2;
      // Approx sun angle from fraction: 0 new; π full
      const angle = (frac*2*Math.PI) % (2*Math.PI);
      return {phase, ageDays:age, illum, angle, frac};
    }

    /* -------------------- Numerology -------------------- */
    function sumDigits(n){ return String(n).split("").reduce((a,b)=>a+(+b||0),0); }
    function reduceNum(n){
      while(n>9 && n!==11 && n!==22 && n!==33){ n = sumDigits(n); }
      return n;
    }
    function numerology(d, tz){
      const dt = dateInTZ(d, tz);
      const y=dt.getUTCFullYear(), m=dt.getUTCMonth()+1, day=dt.getUTCDate();
      const total = reduceNum(sumDigits(y)+sumDigits(m)+sumDigits(day));
      const monthN = reduceNum(sumDigits(y)+sumDigits(m));
      const dayN = reduceNum(sumDigits(day));
      return {total, monthN, dayN};
    }

    /* -------------------- UI state & wiring -------------------- */
    const nowDate=$("#nowDate"), nowClock=$("#nowClock"), nowTZ=$("#nowTZ");
    const moonLine=$("#moonLine"), moonMeta=$("#moonMeta");
    const phaseLine=$("#phaseLine"), phaseMeta=$("#phaseMeta");
    const numLine=$("#numLine"), numMeta=$("#numMeta");
    const energyNote=$("#energyNote"), energyQuote=$("#energyQuote");
    const moonList=$("#moonList"); MOONS.forEach((m,i)=>{ const li=document.createElement("li"); li.textContent = `${i+1}. ${m} — ${MOON_ESSENCE[i]}`; moonList.appendChild(li); });

    // Source chip (YHWH) when resonant
    const sourceChip=$("#sourceChip");
    function updateSourceChip(nu){
      const resonant = [1,4,7,11,22,33].includes(nu.total);
      sourceChip.style.display = resonant ? "inline-flex" : "none";
    }

    // Controls
    const datePick=$("#datePick"), hourPick=$("#hourPick"), tzOut=$("#scrubTZ"), scrubRead=$("#scrubRead");
    const tzLabel=$("#nowTZ");
    const timeRange=$("#timeRange"), autoPlay=$("#autoPlay");
    on(tzPick,"change",()=>{ localStorage.setItem(TZ_KEY, tzPick.value); updateAll(); writeURL(); });
    on(datePick,"change",()=>{ syncScrubFromInputs(); updateAll(); writeURL(); });
    on(hourPick,"change",()=>{ syncScrubFromInputs(); updateAll(); writeURL(); });
    on(timeRange,"input",()=>{ syncInputsFromScrub(); updateAll(); });
    on($("#btnToday"),"click",()=>{ const tz=tzPick.value; const dt=dateInTZ(new Date(), tz); datePick.value=dt.toISOString().slice(0,10); hourPick.value=dt.getUTCHours(); syncScrubFromInputs(); updateAll(); writeURL(); });
    on($("#prevDay"),"click",()=>{ const d=new Date(datePick.value+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()-1); datePick.value=d.toISOString().slice(0,10); updateAll(); writeURL(); });
    on($("#nextDay"),"click",()=>{ const d=new Date(datePick.value+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+1); datePick.value=d.toISOString().slice(0,10); updateAll(); writeURL(); });
    on($("#shareLink"),"click",()=>{ writeURL(); navigator.clipboard?.writeText(location.href); toast("Link copied"); });

    /* -------------------- URL sync -------------------- */
    function readURL(){
      const u=new URL(location.href);
      const d=u.searchParams.get("d");
      const z=u.searchParams.get("tz");
      const t=u.searchParams.get("t"); // hour:minute (local in tz)
      if(z && merged.includes(z)){ tzPick.value=z; localStorage.setItem(TZ_KEY,z); }
      if(d){ datePick.value = d; } else {
        const dt=dateInTZ(new Date(), tzPick.value);
        datePick.value = dt.toISOString().slice(0,10);
      }
      if(t){
        const [hh,mm]=t.split(":").map(x=>+x||0);
        hourPick.value = Math.min(23,Math.max(0, hh + (mm>=30?1:0)));
        timeRange.value = Math.min(24, Math.max(0, hh + mm/60));
      } else {
        const wall = dateInTZ(new Date(), tzPick.value);
        hourPick.value = wall.getUTCHours();
        timeRange.value = wall.getUTCHours() + wall.getUTCMinutes()/60;
      }
    }
    function writeURL(){
      const u=new URL(location.href);
      u.searchParams.set("d", datePick.value);
      u.searchParams.set("tz", tzPick.value);
      const hh = Math.floor(+timeRange.value);
      const mm = Math.round((+timeRange.value - hh)*60);
      u.searchParams.set("t", `${pad2(hh)}:${pad2(mm)}`);
      history.replaceState(null,"",u);
    }
    function syncScrubFromInputs(){
      const h = Math.min(23,Math.max(0, +hourPick.value||0));
      timeRange.value = h;
    }
    function syncInputsFromScrub(){
      const h = Math.floor(+timeRange.value);
      hourPick.value = h;
    }

    /* -------------------- Live clock -------------------- */
    function updateClockLine(){
      const tz=tzPick.value;
      const base = new Date();
      const wall = dateInTZ(base, tz);
      nowDate.textContent = formatDate(wall, tz);
      nowClock.textContent = formatClock(base, tz);
      tzLabel.textContent = tz;
      $("#simUTC").textContent = wall.toISOString().replace("T"," ").slice(0,19) + "Z";
    }
    setInterval(()=>{ updateClockLine();
      // Rollover if user views "today"
      const tz=tzPick.value;
      const today = dateInTZ(new Date(), tz).toISOString().slice(0,10);
      const isTodaySelected = datePick.value === today;
      if(isTodaySelected && !autoPlay.checked){ datePick.value = today; updateAll(); }
    }, 1000);

    /* -------------------- Simulation -------------------- */
    const canvas=$("#sky"), ctx=canvas.getContext("2d");
    function fitCanvas(){
      const r=canvas.getBoundingClientRect();
      canvas.width=r.width;
      canvas.height=Math.max(340, Math.min(560, Math.round(r.width*0.38)));
    }
    fitCanvas(); addEventListener("resize", fitCanvas, {passive:true});
    if('ResizeObserver' in window){ new ResizeObserver(()=>fitCanvas()).observe(canvas.parentElement); }

    const PREFERS_RM = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let anim = !PREFERS_RM;

    function getSelectedDateTime(){
      // Combine datePick (in tz) with timeRange hour selection
      const tz = tzPick.value;
      const dateStr = datePick.value; // YYYY-MM-DD
      const hours = +timeRange.value;
      // Build wall time in tz, then convert to Date
      const dt = new Date(`${dateStr}T00:00:00Z`);
      // Shift to tz wall midnight then add hours
      const midnight = dateInTZ(dt, tz); // tz-relative midnight UTC stamp
      const d = new Date(midnight.getTime() + hours*3600*1000);
      return {tz, d};
    }

    function drawSimulation(){
      const {tz, d} = getSelectedDateTime();

      // Compute phase
      const ph = moonPhase(d);
      $("#simPhase").textContent = "Phase: " + ph.phase;
      $("#simIllum").textContent = "Illum: " + Math.round(ph.illum*100) + "%";
      $("#simAge").textContent = "Age: " + ph.ageDays.toFixed(1) + " d";
      const deg = (ph.angle*180/Math.PI).toFixed(0);
      $("#simAngle").textContent = "Angle: " + deg + "°";

      // Background starfield
      const W=canvas.width,H=canvas.height;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle="#070b11"; ctx.fillRect(0,0,W,H);
      // subtle glow gradients
      const g1=ctx.createRadialGradient(W*0.5,H*0.3,100,W*0.5,H*0.3,Math.max(W,H)*0.65);
      g1.addColorStop(0,"rgba(122,243,255,.08)");
      g1.addColorStop(1,"rgba(10,16,24,0)");
      ctx.fillStyle=g1; ctx.fillRect(0,0,W,H);

      // Sun direction rotates across the day for visual interest:
      // tie to local hour in tz (not astronomically exact, just a pleasing cue)
      const wall=dateInTZ(d, tz);
      const hour = wall.getUTCHours() + wall.getUTCMinutes()/60;
      const sunTheta = (hour/24)*2*Math.PI; // 0..2π
      const sunVec = [Math.cos(sunTheta), Math.sin(sunTheta)]; // unit vector

      // Earth at center
      const ex=W/2, ey=H/2, er=Math.min(W,H)*0.13;
      const eg=ctx.createRadialGradient(ex,ey,er*0.2,ex,ey,er);
      eg.addColorStop(0,"#1f2b3b");
      eg.addColorStop(1,"#0a121c");
      ctx.beginPath(); ctx.arc(ex,ey,er,0,Math.PI*2); ctx.fillStyle=eg; ctx.fill();

      // Earth terminator shading (from Sun direction)
      ctx.save();
      ctx.globalCompositeOperation="multiply";
      ctx.fillStyle="rgba(0,0,0,.45)";
      ctx.beginPath();
      // Draw a big ellipse shadow opposite sun
      const sx = ex - sunVec[0]*er*0.7, sy = ey - sunVec[1]*er*0.7;
      ctx.ellipse(sx, sy, er*1.15, er*0.95, Math.atan2(sunVec[1],sunVec[0]), 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      // Simple orbit radius and parallax-ish scale for Moon
      const orbitR = Math.min(W,H)*0.28;
      const moonBaseR = Math.min(W,H)*0.05;
      // Use synodic fraction as orbital angle (visualization, not true sidereal)
      const theta = ph.frac * 2*Math.PI;
      const mx = ex + orbitR*Math.cos(theta);
      const my = ey + orbitR*Math.sin(theta);
      // fake distance for scale: farther at new/full, closer at quarters (just to add life)
      const depth = 0.5 + 0.5*Math.sin(theta);
      const mr = moonBaseR * (0.9 + 0.15*depth);

      // Draw orbit path
      ctx.strokeStyle="rgba(122,243,255,.18)";
      ctx.lineWidth=1.2; ctx.setLineDash([4,6]); ctx.beginPath();
      ctx.ellipse(ex,ey,orbitR,orbitR*0.86,0,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);

      // Sun flare indicator
      const sunX = ex + Math.cos(sunTheta)* (orbitR+er*0.9);
      const sunY = ey + Math.sin(sunTheta)* (orbitR+er*0.9);
      const sg = ctx.createRadialGradient(sunX,sunY,4,sunX,sunY,40);
      sg.addColorStop(0,"rgba(255,240,210,.95)");
      sg.addColorStop(1,"rgba(255,184,116,.08)");
      ctx.beginPath(); ctx.arc(sunX,sunY,40,0,Math.PI*2); ctx.fillStyle=sg; ctx.fill();
      ctx.beginPath(); ctx.arc(sunX,sunY,3.5,0,Math.PI*2); ctx.fillStyle="#ffd187"; ctx.fill();

      // Moon body (base)
      const mg=ctx.createRadialGradient(mx,my,mr*0.2,mx,my,mr);
      mg.addColorStop(0,"#eae6dd");
      mg.addColorStop(1,"#aaa79e");
      ctx.beginPath(); ctx.arc(mx,my,mr,0,Math.PI*2); ctx.fillStyle=mg; ctx.fill();

      // Phase terminator: shadow as a shifted ellipse aligned with sun vector
      // We model the illuminated limb as the projection of a light vector; crescent thickness ≈ |cos(π·frac)|
      const k = Math.cos(ph.frac*Math.PI*2); // -1..1 (full..new)
      // shadow offset along sun direction (flip to ensure correct waxing/waning)
      const off = k * mr;
      ctx.save();
      ctx.beginPath();
      // Clip moon
      ctx.arc(mx,my,mr,0,Math.PI*2);
      ctx.clip();

      // Shadow side
      ctx.translate(mx,my);
      const rot = Math.atan2(sunVec[1],sunVec[0]);
      ctx.rotate(rot + Math.PI); // so that "light" comes from +sunVec
      const shGrad = ctx.createLinearGradient(-mr,0,mr,0);
      shGrad.addColorStop(0,"rgba(0,0,0,.85)");
      shGrad.addColorStop(0.5,"rgba(0,0,0,.35)");
      shGrad.addColorStop(1,"rgba(0,0,0,0)");
      ctx.fillStyle=shGrad;
      ctx.beginPath();
      ctx.ellipse(off,0, mr, mr*1.02, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      // Rim highlight on bright limb
      ctx.save();
      ctx.globalCompositeOperation="screen";
      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(mx,my,mr-0.5,0,Math.PI*2); ctx.stroke();
      ctx.restore();

      // Little labels
      ctx.fillStyle="rgba(230,240,255,.9)";
      ctx.font="12px Inter, system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Earth", ex - 16, ey + er + 14);
      ctx.fillText("Sun", sunX + 10, sunY + 4);
      ctx.fillText("Moon", mx - 18, my + mr + 12);
    }

    // PNG export
    on($("#simPNG"),"click",()=>{ try{ const url=canvas.toDataURL("image/png"); const a=document.createElement("a"); a.href=url; a.download="moon-sim.png"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);}catch(_){ toast("Download failed"); } });
    on($("#simSnap"),"click",()=>{ const tz=tzPick.value; const wall=dateInTZ(new Date(), tz); datePick.value = wall.toISOString().slice(0,10); const h=wall.getUTCHours()+wall.getUTCMinutes()/60; timeRange.value=h; hourPick.value=Math.floor(h); updateAll(); writeURL(); });

    // Animation
    const playBtn=$("#simPlay");
    let rafId=null;
    function loop(){
      drawSimulation();
      if(anim) rafId=requestAnimationFrame(loop);
    }
    function start(){ if(!anim){ anim=true; loop(); } }
    function stop(){ anim=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; }
    on(playBtn,"click",()=>{ if(anim){ stop(); playBtn.textContent="▶︎ Auto"; } else { start(); playBtn.textContent="⏸︎ Pause"; } });
    if(!PREFERS_RM){ start(); }

    /* -------------------- Page data update -------------------- */
    function updateAll(){
      const tz=tzPick.value;
      const base = new Date(); // system now
      const wall = dateInTZ(base, tz);
      $("#simUTC").textContent = wall.toISOString().replace("T"," ").slice(0,19) + "Z";
      tzOut.textContent = tz;
      // Scrub readout
      const hh = Math.floor(+timeRange.value);
      const mm = Math.round((+timeRange.value - hh)*60);
      scrubRead.textContent = `${pad2(hh)}:${pad2(mm)}`;

      // Selected date/time
      const sel = new Date(datePick.value+"T00:00:00Z");
      // 13-Moon
      const m13 = calc13Moon(sel, tz);
      if(m13.special){
        moonLine.textContent = m13.special;
        moonMeta.textContent = `13-Moon Year: ${m13.year} • Outside the 13×28 count`;
      }else{
        const idx = (m13.moon-1);
        moonLine.textContent = `${MOONS[idx]} Moon — Day ${m13.day}`;
        moonMeta.textContent = `${MOON_ESSENCE[idx]} • Year ${m13.year}`;
      }

      // Phase for selected day at current scrub hour
      const selWall = new Date(getSelectedDateTime().d);
      const ph = moonPhase(selWall);
      phaseLine.textContent = ph.phase;
      phaseMeta.textContent = `Age ≈ ${ph.ageDays.toFixed(1)} d • Illum ≈ ${(ph.illum*100).toFixed(0)}%`;

      // Numerology
      const nu = numerology(sel, tz);
      numLine.textContent = `Universal ${nu.total}`;
      numMeta.textContent = `Month tone ${nu.monthN} • Day tone ${nu.dayN}`;
      updateSourceChip(nu);

      // Energy note + quote (deterministic)
      const seedIdx = Math.abs(sel.getUTCFullYear()*372 + (sel.getUTCMonth()+1)*31 + sel.getUTCDate());
      energyNote.textContent = ENERGY_NOTES[ seedIdx % ENERGY_NOTES.length ];
      energyQuote.textContent = QUOTES[ (seedIdx+7) % QUOTES.length ];

      // Redraw sim once to reflect hour slider changes
      drawSimulation();
    }

    /* -------------------- Auto-play clock tick -------------------- */
    setInterval(()=>{
      if(!autoPlay.checked) return;
      // Advance 0.25h steps
      let v=+timeRange.value + 0.25;
      if(v>24){ v=0; // advance the date
        const d=new Date(datePick.value+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+1); datePick.value=d.toISOString().slice(0,10);
      }
      timeRange.value=v; syncInputsFromScrub(); updateAll(); writeURL();
    }, 1000); // 1s per quarter hour (fast visual clock)

    /* -------------------- Reveal animation -------------------- */
    if('IntersectionObserver' in window){
      const io=new IntersectionObserver(es=>es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); } }), {threshold:.08});
      $$(".card").forEach(c=>io.observe(c));
    } else { $$(".card").forEach(c=>c.classList.add('visible')); }

    // Tiny toast
    function toast(msg){
      const el=document.createElement("div"); el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }

    // Init
    readURL(); updateClockLine(); updateAll();

  })();
  </script>
</body>
</html>
