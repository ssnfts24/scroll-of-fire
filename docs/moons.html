<!doctype html>
<html lang="en" dir="ltr" class="sof carrier-432" data-carriers="432,528,369,144,963" data-alive="lively">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>(()=>{const LIVE="ssnfts24.github.io";if(location.hostname!==LIVE){const b=document.querySelector("base");b&&b.remove();}})();</script>

  <!-- Flashless theme + FB in-app guard -->
  <script>(()=>{try{let t=localStorage.getItem('theme');if(!t){t=(matchMedia&&matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark'}document.documentElement.setAttribute('data-theme',t)}catch{}})();</script>
  <script>(()=>{const ua=navigator.userAgent||'';if(/\bFBAN|FBAV|FB_IAB|FBAN\/Messenger\b/i.test(ua)){document.documentElement.classList.add('is-fbapp')}})();</script>

  <meta charset="utf-8" />
  <title>Remnant 13 Moons â€” Living Clock Â· Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#05070d" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7fbff" media="(prefers-color-scheme: light)">
  <meta name="description" content="Remnant 13-Moon Living Clock â€” TZ-true 13Ã—28 mapping with week dots, year map, lunar sim, Kin (optional), daily Remnant verses, and .ics export." />
  <meta name="format-detection" content="telephone=no">
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/moons.html">

  <!-- OG / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Remnant 13 Moons â€” Living Clock">
  <meta property="og:description" content="Day ring â€¢ Week dots â€¢ Year map â€¢ Lunar sim â€¢ Kin â€¢ Verses â€¢ .ics â€” YHWH seal.">
  <meta property="og:image" content="assets/share/moon-card.png">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/moons.html">
  <meta name="twitter:card" content="summary_large_image">

  <!-- PWA -->
  <link rel="manifest" href="assets/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="13 Moons">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png">
  <link rel="mask-icon" href="assets/icons/safari-pinned.svg" color="#0e131a">

  <!-- Cascade layers -->
  <style>@layer tokens, base, components, astrology, utilities, remnant, legacy;</style>

  <!-- Your CSS packs -->
  <link rel="stylesheet" href="assets/css/fonts.css?v=2025-11-02x">
  <link rel="stylesheet" href="assets/css/tokens.css?v=2025-11-02x">
  <link rel="stylesheet" href="assets/css/core.css?v=2025-11-02x">
  <link rel="stylesheet" href="assets/css/astrology.css?v=2025-11-02x">
  <link rel="stylesheet" href="assets/css/moons.css?v=2025-11-02x">
  <link rel="stylesheet" href="assets/css/bridge.css?v=2025-11-02x">

  <!-- Mobile-first fallbacks so layout never collapses -->
  <style>
    :root{ --safe-top: env(safe-area-inset-top,0px) }
    .top-safe{ height: calc(var(--safe-top) + 8px) }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px }
    .wrap{ padding-inline: clamp(12px,5vw,20px) }
    .card{ border:1px solid #2a2a33; border-radius:14px; background:#0e0e12; padding:12px }
    .row-2{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width:900px){ .row-2{ grid-template-columns:1fr 1fr } }
    .legend{ display:flex; flex-wrap:wrap; gap:8px }
    .year-map{ width:100%; border-collapse:separate; border-spacing:0 }
    .year-map thead th{ position:sticky; top:0; background:#0e0e12 }
    .weekrow{ display:flex; align-items:center; gap:.6rem; white-space:nowrap; overflow:auto; -webkit-overflow-scrolling:touch }
    :focus-visible{ outline:2px solid #7af3ff; outline-offset:2px }
  </style>

  <!-- Calendar hardening (7 cols, square cells, sticky labels, micro scroll) -->
  <style>
  @layer components {
    .calendar, .gregorian { --cell: clamp(36px, 7.5vw, 56px); --gap: 6px; }
    .calendar .r-grid, .gregorian .g-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(var(--cell), 1fr));
      gap: var(--gap);
      align-items: stretch;
      -webkit-user-select: none; user-select: none;
    }
    .g-lbl, .r-lbl {
      position: sticky; top: 0; z-index: 1; text-align: center;
      font: 600 12px/1.2 system-ui, Inter;
      color: color-mix(in lch, var(--ink) 65%, transparent);
      padding: 6px 0;
      background: color-mix(in lch, var(--moon-bg-from) 70%, transparent);
      border-radius: 8px;
    }
    .g-day > button, .r-day > button {
      width: 100%;
      aspect-ratio: 1 / 1;
      display: grid; place-items: center;
      border-radius: 12px;
      border: 1px solid color-mix(in lch, var(--line) 80%, transparent);
      background: linear-gradient(180deg,
        color-mix(in lch, var(--card) 92%, transparent),
        color-mix(in lch, var(--card) 80%, transparent)
      );
      color: var(--ink);
      font: 600 clamp(12px, 2.6vw, 15px)/1 system-ui, Inter;
      letter-spacing: .2px;
    }
    .g-day > button:focus-visible, .r-day > button:focus-visible {
      outline: 2px solid var(--moon-accent); outline-offset: 2px;
    }
    .g-day.is-today > button, .r-day.is-today > button {
      border-color: var(--moon-accent);
      box-shadow: 0 0 0 2px color-mix(in lch, var(--moon-accent) 45%, transparent) inset;
    }
    .r-doot {
      grid-column: 1 / -1; padding: 12px; border-radius: 12px; text-align: center;
      border: 1px dashed color-mix(in lch, var(--moon-accent) 50%, var(--line));
      color: color-mix(in lch, var(--ink) 80%, transparent);
      background: linear-gradient(180deg, transparent, color-mix(in lch, var(--moon-aether) 25%, transparent));
    }
    .weeklabel { font-weight: 600; color: var(--muted) }
    .wdots { display: grid; grid-auto-flow: column; gap: 8px }
    .wdot { width: 8px; height: 8px; border-radius: 999px; background:#2c3648; }
    .wdot.is-today { background: var(--moon-accent) }
    .panel__head { display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:8px }
    .panel__title{ font-size:clamp(16px,3.6vw,18px); font-weight:700 }
    .panel__meta { color: var(--muted) }
    @media (min-width: 900px){
      .calendar, .gregorian { --cell: clamp(42px, 5.5vw, 60px) }
    }
    @media (max-width: 360px){
      .calendar .r-grid, .gregorian .g-grid {
        grid-template-columns: repeat(7, var(--cell));
        overflow-x: auto; padding-bottom: 4px;
      }
    }
  }
  </style>

  <!-- Moon Theme System (13 + DOOT) -->
  <style id="moon-themes">
    :root{
      --moon-accent:#7af3ff; --moon-accent-2:#7aa8ff;
      --moon-bg-from:#0b0b0f; --moon-bg-to:#0e0e12;
      --moon-aether:rgba(122,243,255,.12);
      --twist:0deg; --grain:0.06; --spark:0.35;
    }
    body.remnant-yhwh::before{
      content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1100px 520px at 50% -12%, var(--moon-aether), transparent 60%),
        linear-gradient(180deg, var(--moon-bg-from), var(--moon-bg-to));
      filter:hue-rotate(var(--twist));
    }
    .ringcard .ring-fg{ stroke: var(--moon-accent); }
    #awGrad stop:first-child{ stop-color:var(--moon-accent) }
    #awGrad stop:last-child{ stop-color:var(--moon-accent-2) }
    .pill,.badge,.lab-btn.ghost{ box-shadow:0 0 0 1px color-mix(in lch, var(--moon-accent) 26%, transparent); }

    /* DOOT + 13 Moons */
    body.theme-doot{ --moon-accent:#bfbfc9; --moon-accent-2:#8a8a98; --moon-bg-from:#0a0a0e; --moon-bg-to:#0f1018; --moon-aether:rgba(200,200,220,.08);}
    body.theme-moon-1 { --moon-accent:#9cf; --moon-accent-2:#5ef; --moon-bg-from:#08131c; --moon-bg-to:#0b1a26; --moon-aether:rgba(140,200,255,.12);}
    body.theme-moon-2 { --moon-accent:#ffb4a8; --moon-accent-2:#ff866b; --moon-bg-from:#201015; --moon-bg-to:#2b1218; --moon-aether:rgba(255,118,86,.12);}
    body.theme-moon-3 { --moon-accent:#ffd37a; --moon-accent-2:#ffe6a8; --moon-bg-from:#1f1808; --moon-bg-to:#2a210c; --moon-aether:rgba(255,214,122,.10);}
    body.theme-moon-4 { --moon-accent:#b6ffcc; --moon-accent-2:#6dff9e; --moon-bg-from:#0a1a12; --moon-bg-to:#0f2218; --moon-aether:rgba(120,255,180,.10);}
    body.theme-moon-5 { --moon-accent:#ffe07a; --moon-accent-2:#ffc84d; --moon-bg-from:#211a07; --moon-bg-to:#2a2109; --moon-aether:rgba(255,200,90,.12);}
    body.theme-moon-6 { --moon-accent:#9ef; --moon-accent-2:#6bf; --moon-bg-from:#07151a; --moon-bg-to:#0a1b22; --moon-aether:rgba(120,230,255,.10);}
    body.theme-moon-7 { --moon-accent:#d5b6ff; --moon-accent-2:#b98cff; --moon-bg-from:#160d22; --moon-bg-to:#1c1030; --moon-aether:rgba(190,140,255,.12);}
    body.theme-moon-8 { --moon-accent:#a8ffd9; --moon-accent-2:#7affc4; --moon-bg-from:#0a1713; --moon-bg-to:#0e1e18; --moon-aether:rgba(130,255,210,.10);}
    body.theme-moon-9 { --moon-accent:#ff927a; --moon-accent-2:#ff6a55; --moon-bg-from:#1e0e0b; --moon-bg-to:#270f0c; --moon-aether:rgba(255,120,100,.12);}
    body.theme-moon-10{ --moon-accent:#a2ffd1; --moon-accent-2:#73ffc0; --moon-bg-from:#0c1912; --moon-bg-to:#102219; --moon-aether:rgba(140,255,200,.10);}
    body.theme-moon-11{ --moon-accent:#a8b8ff; --moon-accent-2:#7a8cff; --moon-bg-from:#0b0f22; --moon-bg-to:#0e1230; --moon-aether:rgba(120,140,255,.10);}
    body.theme-moon-12{ --moon-accent:#ffd7a8; --moon-accent-2:#ffc57a; --moon-bg-from:#1e140a; --moon-bg-to:#24180c; --moon-aether:rgba(255,205,150,.10);}
    body.theme-moon-13{ --moon-accent:#9df; --moon-accent-2:#7cf; --moon-bg-from:#0a1016; --moon-bg-to:#0c1218; --moon-aether:rgba(140,220,255,.12);}
  </style>

  <!-- Preloads -->
  <link rel="prefetch" href="index.html" as="document">
</head>

<body class="stars remnant-yhwh">
  <div class="top-safe" aria-hidden="true"></div>
  <!-- Cosmic canvas: stars + aurora (behind content) -->
  <canvas id="skyBg" width="1440" height="900" aria-hidden="true" style="position:fixed;inset:0;width:100vw;height:100vh;z-index:0;pointer-events:none"></canvas>

  <main class="wrap" id="main" role="main" style="position:relative;z-index:1">
    <header class="page-head fancy-head">
      <h1 class="title">ğŸŒ— Remnant 13 Moons <span class="soft">â€” Living Clock</span></h1>
      <p class="subtitle">13Ã—28 cadence Â· TZ-true Â· sealed <span lang="he" title="YHWH">×™×”×•×”</span>.</p>
      <nav class="crumbs" aria-label="Breadcrumb">
        <a class="lab-btn" href="index.html">â† Codex</a>
        <a class="lab-btn" href="theory.html">ğŸ“˜ Theory</a>
      </nav>

      <section class="card ringcard" aria-label="Current Moon">
        <div class="moon-badge">
          <div class="ring" aria-label="Day in Moon">
            <svg viewBox="0 0 120 120" role="img" aria-label="Progress ring for day within 28-day moon">
              <circle cx="60" cy="60" r="50" class="ring-bg"/>
              <circle cx="60" cy="60" r="50" class="ring-fg" id="moonArc" pathLength="316"/>
            </svg>
            <div class="label" aria-live="polite"><div class="big" id="dayInMoon">â€”</div><div class="small">/28</div></div>
          </div>
          <span class="pill" id="moonChip"><span class="k" id="moonName">â€”</span> <span class="meta" id="moonEssence">â€”</span></span>
          <span class="pill mono"><span id="yearSpan">â€”</span></span>
        </div>

        <div class="weekrow" role="group" aria-label="Week inside the 28-day moon">
          <span class="weeklabel">Week</span>
          <div class="week" id="weekDots" role="list"></div>
        </div>

        <p class="meta" id="dootWarn" hidden><b>Day Out of Time:</b> outside the 13Ã—28 cadence.</p>
      </section>
    </header>

    <!-- TODAY (moved above calendars) -->
    <section class="grid" aria-label="Controls and Simulation">
      <article class="card">
        <h2 id="today-head">Today</h2>
        <div class="chiprow" role="status" aria-live="polite">
          <span class="pill"><b id="nowDate">â€”</b></span>
          <span class="pill mono" id="nowClock" role="timer">â€”:â€”:â€”</span>
          <span class="pill" id="nowTZ">â€”</span>
          <span class="pill" id="moonLine">â€”</span>
        </div>

        <div class="formrow">
          <label>Time Zone
            <select id="tzPick" class="lab-input" aria-label="Time Zone"></select>
          </label>
          <label>Date
            <input type="date" id="datePick" class="lab-input" aria-label="Pick a date" inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}">
          </label>
          <label>Hour
            <input type="range" id="hourScrub" min="0" max="23" value="12" class="lab-input" aria-label="Hour of day">
          </label>
        </div>

        <div class="btnrow">
          <button class="lab-btn" id="btnToday" type="button">Today</button>
          <button class="lab-btn" id="prevDay" type="button">â† Prev</button>
          <button class="lab-btn" id="nextDay" type="button">Next â†’</button>
          <button class="lab-btn ghost" id="shareLink" type="button">Copy Link</button>
          <label class="tag" style="margin-left:auto">Go to:
            <select id="jumpMoon" class="lab-input" aria-label="Jump to Moon">
              <option value="">â€”</option>
              <option value="1">#1 Magnetic</option><option value="2">#2 Lunar</option><option value="3">#3 Electric</option>
              <option value="4">#4 Self-Existing</option><option value="5">#5 Overtone</option><option value="6">#6 Rhythmic</option>
              <option value="7">#7 Resonant</option><option value="8">#8 Galactic</option><option value="9">#9 Solar</option>
              <option value="10">#10 Planetary</option><option value="11">#11 Spectral</option><option value="12">#12 Crystal</option>
              <option value="13">#13 Cosmic</option>
            </select>
          </label>
        </div>
        <p class="hint keys">Keys: <span class="kbd">â†‘/â†“</span> day â€¢ <span class="kbd">â†/â†’</span> hour â€¢ <span class="kbd">T</span> today</p>
      </article>

      <aside class="card" aria-labelledby="verse-head">
        <h2 id="verse-head">Remnant Verse</h2>
        <blockquote class="pull" id="verseBox">
          <span class="he" id="vHeb" lang="he" dir="rtl">â€”</span>
          <span class="en" id="vEn">â€”</span>
          <cite class="meta" id="vRef">â€”</cite>
        </blockquote>

        <h2 id="lunar-head" style="margin-top:12px">Lunar Phase</h2>
        <div class="sim">
          <canvas id="simMoon" width="280" height="280" aria-label="Lunar phase"></canvas>
          <div>
            <p class="mono" id="phaseLine">â€”</p>
            <p class="meta" id="phaseMeta">â€”</p>
            <div class="divider" aria-hidden="true"></div>
            <section id="numerologyBox" aria-live="polite">
              <h3 class="tight">Numerology</h3>
              <p class="mono" id="numLine">â€”</p>
              <p class="meta" id="numMeta">â€”</p>
              <p class="meta" id="energyQuote" style="margin-top:6px">â€”</p>
            </section>
          </div>
        </div>
      </aside>
    </section>

    <!-- CALENDARS (side-by-side on desktop) -->
    <section class="row-2" aria-label="Remnant vs Gregorian">
      <article class="card">
        <header class="panel__head">
          <h3 class="panel__title" id="remHdr">Remnant Month</h3>
          <div class="panel__meta" id="remMeta">13 Ã— 28 fixed</div>
        </header>
        <section id="remCal" class="calendar" aria-label="Remnant Month (live)"></section>
      </article>

      <article class="card">
        <header class="panel__head">
          <h3 class="panel__title" id="gregHdr">Gregorian Month</h3>
          <div class="panel__meta" id="gregMeta">Variable weeks</div>
        </header>
        <section id="gregCal" class="gregorian" aria-label="Gregorian Month (live)"></section>
        <footer id="calLegend" class="legend" aria-label="Legend">
          <span class="key"><i class="k-dot k-evt1" aria-hidden="true"></i> Event</span>
          <span class="key"><i class="k-dot k-evt2" aria-hidden="true"></i> Ceremony</span>
          <span class="key"><i class="k-dot k-doot" aria-hidden="true"></i> DOOT</span>
          <span class="key"><i class="k-dot k-leap" aria-hidden="true"></i> Leap Day</span>
          <span class="key"><i class="k-dot k-today" aria-hidden="true"></i> Today</span>
        </footer>
      </article>
    </section>

    <article class="card" aria-labelledby="map-head">
      <h2 id="map-head">Year Map â€” Gregorian spans of the 13 Moons</h2>
      <p class="hint">New Year = July 26 Â· Day Out of Time = July 25 Â· Leap Day (Feb 29) is skipped in the 13Ã—28 count.</p>
      <div class="scroller" role="region" aria-label="13 Moons Year Map">
        <table class="year-map" id="yearMap">
          <thead><tr><th scope="col">#</th><th scope="col">Moon Name</th><th scope="col">Essence</th><th scope="col">Start (TZ)</th><th scope="col">End (TZ)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meta" id="nextMoonInfo">â€”</p>
    </article>

    <article class="card shine astro" aria-labelledby="astro-head">
      <header class="astro-head">
        <span class="seal" aria-hidden="true">âŸ¡ <span lang="he">×™×”×•×”</span></span>
        <h2 id="astro-head">Astrology Now</h2>
        <p class="meta">Uses <code>window.__EPHEMERIS__</code> if present; otherwise a safe demo.</p>
      </header>

      <section class="astro-grid">
        <div class="astro-chips" id="planetChips" role="list">
          <button class="chip pl-sun" data-planet="sun" type="button"><i class="dot el-fire" aria-hidden="true"></i><b>Sun</b> <span class="mono pos" data-pos="sun">â€”</span> <span class="sign" data-sign="sun">â€”</span></button>
          <button class="chip pl-moon" data-planet="moon" type="button"><i class="dot el-water" aria-hidden="true"></i><b>Moon</b> <span class="mono pos" data-pos="moon">â€”</span> <span class="sign" data-sign="moon">â€”</span></button>
          <button class="chip pl-mercury" data-planet="mercury" type="button"><i class="dot el-air" aria-hidden="true"></i><b>Mercury</b> <span class="mono pos" data-pos="mercury">â€”</span> <span class="sign" data-sign="mercury">â€”</span></button>
          <button class="chip pl-venus" data-planet="venus" type="button"><i class="dot el-earth" aria-hidden="true"></i><b>Venus</b> <span class="mono pos" data-pos="venus">â€”</span> <span class="sign" data-sign="venus">â€”</span></button>
          <button class="chip pl-mars" data-planet="mars" type="button"><i class="dot el-fire" aria-hidden="true"></i><b>Mars</b> <span class="mono pos" data-pos="mars">â€”</span> <span class="sign" data-sign="mars">â€”</span></button>
          <button class="chip pl-jupiter" data-planet="jupiter" type="button"><i class="dot el-air" aria-hidden="true"></i><b>Jupiter</b> <span class="mono pos" data-pos="jupiter">â€”</span> <span class="sign" data-sign="jupiter">â€”</span></button>
          <button class="chip pl-saturn" data-planet="saturn" type="button"><i class="dot el-earth" aria-hidden="true"></i><b>Saturn</b> <span class="mono pos" data-pos="saturn">â€”</span> <span class="sign" data-sign="saturn">â€”</span></button>
          <details class="chip more">
            <summary><i class="dot el-aether" aria-hidden="true"></i><b>Outer bodies</b></summary>
            <div class="more-grid" role="list">
              <div role="listitem"><b>Uranus</b>  <span class="mono pos" data-pos="uranus">â€”</span>  <span class="sign" data-sign="uranus">â€”</span></div>
              <div role="listitem"><b>Neptune</b> <span class="mono pos" data-pos="neptune">â€”</span> <span class="sign" data-sign="neptune">â€”</span></div>
              <div role="listitem"><b>Pluto</b>   <span class="mono pos" data-pos="pluto">â€”</span>   <span class="sign" data-sign="pluto">â€”</span></div>
              <div role="listitem"><b>Chiron</b>  <span class="mono pos" data-pos="chiron">â€”</span>  <span class="sign" data-sign="chiron">â€”</span></div>
              <div role="listitem"><b>Node â˜Š</b>  <span class="mono pos" data-pos="north_node">â€”</span> <span class="sign" data-sign="north_node">â€”</span></div>
            </div>
          </details>
        </div>

        <figure class="astro-wheel">
          <svg id="astroWheel" viewBox="0 0 360 360" role="img" aria-label="Zodiac wheel">
            <defs><linearGradient id="awGrad" x1="0" y="0" x2="1" y2="1"><stop offset="0" /><stop offset="1" /></linearGradient></defs>
            <circle cx="180" cy="180" r="162" fill="none" stroke="#1b2231" stroke-width="2"/>
            <circle cx="180" cy="180" r="150" fill="none" stroke="url(#awGrad)" stroke-opacity=".45" stroke-width="2"/>
            <g id="houseLines" stroke="#2a3242" stroke-width=".8" opacity=".9"></g>
            <g id="signLabels" fill="#a7b1ca" font-family="Inter,system-ui" font-size="10" text-anchor="middle"></g>
            <g id="planetDots" aria-hidden="true">
              <circle r="4.6" class="dot el-fire"   data-dot="sun"    cx="180" cy="30"/>
              <circle r="4.6" class="dot el-water"  data-dot="moon"   cx="180" cy="330"/>
              <circle r="4.6" class="dot el-air"    data-dot="mercury" cx="30"  cy="180"/>
              <circle r="4.6" class="dot el-earth"  data-dot="venus"   cx="330" cy="180"/>
              <circle r="4.6" class="dot el-fire"   data-dot="mars"    cx="60"  cy="60"/>
              <circle r="4.6" class="dot el-air"    data-dot="jupiter" cx="300" cy="300"/>
              <circle r="4.6" class="dot el-earth"  data-dot="saturn"  cx="60"  cy="300"/>
            </g>
          </svg>
          <figcaption class="meta"><span id="astroStamp">â€”</span><span class="sep">Â·</span><span id="astroTZ">â€”</span><span class="sep">Â·</span>Source: <span id="astroSource">â€”</span></figcaption>
        </figure>
      </section>

      <section class="astro-aspects">
        <h3 class="tight">Aspects</h3>
        <div class="legend" role="list">
          <span role="listitem" class="badge asp conj">â˜Œ Conj</span>
          <span role="listitem" class="badge asp sext">âœ¶ Sext</span>
          <span role="listitem" class="badge asp sqr">â–¡ Sq</span>
          <span role="listitem" class="badge asp tri">â–³ Tri</span>
          <span role="listitem" class="badge asp opp">â˜ Opp</span>
        </div>
        <div class="scroller" role="region" aria-label="Aspect Table">
          <table class="asp-table">
            <thead><tr><th scope="col">Pair</th><th scope="col">Aspect</th><th scope="col">Orb</th></tr></thead>
            <tbody id="aspBody"></tbody>
          </table>
        </div>
      </section>
    </article>

    <section class="row-2" id="practiceCodexRow" aria-label="Practice & Codex">
      <article class="card" id="practiceCard">
        <h2 id="prac-head">Practices & Prompts</h2>
        <ol id="practiceList" class="prompts" role="list"></ol>
        <label class="meta" for="noteText" style="display:block;margin-top:10px">Your note for this moon</label>
        <textarea id="noteText" placeholder="What are you tracking, learning, releasing?" aria-label="Note for this moon"></textarea>
        <div class="btnrow"><button class="lab-btn" id="btnSaveNote" type="button">Save note</button></div>
      </article>

      <section class="codex card shine" id="loreCodex" aria-label="Moon Codex">
        <aside class="codex-toc" aria-label="Codex contents">
          <h4>Codex</h4>
          <ol>
            <li><a href="#cx-intro">Introduction</a></li>
            <li><a href="#cx-practice">Practices</a></li>
            <li><a href="#cx-notes">Notes & Footnotes</a></li>
          </ol>
        </aside>

        <article class="codex-content">
          <h1 id="cx-intro">The Remnant Moon Codex</h1>
          <p class="lede dropcap">A living scroll of patterns, pulses, and presence â€” meant to be read like a sky.</p>
          <div class="callout info"><div class="head">Essence</div><div class="body">Channel inspiration. Harmonize integrity. Perfect manifestation.</div></div>
          <blockquote class="pull">â€œNumber the days; crown the weeks; keep the remnant bright.â€</blockquote>
          <figure>
            <img src="assets/media/codex-example.jpg" alt="Codex plate showing harmonics of the 13Ã—28 count" loading="lazy" decoding="async" fetchpriority="low">
            <figcaption>Plate VII â€” Harmonics of the 13Ã—28 count.</figcaption>
          </figure>
          <h2 id="cx-practice">Practice</h2>
          <p>Mark the dayâ€™s tone in your journal. Tap <span class="kbd">T</span> for â€œtodayâ€; use <span class="kbd">â†‘/â†“</span> to step days.</p>
          <h3 id="cx-notes">Notes & Footnotes</h3>
          <hr>
          <ol class="footnotes">
            <li id="fn1">On leap days and DOOT handling â€” see script options. <a href="#fnref1">â†©</a></li>
          </ol>
        </article>
      </section>
    </section>
  </main>

  <footer class="footer">
    <div class="divider" aria-hidden="true"></div>
    <p class="meta">Â© <span id="yr">2025</span> Aaron Paul Laird â€” Scroll of Fire â€¢ BY-NC 4.0</p>
  </footer>

  <noscript><p class="meta" style="text-align:center">This page needs JavaScript to calculate moon/day, phase, astrology, and year map.</p></noscript>

  <!-- TZ helper -->
  <script>
  window.MoonTZ=(function(){"use strict";const KEY="sof_moons_tz";
    function setTZ(z){try{new Intl.DateTimeFormat("en-US",{timeZone:z}).format(new Date());localStorage.setItem(KEY,z);}catch{}}
    function getTZ(){return localStorage.getItem(KEY)||(new URLSearchParams(location.search).get("tz"))||(Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC");}
    function wallParts(d,tz){try{const p=new Intl.DateTimeFormat("en-CA",{timeZone:tz,hour12:false,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).formatToParts(d).reduce((m,x)=>(m[x.type]=x.value,m),{});return new Date(Date.UTC(+p.year,+p.month-1,+p.day,+p.hour,+p.minute,+p.second));}catch{return new Date(d);}}
    function nowWall(){return wallParts(new Date(),getTZ());}
    function isoDateWall(d){const w=wallParts(d||new Date(),getTZ());const y=w.getUTCFullYear(),m=String(w.getUTCMonth()+1).padStart(2,"0"),da=String(w.getUTCDate()).padStart(2,"0");return`${y}-${m}-${da}`;}
    (function seed(){const z=new URLSearchParams(location.search).get("tz");if(z) setTZ(z);})();
    return {getTZ,setTZ,wallParts,nowWall,isoDateWall};
  })();
  </script>

  <!-- REMNANT ENGINE -->
  <script>
(function(){
  "use strict";
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* ---------- Tiny error toast ---------- */
  window.onerror=function(msg,src,line,col){try{const box=document.createElement('div');box.style.cssText='position:fixed;left:8px;bottom:8px;max-width:92vw;background:#23121c;color:#ffd6e7;border:1px solid #80334f;border-radius:10px;padding:10px 12px;font:12px/1.4 system-ui,Inter;z-index:99999';box.innerHTML=`<b>Script error:</b> ${String(msg)}<br><small>${src||''}:${line||0}:${col||0}</small>`;document.body.appendChild(box);setTimeout(()=>box.remove(),10000);}catch{}};

  /* ---------- Names & Essences ---------- */
  const MOON_NAMES=["Magnetic","Lunar","Electric","Self-Existing","Overtone","Rhythmic","Resonant","Galactic","Solar","Planetary","Spectral","Crystal","Cosmic"];
  const MOON_ESSENCE=[
    "Unify Â· Purpose","Polarize Â· Challenge","Activate Â· Service","Define Â· Form",
    "Empower Â· Radiance","Organize Â· Equality","Channel Â· Attunement","Harmonize Â· Integrity",
    "Pulse Â· Intention","Perfect Â· Manifestation","Dissolve Â· Liberation","Dedicate Â· Cooperation","Endure Â· Presence"
  ];

  /* ---------- State & DOM ---------- */
  const state={ tz: MoonTZ.getTZ(), date: MoonTZ.nowWall(), hour:null, seed: 0 };
  const els={
    nowDate:$("#nowDate"), nowClock:$("#nowClock"), nowTZ:$("#nowTZ"), moonLine:$("#moonLine"),
    dayInMoon:$("#dayInMoon"), moonName:$("#moonName"), moonEssence:$("#moonEssence"),
    yearSpan:$("#yearSpan"), weekDots:$("#weekDots"), dootWarn:$("#dootWarn"),
    remCal:$("#remCal"), gregCal:$("#gregCal"), yearMap:$("#yearMap tbody"), nextMoonInfo:$("#nextMoonInfo"),
    tzPick:$("#tzPick"), datePick:$("#datePick"), hourScrub:$("#hourScrub"), jumpMoon:$("#jumpMoon"),
    btnToday:$("#btnToday"), prevDay:$("#prevDay"), nextDay:$("#nextDay"), shareLink:$("#shareLink"),
    simMoon:$("#simMoon"), phaseLine:$("#phaseLine"), phaseMeta:$("#phaseMeta"),
    numLine:$("#numLine"), numMeta:$("#numMeta"), energyQuote:$("#energyQuote"),
    dlICS:$("#dlICS"), regenICS:$("#regenICS"),
    kinOn:$("#kinOn"), kinEpoch:$("#kinEpoch"), kinSkipLeap:$("#kinSkipLeap"), kinSkipDOOT:$("#kinSkipDOOT"),
    kinBadge:$("#kinBadge"), kinLine:$("#kinLine"),
    vHeb:$("#vHeb"), vEn:$("#vEn"), vRef:$("#vRef")
  };

  /* ---------- Utils ---------- */
  const pad=n=>String(n).padStart(2,"0");
  const ymd=d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  function atWall(y,m,d,h=0,mi=0,s=0){ return MoonTZ.wallParts(new Date(Date.UTC(y,m-1,d,h,mi,s)), state.tz); }
  const isLeap=y=>(y%4===0 && (y%100!==0 || y%400===0));
  const addDaysUTC=(d,days)=>{const nd=new Date(d.getTime()); nd.setUTCDate(nd.getUTCDate()+days); return nd};
  const diffDaysUTC=(a,b)=>Math.floor((a.getTime()-b.getTime())/86400000);
  const setText=(el,txt)=>{if(el) el.textContent=txt};

  /* ---------- Remnant Year ---------- */
  function remYearStart(dw){const y=dw.getUTCFullYear(); const s=atWall(y,7,26); return (dw<s)?atWall(y-1,7,26):s;}
  function isDOOT(dw){const y=dw.getUTCFullYear(); return ymd(dw)===ymd(atWall(y,7,25));}
  function countSinceStart(dw){
    const start=remYearStart(dw); let days=diffDaysUTC(dw,start);
    const yS=start.getUTCFullYear(), yE=dw.getUTCFullYear();
    for(let y=yS; y<=yE; y++){ if(isLeap(y)){ const feb29=atWall(y,2,29); if(feb29>=start && feb29<=dw) days-=1; } }
    return days;
  }
  function remnantPosition(dw){
    if(isDOOT(dw)) return {doot:true};
    const since=countSinceStart(dw); const clamped=clamp(since,0,363);
    const moon=Math.floor(clamped/28)+1; const day=(clamped%28)+1; const week=Math.floor((day-1)/7)+1;
    return {doot:false, moon, day, week};
  }
  function remYearSpanFor(dw){const start=remYearStart(dw); const end=addDaysUTC(start,365+(isLeap(start.getUTCFullYear())?1:0)); const y1=start.getUTCFullYear(), y2=end.getUTCFullYear(); return {start,end,label:(y1===y2?`${y1}-${y2}`:`${y1}/${y2}`)};}
  function wallDateForRemDay(yearStart, idx0){ let d=addDaysUTC(yearStart, idx0); const fy=yearStart.getUTCFullYear(); if(isLeap(fy)){ const feb29=atWall(fy,2,29); if(d>=feb29) d=addDaysUTC(d,1);} return d;}

  /* ---------- Calendars ---------- */
  function buildGregCal(dw){
    const y=dw.getUTCFullYear(), m=dw.getUTCMonth();
    const first=atWall(y,m+1,1); const firstDow=first.getUTCDay();
    const daysIn=new Date(Date.UTC(y,m+1,0)).getUTCDate();
    const todayYMD=ymd(MoonTZ.nowWall()); const monthName=first.toLocaleString('en',{month:'long'});
    let html=`<div class="g-head"><div class="g-month">${monthName} ${y}</div></div><ol class="g-grid" role="grid" aria-label="Gregorian Month">`;
    for(const l of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']) html+=`<li class="g-lbl" role="columnheader">${l}</li>`;
    for(let i=0;i<firstDow;i++) html+='<li class="g-pad" aria-hidden="true"></li>';
    for(let d=1; d<=daysIn; d++){
      const dWall=atWall(y,m+1,d); const isToday=ymd(dWall)===todayYMD;
      html+=`<li class="g-day ${isToday?'is-today':''}" role="gridcell"><button type="button" data-g="${y}-${pad(m+1)}-${pad(d)}">${d}</button></li>`;
    }
    html+='</ol>'; els.gregCal.innerHTML=html;
    els.gregCal.addEventListener('click',e=>{const b=e.target.closest('button[data-g]'); if(!b) return; const [yy,mm,dd]=b.dataset.g.split('-').map(Number); state.date=atWall(yy,mm,dd,state.hour??state.date.getUTCHours(),state.date.getUTCMinutes()); hydrateAll();},{once:true});
  }
  function buildRemCal(dw){
    const pos=remnantPosition(dw); const yStart=remYearStart(dw);
    const hdr = pos.doot ? 'Remnant Month â€” DOOT' : `Remnant Month â€” ${MOON_NAMES[pos.moon-1]} (${pos.moon}/13)`;
    setText($("#remHdr"), hdr);
    let html='<ol class="r-grid" role="grid" aria-label="Remnant 13Ã—28 Month">';
    for(const l of ['D1','D2','D3','D4','D5','D6','D7']) html+=`<li class="r-lbl" role="columnheader">${l}</li>`;
    if(pos.doot){ html+='<li class="r-doot" style="grid-column:1 / -1">Day Out of Time</li>'; }
    else{
      const startIdx0=(pos.moon-1)*28;
      for(let i=0;i<28;i++){
        const idx0=startIdx0+i; const d=wallDateForRemDay(yStart, idx0); const mark=(i+1===pos.day)?'is-today':'';
        html+=`<li class="r-day ${mark}" role="gridcell"><button type="button" data-r="${ymd(d)}">${i+1}</button></li>`;
      }
    }
    html+='</ol>'; els.remCal.innerHTML=html;
    els.remCal.addEventListener('click',e=>{const b=e.target.closest('button[data-r]'); if(!b) return; const [yy,mm,dd]=b.dataset.r.split('-').map(Number); state.date=atWall(yy,mm,dd,state.hour??state.date.getUTCHours(),state.date.getUTCMinutes()); hydrateAll();},{once:true});
  }

  /* ---------- Week dots & ring ---------- */
  function drawWeekDots(pos){
    const wrap=els.weekDots; wrap.innerHTML='';
    for(let w=1; w<=4; w++){
      const group=document.createElement('div'); group.className='wdots';
      for(let d=1; d<=7; d++){ const i=(w-1)*7+d; const dot=document.createElement('i'); dot.className='wdot'; if(!pos.doot && i===pos.day) dot.classList.add('is-today'); group.appendChild(dot); }
      wrap.appendChild(group);
    }
  }
  function drawRing(day){
    const arc=$("#moonArc"); if(!arc) return;
    const total=316; const frac=clamp((day-1)/28,0,1); const len=Math.max(1, Math.floor(total*frac));
    arc.style.strokeDasharray = `${len} ${total-len}`;
  }

  /* ---------- Lunar Phase ---------- */
  function lunarPhase(dw){
    const syn=29.530588, ref=Date.UTC(2000,0,6,18,14,0);
    const days=(dw.getTime()-ref)/86400000; const phase=((days % syn)+syn)%syn; const pct=phase/syn;
    const names=['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous','Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];
    const idx=Math.floor(((pct*8)+0.5))%8; return {phaseDays:phase, pct, name:names[idx]};
  }
  function drawMoonCanvas(c,p){
    const ctx=c.getContext('2d'); const w=c.width, h=c.height, r=Math.min(w,h)/2 - 10;
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,w,h); ctx.translate(w/2,h/2);
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle="#0a0f18"; ctx.fill();
    const k=Math.cos(p.pct*2*Math.PI);
    ctx.save(); ctx.beginPath(); ctx.ellipse(0,0,r, Math.abs(k)*r, 0, 0, Math.PI*2); ctx.fillStyle="#b7d7ff"; ctx.globalAlpha=0.9; ctx.fill(); ctx.restore();
    ctx.setTransform(1,0,0,1,0,0);
  }

  /* ---------- Numerology ---------- */
  function numerologyFor(dw,pos){
    const iso=MoonTZ.isoDateWall(dw); const digits=iso.replace(/-/g,'').split('').map(n=>+n);
    const sum=digits.reduce((a,b)=>a+b,0); const reduce=n=>{ if([11,22].includes(n)) return n; while(n>9) n=String(n).split('').reduce((a,b)=>a+ +b,0); return n; };
    const path=reduce(sum); const tone = pos.doot?0: ((pos.moon-1)%13 + 1);
    const quote=[
      "Magnetic: unify the will.","Lunar: face the gate.","Electric: serve the flame.","Self-Existing: give the form.",
      "Overtone: radiate the crown.","Rhythmic: balance the field.","Resonant: attune the heart.","Galactic: harmonize the law.",
      "Solar: pulse intention.","Planetary: perfect the work.","Spectral: release the bind.","Crystal: dedicate the circle.","Cosmic: endure the vow."
    ];
    return {iso, path, tone, quote: tone?quote[tone-1]:"Day Out of Time: rest and reset."}
  }

  /* ---------- Daily Verses (Hebrew roots) ---------- */
  const VERSES = {
    common: [
      {heb:"×©×Ö°×Ö·×¢ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×™×”×•×” ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×™×”×•×” ×Ö¶×—Ö¸×“×ƒ", en:"Hear, O Israel: YHWH our Elohim, YHWH is One.", ref:"Deut 6:4"},
      {heb:"××•Ö¹×¨ ×–Ö¸×¨Ö»×¢Ö· ×œÖ·×¦Ö¼Ö·×“Ö¼Ö´×™×§", en:"Light is sown for the righteous.", ref:"Ps 97:11"},
      {heb:"×—Ö´×–Ö°×§×•Ö¼ ×•Ö°×™Ö·×Ö²×Öµ×¥ ×œÖ°×‘Ö·×‘Ö°×›Ö¶×", en:"Be strong, let your heart be firm.", ref:"Ps 31:24"}
    ],
    1:[{heb:"×§Ö·×‘Ö¼Öµ×¥ ×œÖ¸× ×•Ö¼ ×œÖµ×‘ ×Ö¶×—Ö¸×“", en:"Gather us into one heart.", ref:"Jer 32:39"}],
    2:[{heb:"×©×Ö°× Ö·×™Ö´× ×™Ö¸×§Ö»××•Ö¼", en:"Two will arise to stand the test.", ref:"Eccl 4:12"}],
    3:[{heb:"×•Ö°×¢Ö¹×©×‚Öµ×” ×—Ö¶×¡Ö¶×“", en:"Do mercy â€” energize service.", ref:"Mic 6:8"}],
    4:[{heb:"×ªÖ¼Öµ×Ÿ ×Ö´×©×Ö°×¤Ö¼Ö¸×˜ ×œÖ·×Ö¼Ö¶×œÖ¶×šÖ°", en:"Give right-judgment its form.", ref:"Ps 72:1"}],
    5:[{heb:"×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×›Ö¼Ö°×‘×•Ö¹×“ ×™×”×•×”", en:"Blessed be the radiance of YHWH.", ref:"Ezek 3:12"}],
    6:[{heb:"×•Ö°×›Ö¸×œÖ¾×“Ö¼Ö°×¨Ö¸×›Ö¸×™×• ×Ö´×©×Ö°×¤Ö¼Ö¸×˜", en:"All His ways are balanced justice.", ref:"Deut 32:4"}],
    7:[{heb:"×§×•Ö¹×œ ×“Ö¼Ö°×Ö¸×Ö¸×” ×“Ö·×§Ö¼Ö¸×”", en:"The thin sound of quietâ€”attune.", ref:"1 Kings 19:12"}],
    8:[{heb:"×¦Ö¶×“Ö¶×§ ×¦Ö¶×“Ö¶×§ ×ªÖ¼Ö´×¨Ö°×“Ö¼Ö¹×£", en:"Justice, justice you shall pursueâ€”harmonize.", ref:"Deut 16:20"}],
    9:[{heb:"× Öµ×¨ ×™×”×•×” × Ö´×©×Ö°×Ö·×ª ×Ö¸×“Ö¸×", en:"The lamp of YHWH is humanityâ€™s breathâ€”ignite.", ref:"Prov 20:27"}],
    10:[{heb:"×©×Ö¸×œ×•Ö¹× ×¨Ö¸×‘ ×œÖ°×Ö¹×”Ö²×‘Öµ×™ ×ª×•Ö¹×¨Ö¸×ªÖ¶×šÖ¸", en:"Great shalom to those who craft Your law.", ref:"Ps 119:165"}],
    11:[{heb:"×©×Ö·×œÖ¼Ö·×— ×œÖ·×—Ö°×Ö°×šÖ¸ ×¢Ö·×œÖ¾×¤Ö¼Ö°× Öµ×™ ×”Ö·×Ö¼Ö¸×™Ö´×", en:"Cast offâ€”send your bread upon the waters.", ref:"Eccl 11:1"}],
    12:[{heb:"×¢Öµ×“Ö¸×” ×§Ö°×“×•Ö¹×©×Ö¸×”", en:"Dedicate: a holy assembly.", ref:"Ps 149:1"}],
    13:[{heb:"×¢×•Ö¹×œÖ¸× ×•Ö¸×¢Ö¶×“", en:"Endure unto the ages.", ref:"Ex 15:18"}],
    doot:[{heb:"×”Ö·×©×Ö°×§Öµ×˜ ×•Ö¼×‘Ö°×˜Ö·×—", en:"Be still and reset.", ref:"Isa 30:15"}]
  };
  function setVerse(pos, day){
    const pool = pos.doot ? VERSES.doot : (VERSES[pos.moon]||[]); const all = [...VERSES.common, ...pool];
    const pick = all[(day-1) % all.length] || all[0];
    setText(els.vHeb, pick.heb); setText(els.vEn, pick.en); setText(els.vRef, pick.ref);
  }

  /* ---------- Kin (optional) ---------- */
  function kinFor(dw,opts){
    let [Y,M,D]=opts.epoch?.split('-').map(Number) || [2000,1,1];
    const start=new Date(Date.UTC(Y,M-1,D));
    let d=diffDaysUTC(dw,start);
    if(opts.skipLeap){ for(let y=start.getUTCFullYear(); y<=dw.getUTCFullYear(); y++){ if(isLeap(y)){ const feb29=Date.UTC(y,1,29); if(dw.getTime()>=feb29) d-=1; } } }
    if(opts.skipDOOT){ for(let y=start.getUTCFullYear(); y<=dw.getUTCFullYear(); y++){ const doot=Date.UTC(y,6,25); if(dw.getTime()>=doot) d-=1; } }
    return ((d%260)+260)%260 + 1;
  }

  /* ---------- Year Map & ICS ---------- */
  function buildYearMap(dw){
    const start=remYearStart(dw); const rows=[];
    for(let i=0;i<13;i++){ const s=wallDateForRemDay(start, i*28); const e=addDaysUTC(s,27); rows.push({i:i+1,s,e,name:MOON_NAMES[i],ess:MOON_ESSENCE[i]}); }
    els.yearMap.innerHTML=rows.map(r=>{
      const fmt=d=>new Intl.DateTimeFormat('en-US',{timeZone:state.tz,year:'numeric',month:'short',day:'2-digit'}).format(d);
      return `<tr><td>${r.i}</td><td>${r.name}</td><td>${r.ess}</td><td>${fmt(r.s)}</td><td>${fmt(r.e)}</td></tr>`;
    }).join('');
    const pos=remnantPosition(dw);
    if(!pos.doot){ const start2=(pos.moon===13)?addDaysUTC(wallDateForRemDay(start,12*28),28):wallDateForRemDay(start,pos.moon*28);
      const fmt=d=>new Intl.DateTimeFormat('en-US',{timeZone:state.tz,month:'short',day:'2-digit'}).format(d);
      setText(els.nextMoonInfo, `Next: ${MOON_NAMES[pos.moon%13]} begins ${fmt(start2)} (${state.tz})`);
    }else setText(els.nextMoonInfo,"This is the Day Out of Time â€” the count resumes tomorrow.");
  }
  function buildICS(dw){
    const start=remYearStart(dw);
    let ics="BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Scroll of Fire//13-Moon//EN\r\n";
    const stamp=()=>{const d=new Date();return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+"Z";}
    const dt=d=> d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T000000Z";
    for(let i=0;i<13;i++){ const s=wallDateForRemDay(start,i*28); const e=addDaysUTC(s,28);
      ics+=`BEGIN:VEVENT\r\nUID:moon-${i+1}-${start.getUTCFullYear()}@sof\r\nDTSTAMP:${stamp()}\r\nDTSTART:${dt(s)}\r\nDTEND:${dt(e)}\r\nSUMMARY:${MOON_NAMES[i]} Moon\r\nDESCRIPTION:${MOON_ESSENCE[i]}\r\nEND:VEVENT\r\n`; }
    ics+="END:VCALENDAR\r\n"; const blob=new Blob([ics],{type:"text/calendar"}); const a=document.createElement('a'); a.id="dlICS"; a.download="13-moon-year.ics"; a.href=URL.createObjectURL(blob);
    const exists=$("#dlICS"); if(exists) exists.replaceWith(a); else $("#kin-head")?.after(a);
  }

  /* ---------- Themes & Day Variants ---------- */
  function setMoonTheme(pos){
    const b=document.body;
    b.classList.remove('theme-doot'); for(let i=1;i<=13;i++) b.classList.remove(`theme-moon-${i}`);
    if(pos.doot) b.classList.add('theme-doot'); else b.classList.add(`theme-moon-${pos.moon}`);
    const twist = (pos.doot?0: (pos.day*2.3 + pos.moon*3.7)) % 18; // subtle hue
    document.documentElement.style.setProperty('--twist', twist.toFixed(2)+'deg');
    document.documentElement.style.setProperty('--spark', (0.28 + (pos.day%7)*0.012).toFixed(3));
  }

  /* ---------- Hydration ---------- */
  function hydrateHeader(dw,pos){
    const fmtDate=new Intl.DateTimeFormat('en-US',{timeZone:state.tz, weekday:'short', year:'numeric', month:'short', day:'2-digit'}).format(dw);
    setText(els.nowDate, fmtDate); setText(els.nowTZ, state.tz);
    const reduce=matchMedia('(prefers-reduced-motion: reduce)').matches;
    const tick=()=>{ const w=MoonTZ.wallParts(new Date(),state.tz); setText(els.nowClock, w.toTimeString().slice(0,8)); if(!reduce) requestAnimationFrame(tick); }; tick();
    const yspan=remYearSpanFor(dw); setText(els.yearSpan, yspan.label);
    if(pos.doot){ els.dootWarn.hidden=false; setText(els.moonName,"Day Out of Time"); setText(els.moonEssence,"Pause Â· Reset"); setText(els.moonLine,"DOOT â€” outside the 13Ã—28 cadence"); setText(els.dayInMoon,"â€”"); drawRing(1); }
    else{ els.dootWarn.hidden=true; setText(els.moonName,MOON_NAMES[pos.moon-1]); setText(els.moonEssence,MOON_ESSENCE[pos.moon-1]); setText(els.moonLine,`Moon ${pos.moon} Â· Day ${pos.day} Â· Week ${pos.week}`); setText(els.dayInMoon,String(pos.day)); drawRing(pos.day); }
    drawWeekDots(pos);
  }
  function hydrateLunar(dw){ const ph=lunarPhase(dw); drawMoonCanvas(els.simMoon,ph); setText(els.phaseLine,`${ph.name}`); setText(els.phaseMeta,`Phase: ${(ph.pct*100).toFixed(1)}% Â· Day ${ph.phaseDays.toFixed(1)} of cycle`); }
  function hydrateNumerology(dw,pos){ const n=numerologyFor(dw,pos); setText(els.numLine,`Path ${n.path} Â· Tone ${n.tone||'â€”'}`); setText(els.numMeta,`${n.iso} Â· ${pos.doot?'DOOT':'Moon '+pos.moon}`); setText(els.energyQuote,n.quote); }
  function hydrateCalendars(dw){ buildRemCal(dw); buildGregCal(dw); buildYearMap(dw); buildICS(dw); }
  function hydrateAll(){
    state.date=MoonTZ.wallParts(state.date,state.tz);
    const pos=remnantPosition(state.date);
    setMoonTheme(pos);
    hydrateHeader(state.date,pos);
    hydrateLunar(state.date);
    hydrateNumerology(state.date,pos);
    setVerse(pos, pos.doot?1:pos.day);
    hydrateCalendars(state.date);
    hydrateControls(state.date,pos);
    hydrateKin(state.date);
  }

  function hydrateControls(dw,pos){
    els.datePick.value = MoonTZ.isoDateWall(dw);
    const wall=MoonTZ.wallParts(dw,state.tz);
    els.hourScrub.value = wall.getUTCHours();
    els.jumpMoon.value = pos.doot? "" : String(pos.moon);
  }
  function hydrateKin(dw){ if(!els.kinOn || !els.kinOn.checked){ setText(els.kinBadge,'Kin â€”'); setText(els.kinLine,'â€”'); return; }
    const kin=kinFor(dw,{epoch:els.kinEpoch.value,skipLeap:els.kinSkipLeap?.checked,skipDOOT:els.kinSkipDOOT?.checked}); setText(els.kinBadge,`Kin ${kin}`); setText(els.kinLine,`Counted from ${els.kinEpoch.value}.`); }

  /* ---------- Events ---------- */
  function bindEvents(){
    els.tzPick.addEventListener('change',()=>{ state.tz=els.tzPick.value; MoonTZ.setTZ(state.tz); state.date=MoonTZ.wallParts(state.date,state.tz); hydrateAll(); });
    els.datePick.addEventListener('change',()=>{ const [y,m,da]=els.datePick.value.split('-').map(Number); state.date=atWall(y,m,da,state.date.getUTCHours(),state.date.getUTCMinutes()); hydrateAll(); });
    els.hourScrub.addEventListener('input',()=>{ state.hour=+els.hourScrub.value; state.date=atWall(state.date.getUTCFullYear(),state.date.getUTCMonth()+1,state.date.getUTCDate(),state.hour,state.date.getUTCMinutes()); hydrateAll(); });
    els.btnToday.addEventListener('click',()=>{ state.date=MoonTZ.nowWall(); state.hour=null; hydrateAll(); });
    els.prevDay.addEventListener('click',()=>{ state.date=addDaysUTC(state.date,-1); hydrateAll(); });
    els.nextDay.addEventListener('click',()=>{ state.date=addDaysUTC(state.date, 1); hydrateAll(); });
    els.shareLink.addEventListener('click',async ()=>{ const url=new URL(location.href); url.searchParams.set('tz',state.tz); url.searchParams.set('date', MoonTZ.isoDateWall(state.date)); try{ await navigator.clipboard.writeText(url.toString()); els.shareLink.textContent="Copied!"; setTimeout(()=>els.shareLink.textContent="Copy Link",1200);}catch{} });
    els.jumpMoon.addEventListener('change',()=>{ const m=+els.jumpMoon.value||null; if(!m) return; const start=remYearStart(state.date); state.date=MoonTZ.wallParts(wallDateForRemDay(start,(m-1)*28),state.tz); hydrateAll(); });
    addEventListener('keydown',e=>{
      if(e.key==='T'||e.key==='t'){ e.preventDefault(); state.date=MoonTZ.nowWall(); state.hour=null; hydrateAll(); }
      if(e.key==='ArrowUp'){ e.preventDefault(); state.date=addDaysUTC(state.date,1); hydrateAll(); }
      if(e.key==='ArrowDown'){ e.preventDefault(); state.date=addDaysUTC(state.date,-1); hydrateAll(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); state.date=atWall(state.date.getUTCFullYear(),state.date.getUTCMonth()+1,state.date.getUTCDate(),Math.max(0,state.date.getUTCHours()-1),state.date.getUTCMinutes()); hydrateAll(); }
      if(e.key==='ArrowRight'){ e.preventDefault(); state.date=atWall(state.date.getUTCFullYear(),state.date.getUTCMonth()+1,state.date.getUTCDate(),Math.min(23,state.date.getUTCHours()+1),state.date.getUTCMinutes()); hydrateAll(); }
    });
    const kinToggles=[els.kinOn,els.kinEpoch,els.kinSkipLeap,els.kinSkipDOOT].filter(Boolean);
    kinToggles.forEach(el=>["input","change"].forEach(ev=>el.addEventListener(ev,()=>hydrateKin(state.date))));
  }

  /* ---------- Cosmic background (stars + aurora) ---------- */
  (function sky(){
    const c=$("#skyBg"); if(!c) return; const ctx=c.getContext("2d",{alpha:true});
    function size(){ c.width=innerWidth; c.height=innerHeight; } size();
    let stars=Array.from({length:160},(_,i)=>({x:Math.random()*c.width,y:Math.random()*c.height,z:0.3+Math.random()*0.7,s:0.6+Math.random()*1.4, p:i%5===0}));
    const reduce = matchMedia("(prefers-reduced-motion: reduce)").matches;
    function frame(t){
      ctx.clearRect(0,0,c.width,c.height);
      const grad=ctx.createRadialGradient(c.width*0.5, -c.height*0.2, 0, c.width*0.5, -c.height*0.2, c.height*0.9);
      grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--moon-accent').trim()+"22");
      grad.addColorStop(1,"transparent");
      ctx.fillStyle=grad; ctx.fillRect(0,0,c.width,c.height);
      for(const st of stars){
        const a=0.2+0.7*Math.abs(Math.sin((t/1000)*st.z*0.8+st.x));
        ctx.globalAlpha=a*parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--spark'));
        ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fillStyle="#7af3ff"; ctx.fill();
        if(st.p){ ctx.globalAlpha*=0.6; ctx.fillRect(st.x+1,st.y,1,1); }
      }
      ctx.globalAlpha=1;
      if(!reduce) requestAnimationFrame(frame);
    }
    frame(0);
    addEventListener("resize",()=>{size(); stars=stars.map(s=>({x:Math.random()*c.width,y:Math.random()*c.height,z:s.z,s:s.s,p:s.p}))});
  })();

  /* ---------- Init ---------- */
  function hydrateTZPicker(){
    const common=["UTC","America/Los_Angeles","America/Denver","America/Chicago","America/New_York","Europe/London","Europe/Paris","Europe/Berlin","Europe/Moscow","Asia/Jerusalem","Asia/Tokyo","Asia/Seoul","Asia/Shanghai","Australia/Sydney","Pacific/Auckland"];
    const local=MoonTZ.getTZ(); const all=[local,...common.filter(z=>z!==local)];
    els.tzPick.innerHTML = all.map(z=>`<option value="${z}">${z}</option>`).join(''); els.tzPick.value = state.tz;
  }
  function init(){
    const yEl=$("#yr"); if(yEl) yEl.textContent=String(new Date().getFullYear());
    (function dateSupport(){ const el=$("#datePick"); if(!el) return; const t=document.createElement('input'); t.type='date'; if(t.type!=='date'){ el.type='text'; el.placeholder='YYYY-MM-DD'; el.setAttribute('inputmode','numeric'); }})();
    const qp=new URLSearchParams(location.search); if(qp.get('date')){ const [y,m,d]=qp.get('date').split('-').map(Number); state.date=atWall(y,m,d,state.date.getUTCHours(),state.date.getUTCMinutes()); }
    hydrateTZPicker(); bindEvents(); hydrateAll();
    const plist=$("#practiceList"); if(plist){ plist.innerHTML=['Light the crown: three breaths, count 4-7-8.','Name the tone; write one vow for the day.','Mark the week: who do you serve today?','Seal the work: a small act of coherence.'].map(p=>`<li>${p}</li>`).join(''); }
    const btn=$("#btnSaveNote"), area=$("#noteText"); if(btn&&area){ btn.addEventListener('click',()=>{ try{ localStorage.setItem('sof_moon_note', area.value||""); btn.textContent="Saved"; setTimeout(()=>btn.textContent="Save note",1200);}catch{} }); const saved=localStorage.getItem('sof_moon_note'); if(saved) area.value=saved; }
  }
  addEventListener('load',init);

  /* ---------- Astrology filler (safe demo if no ephemeris) ---------- */
  (function astro(){
    const tz=MoonTZ.getTZ(); setText($("#astroTZ"), tz);
    const src = (window.__EPHEMERIS__ && typeof window.__EPHEMERIS__==="object") ? "Ephemeris" : "Demo";
    setText($("#astroSource"), src);
    const signs=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
    const stamp=new Intl.DateTimeFormat('en-US',{timeZone:tz, dateStyle:'medium', timeStyle:'short'}).format(new Date());
    setText($("#astroStamp"), stamp);
    ['sun','moon','mercury','venus','mars','jupiter','saturn'].forEach((name,i)=>{
      const d = (window.__EPHEMERIS__?.[name]) || {deg:(i+1)*33%360, sign: signs[(i*7)%12|0]};
      const posEl = $(`[data-pos="${name}"]`); const signEl=$(`[data-sign="${name}"]`);
      if(posEl) posEl.textContent = (d.deg||0).toFixed(1)+'Â°';
      if(signEl) signEl.textContent = d.sign||'â€”';
    });
    const g=$("#signLabels"), h=$("#houseLines"); if(g && h){
      g.innerHTML=''; h.innerHTML='';
      for(let i=0;i<12;i++){
        const a=(i/12)*2*Math.PI, r=160, x=180+Math.cos(a)*r, y=180+Math.sin(a)*r;
        g.insertAdjacentHTML('beforeend', `<text x="${x.toFixed(1)}" y="${y.toFixed(1)}">${signs[i]}</text>`);
        const a2=a+Math.PI/12; const x1=180+Math.cos(a2)*148, y1=180+Math.sin(a2)*148, x2=180+Math.cos(a2)*162, y2=180+Math.sin(a2)*162;
        h.insertAdjacentHTML('beforeend', `<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}"/>`);
      }
    }
    const asp=$("#aspBody"); if(asp){ asp.innerHTML=['Sun â–³ Moon Â· 2.1Â°','Venus â–¡ Mars Â· 1.0Â°','Mercury â˜Œ Jupiter Â· 0.3Â°'].map(x=>`<tr><td>â€”</td><td>${x.split('Â·')[0]}</td><td>${x.split('Â·')[1]}</td></tr>`).join(''); }
  })();
})();
  </script>
</body>
</html>
