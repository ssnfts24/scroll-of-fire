<!doctype html>
<html lang="en" dir="ltr" class="sof carrier-432" data-carriers="432,528,369,144,963" data-alive="lively">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>(()=>{const LIVE="ssnfts24.github.io";if(location.hostname!==LIVE){const b=document.querySelector("base");b&&b.remove();}})();</script>

  <!-- Flashless theme + FB in-app guard -->
  <script>(()=>{try{let t=localStorage.getItem('theme');if(!t){t=(matchMedia&&matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark'}document.documentElement.setAttribute('data-theme',t)}catch{}})();</script>
  <script>(()=>{const ua=navigator.userAgent||'';if(/\bFBAN|FBAV|FB_IAB|FBAN\/Messenger\b/i.test(ua)){document.documentElement.classList.add('is-fbapp')}})();</script>

  <meta charset="utf-8" />
  <title>Remnant 13 Moons ‚Äî Living Clock ¬∑ Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#05070d" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7fbff" media="(prefers-color-scheme: light)">
  <meta name="description" content="Remnant 13-Moon Living Clock ‚Äî TZ-true 13√ó28 mapping with week dots, year map, optional Kin, zodiac fallback, lunar sim, and .ics export." />
  <meta name="format-detection" content="telephone=no">
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/moons.html">

  <!-- OG / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Remnant 13 Moons ‚Äî Living Clock">
  <meta property="og:description" content="Day ring ‚Ä¢ Week dots ‚Ä¢ Year map ‚Ä¢ Lunar sim ‚Ä¢ Kin ‚Ä¢ .ics ‚Äî YHWH seal.">
  <meta property="og:image" content="assets/share/moon-card.png">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/moons.html">
  <meta name="twitter:card" content="summary_large_image">

  <!-- PWA -->
  <link rel="manifest" href="assets/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="13 Moons">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png">
  <link rel="mask-icon" href="assets/icons/safari-pinned.svg" color="#0e131a">

  <!-- Cascade layers -->
  <style>@layer tokens, base, components, astrology, utilities, remnant, legacy;</style>

  <!-- CSS (mobile-first pack) -->
  <link rel="stylesheet" href="assets/css/fonts.css?v=2025-11-02w">
  <link rel="stylesheet" href="assets/css/tokens.css?v=2025-11-02w">
  <link rel="stylesheet" href="assets/css/core.css?v=2025-11-02w">
  <link rel="stylesheet" href="assets/css/astrology.css?v=2025-11-02w">
  <link rel="stylesheet" href="assets/css/moons.css?v=2025-11-02w">
  <link rel="stylesheet" href="assets/css/bridge.css?v=2025-11-02w">

  <!-- Minimal critical helpers to ensure single-column on small screens even if CSS fails to load -->
  <style>
    :root{ --safe-top: env(safe-area-inset-top,0px) }
    .top-safe{ height: calc(var(--safe-top) + 8px) }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px }
    .wrap{ padding-inline: clamp(12px,5vw,20px) }
    .card{ border:1px solid #2a2a33; border-radius:14px; background:#0e0e12; padding:12px }
    .row-2{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width:900px){ .row-2{ grid-template-columns:1fr 1fr } }
    .legend{ display:flex; flex-wrap:wrap; gap:8px }
    .year-map{ width:100%; border-collapse:separate; border-spacing:0 }
    .year-map thead th{ position:sticky; top:0; background:#0e0e12 }
    .weekrow{ display:flex; align-items:center; gap:.6rem; white-space:nowrap; overflow:auto; -webkit-overflow-scrolling:touch }
    :focus-visible{ outline:2px solid #7af3ff; outline-offset:2px }
    /* Wizard of YHWH: subtle consecration line */
    .fancy-head .subtitle::after{content:" ¬∑ consecrated to ◊ô◊î◊ï◊î"; opacity:.6}
  </style>

  <!-- Preloads -->
  <link rel="prefetch" href="genesis-oracle.html" as="document">
</head>

<body class="stars remnant-yhwh">
  <div class="top-safe" aria-hidden="true"></div>
  <canvas id="skyBg" width="1440" height="900" aria-hidden="true" style="position:fixed;inset:0;width:100vw;height:100vh;z-index:0;pointer-events:none"></canvas>

  <main class="wrap" id="main" role="main" style="position:relative;z-index:1">
    <header class="page-head fancy-head">
      <h1 class="title">üåó Remnant 13 Moons <span class="soft">‚Äî Living Clock</span></h1>
      <p class="subtitle">13√ó28 cadence ¬∑ TZ-true ¬∑ sealed <span lang="he" title="YHWH">◊ô◊î◊ï◊î</span>.</p>
      <nav class="crumbs" aria-label="Breadcrumb">
        <a class="lab-btn" href="index.html">‚Üê Codex</a>
        <a class="lab-btn" href="theory.html">üìò Theory</a>
        <a id="openSealHeader" class="lab-btn" href="genesis-oracle.html" title="Open the Remnant Birth Seal">‚ü° Birth Seal</a>
      </nav>

      <section class="card ringcard" aria-label="Current Moon">
        <div class="moon-badge">
          <div class="ring" aria-label="Day in Moon">
            <svg viewBox="0 0 120 120" role="img" aria-label="Progress ring for day within 28-day moon">
              <circle cx="60" cy="60" r="50" class="ring-bg"/>
              <circle cx="60" cy="60" r="50" class="ring-fg" id="moonArc" pathLength="316"/>
            </svg>
            <div class="label" aria-live="polite"><div class="big" id="dayInMoon">‚Äî</div><div class="small">/28</div></div>
          </div>
          <span class="pill" id="moonChip"><span class="k" id="moonName">‚Äî</span><span class="meta" id="moonEssence">‚Äî</span></span>
          <span class="pill mono"><span id="yearSpan">‚Äî</span></span>
        </div>

        <div class="weekrow" role="group" aria-label="Week inside the 28-day moon">
          <span class="weeklabel">Week</span>
          <div class="week" id="weekDots" role="list"></div>
        </div>

        <p class="meta" id="dootWarn" hidden><b>Day Out of Time:</b> outside the 13√ó28 moons.</p>
      </section>
    </header>

    <section class="grid" aria-label="Remnant vs Gregorian">
      <article class="card">
        <header class="panel__head">
          <h3 class="panel__title" id="remHdr">Remnant Month</h3>
          <div class="panel__meta" id="remMeta">13 √ó 28 fixed</div>
        </header>
        <section id="remCal" class="calendar" aria-label="Remnant Month (live)"></section>
      </article>

      <article class="card">
        <header class="panel__head">
          <h3 class="panel__title" id="gregHdr">Gregorian Month</h3>
          <div class="panel__meta" id="gregMeta">Variable weeks</div>
        </header>
        <section id="gregCal" class="gregorian" aria-label="Gregorian Month (live)"></section>
        <footer id="calLegend" class="legend" aria-label="Legend">
          <span class="key"><i class="k-dot k-evt1" aria-hidden="true"></i> Event</span>
          <span class="key"><i class="k-dot k-evt2" aria-hidden="true"></i> Ceremony</span>
          <span class="key"><i class="k-dot k-doot" aria-hidden="true"></i> DOOT</span>
          <span class="key"><i class="k-dot k-leap" aria-hidden="true"></i> Leap Day</span>
          <span class="key"><i class="k-dot k-today" aria-hidden="true"></i> Today</span>
        </footer>
      </article>
    </section>

    <section class="wrap-pad card remnant-frame" id="remnantOpener" aria-label="Open the Remnant Birth Seal">
      <div class="op-grid">
        <div class="op-left" aria-hidden="true">
          <svg class="op-sigil" viewBox="0 0 64 64">
            <defs><linearGradient id="opGrad" x1="0" x2="1"><stop offset="0" stop-color="var(--moon-accent)"/><stop offset="1" stop-color="var(--moon-accent-2)"/></linearGradient></defs>
            <circle cx="32" cy="32" r="26" fill="none" stroke="#1b2231" stroke-width="6"/>
            <circle cx="32" cy="32" r="26" fill="none" stroke="url(#opGrad)" stroke-linecap="round" stroke-width="6" stroke-dasharray="78 163"></circle>
            <text x="32" y="32" text-anchor="middle" dominant-baseline="central" font-family="Inter,system-ui" font-size="16" font-weight="900" fill="currentColor">‚ü°</text>
          </svg>
        </div>
        <div class="op-mid">
          <h3 class="op-title">The Seal of Becoming</h3>
          <p class="op-sub meta">Prefills your <b>Moon ¬∑ Day ¬∑ Week ¬∑ Tone</b> using date/time/tz.</p>
        </div>
        <div class="op-right">
          <a id="openSeal" class="lab-btn big cta-link" href="genesis-oracle.html">Open Birth Seal</a>
        </div>
      </div>
    </section>

    <section class="grid" aria-label="Controls and Simulation">
      <article class="card">
        <h2 id="today-head">Today</h2>
        <div class="chiprow" role="status" aria-live="polite">
          <span class="pill"><b id="nowDate">‚Äî</b></span>
          <span class="pill mono" id="nowClock" role="timer">‚Äî:‚Äî:‚Äî</span>
          <span class="pill" id="nowTZ">‚Äî</span>
          <span class="pill" id="moonLine">‚Äî</span>
        </div>

        <div class="formrow">
          <label>Time Zone
            <select id="tzPick" class="lab-input" aria-label="Time Zone"></select>
          </label>
          <label>Date
            <input type="date" id="datePick" class="lab-input" aria-label="Pick a date" inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}">
          </label>
          <label>Hour
            <input type="range" id="hourScrub" min="0" max="23" value="12" class="lab-input" aria-label="Hour of day">
          </label>
        </div>

        <div class="btnrow">
          <button class="lab-btn" id="btnToday" type="button">Today</button>
          <button class="lab-btn" id="prevDay" type="button">‚Üê Prev</button>
          <button class="lab-btn" id="nextDay" type="button">Next ‚Üí</button>
          <button class="lab-btn ghost" id="shareLink" type="button">Copy Link</button>
          <label class="tag" style="margin-left:auto">Go to:
            <select id="jumpMoon" class="lab-input" aria-label="Jump to Moon">
              <option value="">‚Äî</option>
              <option value="1">#1 Magnetic</option><option value="2">#2 Lunar</option><option value="3">#3 Electric</option>
              <option value="4">#4 Self-Existing</option><option value="5">#5 Overtone</option><option value="6">#6 Rhythmic</option>
              <option value="7">#7 Resonant</option><option value="8">#8 Galactic</option><option value="9">#9 Solar</option>
              <option value="10">#10 Planetary</option><option value="11">#11 Spectral</option><option value="12">#12 Crystal</option>
              <option value="13">#13 Cosmic</option>
            </select>
          </label>
        </div>
        <p class="hint keys">Keys: <span class="kbd">‚Üë/‚Üì</span> day ‚Ä¢ <span class="kbd">‚Üê/‚Üí</span> hour ‚Ä¢ <span class="kbd">T</span> today</p>
      </article>

      <aside class="card" aria-labelledby="lunar-head">
        <h2 id="lunar-head">Lunar Phase</h2>
        <div class="sim">
          <canvas id="simMoon" width="280" height="280" aria-label="Lunar phase"></canvas>
          <div>
            <p class="mono" id="phaseLine">‚Äî</p>
            <p class="meta" id="phaseMeta">‚Äî</p>
            <div class="divider" aria-hidden="true"></div>
            <section id="numerologyBox" aria-live="polite">
              <h3 class="tight">Numerology</h3>
              <p class="mono" id="numLine">‚Äî</p>
              <p class="meta" id="numMeta">‚Äî</p>
              <p class="meta" id="energyQuote" style="margin-top:6px">‚Äî</p>
            </section>
          </div>
        </div>
      </aside>
    </section>

    <article class="card" aria-labelledby="map-head">
      <h2 id="map-head">Year Map ‚Äî Gregorian spans of the 13 Moons</h2>
      <p class="hint">New Year = July 26 ¬∑ Day Out of Time = July 25 ¬∑ Leap Day (Feb 29) is skipped in the 13√ó28 count.</p>
      <div class="scroller" role="region" aria-label="13 Moons Year Map">
        <table class="year-map" id="yearMap">
          <thead><tr><th scope="col">#</th><th scope="col">Moon Name</th><th scope="col">Essence</th><th scope="col">Start (TZ)</th><th scope="col">End (TZ)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="meta" id="nextMoonInfo">‚Äî</p>
    </article>

    <article class="card" aria-labelledby="kin-head">
      <h2 id="kin-head">Kin of Today (optional)</h2>
      <div class="kin">
        <div class="kin-row" role="group" aria-label="Kin Options">
          <label class="tag"><input type="checkbox" id="kinOn" /><span>Show Kin</span></label>
          <label class="tag">Epoch:
            <select id="kinEpoch" class="lab-input">
              <option value="1987-07-26">1987-07-26 (Dreamspell common)</option>
              <option value="1990-01-01">1990-01-01</option>
            </select>
          </label>
          <label class="tag"><input type="checkbox" id="kinSkipLeap" checked /><span>Skip Leap Day</span></label>
          <label class="tag"><input type="checkbox" id="kinSkipDOOT" checked /><span>Skip DOOT</span></label>
        </div>
        <div class="kin-row">
          <span class="tag" id="kinBadge" aria-live="polite">Kin ‚Äî</span>
          <span class="meta" id="kinLine" aria-live="polite">‚Äî</span>
        </div>
        <small class="meta">Toggle options to match external calculators exactly.</small>
      </div>

      <div class="goldline" aria-hidden="true"></div>
      <h3 class="tight">Export this 13-Moon Year</h3>
      <p class="meta">Download an <code>.ics</code> calendar with the 13 Moon spans for the selected time-zone/year.</p>
      <div class="btnrow">
        <a id="dlICS" class="dl" href="#" download="13-moon-year.ics" role="button">‚¨áÔ∏è Download .ics</a>
        <button class="lab-btn ghost" id="regenICS" type="button">Refresh</button>
      </div>
    </article>

    <article class="card shine astro" aria-labelledby="astro-head">
      <header class="astro-head">
        <span class="seal" aria-hidden="true">‚ü° <span lang="he">◊ô◊î◊ï◊î</span></span>
        <h2 id="astro-head">Astrology Now</h2>
        <p class="meta">Filled by <code>window.__EPHEMERIS__</code> when available; otherwise shows a safe demo.</p>
      </header>

      <section class="astro-grid">
        <div class="astro-chips" id="planetChips" role="list">
          <button class="chip pl-sun" data-planet="sun" type="button"><i class="dot el-fire" aria-hidden="true"></i><b>Sun</b> <span class="mono pos" data-pos="sun">‚Äî</span> <span class="sign" data-sign="sun">‚Äî</span></button>
          <button class="chip pl-moon" data-planet="moon" type="button"><i class="dot el-water" aria-hidden="true"></i><b>Moon</b> <span class="mono pos" data-pos="moon">‚Äî</span> <span class="sign" data-sign="moon">‚Äî</span></button>
          <button class="chip pl-mercury" data-planet="mercury" type="button"><i class="dot el-air" aria-hidden="true"></i><b>Mercury</b> <span class="mono pos" data-pos="mercury">‚Äî</span> <span class="sign" data-sign="mercury">‚Äî</span></button>
          <button class="chip pl-venus" data-planet="venus" type="button"><i class="dot el-earth" aria-hidden="true"></i><b>Venus</b> <span class="mono pos" data-pos="venus">‚Äî</span> <span class="sign" data-sign="venus">‚Äî</span></button>
          <button class="chip pl-mars" data-planet="mars" type="button"><i class="dot el-fire" aria-hidden="true"></i><b>Mars</b> <span class="mono pos" data-pos="mars">‚Äî</span> <span class="sign" data-sign="mars">‚Äî</span></button>
          <button class="chip pl-jupiter" data-planet="jupiter" type="button"><i class="dot el-air" aria-hidden="true"></i><b>Jupiter</b> <span class="mono pos" data-pos="jupiter">‚Äî</span> <span class="sign" data-sign="jupiter">‚Äî</span></button>
          <button class="chip pl-saturn" data-planet="saturn" type="button"><i class="dot el-earth" aria-hidden="true"></i><b>Saturn</b> <span class="mono pos" data-pos="saturn">‚Äî</span> <span class="sign" data-sign="saturn">‚Äî</span></button>
          <details class="chip more">
            <summary><i class="dot el-aether" aria-hidden="true"></i><b>Outer bodies</b></summary>
            <div class="more-grid" role="list">
              <div role="listitem"><b>Uranus</b>  <span class="mono pos" data-pos="uranus">‚Äî</span>  <span class="sign" data-sign="uranus">‚Äî</span></div>
              <div role="listitem"><b>Neptune</b> <span class="mono pos" data-pos="neptune">‚Äî</span> <span class="sign" data-sign="neptune">‚Äî</span></div>
              <div role="listitem"><b>Pluto</b>   <span class="mono pos" data-pos="pluto">‚Äî</span>   <span class="sign" data-sign="pluto">‚Äî</span></div>
              <div role="listitem"><b>Chiron</b>  <span class="mono pos" data-pos="chiron">‚Äî</span>  <span class="sign" data-sign="chiron">‚Äî</span></div>
              <div role="listitem"><b>Node ‚òä</b>  <span class="mono pos" data-pos="north_node">‚Äî</span> <span class="sign" data-sign="north_node">‚Äî</span></div>
            </div>
          </details>
        </div>

        <figure class="astro-wheel">
          <svg id="astroWheel" viewBox="0 0 360 360" role="img" aria-label="Zodiac wheel">
            <defs><linearGradient id="awGrad" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="var(--moon-accent)"/><stop offset="1" stop-color="var(--moon-accent-2)"/></linearGradient></defs>
            <circle cx="180" cy="180" r="162" fill="none" stroke="#1b2231" stroke-width="2"/>
            <circle cx="180" cy="180" r="150" fill="none" stroke="url(#awGrad)" stroke-opacity=".45" stroke-width="2"/>
            <g id="houseLines" stroke="#2a3242" stroke-width=".8" opacity=".9"></g>
            <g id="signLabels" fill="#a7b1ca" font-family="Inter,system-ui" font-size="10" text-anchor="middle"></g>
            <g id="planetDots" aria-hidden="true">
              <circle r="4.6" class="dot el-fire"   data-dot="sun"    cx="180" cy="30"/>
              <circle r="4.6" class="dot el-water"  data-dot="moon"   cx="180" cy="330"/>
              <circle r="4.6" class="dot el-air"    data-dot="mercury" cx="30"  cy="180"/>
              <circle r="4.6" class="dot el-earth"  data-dot="venus"   cx="330" cy="180"/>
              <circle r="4.6" class="dot el-fire"   data-dot="mars"    cx="60"  cy="60"/>
              <circle r="4.6" class="dot el-air"    data-dot="jupiter" cx="300" cy="300"/>
              <circle r="4.6" class="dot el-earth"  data-dot="saturn"  cx="60"  cy="300"/>
            </g>
          </svg>
          <figcaption class="meta"><span id="astroStamp">‚Äî</span><span class="sep">¬∑</span><span id="astroTZ">‚Äî</span><span class="sep">¬∑</span>Source: <span id="astroSource">‚Äî</span></figcaption>
        </figure>
      </section>

      <section class="astro-aspects">
        <h3 class="tight">Aspects</h3>
        <div class="legend" role="list">
          <span role="listitem" class="badge asp conj">‚òå Conj</span>
          <span role="listitem" class="badge asp sext">‚ú∂ Sext</span>
          <span role="listitem" class="badge asp sqr">‚ñ° Sq</span>
          <span role="listitem" class="badge asp tri">‚ñ≥ Tri</span>
          <span role="listitem" class="badge asp opp">‚òç Opp</span>
        </div>
        <div class="scroller" role="region" aria-label="Aspect Table">
          <table class="asp-table">
            <thead><tr><th scope="col">Pair</th><th scope="col">Aspect</th><th scope="col">Orb</th></tr></thead>
            <tbody id="aspBody"></tbody>
          </table>
        </div>
      </section>
    </article>

    <section class="row-2" id="practiceCodexRow" aria-label="Practice & Codex">
      <article class="card" id="practiceCard">
        <h2 id="prac-head">Practices & Prompts</h2>
        <ol id="practiceList" class="prompts" role="list"></ol>
        <label class="meta" for="noteText" style="display:block;margin-top:10px">Your note for this moon</label>
        <textarea id="noteText" placeholder="What are you tracking, learning, releasing?" aria-label="Note for this moon"></textarea>
        <div class="btnrow"><button class="lab-btn" id="btnSaveNote" type="button">Save note</button></div>
      </article>

      <section class="codex card shine" id="loreCodex" aria-label="Moon Codex">
        <aside class="codex-toc" aria-label="Codex contents">
          <h4>Codex</h4>
          <ol>
            <li><a href="#cx-intro">Introduction</a></li>
            <li><a href="#cx-practice">Practices</a></li>
            <li><a href="#cx-notes">Notes & Footnotes</a></li>
          </ol>
        </aside>

        <article class="codex-content">
          <h1 id="cx-intro">The Remnant Moon Codex</h1>
          <p class="lede dropcap">A living scroll of patterns, pulses, and presence ‚Äî meant to be read like a sky.</p>
          <div class="callout info"><div class="head">Essence</div><div class="body">Channel inspiration. Harmonize integrity. Perfect manifestation.</div></div>
          <blockquote class="pull">‚ÄúNumber the days; crown the weeks; keep the remnant bright.‚Äù</blockquote>
          <figure>
            <img src="assets/media/codex-example.jpg" alt="Codex plate showing harmonics of the 13√ó28 count" loading="lazy" decoding="async" fetchpriority="low">
            <figcaption>Plate VII ‚Äî Harmonics of the 13√ó28 count.</figcaption>
          </figure>
          <h2 id="cx-practice">Practice</h2>
          <p>Mark the day‚Äôs tone in your journal. Tap <span class="kbd">T</span> for ‚Äútoday‚Äù; use <span class="kbd">‚Üë/‚Üì</span> to step days.</p>
          <h3 id="cx-notes">Notes & Footnotes</h3>
          <hr>
          <ol class="footnotes">
            <li id="fn1">On leap days and DOOT handling ‚Äî see script options. <a href="#fnref1">‚Ü©</a></li>
          </ol>
        </article>
      </section>
    </section>
  </main>

  <footer class="footer">
    <div class="divider" aria-hidden="true"></div>
    <p class="meta">¬© <span id="yr">2025</span> Aaron Paul Laird ‚Äî Scroll of Fire ‚Ä¢ BY-NC 4.0</p>
  </footer>

  <noscript><p class="meta" style="text-align:center">This page needs JavaScript to calculate moon/day, phase, and year map.</p></noscript>

  <!-- TZ helper -->
  <script>
  window.MoonTZ=(function(){"use strict";const KEY="sof_moons_tz";
    function setTZ(z){try{new Intl.DateTimeFormat("en-US",{timeZone:z}).format(new Date());localStorage.setItem(KEY,z);}catch{}}
    function getTZ(){return localStorage.getItem(KEY)||(new URLSearchParams(location.search).get("tz"))||(Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC");}
    function wallParts(d,tz){try{const p=new Intl.DateTimeFormat("en-CA",{timeZone:tz,hour12:false,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).formatToParts(d).reduce((m,x)=>(m[x.type]=x.value,m),{});return new Date(Date.UTC(+p.year,+p.month-1,+p.day,+p.hour,+p.minute,+p.second));}catch{return new Date(d);}}
    function nowWall(){return wallParts(new Date(),getTZ());}
    function isoDateWall(d){const w=wallParts(d||new Date(),getTZ());const y=w.getUTCFullYear(),m=String(w.getUTCMonth()+1).padStart(2,"0"),da=String(w.getUTCDate()).padStart(2,"0");return`${y}-${m}-${da}`;}
    (function seed(){const z=new URLSearchParams(location.search).get("tz");if(z) setTZ(z);})();
    return {getTZ,setTZ,wallParts,nowWall,isoDateWall};
  })();
  </script>

  <!-- SELF-CONTAINED REMNANT ENGINE -->
  <script>
(function(){
  "use strict";
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

  // --- Tiny error reporter (so silent failures never hide again)
  window.onerror = function(msg, src, line, col, err){
    try{
      const box=document.createElement('div');
      box.style.cssText='position:fixed;left:8px;bottom:8px;max-width:92vw;background:#2b1120;color:#ffd6e7;border:1px solid #80334f;border-radius:10px;padding:10px 12px;font:12px/1.4 system-ui,Segoe UI,Inter;z-index:99999';
      box.innerHTML = `<b>Script error:</b> ${String(msg)}<br><small>${src||''}:${line||0}:${col||0}</small>`;
      document.body.appendChild(box);
      setTimeout(()=>box.remove(),10000);
    }catch(_){}
  };

  /* ---------------- Wizard Names & Essences ---------------- */
  const MOON_NAMES=[
    "Magnetic","Lunar","Electric","Self-Existing","Overtone","Rhythmic","Resonant","Galactic","Solar","Planetary","Spectral","Crystal","Cosmic"
  ];
  const MOON_ESSENCE=[
    "Unify ¬∑ Purpose","Polarize ¬∑ Challenge","Activate ¬∑ Service","Define ¬∑ Form",
    "Empower ¬∑ Radiance","Organize ¬∑ Equality","Channel ¬∑ Attunement","Harmonize ¬∑ Integrity",
    "Pulse ¬∑ Intention","Perfect ¬∑ Manifestation","Dissolve ¬∑ Liberation","Dedicate ¬∑ Cooperation","Endure ¬∑ Presence"
  ];

  /* ---------------- Time / DOM ---------------- */
  const state={
    tz: MoonTZ.getTZ(),
    date: MoonTZ.nowWall(),
    hour:null
  };

  const els={
    nowDate:$("#nowDate"), nowClock:$("#nowClock"), nowTZ:$("#nowTZ"), moonLine:$("#moonLine"),
    dayInMoon:$("#dayInMoon"), moonName:$("#moonName"), moonEssence:$("#moonEssence"),
    yearSpan:$("#yearSpan"), weekDots:$("#weekDots"), dootWarn:$("#dootWarn"),
    remCal:$("#remCal"), gregCal:$("#gregCal"), yearMap:$("#yearMap tbody"), nextMoonInfo:$("#nextMoonInfo"),
    tzPick:$("#tzPick"), datePick:$("#datePick"), hourScrub:$("#hourScrub"), jumpMoon:$("#jumpMoon"),
    btnToday:$("#btnToday"), prevDay:$("#prevDay"), nextDay:$("#nextDay"), shareLink:$("#shareLink"),
    simMoon:$("#simMoon"), phaseLine:$("#phaseLine"), phaseMeta:$("#phaseMeta"),
    numLine:$("#numLine"), numMeta:$("#numMeta"), energyQuote:$("#energyQuote"),
    dlICS:$("#dlICS"), regenICS:$("#regenICS"),
    kinOn:$("#kinOn"), kinEpoch:$("#kinEpoch"), kinSkipLeap:$("#kinSkipLeap"), kinSkipDOOT:$("#kinSkipDOOT"),
    kinBadge:$("#kinBadge"), kinLine:$("#kinLine")
  };

  /* ---------------- Utils ---------------- */
  const pad=n=>String(n).padStart(2,"0");
  const ymd=d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;
  function atWall(y,m,d,h=0,mi=0,s=0){
    return MoonTZ.wallParts(new Date(Date.UTC(y,m-1,d,h,mi,s)), state.tz);
  }
  const isLeap=y=>(y%4===0 && (y%100!==0 || y%400===0));
  const addDaysUTC=(d,days)=>{const nd=new Date(d.getTime()); nd.setUTCDate(nd.getUTCDate()+days); return nd};
  const diffDaysUTC=(a,b)=>Math.floor((a.getTime()-b.getTime())/86400000);
  const setText=(el,txt)=>{ if(el) el.textContent=txt };

  /* ---------------- Remnant Year Math ----------------
     - Year starts July 26 (TZ-aware)
     - DOOT = July 25
     - Feb 29 skipped from 13√ó28 count
  -----------------------------------------------------*/
  function remYearStart(dateWall){
    const y=dateWall.getUTCFullYear();
    const startThis=atWall(y,7,26,0,0,0);
    return (dateWall < startThis) ? atWall(y-1,7,26,0,0,0) : startThis;
  }
  function isDOOT(dateWall){
    const y=dateWall.getUTCFullYear();
    return ymd(dateWall)===ymd(atWall(y,7,25,0,0,0));
  }
  function countSinceStart(dateWall){
    const start=remYearStart(dateWall);
    let days=diffDaysUTC(dateWall,start); // 0-based
    // If a leap Feb 29 occurs between start and dateWall inclusive end, remove it
    // We need to check both the start year and (if spans) end year.
    const yS=start.getUTCFullYear(), yE=dateWall.getUTCFullYear();
    for(let y=yS; y<=yE; y++){
      if(isLeap(y)){
        const feb29=atWall(y,2,29,0,0,0);
        if(feb29>=start && feb29<=dateWall) days -= 1;
      }
    }
    return days;
  }
  function remnantPosition(dateWall){
    if(isDOOT(dateWall)) return {doot:true};
    const since=countSinceStart(dateWall);
    const clamped=Math.max(0,Math.min(363,since)); // 0..363 counted days
    const moon=Math.floor(clamped/28)+1; // 1..13
    const day=(clamped%28)+1;           // 1..28
    const week=Math.floor((day-1)/7)+1; // 1..4
    return {doot:false, moon, day, week};
  }
  function remYearSpanFor(dateWall){
    const start=remYearStart(dateWall);
    // 364 counted days + the uncounted leap insertion in wall span + DOOT day in span
    const end = addDaysUTC(start, 365 + (isLeap(start.getUTCFullYear())?1:0)); // end is exclusive-ish marker
    const y1=start.getUTCFullYear(), y2=end.getUTCFullYear();
    return {start, end, label: (y1===y2? `${y1}-${y2}`:`${y1}/${y2}`)};
  }
  function wallDateForRemDay(yearStart, idx0){
    // idx0: 0..363 counted day index
    // Compute wall date adding idx0, but add +1 after the leap day boundary in leap years
    let d = addDaysUTC(yearStart, idx0);
    const fy = yearStart.getUTCFullYear();
    if(isLeap(fy)){
      const feb29 = atWall(fy,2,29,0,0,0);
      if(d >= feb29) d = addDaysUTC(d,1);
    }
    return d;
  }

  /* ---------------- Calendars ---------------- */
  function buildGregCal(dateWall){
    const y=dateWall.getUTCFullYear(), m=dateWall.getUTCMonth();
    const first=atWall(y,m+1,1,0,0,0);
    const firstDow= first.getUTCDay(); // 0..6
    const daysInMonth = new Date(Date.UTC(y,m+1,0)).getUTCDate();
    const todayYMD= ymd(MoonTZ.nowWall());
    const monthName = first.toLocaleString('en',{month:'long'});
    let html=`<div class="g-head"><div class="g-month">${monthName} ${y}</div></div>`;
    html+='<ol class="g-grid" role="grid" aria-label="Gregorian Month">';
    const labels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for(const l of labels) html+=`<li class="g-lbl" role="columnheader">${l}</li>`;
    for(let i=0;i<firstDow;i++) html+='<li class="g-pad" aria-hidden="true"></li>';
    for(let d=1; d<=daysInMonth; d++){
      const dWall=atWall(y,m+1,d,0,0,0);
      const isToday = ymd(dWall)===todayYMD;
      html+=`<li class="g-day ${isToday?'is-today':''}" role="gridcell"><button type="button" data-g="${y}-${pad(m+1)}-${pad(d)}">${d}</button></li>`;
    }
    html+='</ol>';
    els.gregCal.innerHTML=html;
    els.gregCal.addEventListener('click',e=>{
      const b=e.target.closest('button[data-g]'); if(!b) return;
      const [yy,mm,dd]=b.dataset.g.split('-').map(Number);
      state.date = atWall(yy,mm,dd, state.hour??state.date.getUTCHours(), state.date.getUTCMinutes(), 0);
      hydrateAll();
    },{once:true});
  }

  function buildRemCal(dateWall){
    const pos=remnantPosition(dateWall);
    const yStart=remYearStart(dateWall);
    const hdr = pos.doot ? 'Remnant Month ‚Äî DOOT' : `Remnant Month ‚Äî ${MOON_NAMES[pos.moon-1]} (${pos.moon}/13)`;
    setText($("#remHdr"), hdr);

    let html='<ol class="r-grid" role="grid" aria-label="Remnant 13√ó28 Month">';
    const labels=['D1','D2','D3','D4','D5','D6','D7'];
    for(const l of labels) html+=`<li class="r-lbl" role="columnheader">${l}</li>`;
    if(pos.doot){
      html+='<li class="r-doot" style="grid-column:1 / -1">Day Out of Time</li>';
    }else{
      const startIdx0=(pos.moon-1)*28;
      for(let i=0;i<28;i++){
        const idx0=startIdx0+i;
        const d = wallDateForRemDay(yStart, idx0);
        const mark = (i+1===pos.day) ? 'is-today' : '';
        html+=`<li class="r-day ${mark}" role="gridcell"><button type="button" data-r="${ymd(d)}">${i+1}</button></li>`;
      }
    }
    html+='</ol>';
    els.remCal.innerHTML=html;
    els.remCal.addEventListener('click',e=>{
      const b=e.target.closest('button[data-r]'); if(!b) return;
      const [yy,mm,dd]=b.dataset.r.split('-').map(Number);
      state.date = atWall(yy,mm,dd, state.hour??state.date.getUTCHours(), state.date.getUTCMinutes(), 0);
      hydrateAll();
    },{once:true});
  }

  /* ---------------- Week Dots & Ring ---------------- */
  function drawWeekDots(pos){
    const wrap=els.weekDots; if(!wrap) return;
    wrap.innerHTML='';
    for(let w=1; w<=4; w++){
      const group=document.createElement('div'); group.className='wdots';
      for(let d=1; d<=7; d++){
        const i=(w-1)*7+d;
        const dot=document.createElement('i'); dot.className='wdot';
        if(!pos.doot && i===pos.day) dot.classList.add('is-today');
        group.appendChild(dot);
      }
      wrap.appendChild(group);
    }
  }
  function drawRing(day){
    const arc=$("#moonArc"); if(!arc) return;
    const total=316; const frac=(day-1)/28; const len=Math.max(1, Math.floor(total*frac));
    arc.style.strokeDasharray = `${len} ${total-len}`;
  }

  /* ---------------- Lunar Phase (approx) ---------------- */
  function lunarPhase(dWall){
    const syn=29.530588, ref=Date.UTC(2000,0,6,18,14,0);
    const days=(dWall.getTime()-ref)/86400000;
    const phase=((days % syn)+syn)%syn;
    const pct=phase/syn;
    const names=['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous','Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];
    const idx=Math.floor(((pct*8)+0.5))%8;
    return {phaseDays:phase, pct, name:names[idx]};
  }
  function drawMoonCanvas(c,p){
    const ctx=c.getContext('2d');
    const w=c.width, h=c.height, r=Math.min(w,h)/2 - 10;
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,w,h);
    ctx.translate(w/2,h/2);
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle="#0a0f18"; ctx.fill();
    const k=Math.cos(p.pct*2*Math.PI);
    ctx.save(); ctx.beginPath(); ctx.ellipse(0,0,r, Math.abs(k)*r, 0, 0, Math.PI*2); ctx.fillStyle="#b7d7ff"; ctx.globalAlpha=0.9; ctx.fill(); ctx.restore();
    ctx.setTransform(1,0,0,1,0,0);
  }

  /* ---------------- Numerology ---------------- */
  function numerologyFor(dateWall,pos){
    const iso=MoonTZ.isoDateWall(dateWall);
    const digits=iso.replace(/-/g,'').split('').map(n=>+n);
    const sum=digits.reduce((a,b)=>a+b,0);
    const reduce=(n)=>{ if([11,22].includes(n)) return n; while(n>9) n=String(n).split('').reduce((a,b)=>a+ +b,0); return n; };
    const path=reduce(sum);
    const tone = pos.doot?0: ((pos.moon-1)%13 + 1);
    const quote = [
      "Magnetic: unify the will.","Lunar: face the gate.","Electric: serve the flame.","Self-Existing: give the form.",
      "Overtone: radiate the crown.","Rhythmic: balance the field.","Resonant: attune the heart.","Galactic: harmonize the law.",
      "Solar: pulse intention.","Planetary: perfect the work.","Spectral: release the bind.","Crystal: dedicate the circle.","Cosmic: endure the vow."
    ];
    return {iso, path, tone, quote: tone?quote[tone-1]:"Day Out of Time: rest and reset."}
  }

  /* ---------------- Kin (optional) ---------------- */
  function kinFor(dateWall, opts){
    let [Y,M,D]=opts.epoch.split('-').map(Number);
    const start=new Date(Date.UTC(Y,M-1,D,0,0,0));
    let d = diffDaysUTC(dateWall,start);
    if(opts.skipLeap){
      for(let y=start.getUTCFullYear(); y<=dateWall.getUTCFullYear(); y++){
        if(isLeap(y)){
          const feb29=Date.UTC(y,1,29);
          if(dateWall.getTime()>=feb29) d-=1;
        }
      }
    }
    if(opts.skipDOOT){
      for(let y=start.getUTCFullYear(); y<=dateWall.getUTCFullYear(); y++){
        const doot=Date.UTC(y,6,25);
        if(dateWall.getTime()>=doot) d-=1;
      }
    }
    return ((d%260)+260)%260 + 1;
  }

  /* ---------------- Year Map + ICS ---------------- */
  function buildYearMap(dateWall){
    const start=remYearStart(dateWall);
    const rows=[];
    for(let i=0;i<13;i++){
      const dStart = wallDateForRemDay(start, i*28);
      const dEnd   = addDaysUTC(dStart,27);
      rows.push({i:i+1, s:dStart, e:dEnd, name:MOON_NAMES[i], ess:MOON_ESSENCE[i]});
    }
    els.yearMap.innerHTML = rows.map(r=>{
      const fmt=(d)=> new Intl.DateTimeFormat('en-US',{timeZone:state.tz, year:'numeric', month:'short', day:'2-digit'}).format(d);
      return `<tr><td>${r.i}</td><td>${r.name}</td><td>${r.ess}</td><td>${fmt(r.s)}</td><td>${fmt(r.e)}</td></tr>`;
    }).join('');
    // Next moon info
    const pos=remnantPosition(dateWall);
    if(!pos.doot){
      const nextStart = (pos.moon===13) ? addDaysUTC(wallDateForRemDay(start, 12*28), 28) : wallDateForRemDay(start, pos.moon*28);
      const fmt=(d)=> new Intl.DateTimeFormat('en-US',{timeZone:state.tz, month:'short', day:'2-digit'}).format(d);
      setText(els.nextMoonInfo, `Next: ${MOON_NAMES[pos.moon%13]} begins ${fmt(nextStart)} (${state.tz})`);
    } else {
      setText(els.nextMoonInfo, "This is the Day Out of Time ‚Äî the count resumes tomorrow.");
    }
  }
  function buildICS(dateWall){
    const start=remYearStart(dateWall);
    let ics="BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Scroll of Fire//13-Moon//EN\r\n";
    const stamp=()=>{const d=new Date();return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+"Z";}
    const dt=(d)=> d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T000000Z";
    for(let i=0;i<13;i++){
      const s=wallDateForRemDay(start, i*28);
      const e=addDaysUTC(s,28); // exclusive
      ics+=`BEGIN:VEVENT\r\nUID:moon-${i+1}-${start.getUTCFullYear()}@sof\r\nDTSTAMP:${stamp()}\r\nDTSTART:${dt(s)}\r\nDTEND:${dt(e)}\r\nSUMMARY:${MOON_NAMES[i]} Moon\r\nDESCRIPTION:${MOON_ESSENCE[i]}\r\nEND:VEVENT\r\n`;
    }
    ics+="END:VCALENDAR\r\n";
    const blob=new Blob([ics],{type:"text/calendar"});
    els.dlICS.href=URL.createObjectURL(blob);
  }

  /* ---------------- Hydration ---------------- */
  function hydrateHeader(dateWall,pos){
    const fmtDate=new Intl.DateTimeFormat('en-US',{timeZone:state.tz, weekday:'short', year:'numeric', month:'short', day:'2-digit'}).format(dateWall);
    setText(els.nowDate, fmtDate);
    setText(els.nowTZ, state.tz);
    const tick=()=>{ const w=MoonTZ.wallParts(new Date(),state.tz); setText(els.nowClock, w.toTimeString().slice(0,8)); requestAnimationFrame(tick); }; tick();

    const yspan=remYearSpanFor(dateWall);
    setText(els.yearSpan, yspan.label);

    if(pos.doot){
      els.dootWarn.hidden=false;
      setText(els.moonName, "Day Out of Time");
      setText(els.moonEssence, "Pause ¬∑ Reset");
      setText(els.moonLine, "‚Äî outside the 13√ó28 cadence ‚Äî");
      setText(els.dayInMoon, "‚Äî");
      drawRing(1);
    }else{
      els.dootWarn.hidden=true;
      setText(els.moonName, MOON_NAMES[pos.moon-1]);
      setText(els.moonEssence, MOON_ESSENCE[pos.moon-1]);
      setText(els.moonLine, `Moon ${pos.moon} ¬∑ Day ${pos.day} ¬∑ Week ${pos.week}`);
      setText(els.dayInMoon, String(pos.day));
      drawRing(pos.day);
    }
    drawWeekDots(pos);
  }
  function hydrateLunar(dateWall){
    const ph=lunarPhase(dateWall);
    drawMoonCanvas(els.simMoon,ph);
    setText(els.phaseLine, `${ph.name}`);
    setText(els.phaseMeta, `Phase: ${(ph.pct*100).toFixed(1)}% ¬∑ Day ${ph.phaseDays.toFixed(1)} of cycle`);
  }
  function hydrateNumerology(dateWall,pos){
    const n=numerologyFor(dateWall,pos);
    setText(els.numLine, `Path ${n.path} ¬∑ Tone ${n.tone||'‚Äî'}`);
    setText(els.numMeta, `${n.iso} ¬∑ ${pos.doot?'DOOT':'Moon '+pos.moon}`);
    setText(els.energyQuote, n.quote);
  }
  function hydrateKin(dateWall){
    if(!els.kinOn || !els.kinOn.checked){ setText(els.kinBadge,'Kin ‚Äî'); setText(els.kinLine,'‚Äî'); return; }
    const kin = kinFor(dateWall,{epoch:els.kinEpoch.value, skipLeap:els.kinSkipLeap.checked, skipDOOT:els.kinSkipDOOT.checked});
    setText(els.kinBadge, `Kin ${kin}`);
    setText(els.kinLine, `Counted from ${els.kinEpoch.value}${els.kinSkipLeap.checked?', skipping leap day':''}${els.kinSkipDOOT.checked?', skipping DOOT':''}.`);
  }
  function hydrateTZPicker(){
    const common=["UTC","America/Los_Angeles","America/Denver","America/Chicago","America/New_York","Europe/London","Europe/Paris","Europe/Berlin","Europe/Moscow","Asia/Jerusalem","Asia/Tokyo","Asia/Seoul","Asia/Shanghai","Australia/Sydney","Pacific/Auckland"];
    const local=MoonTZ.getTZ();
    const all=[local,...common.filter(z=>z!==local)];
    els.tzPick.innerHTML = all.map(z=>`<option value="${z}">${z}</option>`).join('');
    els.tzPick.value = state.tz;
  }
  function hydrateControls(dateWall,pos){
    els.datePick.value = MoonTZ.isoDateWall(dateWall);
    const wall=MoonTZ.wallParts(dateWall,state.tz);
    els.hourScrub.value = wall.getUTCHours();
    els.jumpMoon.value = pos.doot? "" : String(pos.moon);
  }
  function hydrateCalendars(dateWall){
    buildRemCal(dateWall);
    buildGregCal(dateWall);
    buildYearMap(dateWall);
    buildICS(dateWall);
  }
  function hydrateAll(){
    state.date = MoonTZ.wallParts(state.date, state.tz);
    const pos=remnantPosition(state.date);
    hydrateHeader(state.date,pos);
    hydrateControls(state.date,pos);
    hydrateLunar(state.date);
    hydrateNumerology(state.date,pos);
    hydrateKin(state.date);
    hydrateCalendars(state.date);
  }

  /* ---------------- Events ---------------- */
  function bindEvents(){
    els.tzPick.addEventListener('change',()=>{ state.tz=els.tzPick.value; MoonTZ.setTZ(state.tz); state.date=MoonTZ.wallParts(state.date,state.tz); hydrateAll(); });
    els.datePick.addEventListener('change',()=>{ const [y,m,da]=els.datePick.value.split('-').map(Number); state.date=atWall(y,m,da,state.date.getUTCHours(),state.date.getUTCMinutes(),0); hydrateAll();});
    els.hourScrub.addEventListener('input',()=>{ state.hour=+els.hourScrub.value; state.date=atWall(state.date.getUTCFullYear(), state.date.getUTCMonth()+1, state.date.getUTCDate(), state.hour, state.date.getUTCMinutes(), 0); hydrateAll(); });
    els.btnToday.addEventListener('click',()=>{ state.date=MoonTZ.nowWall(); state.hour=null; hydrateAll(); });
    els.prevDay.addEventListener('click',()=>{ state.date=addDaysUTC(state.date,-1); hydrateAll(); });
    els.nextDay.addEventListener('click',()=>{ state.date=addDaysUTC(state.date, 1); hydrateAll(); });
    els.shareLink.addEventListener('click',async ()=>{
      const url=new URL(location.href);
      url.searchParams.set('tz',state.tz);
      url.searchParams.set('date', MoonTZ.isoDateWall(state.date));
      try{ await navigator.clipboard.writeText(url.toString()); els.shareLink.textContent="Copied!"; setTimeout(()=>els.shareLink.textContent="Copy Link",1200);}catch{}
    });
    els.jumpMoon.addEventListener('change',()=>{
      const m=+els.jumpMoon.value||null; if(!m) return;
      const start=remYearStart(state.date);
      let target=wallDateForRemDay(start,(m-1)*28);
      state.date=MoonTZ.wallParts(target,state.tz); hydrateAll();
    });
    ["input","change"].forEach(ev=>{
      els.kinOn && els.kinOn.addEventListener(ev,()=>hydrateKin(state.date));
      els.kinEpoch && els.kinEpoch.addEventListener(ev,()=>hydrateKin(state.date));
      els.kinSkipLeap && els.kinSkipLeap.addEventListener(ev,()=>hydrateKin(state.date));
      els.kinSkipDOOT && els.kinSkipDOOT.addEventListener(ev,()=>hydrateKin(state.date));
    });
    els.regenICS.addEventListener('click',()=>buildICS(state.date));
    addEventListener('keydown',e=>{
      if(e.key==='T' || e.key==='t'){ e.preventDefault(); state.date=MoonTZ.nowWall(); state.hour=null; hydrateAll(); }
      if(e.key==='ArrowUp'){ e.preventDefault(); state.date=addDaysUTC(state.date,1); hydrateAll(); }
      if(e.key==='ArrowDown'){ e.preventDefault(); state.date=addDaysUTC(state.date,-1); hydrateAll(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); state.date=atWall(state.date.getUTCFullYear(),state.date.getUTCMonth()+1,state.date.getUTCDate(), Math.max(0,(state.date.getUTCHours()-1)), state.date.getUTCMinutes(), 0); hydrateAll(); }
      if(e.key==='ArrowRight'){ e.preventDefault(); state.date=atWall(state.date.getUTCFullYear(),state.date.getUTCMonth()+1,state.date.getUTCDate(), Math.min(23,(state.date.getUTCHours()+1)), state.date.getUTCMinutes(), 0); hydrateAll(); }
    });
  }

  /* ---------------- Ambient stars (unchanged) ---------------- */
  (function sky(){
    const c=$("#skyBg"); if(!c) return;
    const ctx=c.getContext("2d",{alpha:true});
    function size(){ c.width=innerWidth; c.height=innerHeight; }
    size();
    let stars=Array.from({length:144},()=>({x:Math.random()*c.width,y:Math.random()*c.height,z:0.3+Math.random()*0.7,s:0.6+Math.random()*1.4}));
    const reduce = matchMedia("(prefers-reduced-motion: reduce)").matches;
    function frame(){
      ctx.clearRect(0,0,c.width,c.height);
      for(const st of stars){
        const a=0.25+0.65*Math.abs(Math.sin((performance.now()/1000)*st.z*0.8+st.x));
        ctx.fillStyle=`rgba(122,243,255,${a*0.35})`;
        ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill();
      }
      if(!reduce) requestAnimationFrame(frame);
    }
    frame();
    addEventListener("resize",()=>{size(); stars=stars.map(s=>({x:Math.random()*c.width,y:Math.random()*c.height,z:s.z,s:s.s}))});
  })();

  /* ---------------- Init ---------------- */
  function init(){
    const yEl=document.getElementById("yr"); if(yEl) yEl.textContent=String(new Date().getFullYear());
    (function dateSupport(){
      const el = document.getElementById('datePick');
      if(!el) return; const test=document.createElement('input');test.setAttribute('type','date');
      if(test.type!=='date'){ el.type='text'; el.placeholder='YYYY-MM-DD'; el.setAttribute('inputmode','numeric'); }
    })();
    const qp=new URLSearchParams(location.search);
    if(qp.get('date')){ const [y,m,d]=qp.get('date').split('-').map(Number); state.date=atWall(y,m,d,state.date.getUTCHours(),state.date.getUTCMinutes(),0); }
    hydrateTZPicker();
    bindEvents();
    hydrateAll();
    // prompts
    const plist=$("#practiceList");
    if(plist){plist.innerHTML=['Light the crown: three breaths, count 4-7-8.','Name the tone; write one vow for the day.','Mark the week: who do you serve today?','Seal the work: a small act of coherence.'].map(p=>`<li>${p}</li>`).join('')}
    // numerology auto-hide if nothing
    setTimeout(()=>{ const line=$("#numLine"); const box=$("#numerologyBox"); if(box && (!line || !line.textContent || line.textContent.trim()==="‚Äî")) box.hidden=true; }, 900);
    // note save
    const btn=$("#btnSaveNote"), area=$("#noteText");
    if(btn && area){
      btn.addEventListener('click',()=>{ try{ localStorage.setItem('sof_moon_note', area.value||""); btn.textContent="Saved"; setTimeout(()=>btn.textContent="Save note",1200);}catch{} });
      const saved=localStorage.getItem('sof_moon_note'); if(saved) area.value=saved;
    }
  }
  addEventListener('load',init);
})();
 </script>
</body>
</html>
