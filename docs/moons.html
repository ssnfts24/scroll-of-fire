<!doctype html>
<html lang="en" dir="ltr" class="sof" data-alive="lively">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <meta charset="utf-8" />
  <title>Remnant 13 Moons · Living Clock — Scroll of Fire</title>

  <!-- Viewport / theme / color -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#05070d" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7fbff" media="(prefers-color-scheme: light)">
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="A Remnant-themed 13 Moon calendar — Ancient Wizard of YHWH aesthetics with day ring, week dots, year map, lunar simulation, numerology, optional Kin, share card, and .ics export." />

  <!-- Canonical + Social -->
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/moons.html">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Remnant 13 Moons · Living Clock — Scroll of Fire">
  <meta property="og:description" content="Which Moon am I in? Day ring, week dots, year map, DOOT handling, lunar sim, numerology, Kin, .ics export — Remnant / YHWH wizard theming.">
  <meta property="og:image" content="assets/share/moon-card.png">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/moons.html">
  <meta name="twitter:card" content="summary_large_image">

  <!-- PWA -->
  <link rel="manifest" href="assets/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="13 Moons">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png">
  <link rel="mask-icon" href="assets/icons/safari-pinned.svg" color="#0e131a">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Site + page CSS (v4.1) -->
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-24">
  <link rel="stylesheet" href="assets/css/moons.css?v=2025-10-24">

  <!-- Critical safety patch + Remnant style + Astro mobile fixes -->
  <style>
    html,body{background:#05070d!important;color:#eaf1ff}
    body{overflow-x:hidden} /* no sideways scroll on mobile */

    .moonbar.contrast-light,.moonbar.contrast-light .tag,.moonbar.contrast-light button{color:#0b1220!important}
    .moonbar.contrast-light .mb-bg{stroke:#e1e8ff!important}
    .moonbar.contrast-light .mb-fg{filter:none!important}
    .lore-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:780px){.lore-grid{grid-template-columns:1fr}}
    .moon-media img{width:100%;height:auto;border-radius:12px;border:1px solid var(--line)}
    .prompts{padding-left:1.2rem}
    #noteText{width:100%;min-height:110px;border:1px solid var(--line);border-radius:10px;background:#0f1116;color:inherit;padding:.65rem}
    .remnant-opener{position:relative;overflow:hidden}
    .op-grid{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .op-sigil{width:64px;height:64px;filter:drop-shadow(0 0 8px color-mix(in srgb, var(--moon-accent) 30%, transparent))}
    .op-title{margin:0;font:800 20px/1.15 "Crimson Pro",serif;letter-spacing:.2px}
    .op-sub{margin:.25rem 0 0}
    .lab-btn.big{padding:.8rem 1.1rem;font-weight:900}
    .cta-link{text-decoration:none;color:inherit}
    @media (max-width:720px){.op-grid{grid-template-columns:auto 1fr;gap:10px}.op-right{grid-column:1/-1}}

    /* ===== Remnant · YHWH style (v2) ===== */
    .remnant-yhwh{
      --remnant-bg-0:#05070d;
      --remnant-bg-1:#0a0f18;
      --remnant-ink:#eaf1ff;
      --remnant-ink-soft:#a8b1c9;
      --remnant-line:#253044;

      /* primary auric gradient */
      --moon-accent:#7af3ff;
      --moon-accent-2:#f3c97a;

      /* element tints */
      --el-fire:#ffb16e;
      --el-water:#7bc7ff;
      --el-air:#c9d3e9;
      --el-earth:#b4ff9a;
      --el-aether:#ffd1f3;

      background:
        radial-gradient(900px 600px at 50% 18%, rgba(122,243,255,.06), transparent 60%),
        radial-gradient(1200px 800px at 50% 95%, rgba(243,201,122,.05), transparent 70%),
        linear-gradient(180deg, var(--remnant-bg-0), var(--remnant-bg-1));
      color:var(--remnant-ink);
    }
    .remnant-yhwh .card{
      border:1px solid var(--remnant-line);
      background:linear-gradient(180deg, rgba(255,255,255,.015), rgba(0,0,0,.07));
      border-radius:14px;
    }
    .remnant-yhwh .shine{
      box-shadow:inset 0 0 28px rgba(122,243,255,.08), 0 14px 60px rgba(0,0,0,.35);
    }
    .remnant-yhwh .lab-btn{
      border:1px solid var(--remnant-line);
      background:rgba(255,255,255,.03);
      border-radius:10px;
    }
    .remnant-yhwh .lab-btn:hover{background:rgba(255,255,255,.06)}
    .remnant-yhwh .seal{
      display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .6rem;border-radius:999px;
      border:1px solid var(--remnant-line);
      background:linear-gradient(90deg, color-mix(in srgb,var(--moon-accent) 14%, transparent), transparent);
    }
    .remnant-yhwh .dot{width:.9em;height:.9em;border-radius:50%;display:inline-block}
    .remnant-yhwh .el-fire{background:var(--el-fire)}
    .remnant-yhwh .el-water{background:var(--el-water)}
    .remnant-yhwh .el-air{background:var(--el-air)}
    .remnant-yhwh .el-earth{background:var(--el-earth)}
    .remnant-yhwh .el-aether{background:var(--el-aether)}
    .remnant-yhwh .ring-bg{stroke:#1b2231;fill:none;stroke-width:10}
    .remnant-yhwh .ring-fg{stroke:url(#mbGrad);stroke-width:10;stroke-linecap:round;fill:none}
    .remnant-yhwh .meta{color:var(--remnant-ink-soft)}
    .remnant-yhwh code,.remnant-yhwh .mono{background:rgba(255,255,255,.03);padding:.05rem .3rem;border-radius:.35rem}

    /* ---------- ASTROLOGY NOW: layout & mobile fit ---------- */
    .astro{padding:12px}
    .astro-head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .astro-grid{
      display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:start;
    }
    /* Planet chips */
    .astro-chips{display:grid;grid-template-columns:1fr;gap:8px}
    .astro-chips .chip{
      display:flex;align-items:center;gap:.6rem;justify-content:space-between;
      padding:.55rem .7rem;border:1px solid var(--remnant-line);border-radius:12px;
      color:var(--remnant-ink);background:rgba(255,255,255,.03);
      transition:transform .12s ease, box-shadow .12s ease;
      width:100%;
    }
    .astro-chips .chip b{min-width:72px}
    .astro-chips .chip .pos{min-width:66px;text-align:right}
    .astro-chips .chip:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(0,0,0,.32),0 0 0 1px color-mix(in srgb,var(--moon-accent) 28%, transparent)}
    .astro-chips details.chip{padding:.35rem .7rem}
    .astro-chips .more-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
    /* Wheel */
    .astro-wheel{display:flex;flex-direction:column;align-items:center;gap:6px}
    .astro-wheel svg{width:min(100%,360px);height:auto;display:block}
    /* Aspects */
    .astro-aspects{margin-top:10px}
    .astro-aspects .legend{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px}
    .astro-aspects .badge{border:1px solid var(--remnant-line);background:rgba(255,255,255,.03);padding:.25rem .55rem;border-radius:999px;font-weight:600}
    .astro-aspects .badge.conj{box-shadow:inset 0 -2px 0 0 var(--el-aether)}
    .astro-aspects .badge.sext{box-shadow:inset 0 -2px 0 0 var(--el-air)}
    .astro-aspects .badge.sqr{box-shadow:inset 0 -2px 0 0 var(--el-earth)}
    .astro-aspects .badge.tri{box-shadow:inset 0 -2px 0 0 var(--el-water)}
    .astro-aspects .badge.opp{box-shadow:inset 0 -2px 0 0 var(--el-fire)}
    .asp-table{width:100%;border-collapse:collapse}
    .asp-table th,.asp-table td{padding:.45rem;border-top:1px solid var(--remnant-line);text-align:left}
    .astro-aspects{overflow:auto;-webkit-overflow-scrolling:touch}
    .asp-table thead th{position:sticky;top:0;background:rgba(5,7,13,.9);backdrop-filter:saturate(120%) blur(4px)}

    /* Mobile breakpoint */
    @media (max-width:800px){
      .astro-grid{grid-template-columns:1fr}
      .astro-chips{grid-template-columns:1fr 1fr}
      .astro-chips .chip b{min-width:auto}
    }
    @media (max-width:520px){
      .astro-chips{grid-template-columns:1fr}
      .astro-chips .chip .pos{min-width:auto}
      .astro-head{gap:6px}
    }

    /* “remnant frame” halo */
    .remnant-yhwh .remnant-frame{position:relative;isolation:isolate}
    .remnant-yhwh .remnant-frame::after{
      content:"";position:absolute;inset:-1px;z-index:-1;border-radius:inherit;
      background:
        radial-gradient(500px 220px at 8% -10%, color-mix(in srgb,var(--moon-accent) 22%, transparent), transparent 60%),
        radial-gradient(500px 220px at 108% 120%, color-mix(in srgb,var(--moon-accent-2) 22%, transparent), transparent 60%);
      opacity:.55;pointer-events:none;
    }
  </style>

  <!-- FB in-app browser guard -->
  <script>
    (function(){
      var ua=navigator.userAgent||"";
      if(/\bFBAN|FBAV|FB_IAB|FBAN\/Messenger\b/i.test(ua)){ document.documentElement.classList.add('is-fbapp'); }
    })();
  </script>

  <!-- Resource hints -->
  <link rel="prefetch" href="genesis-oracle.html" as="document">
  <link rel="preload" href="assets/js/moons.js?v=3.9" as="script" crossorigin>

  <!-- Structured data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"Remnant 13 Moons — Living Clock",
    "url":"https://ssnfts24.github.io/scroll-of-fire/moons.html",
    "applicationCategory":"Utility",
    "operatingSystem":"Any",
    "description":"Interactive 13-Moon calendar with Remnant / YHWH wizard theme: lunar phase simulation, numerology, Kin, and .ics export.",
    "creator":{"@type":"Person","name":"Aaron Paul Laird"}
  }
  </script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Codex","item":"https://ssnfts24.github.io/scroll-of-fire/index.html"},
      {"@type":"ListItem","position":2,"name":"13 Moons","item":"https://ssnfts24.github.io/scroll-of-fire/moons.html"}
    ]
  }
  </script>
</head>

<body class="stars remnant-yhwh">
  <!-- Hidden defs so JS can recolor gradients safely -->
  <svg width="0" height="0" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="mbGrad" x1="0" x2="1">
        <stop offset="0" stop-color="#7af3ff"/><stop offset="1" stop-color="#f3c97a"/>
      </linearGradient>
      <linearGradient id="rg" x1="0" x2="1">
        <stop offset="0" stop-color="#7af3ff"/><stop offset="1" stop-color="#f3c97a"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Living sky -->
  <canvas id="skyBg" width="1440" height="900" aria-hidden="true"></canvas>

  <!-- Compact Moon widget (always visible) -->
  <section class="wrap" aria-label="Remnant Moonbar">
    <div class="moonbar yhwh-on" data-size="compact" role="group" aria-label="Current Moon mini widget" style="display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;margin-bottom:10px;">
      <svg width="64" height="64" viewBox="0 0 64 64" aria-hidden="true">
        <circle cx="32" cy="32" r="26" class="mb-bg" stroke-width="6" fill="none"></circle>
        <circle cx="32" cy="32" r="26" class="mb-fg" id="moonArcMini" pathLength="163" stroke-width="6" stroke-linecap="round" fill="none" stroke-dasharray="0 163"></circle>
      </svg>
      <div class="moonbar-info">
        <div class="moonbar-line">
          <span class="tag yhwh" title="YHWH Seal">⟡ <span lang="he">יהוה</span></span>
          <span id="mbName"><b>—</b></span>
          <span class="sep" aria-hidden="true">·</span>
          <span id="mbEssence" class="meta">—</span>
        </div>
        <div class="moonbar-tags">
          <span class="tag"><span id="mbDay">—/28</span></span>
          <span class="tag">Year <span id="mbYear">—</span></span>
        </div>
      </div>
      <div class="moonbar-actions" style="display:flex;gap:8px">
        <button id="btnShareImage" class="moonbar-share" type="button" title="Make share card">Share</button>
        <label class="moonbar-tz" for="tzPick" title="Time Zone">TZ</label>
      </div>
    </div>
  </section>

  <!-- Remnant Opener — The Seal of Becoming -->
  <section id="remnantOpener" class="wrap">
    <div class="remnant-opener card remnant-frame" aria-label="Open the Remnant Birth Seal" style="margin:10px 0">
      <div class="op-grid">
        <div class="op-left">
          <svg class="op-sigil" viewBox="0 0 64 64" aria-hidden="true">
            <defs>
              <linearGradient id="opGrad" x1="0" x2="1">
                <stop offset="0" stop-color="var(--moon-accent)"/>
                <stop offset="1" stop-color="var(--moon-accent-2)"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="26" fill="none" stroke="#1b2231" stroke-width="6"/>
            <circle cx="32" cy="32" r="26" fill="none" stroke="url(#opGrad)" stroke-linecap="round" stroke-width="6" stroke-dasharray="78 163"></circle>
            <text x="32" y="32" text-anchor="middle" dominant-baseline="central" font-family="Inter,system-ui" font-size="16" font-weight="900" fill="currentColor">⟡</text>
          </svg>
        </div>
        <div class="op-mid">
          <h3 class="op-title">The Seal of Becoming</h3>
          <p class="op-sub meta">
            Remnant Birth Seal — reads your <b>Moon • Day • Week • Tone</b> and <b>Name code</b>, with Resonant sums and carrier skin.
          </p>
          <small class="meta">Uses your selected date &amp; timezone (or today) to prefill.</small>
        </div>
        <div class="op-right">
          <a id="openSeal" class="lab-btn big cta-link" href="genesis-oracle.html" aria-describedby="opHelp">Open Birth Seal</a>
          <p id="opHelp" class="meta" style="margin:.35rem 0 0">Deep link carries date/time/tz → <span class="mono">genesis-oracle.html</span></p>
        </div>
      </div>
    </div>
  </section>

  <main class="wrap" id="main" role="main">
    <header class="page-head fancy-head">
      <h1 class="title">🌗 Remnant 13 Moons — <em>Living Clock</em></h1>
      <p class="subtitle">
        An ancient-modern calendar in the cadence of 13×28. Phase-tinted, time-zone aware, and trimmed with the seal of
        <span lang="he" title="YHWH">יהוה</span>.
      </p>

      <nav class="crumbs" aria-label="Breadcrumb">
        <a class="lab-btn" href="index.html">← Back to Codex</a>
        <a class="lab-btn" href="theory.html">📘 Theory</a>
        <a id="openSealHeader" class="lab-btn" href="genesis-oracle.html" title="Open the Remnant Birth Seal">⟡ Birth Seal</a>
      </nav>

      <!-- Moon-first badge -->
      <section class="card shine" aria-label="Current Moon">
        <div class="moon-badge">
          <div class="ring" aria-label="Day in Moon">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle cx="60" cy="60" r="50" class="ring-bg"/>
              <circle cx="60" cy="60" r="50" class="ring-fg" id="moonArc" pathLength="316"/>
            </svg>
            <div class="label" aria-live="polite">
              <div class="big" id="dayInMoon">—</div>
              <div class="small">of 28</div>
            </div>
          </div>

          <span class="pill" id="moonChip">
            <span class="k" id="moonName">—</span>
            <span class="meta" id="moonEssence">—</span>
          </span>

          <span class="pill mono"><span id="yearSpan">—</span></span>
          <span class="pill" id="sourceChip" title="Source Seal">⟡ י־ה־ו־ה</span>
        </div>

        <div class="weekrow" aria-label="Week inside the 28-day moon">
          <span class="weeklabel">Week</span>
          <div class="week" id="weekDots" role="group" aria-label="Week dots (1–4 × 7)"></div>
        </div>

        <p class="meta" id="dootWarn" style="display:none;margin-top:8px">
          <b>Day Out of Time:</b> this day sits outside the 13×28 moons. Rest, reflect, reset.
        </p>
      </section>
    </header>

    <section class="grid" aria-label="Controls, Simulation, and Maps">
      <!-- Today + controls -->
      <article class="card col-8" aria-labelledby="today-head">
        <h2 id="today-head">Today</h2>
        <div class="lab-row" style="align-items:flex-end">
          <span class="pill"><b id="nowDate" aria-live="polite">—</b></span>
          <span class="pill mono" id="nowClock" aria-live="polite">—:—:—</span>
          <span class="pill" id="nowTZ">—</span>
          <span class="pill" id="moonLine">—</span>
        </div>
        <div class="lab-row" style="margin-top:8px">
          <label>Time Zone
            <select id="tzPick" class="lab-input" style="min-width:240px" aria-label="Time Zone"></select>
          </label>
          <label>Date
            <input type="date" id="datePick" class="lab-input" aria-label="Pick a date">
          </label>
          <label>Hour
            <input type="range" id="hourScrub" min="0" max="23" value="12" class="lab-input" style="width:160px" aria-label="Hour of day">
          </label>
          <button class="lab-btn" id="btnToday" type="button">Today</button>
          <button class="lab-btn" id="prevDay" type="button">← Prev</button>
          <button class="lab-btn" id="nextDay" type="button">Next →</button>
          <button class="lab-btn" id="shareLink" type="button">Copy Link</button>
          <label class="tag" style="margin-left:auto">Go to:
            <select id="jumpMoon" class="lab-input" style="min-width:140px;margin-left:6px" aria-label="Jump to Moon">
              <option value="">—</option>
              <option value="1">#1 Magnetic</option>
              <option value="2">#2 Lunar</option>
              <option value="3">#3 Electric</option>
              <option value="4">#4 Self-Existing</option>
              <option value="5">#5 Overtone</option>
              <option value="6">#6 Rhythmic</option>
              <option value="7">#7 Resonant</option>
              <option value="8">#8 Galactic</option>
              <option value="9">#9 Solar</option>
              <option value="10">#10 Planetary</option>
              <option value="11">#11 Spectral</option>
              <option value="12">#12 Crystal</option>
              <option value="13">#13 Cosmic</option>
            </select>
          </label>
        </div>
      </article>

      <!-- Lunar simulation & numerology -->
      <aside class="card col-4" aria-labelledby="lunar-head">
        <h2 id="lunar-head">Lunar Phase</h2>
        <div class="sim">
          <canvas id="simMoon" width="280" height="280" aria-label="Lunar phase"></canvas>
          <div>
            <p class="mono" id="phaseLine">—</p>
            <p class="meta" id="phaseMeta">—</p>
            <div class="divider" style="margin:8px 0" aria-hidden="true"></div>
            <h3 style="margin:.2rem 0">Numerology</h3>
            <p class="mono" id="numLine">—</p>
            <p class="meta" id="numMeta">—</p>
            <p class="meta" id="energyQuote" style="margin-top:6px">—</p>
          </div>
        </div>
      </aside>

      <!-- Year map -->
      <article class="card col-12" aria-labelledby="map-head">
        <h2 id="map-head">Year Map — Gregorian spans of the 13 Moons</h2>
        <p class="hint">New Year = July 26 · Day Out of Time = July 25 · Leap Day (Feb 29) is skipped in the 13×28 count.</p>
        <table class="year-map" id="yearMap">
          <thead>
            <tr><th>#</th><th>Moon Name</th><th>Essence</th><th>Start (TZ)</th><th>End (TZ)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="meta" id="nextMoonInfo" style="margin-top:6px">—</p>
      </article>

      <!-- Kin + ICS -->
      <article class="card col-12" aria-labelledby="kin-head">
        <h2 id="kin-head">Kin of Today (optional)</h2>
        <div class="kin">
          <div class="kin-row">
            <label class="tag"><input type="checkbox" id="kinOn" /><span style="margin-left:6px">Show Kin</span></label>
            <label class="tag">Epoch:
              <select id="kinEpoch" class="lab-input" style="margin-left:6px">
                <option value="1987-07-26">1987-07-26 (Dreamspell common)</option>
                <option value="1990-01-01">1990-01-01</option>
              </select>
            </label>
            <label class="tag"><input type="checkbox" id="kinSkipLeap" checked /><span style="margin-left:6px">Skip Leap Day</span></label>
            <label class="tag"><input type="checkbox" id="kinSkipDOOT" checked /><span style="margin-left:6px">Skip DOOT</span></label>
          </div>
          <div class="kin-row">
            <span class="tag" id="kinBadge">Kin —</span>
            <span class="meta" id="kinLine">—</span>
          </div>
          <small class="meta">Toggle options to match external calculators exactly.</small>
        </div>

        <div class="goldline" aria-hidden="true"></div>
        <h3 style="margin:.2rem 0">Export this 13-Moon Year</h3>
        <p class="meta">Download an <code>.ics</code> calendar with the 13 Moon spans for the selected time-zone/year.</p>
        <div class="lab-row">
          <a id="dlICS" class="dl" href="#" download="13-moon-year.ics" role="button">⬇️ Download .ics</a>
          <button class="lab-btn ghost" id="regenICS" type="button">Refresh</button>
        </div>
      </article>

      <!-- ASTRO PANEL -->
      <article class="card col-12 shine astro" aria-labelledby="astro-head">
        <header class="astro-head">
          <span class="seal" aria-hidden="true">⟡ <span lang="he">יהוה</span></span>
          <h2 id="astro-head">Astrology Now</h2>
          <p class="meta">Current sky placements in a lightweight, Remnant panel. Filled by the inline ephemeris below (or your JSON if present).</p>
        </header>

        <section class="astro-grid" aria-label="Current placements and wheel">
          <!-- Left: planet chips -->
          <div class="astro-chips" role="list">
            <button class="chip" role="listitem" data-planet="sun"    aria-live="polite"><i class="dot el-fire"></i><b>Sun</b>    <span class="mono pos"  data-pos="sun">—</span>    <span class="sign" data-sign="sun">—</span></button>
            <button class="chip" role="listitem" data-planet="moon"   aria-live="polite"><i class="dot el-water"></i><b>Moon</b>  <span class="mono pos"  data-pos="moon">—</span>   <span class="sign" data-sign="moon">—</span></button>
            <button class="chip" role="listitem" data-planet="mercury"><i class="dot el-air"></i><b>Mercury</b> <span class="mono pos" data-pos="mercury">—</span> <span class="sign" data-sign="mercury">—</span></button>
            <button class="chip" role="listitem" data-planet="venus"  ><i class="dot el-earth"></i><b>Venus</b>   <span class="mono pos" data-pos="venus">—</span>   <span class="sign" data-sign="venus">—</span></button>
            <button class="chip" role="listitem" data-planet="mars"   ><i class="dot el-fire"></i><b>Mars</b>     <span class="mono pos" data-pos="mars">—</span>    <span class="sign" data-sign="mars">—</span></button>
            <button class="chip" role="listitem" data-planet="jupiter"><i class="dot el-air"></i><b>Jupiter</b>  <span class="mono pos" data-pos="jupiter">—</span> <span class="sign" data-sign="jupiter">—</span></button>
            <button class="chip" role="listitem" data-planet="saturn" ><i class="dot el-earth"></i><b>Saturn</b>  <span class="mono pos" data-pos="saturn">—</span>  <span class="sign" data-sign="saturn">—</span></button>

            <details class="chip more">
              <summary><i class="dot el-aether"></i><b>Outer bodies</b></summary>
              <div class="more-grid">
                <div><b>Uranus</b>  <span class="mono pos" data-pos="uranus">—</span>  <span class="sign" data-sign="uranus">—</span></div>
                <div><b>Neptune</b> <span class="mono pos" data-pos="neptune">—</span> <span class="sign" data-sign="neptune">—</span></div>
                <div><b>Pluto</b>   <span class="mono pos" data-pos="pluto">—</span>   <span class="sign" data-sign="pluto">—</span></div>
                <div><b>Chiron</b>  <span class="mono pos" data-pos="chiron">—</span>  <span class="sign" data-sign="chiron">—</span></div>
                <div><b>Node ☊</b>  <span class="mono pos" data-pos="north_node">—</span> <span class="sign" data-sign="north_node">—</span></div>
              </div>
            </details>
          </div>

          <!-- Right: sacred wheel -->
          <figure class="astro-wheel">
            <svg id="astroWheel" viewBox="0 0 360 360" role="img" aria-label="Zodiac wheel">
              <defs>
                <linearGradient id="awGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="var(--moon-accent)"/>
                  <stop offset="1" stop-color="var(--moon-accent-2)"/>
                </linearGradient>
              </defs>
              <circle cx="180" cy="180" r="162" fill="none" stroke="#1b2231" stroke-width="2"/>
              <circle cx="180" cy="180" r="150" fill="none" stroke="url(#awGrad)" stroke-opacity=".45" stroke-width="2"/>
              <g id="houseLines" stroke="#2a3242" stroke-width=".8" opacity=".9"></g>
              <g id="signLabels" fill="#a7b1ca" font-family="Inter,system-ui" font-size="10" text-anchor="middle"></g>
              <g id="planetDots">
                <circle r="4.6" class="dot el-fire"   data-dot="sun"    cx="180" cy="30"/>
                <circle r="4.6" class="dot el-water"  data-dot="moon"   cx="180" cy="330"/>
                <circle r="4.6" class="dot el-air"    data-dot="mercury" cx="30"  cy="180"/>
                <circle r="4.6" class="dot el-earth"  data-dot="venus"   cx="330" cy="180"/>
                <circle r="4.6" class="dot el-fire"   data-dot="mars"    cx="60"  cy="60"/>
                <circle r="4.6" class="dot el-air"    data-dot="jupiter" cx="300" cy="300"/>
                <circle r="4.6" class="dot el-earth"  data-dot="saturn"  cx="60"  cy="300"/>
              </g>
            </svg>
            <figcaption class="meta">
              <span id="astroStamp">—</span><span class="sep">·</span>
              <span id="astroTZ">—</span><span class="sep">·</span>
              Source: <span id="astroSource">—</span>
            </figcaption>
          </figure>
        </section>

        <section class="astro-aspects" aria-labelledby="asp-head">
          <h3 id="asp-head">Aspects</h3>
          <div class="legend">
            <span class="badge conj">☌ Conjunction</span>
            <span class="badge sext">✶ Sextile</span>
            <span class="badge sqr">□ Square</span>
            <span class="badge tri">△ Trine</span>
            <span class="badge opp">☍ Opposition</span>
          </div>
          <table class="asp-table">
            <thead><tr><th>Pair</th><th>Aspect</th><th>Orb</th></tr></thead>
            <tbody id="aspBody"></tbody>
          </table>
        </section>
      </article>
    </section>

    <!-- ===== Inline Astro engine + renderer (self-contained) ===== -->
    <script>
    (function(){
      "use strict";

      // ---------- wheel scaffolding ----------
      const TWO_PI=Math.PI*2, cx=180, cy=180, R=145;
      function buildWheel(){
        const gH=document.getElementById('houseLines');
        const gS=document.getElementById('signLabels');
        if(!gH||!gS) return;
        gH.innerHTML=''; gS.innerHTML='';
        for(let i=0;i<12;i++){
          const a=-Math.PI/2 + i*(TWO_PI/12);
          const x=cx+Math.cos(a)*R, y=cy+Math.sin(a)*R;
          const x2=cx+Math.cos(a)*(R-16), y2=cy+Math.sin(a)*(R-16);
          gH.insertAdjacentHTML('beforeend', `<line x1="${x}" y1="${y}" x2="${x2}" y2="${y2}"></line>`);
        }
        const initials=['A','T','G','C','L','V','L','S','C','P','A','P']; // Aries..Pisces
        for(let i=0;i<12;i++){
          const a=-Math.PI/2 + (i+0.5)*(TWO_PI/12);
          const x=cx+Math.cos(a)*(R-26), y=cy+Math.sin(a)*(R-26)+3;
          gS.insertAdjacentHTML('beforeend', `<text x="${x.toFixed(1)}" y="${y.toFixed(1)}">${initials[i]}</text>`);
        }
      }
      const posForLon = lon => {
        const a = (-90 + lon) * Math.PI/180; // 0° Aries at top
        return { x: cx + Math.cos(a)*R, y: cy + Math.sin(a)*R };
      };

      // ---------- renderAstro (chips + dots + aspects table) ----------
      window.renderAstro = (data={})=>{
        if (data.stamp)  document.getElementById('astroStamp').textContent = data.stamp;
        if (data.tz)     document.getElementById('astroTZ').textContent    = data.tz;
        if (data.source) document.getElementById('astroSource').textContent= data.source;

        const P = data.planets || {};
        Object.keys(P).forEach(k=>{
          const p=P[k];
          document.querySelector(`.pos[data-pos="${k}"]`)?.replaceChildren(document.createTextNode(p.text||'—'));
          document.querySelector(`.sign[data-sign="${k}"]`)?.replaceChildren(document.createTextNode(p.sign||'—'));
          const dot=document.querySelector(`[data-dot="${k}"]`);
          if(dot && typeof p.lon==='number'){
            const xy=posForLon(p.lon);
            dot.setAttribute('cx',xy.x.toFixed(1));
            dot.setAttribute('cy',xy.y.toFixed(1));
          }
        });

        const body=document.getElementById('aspBody');
        if(body){
          body.innerHTML='';
          (data.aspects||[]).forEach(a=> body.insertAdjacentHTML('beforeend', `<tr><td>${a.pair}</td><td>${a.kind}</td><td>${a.orb}</td></tr>`));
        }
      };

      // ---------- math & ephemeris (Meeus-lite + Schlyter) ----------
      const PI=Math.PI, RAD=PI/180;
      const sin=d=>Math.sin(d*RAD), atan2=(y,x)=>Math.atan2(y,x)/RAD;
      const norm360=d=>((d%360)+360)%360;
      function toJD(dUTC){
        const a=Math.floor((14-(dUTC.getUTCMonth()+1))/12);
        const y=dUTC.getUTCFullYear()+4800-a;
        const m=(dUTC.getUTCMonth()+1)+12*a-3;
        const JDN=dUTC.getUTCDate()+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)-32045;
        const frac=(dUTC.getUTCHours()-12)/24+dUTC.getUTCMinutes()/1440+dUTC.getUTCSeconds()/86400+dUTC.getUTCMilliseconds()/86400000;
        return JDN+frac;
      }
      function zonedUTC(){
        const tzSel=document.getElementById("tzPick");
        const tz = tzSel?.value || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        const raw = document.getElementById('datePick')?.value;
        const hour = parseInt(document.getElementById('hourScrub')?.value ?? '0',10) || 0;
        const base = raw ? new Date(raw+"T00:00:00") : new Date();
        base.setHours(hour);
        const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})
          .formatToParts(base).reduce((o,p)=>(o[p.type]=p.value,o),{});
        return { tz, dateUTC:new Date(`${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}Z`) };
      }
      function sunLonJD(JD){
        const T=(JD-2451545)/36525;
        const L0=norm360(280.46646+36000.76983*T+0.0003032*T*T);
        const M =norm360(357.52911+35999.05029*T-0.0001537*T*T);
        const C =(1.914602-0.004817*T-0.000014*T*T)*sin(M)
               +(0.019993-0.000101*T)*sin(2*M)
               +0.000289*sin(3*M);
        return norm360(L0+C);
      }
      function moonLonJD(JD){
        const D=JD-2451545.0;
        const L0=norm360(218.3164477+13.17639648*D);
        const Mm=norm360(134.9633964+13.06499295*D);
        const Ms=norm360(357.5291092+0.98560028*D);
        const F =norm360(93.2720950 +13.22935024*D);
        const Dm=norm360(297.8501921+12.19074912*D);
        let lon=L0
          +6.289*sin(Mm)
          +1.274*sin(2*Dm-Mm)
          +0.658*sin(2*Dm)
          +0.214*sin(2*Mm)
          +0.11 *sin(Dm)
          -0.186*sin(Ms)
          -0.114*sin(2*F);
        return norm360(lon);
      }
      const ELEM = {
        Mercury: { N:48.3313, Nd: 3.24587E-5, i:7.0047,  id: 5.00E-8,  w:29.1241,  wd: 1.01444E-5, a:0.387098, ad:0,   e:0.205635, ed: 5.59E-10, M:168.6562, Md:4.0923344368 },
        Venus:   { N:76.6799, Nd: 2.46590E-5, i:3.3946,  id: 2.75E-8,  w:54.8910,  wd: 1.38374E-5, a:0.723330, ad:0,   e:0.006773, ed:-1.30E-9,  M: 48.0052, Md:1.6021302244 },
        Earth:   { N: 0.0,    Nd: 0,          i:0.0,     id: 0,        w:282.9404, wd: 4.70935E-5, a:1.000000, ad:0,   e:0.016709, ed:-1.151E-9, M:356.0470, Md:0.9856002585 },
        Mars:    { N:49.5574, Nd: 2.11081E-5, i:1.8497,  id:-1.78E-8,  w:286.5016, wd: 2.92961E-5, a:1.523688, ad:0,   e:0.093405, ed: 2.516E-9, M: 18.6021, Md:0.5240207766 },
        Jupiter: { N:100.4542,Nd: 2.76854E-5, i:1.3030,  id:-1.55E-8,  w:273.8777, wd: 1.64505E-5, a:5.20256,  ad:0,   e:0.048498, ed: 4.469E-9, M: 19.8950, Md:0.0830853001 },
        Saturn:  { N:113.6634,Nd: 2.38980E-5, i:2.4886,  id:-1.081E-7, w:339.3939, wd: 2.97661E-5, a:9.55475,  ad:0,   e:0.055546, ed:-9.499E-9, M:316.9670, Md:0.0334442282 }
      };
      function kepler(M,e){
        let E = (M + (e<0.8 ? e*Math.sin(M*RAD) : PI)) ;
        for(let k=0;k<10;k++){
          const dE = (E - e*Math.sin(E) - M*RAD) / (1 - e*Math.cos(E));
          E -= dE; if (Math.abs(dE) < 1e-12) break;
        }
        return E;
      }
      function helioXYZ(el, d){
        const N=(el.N + el.Nd*d) * RAD;
        const i=(el.i + el.id*d) * RAD;
        const w=(el.w + el.wd*d) * RAD; // FIX: no undeclared assignment under "use strict"
        const a= el.a + el.ad*d;
        const e= el.e + el.ed*d;
        const M= norm360(el.M + el.Md*d);
        const E= kepler(M, e);
        const xv= a*(Math.cos(E)-e);
        const yv= a*(Math.sqrt(1-e*e)*Math.sin(E));
        const v = Math.atan2(yv,xv), r=Math.hypot(xv,yv);
        const x = r*( Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i) );
        const y = r*( Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i) );
        const z = r*( Math.sin(v+w)*Math.sin(i) );
      return {x,y,z, lon:norm360(atan2(y,x))};
      }
      function planetGeoLon(name, JD){
        const d=JD-2451543.5;
        const p=helioXYZ(ELEM[name], d);
        const e=helioXYZ(ELEM.Earth, d);
        const X=p.x-e.x, Y=p.y-e.y;
        return norm360(atan2(Y,X));
      }
      function signFromLon(lon){
        const SIGNS=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
        const L=norm360(lon), s=Math.floor(L/30), d=L - s*30;
        const deg=Math.floor(d), min=Math.round((d-deg)*60);
        const pad2=n=>String(n).padStart(2,"0");
        return { sign:SIGNS[s], text:`${deg}°${pad2(min)}′` };
      }
      function aspectBetween(a,b){
        const AS=[{k:"Conjunction",a:0,orb:6},{k:"Sextile",a:60,orb:4},{k:"Square",a:90,orb:5},{k:"Trine",a:120,orb:5},{k:"Opposition",a:180,orb:6}];
        const d=Math.abs(norm360(a-b)); const dist=Math.min(d,360-d);
        for(const as of AS){ const delta=Math.abs(dist-as.a); if (delta<=as.orb) return {kind:as.k, orb:`${delta.toFixed(2)}°`}; }
        return null;
      }

      // ---------- data loader: try JSON → fallback to local compute ----------
      const ASTRO_URL=new URL('assets/data/astro-now.json', document.baseURI).toString();

      function computeLocal(){
        const {tz, dateUTC}=zonedUTC();
        const JD=toJD(dateUTC);
        const pack={
          tz,
          stamp: dateUTC.toISOString().slice(0,16).replace('T',' '),
          source: 'Local (Meeus/Schlyter)',
          planets:{}
        };
        const sunLon = sunLonJD(JD);
        const moonLon= moonLonJD(JD);
        pack.planets.sun = { lon:sunLon,  ...signFromLon(sunLon) };
        pack.planets.moon= { lon:moonLon, ...signFromLon(moonLon) };
        ['Mercury','Venus','Mars','Jupiter','Saturn'].forEach(n=>{
          const L=planetGeoLon(n, JD);
          pack.planets[n.toLowerCase()]={ lon:L, ...signFromLon(L) };
        });
        const asp = aspectBetween(sunLon, moonLon);
        pack.aspects = asp ? [ { pair:'Sun–Moon', kind:asp.kind, orb:asp.orb } ] : [];
        return pack;
      }

      async function loadAstro(){
        const {tz, dateUTC}=zonedUTC();
        const iso=dateUTC.toISOString();
        try{
          const u=new URL(ASTRO_URL);
          u.searchParams.set('datetime', iso);
          u.searchParams.set('tz', tz);
          const res=await fetch(u.toString(), {cache:'no-store', mode:'cors'});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const raw=await res.json();
          const data = normalize(raw, {tz, iso});
          coerceLongs(data.planets);
          renderAstro(data);
        }catch(err){
          console.warn('[Astro] Falling back to local compute:', err);
          renderAstro(computeLocal());
        }
      }

      function normalize(raw,q){
        if(raw && raw.planets && typeof raw.planets==='object') return raw;
        if(raw && raw.positions){
          const planets={};
          Object.entries(raw.positions).forEach(([name,p])=>{
            planets[name.toLowerCase()]={ lon:+p.lon, text:p.dms||p.text||signFromLon(+p.lon).text, sign:p.sign||signFromLon(+p.lon).sign };
          });
          return { tz:raw.tz||q.tz, stamp:raw.stamp||q.iso.slice(0,16).replace('T',' '), source:raw.source||'Swiss Ephemeris', planets, aspects:Array.isArray(raw.aspects)?raw.aspects:[] };
        }
        if(raw && Array.isArray(raw.bodies)){
          const planets={};
          raw.bodies.forEach(b=>{
            const k=String(b.name||'').toLowerCase();
            if(!k) return;
            const lon=typeof b.lon==='number'?b.lon:parseFloat(b.lon);
            planets[k]={ lon, text:b.dms||b.text||signFromLon(lon).text, sign:b.sign||signFromLon(lon).sign };
          });
          return { tz:raw.tz||q.tz, stamp:raw.stamp||q.iso.slice(0,16).replace('T',' '), source:raw.source||'Your Ephemeris', planets, aspects:Array.isArray(raw.aspects)?raw.aspects:[] };
        }
        return computeLocal();
      }
      function coerceLongs(obj){
        if(!obj) return;
        for(const k of Object.keys(obj)){
          const v=obj[k]; if(!v) continue;
          let L=typeof v.lon==='number'?v.lon:parseFloat(v.lon);
          if(Number.isFinite(L)) v.lon=((L%360)+360)%360;
        }
      }

      // ---------- events ----------
      document.addEventListener('DOMContentLoaded', ()=>{
        buildWheel();
        loadAstro();
      });
      window.addEventListener('resize', buildWheel, {passive:true});
      document.getElementById('tzPick')   ?.addEventListener('change', loadAstro, {passive:true});
      document.getElementById('datePick') ?.addEventListener('change', loadAstro, {passive:true});
      document.getElementById('hourScrub')?.addEventListener('input',  loadAstro, {passive:true});
    })();
    </script>
    <!-- ===== /Inline Astro engine ===== -->

    <!-- Practices -->
    <article class="card col-6" id="practiceCard" aria-labelledby="prac-head">
      <h2 id="prac-head">Practices & Prompts</h2>
      <ol id="practiceList" class="prompts"></ol>
      <label class="meta" for="noteText" style="display:block;margin-top:10px">Your note for this moon</label>
      <textarea id="noteText" placeholder="What are you tracking, learning, releasing?" aria-label="Note for this moon"></textarea>
      <div class="lab-row" style="margin-top:8px">
        <button class="lab-btn" id="btnSaveNote" type="button">Save note</button>
      </div>
    </article>

    <!-- Codex -->
    <section class="codex card shine" id="loreCodex" aria-label="Moon Codex">
      <aside class="codex-toc" aria-label="Codex contents">
        <h4>Codex</h4>
        <ol>
          <li><a href="#cx-intro">Introduction</a></li>
          <li><a href="#cx-practice">Practices</a></li>
          <li><a href="#cx-notes">Notes & Footnotes</a></li>
        </ol>
      </aside>

      <article class="codex-content">
        <h1 id="cx-intro">The Remnant Moon Codex</h1>
        <p class="lede dropcap">A living scroll of patterns, pulses, and presence — meant to be read like a sky.</p>

        <div class="callout info">
          <div class="head">Essence</div>
          <div class="body">Channel inspiration. Harmonize integrity. Perfect manifestation.</div>
        </div>

        <blockquote class="pull">“Number the days; crown the weeks; keep the remnant bright.”</blockquote>

        <figure>
          <img src="assets/media/codex-example.jpg" alt="Codex plate showing harmonics of the 13×28 count">
          <figcaption>Plate VII — Harmonics of the 13×28 count.</figcaption>
        </figure>

        <h2 id="cx-practice">Practice</h2>
        <p>Mark the day’s tone in your journal. Tap the <span class="kbd">T</span> key to step hours; <span class="kbd">↑/↓</span> to step days.</p>

        <h3 id="cx-notes">Notes & Footnotes</h3>
        <hr>
        <ol class="footnotes">
          <li id="fn1">On leap days and DOOT handling — see script options. <a href="#fnref1">↩</a></li>
        </ol>

        <!-- Example codex files -->
        <div class="codex-files" id="codexFiles">
          <div class="file" data-ext="PDF" role="button" tabindex="0" aria-label="Open PDF: Codex · Resonant Harmonies">
            <div class="file-top">
              <div class="name">Codex · Resonant Harmonies</div>
              <span class="badge"><i class="dot" aria-hidden="true"></i> plate</span>
            </div>
            <div class="file-meta">
              <span class="pill">2.3 MB</span>
              <span class="pill">Updated this moon</span>
            </div>
          </div>

          <div class="file" data-ext="MD" role="button" tabindex="0" aria-label="Open notes: Codex · Praxis Notes">
            <div class="file-top">
              <div class="name">Codex · Praxis Notes</div>
              <span class="badge"><i class="dot" aria-hidden="true"></i> notes</span>
            </div>
            <div class="file-meta">
              <span class="pill">12 min read</span>
              <span class="pill">v1.4</span>
            </div>
          </div>
        </div>
      </article>
    </section>
  </main>

  <footer class="footer">
    <div class="divider" aria-hidden="true"></div>
    <p class="meta">© <span id="yr">2025</span> Aaron Paul Laird — Scroll of Fire • BY-NC 4.0</p>
  </footer>

  <noscript>
    <p class="meta" style="text-align:center">This page needs JavaScript to calculate moon/day, phase, and year map.</p>
  </noscript>

  <!-- Page JS (external; v3.9 fixes phase selector and drives accents) -->
  <script src="assets/js/moons.js?v=3.9" defer></script>

  <!-- Mini glue: moonbar sync, share-card, deep link, keyboard, SW -->
  <script>
  (function(){
    "use strict";

    const arcMain = document.getElementById("moonArc");
    const arcMini = document.getElementById("moonArcMini");
    const mbName  = document.getElementById("mbName");
    const mbDay   = document.getElementById("mbDay");
    const mbEss   = document.getElementById("mbEssence");
    const mbYear  = document.getElementById("mbYear");
    const noteBox = document.getElementById("noteText");
    const jumpSel = document.getElementById("jumpMoon");

    const moonChip   = document.getElementById("moonChip");
    const moonName   = document.getElementById("moonName");
    const moonEss    = document.getElementById("moonEssence");
    const dayInMoon  = document.getElementById("dayInMoon");
    const yearSpan   = document.getElementById("yearSpan");

    const tzPick = document.getElementById("tzPick");
    const datePick = document.getElementById("datePick");
    const hourScrub = document.getElementById("hourScrub");
    const openSeal = document.getElementById("openSeal");
    const openSealHeader = document.getElementById("openSealHeader");

    const prevBtn = document.getElementById("prevDay");
    const nextBtn = document.getElementById("nextDay");
    const todayBtn= document.getElementById("btnToday");

    const cssVar = (name, fb) => getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fb;
    const dl = (name, blob)=>{
      const a=document.createElement("a"); a.download=name; a.href=URL.createObjectURL(blob);
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 400);
    };

    function syncMini(){
      if (mbName && moonName)  mbName.textContent = moonName.textContent || "—";
      if (mbEss  && moonEss)   mbEss.textContent  = moonEss.textContent  || "—";
      if (mbDay  && dayIn…Moon) mbDay.textContent  = (dayInMoon.textContent||"—") + "/28"; if (mbYear && yearSpan)  mbYear.textContent = yearSpan.textContent || "—";

const mainDash = arcMain?.getAttribute("stroke-dasharray");
  if (arcMini && mainDash) arcMini.setAttribute("stroke-dasharray", mainDash);

  const idx = moonChip?.getAttribute("data-idx");
  if (idx && noteBox){
    const saved = localStorage.getItem(`sof_moon_note_${idx}`) || "";
    if (noteBox.value !== saved) noteBox.value = saved;
  }
}

// run once after paint and keep in sync
setTimeout(syncMini, 60);
const mo = new MutationObserver(syncMini);
arcMain   && mo.observe(arcMain,   {attributes:true, attributeFilter:["stroke-dasharray"]});
moonChip  && mo.observe(moonChip,  {childList:true, subtree:true, attributes:true});
yearSpan  && mo.observe(yearSpan,  {childList:true, characterData:true, subtree:true});
document.addEventListener("sof:accent-change", syncMini);

// jump to moon in page
function jump(){ const v = jumpSel?.value; if (v){ location.hash = `#moon-${v}`; } }
jumpSel?.addEventListener("change", jump, {passive:true});

// share card (square PNG)
async function makeShareCard(){
  const w=1080, h=1080, c=document.createElement("canvas"); c.width=w; c.height=h;
  const k=c.getContext("2d");
  const c1=cssVar("--moon-accent","#7af3ff"), c2=cssVar("--moon-accent-2","#f3c97a");

  const g=k.createLinearGradient(0,0,0,h); g.addColorStop(0,"#0a0e15"); g.addColorStop(1,"#06080d");
  k.fillStyle=g; k.fillRect(0,0,w,h);

  const g2=k.createLinearGradient(0,0,w,0); g2.addColorStop(0,c1+"22"); g2.addColorStop(.5,c2+"18"); g2.addColorStop(1,c1+"22");
  k.fillStyle=g2; k.beginPath(); k.moveTo(0,240);
  for(let x=0;x<=w;x+=24){ k.lineTo(x,240+Math.sin(x*0.006)*20); }
  k.lineTo(w,0); k.lineTo(0,0); k.closePath(); k.fill();

  k.fillStyle="#e9eef6"; k.font="800 56px Inter, system-ui";
  k.fillText("Remnant 13 Moons — Living Clock", 64, 112);

  const name=(moonName?.textContent||"—").trim();
  const essence=(moonEss?.textContent||"—").trim();
  const dayTxt=((dayInMoon?.textContent||"—").trim())+" / 28";
  const yearTxt=(yearSpan?.textContent||"—").trim();
  const sub=document.getElementById("phaseLine")?.textContent?.trim()||"";

  k.font="800 92px Inter, system-ui"; k.fillText(name, 64, 260);
  k.font="600 40px Inter, system-ui"; k.fillStyle="#c9d3e9"; k.fillText(essence, 64, 320);

  k.fillStyle="#0f1116"; k.strokeStyle="#2a3242"; k.lineWidth=2;
  function chip(x,y,txt){
    const padX=18; k.font="800 38px Inter, system-ui";
    const mw=k.measureText(txt).width, cw=mw+padX*2, ch=56;
    k.beginPath(); k.roundRect(x,y,cw,ch,12); k.fill(); k.stroke();
    k.fillStyle="#e9eef6"; k.fillText(txt, x+padX, y+40); k.fillStyle="#0f1116";
    return x+cw+10;
  }
  let cx=64; cx=chip(cx,370,dayTxt); cx=chip(cx,370,yearTxt); chip(cx,370, sub || "—");

  k.font="600 32px Inter, system-ui"; k.fillStyle="#a8b1c9";
  k.fillText("scroll-of-fire · ssnfts24.github.io/scroll-of-fire", 64, h-64);

  const blob=await new Promise(res=>c.toBlob(res,"image/png",0.96));
  if (blob) dl(`13-moons-${name.replace(/\s+/g,"-").toLowerCase()}.png`, blob);
}
document.getElementById("btnShareImage")?.addEventListener("click", makeShareCard, {passive:true});

// notes
document.getElementById("btnSaveNote")?.addEventListener("click", ()=>{
  const idx = document.getElementById("moonChip")?.getAttribute("data-idx"); if(!idx) return;
  localStorage.setItem(`sof_moon_note_${idx}`, document.getElementById("noteText")?.value || "");
  const t=document.createElement("div"); t.className="toast"; t.textContent="Note saved";
  Object.assign(t.style,{
    position:"fixed",left:"50%",bottom:"24px",transform:"translateX(-50%)",
    background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid var(--line)",
    borderRadius:"10px",boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:"9999",opacity:"0",transition:"opacity .2s"
  });
  document.body.appendChild(t); requestAnimationFrame(()=>t.style.opacity=1);
  setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),250); }, 1400);
}, {passive:true});

// veil accent based on CSS vars
function refreshVeil(){
  const c1=cssVar("--moon-accent","#7af3ff");
  const c2=cssVar("--moon-accent-2","#f3c97a");
  const veil=`conic-gradient(from 0deg at 50% 50%, ${c1}24, transparent, ${c2}20, transparent)`;
  document.documentElement.style.setProperty("--remnant-veil", veil);
}
document.addEventListener("sof:accent-change", refreshVeil);
refreshVeil();

// deep link for Birth Seal
function buildSealLink(){
  const base = "genesis-oracle.html";
  const tz = (tzPick && tzPick.value) || Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
  const now = new Date();
  const dateStr = (datePick && datePick.value) || new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const hour = (hourScrub && hourScrub.value) ? String(hourScrub.value) : String(now.getHours());
  const u = new URL(base, document.baseURI || location.href);
  u.searchParams.set("d", dateStr);
  u.searchParams.set("tz", tz);
  u.searchParams.set("t", hour);
  const moonIdx = document.getElementById("moonChip")?.getAttribute("data-idx");
  if (moonIdx) u.hash = `moon-${moonIdx}`;
  return u.toString();
}
function applySealHref(a){ if (a) a.setAttribute("href", buildSealLink()); }
["change","input"].forEach(evt=>{
  tzPick?.addEventListener(evt, ()=>{ applySealHref(openSeal); applySealHref(openSealHeader); }, {passive:true});
  datePick?.addEventListener(evt, ()=>{ applySealHref(openSeal); applySealHref(openSealHeader); }, {passive:true});
  hourScrub?.addEventListener(evt, ()=>{ applySealHref(openSeal); applySealHref(openSealHeader); }, {passive:true});
});
applySealHref(openSeal); applySealHref(openSealHeader);

// keyboard shortcuts
document.addEventListener("keydown", (e)=>{
  if (e.target && /input|select|textarea/i.test(e.target.tagName)) return;
  if (e.key === "ArrowRight" || e.key === "PageDown"){ nextBtn?.click(); e.preventDefault(); }
  if (e.key === "ArrowLeft"  || e.key === "PageUp"){   prevBtn?.click(); e.preventDefault(); }
  if (e.key === "ArrowUp"){   let v=+hourScrub.value||0; hourScrub.value=Math.min(23,v+1); hourScrub.dispatchEvent(new Event("input")); e.preventDefault(); }
  if (e.key === "ArrowDown"){ let v=+hourScrub.value||0; hourScrub.value=Math.max(0,v-1);  hourScrub.dispatchEvent(new Event("input")); e.preventDefault(); }
  if (e.key.toLowerCase() === "t"){ todayBtn?.click(); e.preventDefault(); }
  if (e.key.toLowerCase() === "s"){ document.getElementById("btnShareImage")?.click(); e.preventDefault(); }
});

// footer year + PWA
const yEl=document.getElementById("yr"); if(yEl){ yEl.textContent = String(new Date().getFullYear()); }
if ("serviceWorker" in navigator){
  try { navigator.serviceWorker.register("assets/sw.js").catch(()=>{}); } catch(_){}
}

})(); </script>

</body>
</html>
