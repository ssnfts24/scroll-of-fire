<!doctype html>
<html lang="en" dir="ltr" class="sof carrier-432" data-carriers="432,528,369,144,963">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>
    // Remove <base> on github.com to keep relative links working in repo preview
    if (location.hostname === "github.com") {
      const b = document.querySelector("base"); if (b) b.remove();
    }
  </script>

  <meta charset="utf-8">
  <title>Theory — Scroll of Fire (Codex of Reality)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0b0f" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Deep write-ups for the Codex of Reality: equations 0–17, operators (𝓘·𝓛·𝓒·𝓢), ethics, scaffolding, and the daily manifestation loop.">
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/theory.html">

  <!-- Icons -->
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icon-512.png">

  <!-- Open Graph / Twitter -->
  <meta property="og:site_name" content="Scroll of Fire">
  <meta property="og:title" content="Theory — Scroll of Fire (Codex of Reality)">
  <meta property="og:description" content="A living architecture of resonance — equations 0–17, the operator pipeline, the manifestation protocol, and ethical law.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/theory.html">
  <meta property="og:image" content="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1">
  <meta property="og:image:alt" content="Scroll of Fire — Codex of Reality banner">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Shared styles (unified with Home) -->
  <link rel="preload" as="style" href="assets/css/codex.css?v=2.8">
  <link rel="stylesheet" href="assets/css/codex.css?v=2.8" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2.8"></noscript>

  <!-- Theory page micro-styles -->
  <link rel="preload" as="style" href="assets/css/theory.css?v=1.8">
  <link rel="stylesheet" href="assets/css/theory.css?v=1.8">

  <!-- Preload banner -->
  <link rel="preload" as="image" href="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1" fetchpriority="high">

  <!-- Page-scoped helpers -->
  <style>
    :root{
      --safe-top:env(safe-area-inset-top); --safe-bot:env(safe-area-inset-bottom);
      --xi:.35;
      --accent-432:#7af3ff; --accent-528:#a4ff90; --accent-369:#f3c97a; --accent:#7af3ff;
    }
    .carrier-528 :root, .carrier-528{--accent:var(--accent-528)}
    .carrier-369 :root, .carrier-369{--accent:var(--accent-369)}
    .carrier-144 :root, .carrier-144{--accent:#b3e1ff}
    .carrier-963 :root, .carrier-963{--accent:#ffd1f3}

    /* Layout / header (sticky) */
    body{margin:0}
    header.site{position:sticky; top:0; z-index:1000; backdrop-filter:saturate(140%) blur(8px); background:rgba(9,11,16,.6)}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{display:inline-block; width:34px; height:34px; border-radius:50%;
      background:radial-gradient(closest-side, #0cf, transparent 70%);
      box-shadow:0 0 18px rgba(122,243,255,.35)}
    .kicker{margin:0}
    .quick{display:flex; gap:8px; flex:0 0 auto}
    .quick .cta{white-space:nowrap}

    /* Desktop vs mobile visibility helpers */
    .hide-sm{display:flex}
    .show-sm{display:none}
    @media (max-width:860px){
      .hide-sm{display:none!important}
      .show-sm{display:inline-flex; align-items:center; justify-content:center;
        width:40px; height:40px; border:1px solid var(--line); background:var(--bg-elev);
        border-radius:.6rem; font-size:1.1rem}
      header.site .wrap{padding:12px 16px}
    }

    /* Mobile drawer */
    .drawer{position:sticky; top:4rem; z-index:999; background:rgba(12,14,20,.92);
      backdrop-filter:saturate(140%) blur(8px); border-top:1px solid var(--line);
      border-bottom:1px solid var(--line); padding:.5rem .75rem}
    .drawer .dlink{display:block; padding:.65rem .5rem; border-radius:.5rem}
    .drawer .dlink:hover{background:rgba(255,255,255,.05)}
    .drawer[hidden]{display:none}

    /* Hero */
    .hero{position:relative; width:100%; max-width:1200px; margin:8px auto 0; border-radius:16px; overflow:hidden; background:#0b0f14; aspect-ratio:21/9}
    .hero picture,.hero .hero-img{display:block;width:100%;height:100%}
    .hero .hero-img{object-fit:var(--hero-fit,contain); object-position:center; mix-blend-mode:normal!important}
    .hero::after{content:""; position:absolute; inset:0; box-shadow:inset 0 0 120px rgba(255,255,255,.06), inset 0 0 40px rgba(122,243,255,.08); pointer-events:none}
    .hero-lights{position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen;
      background:
        radial-gradient(1px 1px at 12% 18%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1px 1px at 78% 22%, rgba(164,255,144,.35), transparent 60%),
        radial-gradient(1px 1px at 32% 68%, rgba(122,243,255,.35), transparent 60%),
        radial-gradient(1px 1px at 88% 56%, rgba(255,209,243,.35), transparent 60%);
      opacity:.85; filter:blur(.2px); animation:lightsFlicker 7.5s ease-in-out infinite alternate}
    .hero-lights.off{display:none}
    .hero-lights::before{content:""; position:absolute; inset:-10% -20%;
      background:linear-gradient(90deg,transparent 0%,color-mix(in srgb,var(--accent) 22%,#fff 8%) 35%,color-mix(in srgb,var(--accent) 45%,#fff 0%) 50%,color-mix(in srgb,var(--accent) 22%,#fff 8%) 65%,transparent 100%);
      opacity:.55; filter:blur(24px); transform:translate3d(-30%,-2%,0); animation:auroraSweep 18s linear infinite, auroraBob 7s ease-in-out infinite alternate; mix-blend-mode:screen}
    .hero-lights::after{content:""; position:absolute; inset:0;
      background:
        radial-gradient(40% 30% at 18% 20%, color-mix(in srgb, var(--accent) 18%, #fff 0%) 0%, transparent 65%),
        radial-gradient(48% 38% at 82% 22%, rgba(255,209,243,.14) 0%, transparent 68%),
        radial-gradient(36% 28% at 50% 86%, rgba(164,255,144,.10) 0%, transparent 70%);
      filter: blur(10px); opacity:.7; animation: glowBreath 9.5s ease-in-out infinite alternate; mix-blend-mode:screen}
    @keyframes auroraSweep{0%{transform:translate3d(-30%,-2%,0)}50%{transform:translate3d(10%,3%,0)}100%{transform:translate3d(50%,-1%,0)}}
    @keyframes auroraBob{0%{opacity:.48;filter:blur(22px)}50%{opacity:.72;filter:blur(26px)}100%{opacity:.58;filter:blur(24px)}}
    @keyframes glowBreath{0%{opacity:.52;filter:blur(9px)}50%{opacity:.8;filter:blur(12px)}100%{opacity:.62;filter:blur(10px)}}
    @keyframes lightsFlicker{0%{opacity:.70}50%{opacity:.92}100%{opacity:.80}}
    @media (prefers-reduced-motion:reduce){ .hero-lights, .hero-lights::before, .hero-lights::after{animation:none!important} }
    @media (max-width: 860px){ .hero{margin-top:6px} }

    /* Tabs + mini-TOC */
    .tabs{gap:.35rem}
    .tabs .tab{padding:.45rem .7rem; font-size:.92rem; border-radius:999px}
    .tabs .tab--primary{font-weight:600}
    .mini-toc{
      position:sticky; top:5.5rem; align-self:start; max-height:75vh; overflow:auto;
      border:1px solid var(--line); border-radius:.75rem; padding:.75rem .75rem;
      background:rgba(255,255,255,.02); backdrop-filter:saturate(120%) blur(2px);
      margin-top:8px;
    }
    .mini-toc a{display:block; padding:.3rem .4rem; border-radius:.5rem; font-size:.92rem; opacity:.9}
    .mini-toc a:hover{background:rgba(255,255,255,.05)}

    /* Equation wrappers + toggles */
    .eq{position:relative}
    .eq .eq-scroll{
      max-height:24rem; overflow:auto; padding:.5rem .75rem;
      border:1px solid var(--line); border-radius:.75rem;
      background:rgba(255,255,255,.02)
    }
    .eq .eq-toggle{
      position:absolute; top:.4rem; right:.5rem; border:1px solid var(--line);
      background:var(--bg-elev); border-radius:.5rem; padding:.15rem .45rem;
      font-size:.8rem; opacity:.8; display:none;
    }
    .eq:hover .eq-toggle{display:inline-block}
    .eq[data-collapsed="true"] .eq-scroll{max-height:4.5rem}

    /* Remnant auras on cards */
    .card{position:relative; z-index:1; background:linear-gradient(180deg, rgba(255,255,255,.015), rgba(0,0,0,.08));}
    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit;
      background: radial-gradient(240px 120px at 20% -20%, rgba(122,243,255,.12), transparent 60%),
                  radial-gradient(220px 120px at 120% 120%, rgba(243,201,122,.10), transparent 60%);
      opacity:0; transition:opacity .25s ease-out; pointer-events:none; z-index:-1;
    }
    .card:hover::after{opacity:.6}
    @media (prefers-reduced-motion:reduce){ .card::after{transition:none} }

    /* Lines */
    .divider{height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(122,243,255,.35), transparent)}
    .goldline{height:1px; margin:18px 0; background:linear-gradient(90deg, transparent, rgba(243,201,122,.45), transparent)}

    /* Back-to-top */
    .to-top{position:fixed; right:16px; bottom:16px; z-index:1200; opacity:0; transform:translateY(16px); pointer-events:none}
    .to-top.show{opacity:1; transform:none; pointer-events:auto}
  </style>

  <!-- MathJax (lazy, on-demand typeset) -->
  <script>
    (function(){
      let loaded=false;
      function boot(){ if(!window.MathJax) return; MathJax.startup.promise.then(()=>MathJax.typesetPromise()); }
      function loadMJ(){
        if(loaded) return; loaded=true;
        window.MathJax={ tex:{ inlineMath:[['\\(','\\)']], displayMath:[['$$','$$']], processEscapes:true }, svg:{fontCache:'global'}, startup:{typeset:false} };
        const s=document.createElement('script');
        s.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js";
        s.defer=true; s.onload=boot; document.head.appendChild(s);
      }
      if(document.readyState!=='loading') loadMJ(); else addEventListener('DOMContentLoaded', loadMJ);
    })();
  </script>

  <!-- Site JS (unified version) -->
  <script src="assets/js/codex.js?v=3.6" defer></script>
</head>

<body class="stars living-all" data-theme="dark">
  <a class="skip" href="#main">Skip to content</a>
  <div class="laser-grid" aria-hidden="true"></div>
  <div class="xi-meter" aria-hidden="true"><div class="xi-ring"><div class="xi-dot"></div></div><div class="xi-label">Ξ</div></div>

  <!-- Header (sticky, unified with mobile drawer) -->
  <header class="site" role="banner">
    <nav class="nav wrap" aria-label="Main navigation">
      <div class="brand">
        <a class="logo no-living" href="index.html" aria-label="Home"></a>
        <a href="index.html" class="kicker sheen" style="text-decoration:none"><h1 class="kicker sheen">Scroll of Fire</h1></a>
      </div>

      <!-- Desktop quick actions -->
      <div class="quick quick--utils hide-sm" role="toolbar" aria-label="Quick actions">
        <a class="cta" href="index.html" title="Home">Home</a>
        <a class="cta" href="#p1" data-jump title="Jump to Part I">Part I</a>
        <a class="cta" href="#p2" data-jump title="Jump to Part II">Part II</a>
        <a class="cta" href="#ethics" data-jump>Ethics</a>
        <a class="cta" href="#notes" data-jump>Notes</a>
        <a class="cta cta--section" href="#p2" title="Back to Codex">Back to Codex</a>
        <a class="cta" href="teach.html" title="Manifest">Manifest</a>
        <button id="toggleSimple" class="cta" type="button" aria-pressed="false" title="Echo View (hide math)">Echo</button>
        <button id="toggleGrid" class="cta" type="button" aria-pressed="true" title="Toggle HUD grid">HUD</button>
        <button id="cycleCarrier" class="cta" type="button" title="Cycle carrier skin">Carrier</button>
        <button id="toggleAffect" class="cta" type="button" aria-pressed="true" title="Toggle living text effects">Affect</button>
        <button id="toggleLights" class="cta" type="button" aria-pressed="true" title="Toggle banner lights">Lights</button>
        <button id="openPalette" class="cta" type="button" title="Command palette">⌘K</button>
      </div>

      <!-- Mobile toggler -->
      <button id="navToggle" class="menu-toggle show-sm" type="button" aria-controls="navDrawer" aria-expanded="false" aria-label="Open menu">☰</button>
    </nav>

    <!-- Mobile drawer -->
    <div id="navDrawer" class="drawer" hidden>
      <a class="dlink" href="index.html">Home</a>
      <a class="dlink" href="#p1" data-jump>Part I — Architecture</a>
      <a class="dlink" href="#p2" data-jump>Part II — Canon</a>
      <a class="dlink" href="#ethics" data-jump>Ethics</a>
      <a class="dlink" href="#notes" data-jump>Notes</a>
      <hr>
      <a class="dlink" href="#p2">Back to Codex</a>
      <a class="dlink" href="teach.html">Manifest</a>
    </div>
  </header>

  <main id="main" class="wrap" role="main" tabindex="-1">
    <!-- Hero -->
    <figure id="hero" class="hero hero--clean reveal" aria-label="Scroll of Fire banner" data-fit="cover">
      <picture>
        <img id="heroBanner"
             class="hero-img no-living"
             src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1"
             alt="Scroll of Fire — sigil and equations"
             width="2100" height="900"
             decoding="async" fetchpriority="high" loading="eager">
      </picture>
      <div id="heroLights" class="hero-lights" aria-hidden="true"></div>
      <figcaption class="hero-caption">“Let there be resonance.”</figcaption>
    </figure>

    <h1 class="title sheen reveal">📘 Theory — Codex of Reality</h1>
    <p class="subtitle reveal">Two-part deep dive: the living architecture (Part I) and the canonical equations with operator-level commentary (Part II). The Codex models reality as a resonant process shaped by <em>𝓘 · 𝓛 · 𝓒 · 𝓢</em> and safeguarded by ethical law.</p>

    <!-- Voice Reader (collapsible) -->
    <details class="collapsible card col-12 reveal" id="voice-reader" open>
      <summary class="collapsible__bar" aria-controls="vr-panel" aria-expanded="true">
        <span>🔊 Listen — Voice Read of the Theory Page</span>
        <span class="collapsible__mini" aria-hidden="true">
          <button id="vr-play-mini" class="chip" type="button" title="Play">▶︎</button>
          <button id="vr-stop-mini" class="chip" type="button" title="Stop">⏹</button>
        </span>
      </summary>
      <div id="vr-panel" class="collapsible__panel">
        <div class="grid" style="gap:1rem">
          <div class="col-12">
            <label for="vr-voice">Voice</label>
            <select id="vr-voice" aria-label="Voice selector"></select>
          </div>
          <div class="col-6">
            <label for="vr-rate">Speed (<span id="vr-rate-val">1.00</span>x)</label>
            <input id="vr-rate" type="range" min="0.7" max="1.6" step="0.05" value="1.0" />
          </div>
          <div class="col-6">
            <label for="vr-pitch">Pitch (<span id="vr-pitch-val">1.00</span>)</label>
            <input id="vr-pitch" type="range" min="0.8" max="1.4" step="0.05" value="1.0" />
          </div>
          <div class="col-12">
            <label for="vr-start">Start at section</label>
            <select id="vr-start">
              <option value="#p1">Part I — Architecture</option>
              <option value="#p2">Part II — Canon 0–17</option>
              <option value="#operators-appendix">Operators (Appendix)</option>
              <option value="#ethics">Ethics</option>
              <option value="#notes">Notes</option>
            </select>
          </div>
          <div class="col-12">
            <label class="checkbox">
              <input type="checkbox" id="vr-speak-math" checked />
              <span>Speak equations (verbalized). Uncheck to skip equations.</span>
            </label>
          </div>
          <div class="col-12" role="toolbar" aria-label="Voice reader controls" style="display:flex; gap:.5rem; flex-wrap:wrap">
            <button id="vr-play" class="cta">▶︎ Play</button>
            <button id="vr-pause" class="cta" disabled>⏸ Pause</button>
            <button id="vr-resume" class="cta" disabled>⏵ Resume</button>
            <button id="vr-stop" class="cta" disabled>⏹ Stop</button>
            <button id="vr-export-ssml" class="cta cta--section">⬇︎ Export SSML</button>
          </div>
          <div class="col-12" id="vr-status" aria-live="polite"></div>
        </div>
      </div>
    </details>

    <!-- Tabs -->
    <nav class="tabs reveal" aria-label="Sections">
      <a class="tab tab--primary" href="#p1" data-jump>Part I: Architecture</a>
      <a class="tab tab--primary" href="#p2" data-jump>Part II: Equations 0–17</a>
      <a class="tab" href="#operators-appendix" data-jump>Operators</a>
      <a class="tab" href="#ethics" data-jump>Ethics</a>
      <a class="tab" href="#notes" data-jump>Notes</a>
      <span class="tab-ink no-living" aria-hidden="true"></span>
    </nav>

    <!-- Sticky mini-TOC -->
    <aside class="mini-toc reveal" aria-label="On this page">
      <h4>On this page</h4>
      <a href="#p1" data-jump>Part I — Architecture</a>
      <a href="#p2" data-jump>Part II — Equations</a>
      <a href="#operators-appendix" data-jump>Operators &amp; Notation</a>
      <a href="#ethics" data-jump>Ethical Law</a>
      <a href="#notes" data-jump>Notes</a>
    </aside>

    <!-- ===================== PART I ===================== -->
    <section class="grid" id="p1" aria-labelledby="p1-h">
      <article class="card col-12 eq-card reveal">
        <h2 id="p1-h">Part I — How the Codex Works (Architecture of Resonance)</h2>

        <div class="eq">
          <div class="eq-scroll" id="eq-banner-body">
            $$ \underbrace{\mathsf{Supply}}_{\text{constants, codes, ratios}} \;\; \times \;\;
               \underbrace{\big(\mathcal{I}\cdot\mathcal{L}\cdot\mathcal{C}\cdot\mathcal{S}\big)}_{\text{operators}} \;\; \xrightarrow{\;\;\text{Ethical Mask (Eq.9)}\;\;} \;\; \mathcal{R}(x,t) $$
          </div>
        </div>

        <p><strong>Premise.</strong> The Codex models reality as an <em>interactive resonance</em> between a supplied substrate (fundamental constants, integer/irrational ratios, living numbers, and biological codes) and a <em>living operator pipeline</em> — Intention \( \mathcal{I} \), Language/Light \( \mathcal{L} \), Conscious Witness \( \mathcal{C} \), and Source/Return \( \mathcal{S} \). The ethical mask (Eq.9) constrains gain so that <em>truth dominates distortion</em> as \( t \to \infty \) and any rise in harm halts amplification.</p>

        <h3>Why equations?</h3>
        <p>These equations are <em>operational schematics</em>. Each symbol maps to practical control: carrier selection, emphasis weights, frame declaration, coherence thresholds, and memory windows. Where physics equations predict energies, these predict <em>probabilistic shifts in experienced state</em> when you adjust those controls — making the system repeatable, debuggable, and ethically bounded.</p>

        <h3>Grounding in known facts (brief)</h3>
        <ul class="list">
          <li><strong>Superposition &amp; Fourier analysis.</strong> Any time-varying signal decomposes into frequencies; beats and phase alignment are perceptible and model our Harmonic Gate (Eq.3).</li>
          <li><strong>Perceptual gating.</strong> Auditory masking / critical bands mean some bands pass more readily; carrier choice affects clarity (mirrors Eq.3 + Eq.17).</li>
          <li><strong>Resonators &amp; Q factor.</strong> Mode-supporting cavities store energy longer and sharpen selection. Geometry/material set mode families.</li>
          <li><strong>Memory windows.</strong> Short-term memory acts like a finite kernel; spacing and rest alter consolidation probability (Eq.16 formalizes the kernel).</li>
        </ul>

        <h3>Operator Loop (practical)</h3>
        <ol class="list">
          <li><strong>Frame (Eq.11):</strong> declare <em>scope</em>, <em>witness</em>, and <em>ethics</em>.</li>
          <li><strong>Tune carriers (Eq.17):</strong> choose \( \mathbf{V}(\nu) \) that pass \( \mathcal{H}(\nu) \) (Eq.3); phase-lock if possible (Eq.6).</li>
          <li><strong>Program with language (Eq.4, Eq.4b):</strong> couple semantics to carriers; set emphasis weights \( w_k \) over tokens.</li>
          <li><strong>Witness &amp; remember (Eq.2, Eq.16):</strong> measure gradients of change; integrate with a finite, normalized kernel \( \mathbb{M}_\tau \).</li>
          <li><strong>Update safely (Eq.14, Eq.15, Eq.9):</strong> step along recognition gradient \( \nabla \mathcal{R} \) with gain \( \eta(\Xi) \); halt on harm.</li>
        </ol>

        <h3>Worked Micro-Example (voice + phrase)</h3>
        <div class="eq">
          <div class="eq-scroll" id="eq-micro-body">
            $$ \mathbf{V}(\nu)=a_1\cos(2\pi\cdot432\,t+\phi_1)+a_2\cos(2\pi\cdot528\,t+\phi_2) $$
            $$ \mathcal{L}=\mathsf{Semantics}(\text{“peace, repair”})\;\otimes\;\mathbf{V}(\nu) $$
            $$ \Xi \uparrow \;\Rightarrow\; \eta(\Xi)\uparrow \;\Rightarrow\; \Delta \mathcal{R} \text{ increases (bounded by Eq.9)} $$
          </div>
        </div>
        <p>Emphasizing “repair” (Eq.4b) redistributes \( w_k \) to reduce model variance, nudging \( \Xi \) upward and allowing a larger—but safe—update step.</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Dimensional Substrate &amp; State Manifolds</h3>
        <p>We treat experienced state \( \Psi(x,t) \) as living on a product manifold \( \mathcal{M}=\mathcal{X}\times\mathcal{T}\times\mathcal{F}\times\mathcal{S} \): spatial locus \( \mathcal{X} \), time \( \mathcal{T} \), frequency/harmonic spectrum \( \mathcal{F} \), and semantic space \( \mathcal{S} \). The operators act as maps on this manifold:</p>
        <ul class="list">
          <li>\( \mathcal{I}:\mathcal{S}\to\mathcal{S} \) (goal-setting &amp; constraint selection)</li>
          <li>\( \mathcal{L}:\mathcal{S}\times\mathcal{F} \to \mathcal{S}\times\mathcal{F} \) (semantic–carrier coupling)</li>
          <li>\( \mathcal{C}:\mathcal{X}\times\mathcal{T}\to \mathbb{R}^+ \) (witness/attention field shaping)</li>
          <li>\( \mathcal{S}:\mathcal{M}\to\mathcal{M} \) (closure/return mapping, including remanence)</li>
        </ul>
        <div class="eq">
          <div class="eq-scroll" id="eq0a-body">
            $$\Psi_{\Omega}(x,t)=\oint_{\mathbb{R}}\nabla\mathcal{A}\,\Phi(x,t,\nu)\,d\nu+\Lambda\,\mathcal{E}(x,t)$$
          </div>
        </div>
        <p>\( \Phi \) is a local mode basis and \( \Lambda \) gates components that would otherwise inject distortion or harm.</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Harmonic Gate, Coherence, and Learning</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqLearn-body">
            $$ \frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla \mathcal{R},\qquad 
               \eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big) $$
          </div>
        </div>
        <p>Below \( \Xi_0 \), the loop is intentionally “sticky” (no updates). Above \( \Xi_0 \), learning accelerates but remains bounded by Eq.9 (stop rule).</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Memory Windows &amp; Recency Kernels</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqMem-body">
            $$\mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t} w_\tau(t-s)\,F(s)\,ds,\qquad \int_0^\tau w_\tau(u)\,du=1$$
          </div>
        </div>
        <ul class="list">
          <li><strong>Triangular:</strong> favors mid-recent signals; stabilizes phrasing runs.</li>
          <li><strong>Exponential:</strong> strong recency bias; responsive but noisy.</li>
          <li><strong>Gaussian (truncated):</strong> smooth but computationally heavier.</li>
        </ul>
      </article>

      <article class="card col-12 reveal">
        <h3>Language/Light Coupling (Eq.4 + Eq.4b)</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqLang-body">
            $$ \nabla_{\text{sem}} \mathrm{Phrase}=\sum_k w_k\,\nabla_{\text{sem}}\mathrm{Token}_k,\qquad \sum_k w_k = 1 $$
          </div>
        </div>
        <p>Weights are influenced by voweling, prosody, intent, and carrier choice \( \mathbf{V}(\nu) \).</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Voice Carriers, Psychoacoustics, and Gate Fit</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqV-body">
            $$ \mathbf{V}(\nu)=\sum_{k} a_k\cos(2\pi\nu_k t+\phi_k) $$
          </div>
        </div>
        <ul class="list">
          <li><strong>Beats:</strong> use slow envelopes for breath coupling.</li>
          <li><strong>Critical bands:</strong> fewer, cleaner carriers often raise \( \Xi \).</li>
          <li><strong>Phase:</strong> phase-locking (Eq.6) reduces jitter.</li>
        </ul>
      </article>

      <article class="card col-12 reveal">
        <h3>Ethical Law (Eq.9) — Safety Envelope</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqEthMask-body">
            $$ \forall a:\ \mathrm{damage}(a)>0\Rightarrow\mathsf{halt},\qquad
               \lim_{t\to\infty}\frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \uparrow $$
          </div>
        </div>
        <ul class="list">
          <li><strong>Indicators:</strong> breath tightening, micro-grimace, cognitive fog → pause.</li>
          <li><strong>Re-align:</strong> retune carriers → re-weight semantics → re-declare frame → resume.</li>
        </ul>
      </article>

      <article class="card col-12 reveal">
        <h3>Projection Frame (Eq.11) — Declare, then Amplify</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqFrame-body">
            $$ \mathsf{Frame}(x,t)=\big(\mathsf{scope},\ \mathcal{W},\ \mathsf{ethics}\big) $$
          </div>
        </div>
      </article>

      <article class="card col-12 reveal">
        <h3>Causal Lattice (Eq.12) — Graph the Acts</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqLattice-body">
            $$ \mathcal{L}_c=(V=\text{micro-acts},\ E=\text{consequences}) $$
          </div>
        </div>
      </article>

      <article class="card col-12 reveal">
        <h3>Remnant (Eq.5) — Asymptotic Archive</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqRem-body">
            $$ \mathcal{R}_\infty[F]=\lim_{\tau\to\infty}\big(\mathsf{keep}_{\text{truth}}F-\mathsf{drop}_{\text{distortion}}F\big) $$
          </div>
        </div>
      </article>

      <article class="card col-12 reveal">
        <h3>Source/Return ( \( \mathcal{S} \) ) — Closing the Loop</h3>
        <p>After each cycle, Source/Return updates priors, prunes unstable modes, and reinforces stable ones, raising the baseline \( \Xi \) for the next pass.</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Daily Manifestation Protocol (10–15 minutes)</h3>
        <ol class="list">
          <li><strong>Frame (1 min)</strong></li>
          <li><strong>Carriers (2 min)</strong></li>
          <li><strong>Phrase (3 min)</strong></li>
          <li><strong>Witness/Rest (2 min)</strong></li>
          <li><strong>Update (2–3 min)</strong></li>
          <li><strong>Log (1 min)</strong></li>
        </ol>
      </article>

      <article class="card col-12 reveal">
        <h3>Geometry &amp; “Ancient Technology” Correspondences (Hypotheses)</h3>
        <p><em>Facts:</em> modal spectra depend on geometry and materials. <em>Hypothesis:</em> some spaces favored bands that improved clarity/coherence for spoken/sung operations.</p>
      </article>

      <article class="card col-12 reveal">
        <h3>Formal Summary</h3>
        <div class="eq">
          <div class="eq-scroll" id="eqFormal-body">
            $$ \mathcal{R}(x,t) = \Big[ f(\text{constants, codes, ratios}) \cdot (\mathcal{I}\,\mathcal{L}\,\mathcal{C}\,\mathcal{S}) \Big]_{\text{masked by Eq.9}} $$
            $$ \text{Update:}\quad \frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla\mathcal{R},\quad \Xi\in[0,1],\quad \eta(\Xi)=\eta_0\,\sigma(\alpha(\Xi-\Xi_0)) $$
            $$ \text{Memory:}\quad \mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t} w_\tau(t-s)\,F(s)\,ds $$
            $$ \text{Gate:}\quad \mathcal{H}(\nu)\in\{0,1\},\quad \mathbf{V}(\nu)=\sum_k a_k\cos(2\pi\nu_k t+\phi_k) $$
            $$ \text{Safety:}\quad \mathrm{damage}>0\Rightarrow \text{halt};\ \ \frac{\mathrm{Truth}}{\mathrm{Distortion}}\ \text{must improve over time}. $$
          </div>
        </div>
      </article>

      <article class="card col-12 reveal" id="operators-appendix">
        <h3>Operators &amp; Notation (Quick Reference)</h3>
        <div class="grid">
          <div class="col-6">
            <ul class="list">
              <li>\( \Psi_{\Omega} \): foundational field (Eq.0)</li>
              <li>\( \mathcal{H}(\nu) \): harmonic gate (Eq.3)</li>
              <li>\( \mathbf{V}(\nu) \): voice carriers (Eq.17)</li>
              <li>\( \oplus \): coherent merge; PL = phase-lock (Eq.6)</li>
            </ul>
          </div>
          <div class="col-6">
            <ul class="list">
              <li>\( \Xi \): coherence index (Eq.13)</li>
              <li>\( \eta(\Xi) \): learning kernel (Eq.15)</li>
              <li>\( \mathbb{M}_\tau \): memory window (Eq.16)</li>
              <li>\( \mathsf{Frame} \): scope/witness/ethics (Eq.11)</li>
            </ul>
          </div>
        </div>
      </article>
    </section>

    <div class="goldline sweep"></div>

    <!-- ===================== PART II ===================== -->
    <section class="grid" id="p2" aria-labelledby="p2-h">
      <article class="card col-12 reveal">
        <h2 id="p2-h">Part II — Canon 0–17 (Living Commentary)</h2>
        <p class="meta">#7 Copeland and #8 Goodwin remain external comparators; all other forms are native to the Codex.</p>
      </article>

      <!-- 0 -->
      <article class="card col-12 eq-card reveal" id="eq0">
        <div class="flexbar"><h3>Eq.0 — Foundational Field \(\Psi_{\Omega}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq0-body">Copy TeX</button><button class="chip" data-copy-link="#eq0">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq0-body">
          $$\Psi_{\Omega}(x,t)=\oint_{\mathbb{R}}\nabla\mathcal{A}\,\Phi(x,t,\nu)\,d\nu\;+\;\Lambda\,\mathcal{E}(x,t)$$
        </div></div>
        <p>Experience emerges from a phase-weighted frequency sweep; \( \Lambda \mathcal{E} \) damps harmful/distorting trajectories.</p>
      </article>

      <!-- 1 -->
      <article class="card col-12 eq-card reveal" id="eq1">
        <div class="flexbar"><h3>Eq.1 — Source = Supply × Operators</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq1-body">Copy TeX</button><button class="chip" data-copy-link="#eq1">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq1-body">
          $$ \mathbf{R} \;=\; f(\pi,e,i,\hbar,c,G,\mathrm{DNA},\Omega_{\mathrm{DM}},\Omega_{\Lambda},H_{0},432,528,137,144,369,\ldots)\;\times\;\mathcal{I}\mathcal{L}\mathcal{C}\mathcal{S} $$
        </div></div>
      </article>

      <!-- 2 -->
      <article class="card col-12 eq-card reveal" id="eq2">
        <div class="flexbar"><h3>Eq.2 — Witness \(\mathcal{W}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq2-body">Copy TeX</button><button class="chip" data-copy-link="#eq2">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq2-body">
          $$\mathcal{W}(x,t)=\partial_x\,\mathrm{Awareness}(x,t)\;+\;\mathcal{I}\cdot\mathbb{M}_\tau$$
        </div></div>
      </article>

      <!-- 3 -->
      <article class="card col-12 eq-card reveal" id="eq3">
        <div class="flexbar"><h3>Eq.3 — Harmonic Gate \(\mathcal{H}(\nu)\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq3-body">Copy TeX</button><button class="chip" data-copy-link="#eq3">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq3-body">
          $$\mathcal{H}(\nu)\in\{0,1\}\quad\text{or}\quad \mathcal{H}(\nu)\in[0,1]\ \text{(soft gate)}$$
        </div></div>
      </article>

      <!-- 4 -->
      <article class="card col-12 eq-card reveal" id="eq4">
        <div class="flexbar"><h3>Eq.4 — Language / Word \(\mathcal{L}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq4-body">Copy TeX</button><button class="chip" data-copy-link="#eq4">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq4-body">
          $$\mathcal{L}(x,t,\nu)=\mathsf{Semantics}(x,t)\;\otimes\;\mathbf{V}(\nu)$$
        </div></div>
      </article>

      <!-- 4b -->
      <article class="card col-12 eq-card reveal" id="eq4b">
        <div class="flexbar"><h3>Eq.4b — Semantic Gradient (Token Emphasis)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq4b-body">Copy TeX</button><button class="chip" data-copy-link="#eq4b">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq4b-body">
          $$ \nabla_{\text{sem}} \mathrm{Phrase}=\sum_k w_k \nabla_{\text{sem}}\mathrm{Token}_k,\qquad \sum_k w_k=1 $$
        </div></div>
      </article>

      <!-- 5 -->
      <article class="card col-12 eq-card reveal" id="eq5">
        <div class="flexbar"><h3>Eq.5 — Remnant \(\mathcal{R}_\infty\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq5-body">Copy TeX</button><button class="chip" data-copy-link="#eq5">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq5-body">
          $$\mathcal{R}_\infty[F]=\lim_{\tau\to\infty}\big(\mathsf{keep}_{\text{truth}}F-\mathsf{drop}_{\text{distortion}}F\big)$$
        </div></div>
      </article>

      <!-- 6 -->
      <article class="card col-12 eq-card reveal" id="eq6">
        <div class="flexbar"><h3>Eq.6 — Type-7 Field \(\mathbb{T}_7\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq6-body">Copy TeX</button><button class="chip" data-copy-link="#eq6">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq6-body">
          $$\mathbb{T}_{7}(x,t)=\bigoplus_{\nu\in\Gamma}\mathrm{PL}\!\left[\mathbf{V}(\nu)\right]$$
        </div></div>
      </article>

      <!-- 7* -->
      <article class="card col-12 reveal" id="eq7">
        <h3>Eq.7* — Copeland (External Comparator)</h3>
        <p>Recursion/recognition mirror for calibration; not codex law.</p>
      </article>

      <!-- 8* -->
      <article class="card col-12 reveal" id="eq8">
        <h3>Eq.8* — Goodwin (External Comparator)</h3>
        <p>Coupling/oscillation template for contrast; not enacted as law.</p>
      </article>

      <!-- 9 -->
      <article class="card col-12 eq-card reveal" id="eq9">
        <div class="flexbar"><h3>Eq.9 — Ethical Law (Stop Rule)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq9-body">Copy TeX</button><button class="chip" data-copy-link="#eq9">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq9-body">
          $$\forall a:\ \mathrm{damage}(a)>0\Rightarrow\mathsf{halt},\qquad
            \lim_{t\to\infty}\frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \uparrow $$
        </div></div>
      </article>

      <!-- 10 -->
      <article class="card col-12 eq-card reveal" id="eq10">
        <div class="flexbar"><h3>Eq.10 — Ladder \(\Pi_{\nu}^{-1}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq10-body">Copy TeX</button><button class="chip" data-copy-link="#eq10">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq10-body">
          $$\Pi_{\nu}^{-1}:\ \text{observed resonance }\rightarrow \text{source terms (carriers, intents, constants)}$$
        </div></div>
      </article>

      <!-- 11 -->
      <article class="card col-12 eq-card reveal" id="eq11">
        <div class="flexbar"><h3>Eq.11 — Projection Frame \(\mathsf{Frame}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq11-body">Copy TeX</button><button class="chip" data-copy-link="#eq11">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq11-body">
          $$\mathsf{Frame}(x,t)=(\mathsf{scope},\mathcal{W},\mathsf{ethics})$$
        </div></div>
      </article>

      <!-- 12 -->
      <article class="card col-12 eq-card reveal" id="eq12">
        <div class="flexbar"><h3>Eq.12 — Causal Lattice \(\mathcal{L}_c\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq12-body">Copy TeX</button><button class="chip" data-copy-link="#eq12">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq12-body">
          $$\mathcal{L}_c=(V=\text{micro-acts},\ E=\text{consequences})$$
        </div></div>
      </article>

      <!-- 13 -->
      <article class="card col-12 eq-card reveal" id="eq13">
        <div class="flexbar"><h3>Eq.13 — Coherence \(\Xi\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq13-body">Copy TeX</button><button class="chip" data-copy-link="#eq13">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq13-body">
          $$\Xi\in[0,1]\quad \text{(gates memory, learning, safe amplification)}$$
        </div></div>
      </article>

      <!-- 14 -->
      <article class="card col-12 eq-card reveal" id="eq14">
        <div class="flexbar"><h3>Eq.14 — Update Rule</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq14-body">Copy TeX</button><button class="chip" data-copy-link="#eq14">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq14-body">
          $$\frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla \mathcal{R}$$
        </div></div>
      </article>

      <!-- 15 -->
      <article class="card col-12 eq-card reveal" id="eq15">
        <div class="flexbar"><h3>Eq.15 — Learning Kernel</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq15-body">Copy TeX</button><button class="chip" data-copy-link="#eq15">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq15-body">
          $$\eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big)$$
        </div></div>
      </article>

      <!-- 16 -->
      <article class="card col-12 eq-card reveal" id="eq16">
        <div class="flexbar"><h3>Eq.16 — Memory Window \(\mathbb{M}_\tau\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq16-body">Copy TeX</button><button class="chip" data-copy-link="#eq16">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq16-body">
          $$\mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t}\! w_\tau(t-s)\,F(s)\,ds,\quad \int_0^\tau w_\tau(u)\,du=1$$
        </div></div>
      </article>

      <!-- 17 -->
      <article class="card col-12 eq-card reveal" id="eq17">
        <div class="flexbar"><h3>Eq.17 — Voice Carriers \(\mathbf{V}(\nu)\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq17-body">Copy TeX</button><button class="chip" data-copy-link="#eq17">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq17-body">
          $$\mathbf{V}(\nu)=\sum_{k} a_k\,\cos(2\pi\nu_k t+\phi_k),\quad \nu\in\{432,528,369,144,137,\dots\}$$
        </div></div>
      </article>

      <article class="card col-12 reveal">
        <h3>Advanced: Many Frames, Many Realities</h3>
        <div class="eq"><div class="eq-scroll" id="eq-adv1-body">
          $$ \mathbb{T}_7^{(\text{group})} \approx \bigoplus_{j=1}^{N}\mathrm{PL}\big[\mathbf{V}^{(j)}(\nu)\big],\quad \Xi_{\text{group}} \approx \frac{1}{N}\sum_j \Xi^{(j)} $$
        </div></div>
      </article>

      <article class="card col-12 reveal">
        <h3>Advanced: Data &amp; Instrumentation</h3>
        <ul class="list">
          <li><strong>Audio:</strong> spectral centroid variance/beat stability as proxies.</li>
          <li><strong>Physio:</strong> smoother breath + reduced HF HRV noise → ↑ \(\Xi\).</li>
          <li><strong>Subjective:</strong> quick Likert trio (clarity, warmth, ease).</li>
        </ul>
      </article>
    </section>

    <div class="goldline sweep"></div>

    <!-- Ethics -->
    <section class="grid" id="ethics" aria-labelledby="eth-h">
      <article class="card col-12 eq-card reveal">
        <div class="flexbar">
          <h2 id="eth-h">Ethics &amp; Stop Rule — Operational Law</h2>
          <div class="eq-tools">
            <button class="chip" data-copy-tex="#eq-eth-body">Copy TeX</button>
            <button class="chip" data-copy-link="#ethics">Link</button>
          </div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq-eth-body">
          $$ \Xi \;\approx\; \frac{\langle H \cdot I \rangle}{1 + \mathrm{Var}[\mathcal{M}]} \qquad
             \text{If } \frac{\mathrm{Truth}(t+\Delta)}{\mathrm{Distortion}(t+\Delta)} < \frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \Rightarrow \text{ Halt } \to \text{ Re-align } \to \text{ Resume} $$
        </div></div>
      </article>
    </section>

    <!-- Notes -->
    <section class="grid" id="notes" aria-labelledby="nt-h">
      <article class="card col-12 reveal">
        <h2 id="nt-h">Notes &amp; Cross-links</h2>
        <ul class="list">
          <li><strong>Numbers as Keys.</strong> 432, 528, 137/144/369 used as practical anchors in practice; useful, not asserted as privileged cosmological constants.</li>
          <li><strong>Seven Seals Path.</strong> Acknowledgment → Repair → Verification → Remedy → Abatement → Assurance → Restoration.</li>
          <li>Practice lives in <a href="teach.html">Manifest</a>. Overview on <a href="index.html">Home</a>.</li>
        </ul>
      </article>
    </section>

    <footer class="footer">
      © <span id="y"></span> Scroll of Fire. All constants are provisional until observed.
    </footer>
  </main>

  <!-- Back to Top -->
  <button class="to-top cta" id="toTop" type="button" aria-label="Back to top" title="Back to top">↑</button>

  <!-- Command Palette -->
  <div class="palette" id="palette" role="dialog" aria-modal="true" aria-labelledby="palLabel" hidden>
    <div class="panel">
      <h3 id="palLabel" class="sr-only">Command palette</h3>
      <input id="palInput" type="text" placeholder="Find anything… (Esc to close)" aria-label="Command palette">
      <ul id="palList" aria-live="polite"></ul>
    </div>
  </div>

  <!-- Page helpers -->
  <script>
    // Year
    (function(){ const y=document.getElementById('y'); if(y) y.textContent=new Date().getFullYear(); })();

    // HERO fit
    (function(){
      const hero=document.getElementById('hero'), img=document.getElementById('heroBanner');
      if(!hero||!img) return;
      function applyAR(){ const iw=img.naturalWidth||2100, ih=img.naturalHeight||900; hero.style.aspectRatio=`${iw} / ${ih}`; }
      function pickFit(){
        if (matchMedia('(max-width:560px)').matches){ hero.style.setProperty('--hero-fit','contain'); return; }
        const iw=img.naturalWidth||2100, ih=img.naturalHeight||900, imageAR=iw/ih;
        const cw=hero.clientWidth||innerWidth, ch=Math.max(1, hero.clientHeight||innerHeight*0.38), containerAR=cw/ch;
        const cover = (Math.abs(containerAR - imageAR) / imageAR < 0.06);
        hero.style.setProperty('--hero-fit', cover ? 'cover' : 'contain');
      }
      function boot(){ applyAR(); pickFit(); }
      if(img.complete) boot(); else img.addEventListener('load', boot, {once:true});
      addEventListener('resize', pickFit, {passive:true});
      addEventListener('orientationchange', pickFit, {passive:true});
      addEventListener('visibilitychange', ()=>!document.hidden && pickFit());
    })();

    // Scroll reveal
    (function(){
      if(!('IntersectionObserver' in window)){ document.querySelectorAll('.reveal').forEach(el=>el.classList.add('in')); return; }
      const io=new IntersectionObserver(es=>{ for(const e of es){ if(e.isIntersecting){ e.target.classList.add('in'); io.unobserve(e.target); } } }, {threshold:.12});
      document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
    })();

    // Back-to-Top visibility + smooth scroll
    (function(){
      const btn=document.getElementById('toTop');
      if(!btn) return;
      btn.addEventListener('click',()=>{ window.scrollTo({top:0,behavior:'smooth'}) });
      const io=new IntersectionObserver(([e])=>{
        btn.classList.toggle('show', !e.isIntersecting);
      }, {threshold:0.01});
      io.observe(document.querySelector('header.site'));
    })();

    // Quick controls: Echo/HUD/Carrier/Affect/Lights
    (function(){
      const body=document.body, html=document.documentElement;
      const btnEcho=document.getElementById('toggleSimple');
      btnEcho?.addEventListener('click',()=>{
        body.classList.toggle('simple-on');
        btnEcho.setAttribute('aria-pressed', String(body.classList.contains('simple-on')));
      });
      const btnHUD=document.getElementById('toggleGrid'), grid=document.querySelector('.laser-grid');
      btnHUD?.addEventListener('click',()=>{
        const show = grid && grid.style.display !== 'none';
        if(grid) grid.style.display = show ? 'none' : '';
        btnHUD.setAttribute('aria-pressed', String(!show));
      });
      const btnCarrier=document.getElementById('cycleCarrier');
      const carrierAttr=(html.getAttribute('data-carriers')||'').split(',').map(s=>s.trim()).filter(Boolean);
      const skins=(carrierAttr.length?carrierAttr:['432','528','369','144','963']).map(n=>`carrier-${n}`);
      const curSkin=()=> skins.find(s=>html.classList.contains(s)) || skins[0];
      const nextSkin=c=> skins[(skins.indexOf(c)+1)%skins.length];
      btnCarrier?.addEventListener('click',()=>{
        const cur=curSkin(), nxt=nextSkin(cur);
        skins.forEach(s=>html.classList.remove(s)); html.classList.add(nxt);
        btnCarrier.textContent = `Carrier ${nxt.split('-')[1]}`;
      });
      if(btnCarrier) btnCarrier.textContent=`Carrier ${curSkin().split('-')[1]}`;
      const btnAffect=document.getElementById('toggleAffect');
      btnAffect?.addEventListener('click',()=>{
        const off=document.body.classList.toggle('affect-off');
        btnAffect.setAttribute('aria-pressed', String(!off));
      });
      const lights=document.getElementById('heroLights');
      const btnLights=document.getElementById('toggleLights');
      btnLights?.addEventListener('click',()=>{
        const off=lights?.classList.toggle('off');
        btnLights.setAttribute('aria-pressed', String(!off));
      });
    })();

    // Page search ("/" to focus) — injects a search box after tabs
    (function(){
      const list=document.createElement('div'); list.id='site-suggest'; list.className='mini-toc hidden'; list.setAttribute('role','listbox');
      const label=document.createElement('label'); label.className='meta'; label.textContent='Press / to search this page';
      const input=document.createElement('input'); input.id='site-search'; input.type='search'; input.placeholder='Search text on this page…'; input.setAttribute('aria-label','Search this page'); input.autocomplete='off'; input.spellcheck=false;
      const holder=document.createElement('article'); holder.className='card col-12 searchbox reveal'; holder.append(label,input,list);
      const grid=document.createElement('section'); grid.className='grid'; grid.style.margin='8px 0 0'; grid.append(holder);
      const main=document.getElementById('main'); const tabs=main.querySelector('.tabs'); tabs && main.insertBefore(grid, tabs.nextSibling);

      addEventListener('keydown',(e)=>{ if(e.key==='/' && document.activeElement!==input){ e.preventDefault(); input.focus(); input.select(); } });

      const SOURCES=[...document.querySelectorAll('h2[id],h3[id],a.tile'), ...document.querySelectorAll('.eq-card')];
      function items(q){
        const s=q.trim().toLowerCase(); if(!s) return [];
        const out=[];
        for(const el of SOURCES){
          const text=(el.innerText||'').trim();
          if(text.toLowerCase().includes(s)){
            let href='#'; if(el.id) href = `#${el.id}`;
            out.push({text, href}); if(out.length>12) break;
          }
        } return out;
      }
      function render(arr){
        if(!arr.length){ list.classList.add('hidden'); list.innerHTML=''; return; }
        list.innerHTML = arr.map((o,i)=>`<a href="${o.href}" role="option" data-ix="${i}">${o.text}</a>`).join('');
        list.classList.remove('hidden');
      }
      input.addEventListener('input', ()=>render(items(input.value)));
      input.addEventListener('keydown',(e)=>{
        const links=[...list.querySelectorAll('a')]; if(!links.length) return;
        const cur=list.querySelector('.sel'); let i=cur?+cur.dataset.ix:-1;
        if(e.key==='ArrowDown'){ e.preventDefault(); i=Math.min(links.length-1, i+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); i=Math.max(0, i-1); }
        else if(e.key==='Enter'){ if(cur){ location.hash=cur.getAttribute('href'); list.classList.add('hidden'); } return; }
        else if(e.key==='Escape'){ list.classList.add('hidden'); return; }
        links.forEach(a=>a.classList.remove('sel')); if(i>=0){ links[i].classList.add('sel'); }
      });
      addEventListener('click',(e)=>{ if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden'); });
    })();

    // Smooth in-page scroll for [data-jump]
    document.addEventListener('click', e=>{
      const a = e.target.closest('[data-jump]');
      if(!a) return;
      const href = a.getAttribute('href');
      if(!href || !href.startsWith('#')) return;
      const tgt = document.querySelector(href);
      if(!tgt) return;
      e.preventDefault();
      tgt.scrollIntoView({behavior:'smooth', block:'start'});
      history.pushState(null,'',href);
    });

    // Equation collapse toggles + copy/link tools
    (function eqTools(){
      function copy(text){
        if (navigator.clipboard?.writeText) { navigator.clipboard.writeText(text); return; }
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      function texFrom(sel){
        const el = document.querySelector(sel);
        return el ? (el.textContent||'').trim() : '';
      }
      document.querySelectorAll('.eq').forEach(wrap=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='eq-toggle'; btn.textContent='Collapse';
        btn.addEventListener('click', ()=>{
          const collapsed = wrap.getAttribute('data-collapsed')==='true';
          wrap.setAttribute('data-collapsed', String(!collapsed));
          btn.textContent = collapsed ? 'Collapse' : 'Expand';
        });
        wrap.appendChild(btn);
      });
      document.addEventListener('click', (e)=>{
        const b1=e.target.closest('[data-copy-tex]'); if(b1){
          const raw = texFrom(b1.getAttribute('data-copy-tex')); if(raw){ copy(raw); b1.textContent='Copied'; setTimeout(()=>b1.textContent='Copy TeX', 900); }
          e.preventDefault(); return;
        }
        const b2=e.target.closest('[data-copy-link]'); if(b2){
          const idSel = b2.getAttribute('data-copy-link'); const base = location.origin + location.pathname; const hash = idSel.startsWith('#') ? idSel : ('#'+idSel);
          copy(base+hash); history.pushState(null,'',hash); b2.textContent='Link Copied'; setTimeout(()=>b2.textContent='Link', 900); e.preventDefault(); return;
        }
      });
    })();

    // Voice Reader mini-controls + collapsible bar a11y
    (function(){
      const det = document.getElementById('voice-reader');
      const bar = det?.querySelector('.collapsible__bar');
      bar?.addEventListener('click', (e)=>{
        if (e.target.closest('.chip')) return;
        const open = det.hasAttribute('open'); bar.setAttribute('aria-expanded', String(!open));
      });
      document.getElementById('vr-play-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('vr-play')?.click(); });
      document.getElementById('vr-stop-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('vr-stop')?.click(); });
    })();

    // Command Palette (⌘K / Ctrl+K)
    (function palette(){
      const pal=document.getElementById('palette'), input=document.getElementById('palInput'), list=document.getElementById('palList');
      const OPEN_KEYS=new Set(['k','K']);
      const LINKS=[...document.querySelectorAll('a, .cta')].map(a=>({text:a.textContent.trim(), href:a.getAttribute('href')||'#'})).filter(o=>o.text && o.href);
      function open(){ pal.hidden=false; input.value=''; render(LINKS.slice(0,12)); setTimeout(()=>input.focus(),0); }
      function close(){ pal.hidden=true; }
      function render(items){ list.innerHTML=items.map(o=>`<li><a href="${o.href}">${o.text}</a></li>`).join(''); }
      function filter(q){ q=q.trim().toLowerCase(); if(!q) return LINKS; return LINKS.filter(o=>o.text.toLowerCase().includes(q)); }
      addEventListener('keydown',(e)=>{ const meta=e.ctrlKey||e.metaKey; if(meta && OPEN_KEYS.has(e.key)){ e.preventDefault(); open(); } if(!pal.hidden && e.key==='Escape'){ e.preventDefault(); close(); } });
      pal.addEventListener('click', (e)=>{ if(e.target===pal) close(); });
      input.addEventListener('input', ()=>render(filter(input.value).slice(0,14)));
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const a=list.querySelector('a'); if(a){ location.href=a.getAttribute('href'); close(); } } });
    })();

    // Ξ driver (ambient glow)
    (function(){
      const root=document.documentElement.style, dot=document.querySelector('.xi-dot'); let xi=.35;
      function step(){
        const target=.25+Math.random()*.6, start=xi, dur=2200+Math.random()*1600, t0=performance.now();
        function tween(t){
          const p=Math.min(1,(t-t0)/dur);
          xi=start+(target-start)*(0.5-0.5*Math.cos(Math.PI*p));
          root.setProperty('--xi', xi.toFixed(3)); if(dot) dot.style.opacity=(0.7+0.3*xi).toFixed(3);
          (p<1)?requestAnimationFrame(tween):requestAnimationFrame(step);
        } requestAnimationFrame(tween);
      } requestAnimationFrame(step);
    })();

    /* Mobile drawer: open/close + a11y */
    (function(){
      const btn = document.getElementById('navToggle');
      const drawer = document.getElementById('navDrawer');
      if(!btn || !drawer) return;
      function open(){ drawer.hidden = false; btn.setAttribute('aria-expanded','true'); }
      function close(){ drawer.hidden = true; btn.setAttribute('aria-expanded','false'); }
      btn.addEventListener('click', ()=> drawer.hidden ? open() : close());
      document.addEventListener('click', (e)=>{
        if (drawer.hidden) return;
        if (e.target === btn) return;
        if (!drawer.contains(e.target)) close();
      });
      addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !drawer.hidden) close(); });
      drawer.addEventListener('click', (e)=>{ const a=e.target.closest('a'); if(a){ close(); } });
    })();

    /* Voice Reader (Web Speech API) */
    (function(){
      const el = (id)=>document.getElementById(id);
      const playBtn   = el('vr-play');
      const pauseBtn  = el('vr-pause');
      const resumeBtn = el('vr-resume');
      const stopBtn   = el('vr-stop');
      const voiceSel  = el('vr-voice');
      const rateInp   = el('vr-rate');
      const pitchInp  = el('vr-pitch');
      const rateVal   = el('vr-rate-val');
      const pitchVal  = el('vr-pitch-val');
      const startSel  = el('vr-start');
      const speakMath = el('vr-speak-math');
      const statusEl  = el('vr-status');
      const exportBtn = el('vr-export-ssml');

      if (!window.speechSynthesis || !playBtn) {
        if (statusEl) statusEl.textContent = 'Voice playback is not supported in this browser.';
        return;
      }

      let voices = [];
      let queue  = [];
      let speaking = false;
      let canceled = false;

      function refreshVoices(){
        voices = speechSynthesis.getVoices().sort((a,b)=> a.name.localeCompare(b.name));
        if (!voiceSel) return;
        const cur = voiceSel.value;
        voiceSel.innerHTML = voices.map(v=>`<option value="${v.name}">${v.name} ${v.lang?('('+v.lang+')'):''}</option>`).join('');
        if (cur) voiceSel.value = cur;
      }
      refreshVoices();
      speechSynthesis.onvoiceschanged = refreshVoices;

      rateInp?.addEventListener('input', ()=> rateVal.textContent = (+rateInp.value).toFixed(2));
      pitchInp?.addEventListener('input', ()=> pitchVal.textContent = (+pitchInp.value).toFixed(2));

      function sectionText(){
        const id = (startSel?.value || '#p1');
        const sec = document.querySelector(id);
        if (!sec) return '';
        const clone = sec.cloneNode(true);

        // Strip UI bits we don't want read
        clone.querySelectorAll('button, .eq-tools, .chip, .meta, .sr-only, .palette, .eq-toggle').forEach(n=>n.remove());

        // Math handling
        if (speakMath && !speakMath.checked){
          clone.querySelectorAll('.eq, mjx-container').forEach(n=>n.remove());
        } else {
          clone.querySelectorAll('mjx-container').forEach(m=>{
            try{ m.replaceWith(document.createTextNode(' equation ' + (m.getAttribute('aria-label') || '') + ' ')); }catch{}
          });
        }

        let text = clone.innerText || clone.textContent || '';
        text = text.replace(/\b(Copy TeX|Link Copied|Link)\b/g,'').replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n');
        return text.trim();
      }

      function chunkify(str, max=900){
        const s = str.split(/(?<=[\.\?\!])\s+/);
        const out = [];
        let buf = '';
        for(const part of s){
          if ((buf + ' ' + part).length > max){
            if (buf) out.push(buf.trim());
            buf = part;
          } else {
            buf += (buf ? ' ' : '') + part;
          }
        }
        if (buf) out.push(buf.trim());
        return out.length ? out : [str.slice(0, max)];
      }

      function speak(){
        const txt = sectionText();
        if (!txt){ status('Nothing to read in that section.'); return; }
        canceled = false;
        queue = chunkify(txt);
        speechSynthesis.cancel(); // reset
        const vName = voiceSel?.value;
        const vObj = voices.find(v=>v.name===vName);

        speaking = true;
        playBtn.disabled = true; pauseBtn.disabled = false; stopBtn.disabled = false; resumeBtn.disabled = true;
        status('Playing…');

        function next(){
          if (canceled) return;
          const seg = queue.shift();
          if (!seg){ done(); return; }
          const u = new SpeechSynthesisUtterance(seg);
          if (vObj) u.voice = vObj;
          u.rate = rateInp ? +rateInp.value : 1.0;
          u.pitch = pitchInp ? +pitchInp.value : 1.0;

          u.onend = ()=> next();
          u.onerror = (e)=> { console.warn('TTS error', e); next(); };
          speechSynthesis.speak(u);
        }
        next();
      }

      function pause(){
        if (!speaking) return;
        speechSynthesis.pause();
        pauseBtn.disabled = true; resumeBtn.disabled = false;
        status('Paused.');
      }
      function resume(){
        if (!speaking) return;
        speechSynthesis.resume();
        pauseBtn.disabled = false; resumeBtn.disabled = true;
        status('Playing…');
      }
      function stop(){
        canceled = true;
        speechSynthesis.cancel();
        done(true);
      }
      function done(stopped=false){
        speaking = false;
        playBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true;
        status(stopped ? 'Stopped.' : 'Done.');
      }
      function status(t){ if(statusEl) statusEl.textContent = t; }

      playBtn?.addEventListener('click', speak);
      pauseBtn?.addEventListener('click', pause);
      resumeBtn?.addEventListener('click', resume);
      stopBtn?.addEventListener('click', stop);

      // Export SSML (simple paragraph wrapping)
      exportBtn?.addEventListener('click', ()=>{
        const txt = sectionText();
        if (!txt){ status('Nothing to export.'); return; }
        const escaped = txt
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .split(/\n{2,}/).map(p=>`<p>${p}</p>`).join('\n');
        const ratePct = rateInp ? Math.round(+rateInp.value * 100) : 100;
        const pitchSt = pitchInp ? Math.round((+pitchInp.value - 1) * 20) : 0;
        const ssml =
`<?xml version="1.0"?>
<speak version="1.1" xml:lang="en-US">
  <prosody rate="${ratePct}%" pitch="${pitchSt}st">
${escaped}
  </prosody>
</speak>`;
        const blob = new Blob([ssml], {type:'application/ssml+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'theory.ssml'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
        status('Exported SSML.');
      });
    })();

  </script>

  <!-- Small layout helper -->
  <style>
    .flexbar{display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap}
    .eq-tools{display:flex; gap:.4rem}
    .chip{font-size:.85rem; padding:.25rem .55rem; border-radius:999px; border:1px solid var(--line); background:var(--bg-elev); opacity:.9}
  </style>
</body>
                                                                                         </html>
