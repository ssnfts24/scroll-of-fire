<!doctype html>
<html lang="en" dir="ltr" class="sof carrier-432" data-carriers="432,528,369,144,963">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>
    // GitHub HTML preview fix: remove <base> so relative links work there
    if (location.hostname === "github.com") {
      const b = document.querySelector("base"); if (b) b.remove();
    }
  </script>

  <meta charset="utf-8">
  <title>Theory â€” Scroll of Fire (Codex of Reality)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0b0f" media="(prefers-color-scheme: dark)">
  <meta name="description" content="The Codex of Reality: Master Equation, Î”0â€“Î”7 scaffolding, Canon 0â€“17, 13 Moons, operators (ğ“˜Â·ğ“›Â·ğ“’Â·ğ“¢), and an ethical learning loop.">
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/theory.html">

  <!-- Icons -->
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icon-512.png">

  <!-- Open Graph / Twitter -->
  <meta property="og:site_name" content="Scroll of Fire">
  <meta property="og:title" content="Theory â€” Scroll of Fire (Codex of Reality)">
  <meta property="og:description" content="A living architecture of resonance â€” Master Equation, Î”0â€“Î”7, Canon 0â€“17, 13 Moons, and the ethical stop-rule.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/theory.html">
  <meta property="og:image" content="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1">
  <meta property="og:image:alt" content="Scroll of Fire â€” Codex of Reality banner">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Shared styles -->
  <link rel="preload" as="style" href="assets/css/codex.css?v=2.8">
  <link rel="stylesheet" href="assets/css/codex.css?v=2.8" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2.8"></noscript>

  <!-- Theory page micro-styles -->
  <link rel="preload" as="style" href="assets/css/theory.css?v=1.9">
  <link rel="stylesheet" href="assets/css/theory.css?v=1.9">

  <!-- Preload banner -->
  <link rel="preload" as="image" href="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1" fetchpriority="high">

  <!-- Page-scoped helpers -->
  <style>
    :root{
      --safe-top:env(safe-area-inset-top); --safe-bot:env(safe-area-inset-bottom);
      --xi:.35;
      --accent-432:#7af3ff; --accent-528:#a4ff90; --accent-369:#f3c97a; --accent:#7af3ff;
    }
    .carrier-528 :root, .carrier-528{--accent:var(--accent-528)}
    .carrier-369 :root, .carrier-369{--accent:var(--accent-369)}
    .carrier-144 :root, .carrier-144{--accent:#b3e1ff}
    .carrier-963 :root, .carrier-963{--accent:#ffd1f3}

    /* Layout / header (sticky) */
    body{margin:0}
    header.site{position:sticky; top:0; z-index:1000; backdrop-filter:saturate(140%) blur(8px); background:rgba(9,11,16,.6)}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{display:inline-block; width:34px; height:34px; border-radius:50%;
      background:radial-gradient(closest-side, #0cf, transparent 70%);
      box-shadow:0 0 18px rgba(122,243,255,.35)}
    .kicker{margin:0}
    .quick{display:flex; gap:8px; flex:0 0 auto}
    .quick .cta{white-space:nowrap}

    .hide-sm{display:flex}
    .show-sm{display:none}
    @media (max-width:860px){
      .hide-sm{display:none!important}
      .show-sm{display:inline-flex; align-items:center; justify-content:center;
        width:40px; height:40px; border:1px solid var(--line); background:var(--bg-elev);
        border-radius:.6rem; font-size:1.1rem}
      header.site .wrap{padding:12px 16px}
    }

    /* Mobile drawer */
    .drawer{position:sticky; top:4rem; z-index:999; background:rgba(12,14,20,.92);
      backdrop-filter:saturate(140%) blur(8px); border-top:1px solid var(--line);
      border-bottom:1px solid var(--line); padding:.5rem .75rem}
    .drawer .dlink{display:block; padding:.65rem .5rem; border-radius:.5rem}
    .drawer .dlink:hover{background:rgba(255,255,255,.05)}
    .drawer[hidden]{display:none}

    /* Hero (banner) */
    .hero{position:relative; width:100%; max-width:1200px; margin:8px auto 0; border-radius:16px; overflow:hidden; background:#0b0f14; aspect-ratio:21/9}
    .hero picture,.hero .hero-img{display:block;width:100%;height:100%}
    .hero .hero-img{object-fit:var(--hero-fit,contain); object-position:center; mix-blend-mode:normal!important}
    .hero::after{content:""; position:absolute; inset:0; box-shadow:inset 0 0 120px rgba(255,255,255,.06), inset 0 0 40px rgba(122,243,255,.08); pointer-events:none}
    .hero-lights{position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen;
      background:
        radial-gradient(1px 1px at 12% 18%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1px 1px at 78% 22%, rgba(164,255,144,.35), transparent 60%),
        radial-gradient(1px 1px at 32% 68%, rgba(122,243,255,.35), transparent 60%),
        radial-gradient(1px 1px at 88% 56%, rgba(255,209,243,.35), transparent 60%);
      opacity:.85; filter:blur(.2px); animation:lightsFlicker 7.5s ease-in-out infinite alternate}
    .hero-lights.off{display:none}
    .hero-lights::before{content:""; position:absolute; inset:-10% -20%;
      background:linear-gradient(90deg,transparent 0%,color-mix(in srgb,var(--accent) 22%,#fff 8%) 35%,color-mix(in srgb,var(--accent) 45%,#fff 0%) 50%,color-mix(in srgb,var(--accent) 22%,#fff 8%) 65%,transparent 100%);
      opacity:.55; filter:blur(24px); transform:translate3d(-30%,-2%,0); animation:auroraSweep 18s linear infinite, auroraBob 7s ease-in-out infinite alternate; mix-blend-mode:screen}
    .hero-lights::after{content:""; position:absolute; inset:0;
      background:
        radial-gradient(40% 30% at 18% 20%, rgba(164,255,144,.14) 0%, transparent 68%),
        radial-gradient(48% 38% at 82% 22%, rgba(255,209,243,.14) 0%, transparent 70%),
        radial-gradient(36% 28% at 50% 86%, rgba(122,243,255,.10) 0%, transparent 70%);
      filter: blur(10px); opacity:.7; animation: glowBreath 9.5s ease-in-out infinite alternate; mix-blend-mode:screen}
    @keyframes auroraSweep{0%{transform:translate3d(-30%,-2%,0)}50%{transform:translate3d(10%,3%,0)}100%{transform:translate3d(50%,-1%,0)}}
    @keyframes auroraBob{0%{opacity:.48;filter:blur(22px)}50%{opacity:.72;filter:blur(26px)}100%{opacity:.58;filter:blur(24px)}}
    @keyframes glowBreath{0%{opacity:.52;filter:blur(9px)}50%{opacity:.8;filter:blur(12px)}100%{opacity:.62;filter:blur(10px)}}
    @keyframes lightsFlicker{0%{opacity:.70}50%{opacity:.92}100%{opacity:.80}}
    @media (prefers-reduced-motion:reduce){ .hero-lights, .hero-lights::before, .hero-lights::after{animation:none!important} }
    @media (max-width: 860px){ .hero{margin-top:6px} }

    /* Tabs + mini-TOC */
    .tabs{gap:.35rem}
    .tabs .tab{padding:.45rem .7rem; font-size:.92rem; border-radius:999px}
    .tabs .tab--primary{font-weight:600}
    .mini-toc{
      position:sticky; top:5.5rem; align-self:start; max-height:75vh; overflow:auto;
      border:1px solid var(--line); border-radius:.75rem; padding:.75rem .75rem;
      background:rgba(255,255,255,.02); backdrop-filter:saturate(120%) blur(2px); margin-top:8px;
    }
    .mini-toc a{display:block; padding:.3rem .4rem; border-radius:.5rem; font-size:.92rem; opacity:.9}
    .mini-toc a:hover{background:rgba(255,255,255,.05)}

    /* Equation wrappers + toggles */
    .eq{position:relative}
    .eq .eq-scroll{
      max-height:24rem; overflow:auto; padding:.5rem .75rem;
      border:1px solid var(--line); border-radius:.75rem;
      background:rgba(255,255,255,.02)
    }
    .eq .eq-toggle{
      position:absolute; top:.4rem; right:.5rem; border:1px solid var(--line);
      background:var(--bg-elev); border-radius:.5rem; padding:.15rem .45rem;
      font-size:.8rem; opacity:.8; display:none;
    }
    .eq:hover .eq-toggle{display:inline-block}
    .eq[data-collapsed="true"] .eq-scroll{max-height:4.5rem}

    /* Cards + hover auras */
    .card{position:relative; z-index:1; background:linear-gradient(180deg, rgba(255,255,255,.015), rgba(0,0,0,.08));}
    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit;
      background: radial-gradient(240px 120px at 20% -20%, rgba(122,243,255,.12), transparent 60%),
                  radial-gradient(220px 120px at 120% 120%, rgba(243,201,122,.10), transparent 60%);
      opacity:0; transition:opacity .25s ease-out; pointer-events:none; z-index:-1;
    }
    .card:hover::after{opacity:.6}

    /* Lines */
    .divider{height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(122,243,255,.35), transparent)}
    .goldline{height:1px; margin:18px 0; background:linear-gradient(90deg, transparent, rgba(243,201,122,.45), transparent)}

    /* Back-to-top */
    .to-top{position:fixed; right:16px; bottom:16px; z-index:1200; opacity:0; transform:translateY(16px); pointer-events:none}
    .to-top.show{opacity:1; transform:none; pointer-events:auto}

    /* Voice reader highlight */
    .vr-highlight{outline:1px dashed color-mix(in srgb, var(--accent) 55%, #fff 0%); background:rgba(122,243,255,.08)}
    .vr-progress{font-size:.9rem; opacity:.85; margin-top:.3rem}

    /* Equation glamor pack + badges */
    .eq-badge{display:inline-block;margin-left:.5rem;font-size:.75rem;letter-spacing:.02em;
      padding:.15rem .5rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .eq-master .eq-scroll{
      border:1px solid color-mix(in srgb, var(--accent) 60%, #fff 10%);
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(122,243,255,.06), transparent 60%),
        radial-gradient(1000px 420px at 110% 120%, rgba(243,201,122,.06), transparent 60%),
        rgba(255,255,255,.02);
      box-shadow: 0 14px 60px rgba(0,0,0,.45), inset 0 0 28px rgba(122,243,255,.08);
    }
    .eq-legend{font-size:.92rem;color:#b7c3df;line-height:1.5}
    .eq-legend code{background:rgba(255,255,255,.04);padding:.05rem .35rem;border-radius:.35rem}

    /* Î” labels */
    .delta-labels{display:flex;flex-wrap:wrap;gap:.35rem;margin:.5rem 0 0}
    .delta-labels .pill{font-size:.78rem;padding:.2rem .5rem;border-radius:999px;
      border:1px solid var(--line);background:rgba(255,255,255,.03);opacity:.95}

    /* Starfield theme */
    body.stars {
      background:
        radial-gradient(800px 600px at 50% 30%, rgba(15,25,40,.6), transparent 80%),
        linear-gradient(180deg, #05060a 0%, #0b0e14 80%);
      overflow-x:hidden;
    }
    canvas#trace {
      background:
        radial-gradient(circle at 50% 50%, #0a0e15 0%, #06080d 80%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
      box-shadow: inset 0 0 40px rgba(122,243,255,.12), 0 0 120px rgba(122,243,255,.08);
    }
    .stage::after {
      content:"";
      position:absolute; inset:0;
      background:radial-gradient(ellipse at 50% 60%, rgba(122,243,255,.08), transparent 70%);
      pointer-events:none;
    }
  </style>

  <!-- MathJax (lazy, with correct delimiters) -->
  <script>
    (function(){
      let loaded=false;
      function boot(){ if(!window.MathJax) return; MathJax.startup.promise.then(()=>MathJax.typesetPromise()); }
      function loadMJ(){
        if(loaded) return; loaded=true;
        window.MathJax={
          tex:{ inlineMath:[['\\(','\\)']], displayMath:[['$$','$$']], processEscapes:true },
          svg:{fontCache:'global'},
          startup:{typeset:false}
        };
        const s=document.createElement('script');
        s.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js";
        s.defer=true; s.onload=boot; document.head.appendChild(s);
      }
      if(document.readyState!=='loading') loadMJ(); else addEventListener('DOMContentLoaded', loadMJ);
    })();
  </script>

  <!-- Site JS bundle -->
  <script src="assets/js/codex.js?v=3.6" defer></script>
</head>

<body class="stars living-all" data-theme="dark">
  <a class="skip" href="#main">Skip to content</a>
  <div class="laser-grid" aria-hidden="true"></div>
  <div class="xi-meter" aria-hidden="true"><div class="xi-ring"><div class="xi-dot"></div></div><div class="xi-label">Î</div></div>

  <!-- Header -->
  <header class="site" role="banner">
    <nav class="nav wrap" aria-label="Main navigation">
      <div class="brand">
        <a class="logo no-living" href="index.html" aria-label="Home"></a>
        <a href="index.html" class="kicker sheen" style="text-decoration:none"><h1 class="kicker sheen">Scroll of Fire</h1></a>
      </div>

      <!-- Desktop quick actions -->
      <div class="quick quick--utils hide-sm" role="toolbar" aria-label="Quick actions">
        <a class="cta" href="index.html" title="Home">Home</a>
        <a class="cta" href="#p1" data-jump title="Jump to Part I">Part I</a>
        <a class="cta" href="#p2" data-jump title="Jump to Part II">Part II</a>
        <a class="cta" href="#moons" data-jump title="Jump to 13 Moons">13 Moons</a>
        <a class="cta" href="#ethics" data-jump>Ethics</a>
        <a class="cta" href="#notes" data-jump>Notes</a>
        <a class="cta cta--section" href="teach.html" title="Back to Manifest">Manifest</a>
        <button id="toggleSimple" class="cta" type="button" aria-pressed="false" title="Echo View (hide math)">Echo</button>
        <button id="toggleGrid" class="cta" type="button" aria-pressed="true" title="Toggle HUD grid">HUD</button>
        <button id="cycleCarrier" class="cta" type="button" title="Cycle carrier skin">Carrier</button>
        <button id="toggleAffect" class="cta" type="button" aria-pressed="true" title="Toggle living text effects">Affect</button>
        <button id="toggleLights" class="cta" type="button" aria-pressed="true" title="Toggle banner lights">Lights</button>
        <button id="openPalette" class="cta" type="button" title="Command palette">âŒ˜K</button>
      </div>

      <!-- Mobile toggler -->
      <button id="navToggle" class="menu-toggle show-sm" type="button" aria-controls="navDrawer" aria-expanded="false" aria-label="Open menu">â˜°</button>
    </nav>

    <!-- Mobile drawer -->
    <div id="navDrawer" class="drawer" hidden>
      <a class="dlink" href="index.html">Home</a>
      <a class="dlink" href="#p1" data-jump>Part I â€” Architecture</a>
      <a class="dlink" href="#p2" data-jump>Part II â€” Canon</a>
      <a class="dlink" href="#moons" data-jump>13 Moons</a>
      <a class="dlink" href="#ethics" data-jump>Ethics</a>
      <a class="dlink" href="#notes" data-jump>Notes</a>
      <hr>
      <a class="dlink" href="teach.html">Manifest</a>
    </div>
  </header>

  <main id="main" class="wrap" role="main" tabindex="-1">
    <!-- Hero -->
    <figure id="hero" class="hero hero--clean reveal" aria-label="Scroll of Fire banner" data-fit="cover">
      <picture>
        <img id="heroBanner"
             class="hero-img no-living"
             src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png?v=sofv1"
             alt="Scroll of Fire â€” sigil and equations"
             width="2100" height="900"
             decoding="async" fetchpriority="high" loading="eager">
      </picture>
      <div id="heroLights" class="hero-lights" aria-hidden="true"></div>
      <figcaption class="hero-caption">â€œLet there be resonance.â€</figcaption>
    </figure>

    <h1 class="title sheen reveal">ğŸ“˜ Theory â€” Codex of Reality</h1>
    <p class="subtitle reveal">A three-layer map: <em>Master Equation + Î”0â€“Î”7 scaffolding</em>, <em>Canon 0â€“17</em>, and <em>13 Moons praxis</em>. The Codex treats reality as a resonant process guided by <em>ğ“˜ Â· ğ“› Â· ğ“’ Â· ğ“¢</em> and gated by ethical law.</p>

    <!-- TL;DR + Checklist -->
    <section class="grid reveal" aria-label="Quick start">
      <article class="card col-7">
        <h3>TL;DR</h3>
        <p>Set a frame. Choose clean carriers. Speak clearly. Witness what changes. Update only when coherence rises, and stop at the first sign of harm.</p>
      </article>
      <article class="card col-5">
        <h3>Practitioner Checklist</h3>
        <ul class="list">
          <li>Frame: scope â€¢ witness â€¢ ethics.</li>
          <li>Carriers: few, stable bands; test fit.</li>
          <li>Language: short phrases; steady breath.</li>
          <li>Witness: note shifts without forcing.</li>
          <li>Update: only with â†‘Î; otherwise pause.</li>
        </ul>
      </article>
    </section>

    <!-- Voice Reader (collapsible) -->
    <details class="collapsible card col-12 reveal" id="voice-reader" open>
      <summary class="collapsible__bar" aria-controls="vr-panel" aria-expanded="true">
        <span>ğŸ”Š Listen â€” Voice Reader</span>
        <span class="collapsible__mini" aria-hidden="true">
          <button id="vr-play-mini" class="chip" type="button" title="Play">â–¶ï¸</button>
          <button id="vr-stop-mini" class="chip" type="button" title="Stop">â¹</button>
        </span>
      </summary>
      <div id="vr-panel" class="collapsible__panel">
        <div class="grid" style="gap:1rem">
          <div class="col-6">
            <label for="vr-voice">Voice</label>
            <select id="vr-voice" aria-label="Voice selector"></select>
          </div>
          <div class="col-3">
            <label for="vr-rate">Speed (<span id="vr-rate-val">1.00</span>x)</label>
            <input id="vr-rate" type="range" min="0.7" max="1.6" step="0.05" value="1.0" />
          </div>
          <div class="col-3">
            <label for="vr-pitch">Pitch (<span id="vr-pitch-val">1.00</span>)</label>
            <input id="vr-pitch" type="range" min="0.8" max="1.4" step="0.05" value="1.0" />
          </div>
          <div class="col-6">
            <label for="vr-start">Start at</label>
            <select id="vr-start">
              <option value="#p1">Part I â€” Architecture</option>
              <option value="#p2">Part II â€” Canon 0â€“17</option>
              <option value="#moons">13 Moons</option>
              <option value="#operators-appendix">Operators</option>
              <option value="#ethics">Ethics</option>
              <option value="#notes">Notes</option>
            </select>
          </div>
          <div class="col-6">
            <label for="vr-range">Or read selection</label>
            <button id="vr-read-selection" class="cta" type="button" title="Read selected text">Read Whatâ€™s Selected</button>
          </div>
          <div class="col-12">
            <label class="checkbox">
              <input type="checkbox" id="vr-speak-math" checked />
              <span>Speak equations (verbalized). Uncheck to skip.</span>
            </label>
            <label class="checkbox" style="margin-left:1rem">
              <input type="checkbox" id="vr-polish" checked />
              <span>Polish phrasing (cleaner English)</span>
            </label>
          </div>
          <div class="col-12" role="toolbar" aria-label="Voice reader controls" style="display:flex; gap:.5rem; flex-wrap:wrap">
            <button id="vr-play" class="cta">â–¶ï¸ Play</button>
            <button id="vr-pause" class="cta" disabled>â¸ Pause</button>
            <button id="vr-resume" class="cta" disabled>âµ Resume</button>
            <button id="vr-stop" class="cta" disabled>â¹ Stop</button>
            <button id="vr-export-ssml" class="cta cta--section">â¬‡ï¸ Export SSML</button>
          </div>
          <div class="col-12">
            <div id="vr-status" aria-live="polite"></div>
            <div id="vr-progress" class="vr-progress" aria-hidden="true"></div>
          </div>
        </div>
      </div>
    </details>

    <!-- Tabs -->
    <nav class="tabs reveal" aria-label="Sections">
      <a class="tab tab--primary" href="#p1" data-jump>Part I: Architecture</a>
      <a class="tab tab--primary" href="#p2" data-jump>Part II: Equations 0â€“17</a>
      <a class="tab" href="#moons" data-jump>13 Moons</a>
      <a class="tab" href="#operators-appendix" data-jump>Operators</a>
      <a class="tab" href="#ethics" data-jump>Ethics</a>
      <a class="tab" href="#notes" data-jump>Notes</a>
      <span class="tab-ink no-living" aria-hidden="true"></span>
    </nav>

    <!-- Sticky mini-TOC -->
    <aside class="mini-toc reveal" aria-label="On this page">
      <h4>On this page</h4>
      <a href="#p1" data-jump>Part I â€” Architecture</a>
      <a href="#p2" data-jump>Part II â€” Equations</a>
      <a href="#moons" data-jump>13 Moons</a>
      <a href="#operators-appendix" data-jump>Operators &amp; Notation</a>
      <a href="#ethics" data-jump>Ethical Law</a>
      <a href="#notes" data-jump>Notes</a>
    </aside><!-- ===================== PART I ===================== -->
<section class="grid" id="p1" aria-labelledby="p1-h">
  <article class="card col-12 eq-card reveal eq-master">
    <h2 id="p1-h">Part I â€” Master Equation &amp; Architecture of Resonance <span class="eq-badge mono">expanded</span></h2>
    <div class="eq">
      <div class="eq-scroll" id="eq-master">
        $$
          \boxed{
            \mathcal{R}(x,t)
            =
            \Big[
              f(\mathbf{K})\;
              \cdot\;
              \big(\mathcal{I}\,\mathcal{L}\,\mathcal{C}\,\mathcal{S}\big)
            \Big]_{\text{masked by Eq.9}}
          }
        $$
        $$
          \frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla\mathcal{R},\quad
          \Xi\in[0,1],\quad
          \eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big)
        $$
        $$
          \mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t} w_\tau(t-s)\,F(s)\,ds,\qquad
          \int_0^\tau w_\tau(u)\,du=1
        $$
        $$
          \mathcal{H}(\nu)\in\{0,1\},\quad
          \mathbf{V}(\nu)=\sum_k a_k\cos(2\pi\nu_k t+\phi_k)
        $$
      </div>
    </div>
    <p class="eq-legend">
      <code>f(\mathbf{K})</code> bundles your substrate constants/keys
      (<span class="mono">Ï€, e, i, â„, c, G, DNA, Î©<sub>DM</sub>, Î©<sub>Î›</sub>, H<sub>0</sub>, 432, 528, 137, 144, 369, â€¦</span>).
      The operator pipeline <code>ğ“˜Â·ğ“›Â·ğ“’Â·ğ“¢</code> acts on state; all output is bounded by Eq.9 (Ethical Law).
    </p>
  </article>

  <article class="card col-12 reveal">
    <h3>The Codex in one breath</h3>
    <ul class="list">
      <li><b>Reality as resonance.</b> Experience arises from a field <span class="mono">Î¨<sub>Î©</sub></span> driven by carriers and language (Eq.0, Eq.4, Eq.17).</li>
      <li><b>Four operators.</b> <span class="mono">ğ“˜</span> sets intention, <span class="mono">ğ“›</span> encodes semantics into carriers, <span class="mono">ğ“’</span> measures/gates coherence, <span class="mono">ğ“¢</span> selects and returns to source/remnant.</li>
      <li><b>Learning but safe.</b> Updates scale with coherence <span class="mono">Î</span> (Eq.14â€“15) and are halted by harm (Eq.9).</li>
      <li><b>Time has texture.</b> Memory windows <span class="mono">ğ•„<sub>Ï„</sub></span> weight recency (Eq.16); archives keep what remains true (Eq.5).</li>
    </ul>
  </article>

  <article class="card col-12 eq-card reveal">
    <h3>Î”0â€“Î”7 â€” Scaffolding (from intent to archive)</h3>
    <div class="delta-labels">
      <span class="pill">Î”0 â€” Frame</span>
      <span class="pill">Î”1 â€” Carriers</span>
      <span class="pill">Î”2 â€” Language</span>
      <span class="pill">Î”3 â€” Witness</span>
      <span class="pill">Î”4 â€” Update</span>
      <span class="pill">Î”5 â€” Memory</span>
      <span class="pill">Î”6 â€” Lattice</span>
      <span class="pill">Î”7 â€” Remnant</span>
    </div>
    <ul class="list">
      <li><b>Î”0 Frame:</b> declare <em>scope</em>, <em>witness</em>, <em>ethics</em> (Eq.11).</li>
      <li><b>Î”1 Carriers:</b> choose a few stable <span class="mono">Î½</span> that pass the gate (Eq.3, Eq.17).</li>
      <li><b>Î”2 Language:</b> brief phrases with explicit token weights <span class="mono">w_k</span> (Eq.4, Eq.4b).</li>
      <li><b>Î”3 Witness:</b> sense gradients without forcing (Eq.2).</li>
      <li><b>Î”4 Update:</b> step only when <span class="mono">Î</span> â†‘ (Eq.14â€“15, Eq.9).</li>
      <li><b>Î”5 Memory:</b> tune <span class="mono">ğ•„<sub>Ï„</sub></span> for your session length/goal (Eq.16).</li>
      <li><b>Î”6 Lattice:</b> draw links from micro-acts to consequences (Eq.12).</li>
      <li><b>Î”7 Remnant:</b> archive truth, drop distortion (Eq.5) and roll into the next Frame.</li>
    </ul>
  </article>

  <article class="card col-12 eq-card reveal">
    <h3>Operators in detail (ğ“˜ Â· ğ“› Â· ğ“’ Â· ğ“¢)</h3>
    <ul class="list">
      <li><b>ğ“˜ Intention.</b> Selects target region in state-space and primes harmonic gate <span class="mono">ğ“—(Î½)</span> (Eq.3, Eq.11).</li>
      <li><b>ğ“› Language.</b> Couples meaning to carriers: <span class="mono">\(\mathcal{L} = \mathsf{Semantics} \otimes \mathbf{V}(\nu)\)</span> (Eq.4) with weighted token gradient (Eq.4b).</li>
      <li><b>ğ“’ Coherence.</b> Projects onto the safe, phase-locked subspace (Eq.6), yields index <span class="mono">Î</span> (Eq.13).</li>
      <li><b>ğ“¢ Source/Selection.</b> Applies the stop rule (Eq.9), traces causes (Eq.10/Eq.12), writes remnant (Eq.5).</li>
    </ul>
  </article>

  <article class="card col-12 eq-card reveal">
    <h3>Foundational Field &amp; Carriers</h3>
    <div class="eq"><div class="eq-scroll" id="eq0a-body">
      $$\Psi_{\Omega}(x,t)=\oint_{\mathbb{R}}\nabla\mathcal{A}\,\Phi(x,t,\nu)\,d\nu+\Lambda\,\mathcal{E}(x,t)$$
    </div></div>
    <p>Experience emerges from a phase-weighted spectrum; <span class="mono">Î›</span> damps harmful trajectories (Eq.9).</p>
    <div class="eq"><div class="eq-scroll" id="eqV-body">
      $$ \mathbf{V}(\nu)=\sum_{k} a_k\cos(2\pi\nu_k t+\phi_k),\quad \nu\in\Gamma\subset\mathbb{R} $$
    </div></div>
    <p>Choose few, clean carriers in <span class="mono">Î“</span> (e.g., 432/528/369/144/137) and gate with <span class="mono">ğ“—(Î½)</span>.</p>
  </article>

  <article class="card col-12 eq-card reveal">
    <h3>Harmonic Gate â†’ Learning â†’ Memory</h3>
    <div class="eq"><div class="eq-scroll" id="eqLearn-body">
      $$ \mathcal{H}(\nu)\in[0,1],\qquad \frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla \mathcal{R},\qquad 
         \eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big) $$
    </div></div>
    <p>Below <span class="mono">Î<sub>0</sub></span>: motion is sticky; above it: learning accelerates yet remains bounded by Eq.9.</p>
    <div class="eq"><div class="eq-scroll" id="eqMem-body">
      $$\mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t} w_\tau(t-s)\,F(s)\,ds,\qquad \int_0^\tau w_\tau(u)\,du=1$$
    </div></div>
    <ul class="list">
      <li><b>Triangular</b> for ritual arcs; <b>Exponential</b> for responsiveness; <b>Gaussian</b> for smooth study.</li>
    </ul>
  </article>

  <article class="card col-12 eq-card reveal">
    <h3>Ethical Law â€” Safety Envelope</h3>
    <div class="eq"><div class="eq-scroll" id="eqEthMask-body">
      $$ \forall a:\ \mathrm{damage}(a)>0\Rightarrow\mathsf{halt},\qquad
         \lim_{t\to\infty}\frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \uparrow $$
    </div></div>
    <ul class="list">
      <li><b>Indicators:</b> breath tightens â€¢ micro-grimace â€¢ cognitive fog â†’ pause.</li>
      <li><b>Re-align:</b> retune carriers â†’ re-weight semantics â†’ re-declare frame â†’ resume.</li>
    </ul>
  </article>

  <article class="card col-12 eq-card reveal" id="operators-appendix">
    <h3>Operators &amp; Notation (Quick Reference)</h3>
    <div class="grid">
      <div class="col-6">
        <ul class="list">
          <li><span class="mono">Î¨<sub>Î©</sub></span>: foundational field (Eq.0)</li>
          <li><span class="mono">ğ“—(Î½)</span>: harmonic gate (Eq.3)</li>
          <li><span class="mono">ğ•(Î½)</span>: voice carriers (Eq.17)</li>
          <li><span class="mono">âŠ•</span>: coherent merge; PL = phase-lock (Eq.6)</li>
        </ul>
      </div>
      <div class="col-6">
        <ul class="list">
          <li><span class="mono">Î</span>: coherence index (Eq.13)</li>
          <li><span class="mono">Î·(Î)</span>: learning kernel (Eq.15)</li>
          <li><span class="mono">ğ•„<sub>Ï„</sub></span>: memory window (Eq.16)</li>
          <li><span class="mono">Frame</span>: scope/witness/ethics (Eq.11)</li>
        </ul>
      </div>
    </div>
  </article>
</section>

<div class="goldline sweep"></div>

<!-- ===================== OPERATING SECTION (UNIFIED) ===================== -->
<section class="grid" id="ops" aria-labelledby="ops-h">
  <article class="card col-12 eq-card reveal">
    <h2 id="ops-h">Operating Section â€” Unified Master Equation &amp; Canon (0â€“17)</h2>
    <p>This collects the whole system into one object: the field, operators, gates, coherence, learning, memory, and ethics. Use it for teaching, audits, and debugging ritual flow.</p>
    <div class="eq"><div class="eq-scroll" id="eq-unified">
      $$
      \left\{
      \begin{aligned}
        &\textbf{(0)}\quad
        \Psi_{\Omega}(x,t)=\oint_{\mathbb{R}}\nabla\mathcal{A}\,\Phi(x,t,\nu)\,d\nu+\Lambda\,\mathcal{E}(x,t) \\
        &\textbf{(1)}\quad
        \mathbf{R}=f(\mathbf{K})\cdot(\mathcal{I}\,\mathcal{L}\,\mathcal{C}\,\mathcal{S}) \\
        &\textbf{(2)}\quad
        \mathcal{W}(x,t)=\partial_x\,\mathrm{Awareness}(x,t)+\mathcal{I}\cdot\mathbb{M}_\tau \\
        &\textbf{(3)}\quad
        \mathcal{H}(\nu)\in[0,1] \\
        &\textbf{(4)}\quad
        \mathcal{L}(x,t,\nu)=\mathsf{Semantics}(x,t)\otimes\mathbf{V}(\nu) \\
        &\textbf{(4b)}\quad
        \nabla_{\text{sem}}\mathrm{Phrase}=\sum_k w_k\nabla_{\text{sem}}\mathrm{Token}_k,\;\sum_k w_k=1 \\
        &\textbf{(5)}\quad
        \mathcal{R}_\infty[F]=\lim_{\tau\to\infty}\big(\mathsf{keep}_{\text{truth}}F-\mathsf{drop}_{\text{distortion}}F\big) \\
        &\textbf{(6)}\quad
        \mathbb{T}_7(x,t)=\bigoplus_{\nu\in\Gamma}\mathrm{PL}\big[\mathbf{V}(\nu)\big] \\
        &\textbf{(7),(8)}\quad
        \text{External comparators: Copeland / Goodwin (not codex law)} \\
        &\textbf{(9)}\quad
        \forall a:\ \mathrm{damage}(a)>0\Rightarrow\mathsf{halt},\quad
        \lim_{t\to\infty}\frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)}\uparrow \\
        &\textbf{(10)}\quad
        \Pi_{\nu}^{-1}:\ \text{observed resonance}\rightarrow\text{source terms} \\
        &\textbf{(11)}\quad
        \mathsf{Frame}(x,t)=(\mathsf{scope},\mathcal{W},\mathsf{ethics}) \\
        &\textbf{(12)}\quad
        \mathcal{L}_c=(V=\text{micro-acts},\ E=\text{consequences}) \\
        &\textbf{(13)}\quad
        \Xi\in[0,1] \\
        &\textbf{(14)}\quad
        \frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla\mathcal{R} \\
        &\textbf{(15)}\quad
        \eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big) \\
        &\textbf{(16)}\quad
        \mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t} w_\tau(t-s)\,F(s)\,ds,\ \int_0^\tau w_\tau(u)\,du=1 \\
        &\textbf{(17)}\quad
        \mathbf{V}(\nu)=\sum_k a_k\cos(2\pi\nu_k t+\phi_k),\quad \nu\in\{432,528,369,144,137,\dots\}
      \end{aligned}
      \right.
      $$
    </div></div>
    <p class="eq-legend">
      The boxed <span class="mono">ğ“˜Â·ğ“›Â·ğ“’Â·ğ“¢</span> pipeline sits inside the ethical envelope (Eq.9). Learning is coherence-gated (Eq.13â€“15), time-textured (Eq.16), and written to remnant (Eq.5).
    </p>
  </article>

  <article class="card col-12 reveal">
    <h3>Operating loop (6 steps)</h3>
    <ol class="list">
      <li><b>Frame</b> (Eq.11): scope â€¢ witness â€¢ ethics. Declare success/failure states.</li>
      <li><b>Gate carriers</b> (Eq.3, Eq.17): pick 2â€“3 Î½; run the soft gate; verify comfort.</li>
      <li><b>Encode language</b> (Eq.4, 4b): write a 3â€“6 word phrase; set <span class="mono">w_k</span>.</li>
      <li><b>Witness</b> (Eq.2): sense shifts; log <span class="mono">Î</span> with your mini-calculator.</li>
      <li><b>Update</b> (Eq.14â€“15): only if <span class="mono">Î</span> â†‘; else retune (Eq.9).</li>
      <li><b>Archive</b> (Eq.5): keep truth, drop distortion; update lattice (Eq.12) and ladder (Eq.10).</li>
    </ol>
  </article>

  <article class="card col-12 reveal">
    <h3>Design invariants (donâ€™t break these)</h3>
    <ul class="list">
      <li><b>Few carriers</b> beat many; phase-lock before amplifying (Eq.6).</li>
      <li><b>Short language</b> with explicit weights outperforms long prose (Eq.4b).</li>
      <li><b>Safety first</b>: any harm â†’ halt (Eq.9); never â€œpush throughâ€ noise.</li>
      <li><b>Learning follows coherence</b> (Eq.15), not desire.</li>
      <li><b>Memory matches the mission</b> (Eq.16): ritual â‰ˆ triangular, response â‰ˆ exponential, study â‰ˆ Gaussian.</li>
    </ul>
  </article>
</section>

<div class="goldline sweep"></div>
    
    <!-- ===================== PART II ===================== -->
    <section class="grid" id="p2" aria-labelledby="p2-h">
      <article class="card col-12 reveal">
        <h2 id="p2-h">Part II â€” Canon 0â€“17 (Living Commentary)</h2>
        <p class="meta">#7 Copeland and #8 Goodwin remain external comparators; all other forms are native to the Codex.</p>
      </article>

      <!-- 0 -->
      <article class="card col-12 eq-card reveal" id="eq0">
        <div class="flexbar"><h3>Eq.0 â€” Foundational Field \(\Psi_{\Omega}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq0-body">Copy TeX</button><button class="chip" data-copy-link="#eq0">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq0-body">
          $$\Psi_{\Omega}(x,t)=\oint_{\mathbb{R}}\nabla\mathcal{A}\,\Phi(x,t,\nu)\,d\nu\;+\;\Lambda\,\mathcal{E}(x,t)$$
        </div></div>
        <p>Experience emerges from a phase-weighted frequency sweep; \( \Lambda \mathcal{E} \) damps harmful or distorting trajectories.</p>
      </article>

      <!-- 1 -->
      <article class="card col-12 eq-card reveal" id="eq1">
        <div class="flexbar"><h3>Eq.1 â€” Source = Supply Ã— Operators</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq1-body">Copy TeX</button><button class="chip" data-copy-link="#eq1">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq1-body">
          $$ \mathbf{R} \;=\; f(\pi,e,i,\hbar,c,G,\mathrm{DNA},\Omega_{\mathrm{DM}},\Omega_{\Lambda},H_{0},432,528,137,144,369,\ldots)\;\times\;\mathcal{I}\mathcal{L}\mathcal{C}\mathcal{S} $$
        </div></div>
      </article>

      <!-- 2 -->
      <article class="card col-12 eq-card reveal" id="eq2">
        <div class="flexbar"><h3>Eq.2 â€” Witness \(\mathcal{W}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq2-body">Copy TeX</button><button class="chip" data-copy-link="#eq2">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq2-body">
          $$\mathcal{W}(x,t)=\partial_x\,\mathrm{Awareness}(x,t)\;+\;\mathcal{I}\cdot\mathbb{M}_\tau$$
        </div></div>
      </article>

      <!-- 3 -->
      <article class="card col-12 eq-card reveal" id="eq3">
        <div class="flexbar"><h3>Eq.3 â€” Harmonic Gate \(\mathcal{H}(\nu)\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq3-body">Copy TeX</button><button class="chip" data-copy-link="#eq3">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq3-body">
          $$\mathcal{H}(\nu)\in\{0,1\}\quad\text{or}\quad \mathcal{H}(\nu)\in[0,1]\ \text{(soft gate)}$$
        </div></div>
      </article>

      <!-- 4 -->
      <article class="card col-12 eq-card reveal" id="eq4">
        <div class="flexbar"><h3>Eq.4 â€” Language / Word \(\mathcal{L}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq4-body">Copy TeX</button><button class="chip" data-copy-link="#eq4">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq4-body">
          $$\mathcal{L}(x,t,\nu)=\mathsf{Semantics}(x,t)\;\otimes\;\mathbf{V}(\nu)$$
        </div></div>
      </article>

      <!-- 4b -->
      <article class="card col-12 eq-card reveal" id="eq4b">
        <div class="flexbar"><h3>Eq.4b â€” Semantic Gradient (Token Emphasis)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq4b-body">Copy TeX</button><button class="chip" data-copy-link="#eq4b">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq4b-body">
          $$ \nabla_{\text{sem}} \mathrm{Phrase}=\sum_k w_k \nabla_{\text{sem}}\mathrm{Token}_k,\qquad \sum_k w_k=1 $$
        </div></div>
      </article>

      <!-- 5 -->
      <article class="card col-12 eq-card reveal" id="eq5">
        <div class="flexbar"><h3>Eq.5 â€” Remnant \(\mathcal{R}_\infty\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq5-body">Copy TeX</button><button class="chip" data-copy-link="#eq5">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq5-body">
          $$\mathcal{R}_\infty[F]=\lim_{\tau\to\infty}\big(\mathsf{keep}_{\text{truth}}F-\mathsf{drop}_{\text{distortion}}F\big)$$
        </div></div>
      </article>

      <!-- 6 -->
      <article class="card col-12 eq-card reveal" id="eq6">
        <div class="flexbar"><h3>Eq.6 â€” Type-7 Field \(\mathbb{T}_7\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq6-body">Copy TeX</button><button class="chip" data-copy-link="#eq6">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq6-body">
          $$\mathbb{T}_{7}(x,t)=\bigoplus_{\nu\in\Gamma}\mathrm{PL}\!\left[\mathbf{V}(\nu)\right]$$
        </div></div>
      </article>

      <!-- 7* -->
      <article class="card col-12 reveal" id="eq7">
        <h3>Eq.7* â€” Copeland (External Comparator)</h3>
        <p>Recursion/recognition mirror for calibration; not codex law.</p>
      </article>

      <!-- 8* -->
      <article class="card col-12 reveal" id="eq8">
        <h3>Eq.8* â€” Goodwin (External Comparator)</h3>
        <p>Coupling/oscillation template for contrast; not enacted as law.</p>
      </article>

      <!-- 9 -->
      <article class="card col-12 eq-card reveal" id="eq9">
        <div class="flexbar"><h3>Eq.9 â€” Ethical Law (Stop Rule)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq9-body">Copy TeX</button><button class="chip" data-copy-link="#eq9">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq9-body">
          $$\forall a:\ \mathrm{damage}(a)>0\Rightarrow\mathsf{halt},\qquad
            \lim_{t\to\infty}\frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \uparrow $$
        </div></div>
      </article>

      <!-- 10 -->
      <article class="card col-12 eq-card reveal" id="eq10">
        <div class="flexbar"><h3>Eq.10 â€” Ladder \(\Pi_{\nu}^{-1}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq10-body">Copy TeX</button><button class="chip" data-copy-link="#eq10">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq10-body">
          $$\Pi_{\nu}^{-1}:\ \text{observed resonance }\rightarrow \text{source terms (carriers, intents, constants)}$$
        </div></div>
      </article>

      <!-- 11 -->
      <article class="card col-12 eq-card reveal" id="eq11">
        <div class="flexbar"><h3>Eq.11 â€” Projection Frame \(\mathsf{Frame}\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq11-body">Copy TeX</button><button class="chip" data-copy-link="#eq11">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq11-body">
          $$\mathsf{Frame}(x,t)=(\mathsf{scope},\mathcal{W},\mathsf{ethics})$$
        </div></div>
      </article>

      <!-- 12 -->
      <article class="card col-12 eq-card reveal" id="eq12">
        <div class="flexbar"><h3>Eq.12 â€” Causal Lattice \(\mathcal{L}_c\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq12-body">Copy TeX</button><button class="chip" data-copy-link="#eq12">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq12-body">
          $$\mathcal{L}_c=(V=\text{micro-acts},\ E=\text{consequences})$$
        </div></div>
      </article>

      <!-- 13 -->
      <article class="card col-12 eq-card reveal" id="eq13">
        <div class="flexbar"><h3>Eq.13 â€” Coherence \(\Xi\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq13-body">Copy TeX</button><button class="chip" data-copy-link="#eq13">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq13-body">
          $$\Xi\in[0,1]\quad \text{(gates memory, learning, safe amplification)}$$
        </div></div>
      </article>

      <!-- 14 -->
      <article class="card col-12 eq-card reveal" id="eq14">
        <div class="flexbar"><h3>Eq.14 â€” Update Rule</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq14-body">Copy TeX</button><button class="chip" data-copy-link="#eq14">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq14-body">
          $$\frac{d\mathcal{R}}{dt}=\eta(\Xi)\,\nabla \mathcal{R}$$
        </div></div>
      </article>

      <!-- 15 -->
      <article class="card col-12 eq-card reveal" id="eq15">
        <div class="flexbar"><h3>Eq.15 â€” Learning Kernel</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq15-body">Copy TeX</button><button class="chip" data-copy-link="#eq15">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq15-body">
          $$\eta(\Xi)=\eta_0\,\sigma\!\big(\alpha(\Xi-\Xi_0)\big)$$
        </div></div>
      </article>

      <!-- 16 -->
      <article class="card col-12 eq-card reveal" id="eq16">
        <div class="flexbar"><h3>Eq.16 â€” Memory Window \(\mathbb{M}_\tau\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq16-body">Copy TeX</button><button class="chip" data-copy-link="#eq16">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq16-body">
          $$\mathbb{M}_\tau[F](t)=\int_{t-\tau}^{t}\! w_\tau(t-s)\,F(s)\,ds,\quad \int_0^\tau w_\tau(u)\,du=1$$
        </div></div>
      </article>

      <!-- 17 -->
      <article class="card col-12 eq-card reveal" id="eq17">
        <div class="flexbar"><h3>Eq.17 â€” Voice Carriers \(\mathbf{V}(\nu)\)</h3>
          <div class="eq-tools"><button class="chip" data-copy-tex="#eq17-body">Copy TeX</button><button class="chip" data-copy-link="#eq17">Link</button></div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq17-body">
          $$\mathbf{V}(\nu)=\sum_{k} a_k\,\cos(2\pi\nu_k t+\phi_k),\quad \nu\in\{432,528,369,144,137,\dots\}$$
        </div></div>
        <a href="teach.html#observer" class="cta to-manifest">â–¶ Try carriers in Manifest</a>
      </article>

      <article class="card col-12 reveal">
        <h3>Advanced: Many Frames, Many Realities</h3>
        <div class="eq"><div class="eq-scroll" id="eq-adv1-body">
          $$ \mathbb{T}_7^{(\text{group})} \approx \bigoplus_{j=1}^{N}\mathrm{PL}\big[\mathbf{V}^{(j)}(\nu)\big],\quad \Xi_{\text{group}} \approx \frac{1}{N}\sum_j \Xi^{(j)} $$
        </div></div>
      </article>

      <article class="card col-12 reveal">
        <h3>Advanced: Data &amp; Instrumentation</h3>
        <ul class="list">
          <li><b>Audio:</b> spectral centroid variance and beat stability</li>
          <li><b>Physio:</b> smoother breath + reduced HF HRV noise â†’ â†‘ <span class="mono">Î</span></li>
          <li><b>Subjective:</b> quick Likert trio: clarity â€¢ warmth â€¢ ease</li>
        </ul>
      </article>
    </section>

    <div class="goldline sweep"></div>

    <!-- ===================== 13 MOONS ===================== -->
    <section class="grid" id="moons" aria-labelledby="moons-h">
      <article class="card col-12 reveal">
        <h2 id="moons-h">13 Moons â€” Cycle, Operators, Practice</h2>
        <p>The 13-Moon cycle binds timekeeping, operators, and practice. Each Moon emphasizes a facet of the pipeline and specific carriers/phrases. Use it as a ritual calendar and a pedagogical arc.</p>
        <div class="eq"><div class="eq-scroll" id="eq-moons">
          $$ \mathrm{Moon}_m:\quad (\mathsf{Theme}_m,\ \mathcal{I}_m,\ \mathcal{L}_m,\ \mathcal{C}_m,\ \mathcal{S}_m,\ \mathbf{V}_m(\nu),\ \tau_m) $$
        </div></div>
      </article>

      <article class="card col-12 reveal">
        <h3>Mapping (Overview)</h3>
        <ul class="list">
          <li><b>1. Initiation:</b> Frame (Eq.11). Carriers: 432. Phrase: â€œI choose the good.â€</li>
          <li><b>2. Repair:</b> Remediation (Eq.5). Carriers: 528. Phrase: â€œRepair and restore.â€</li>
          <li><b>3. Verification:</b> Witness (Eq.2). Carriers: 369. Phrase: â€œI witness clearly.â€</li>
          <li><b>4. Remedy:</b> Update (Eq.14/15). Carriers: 144. Phrase: â€œStep in safety.â€</li>
          <li><b>5. Abatement:</b> Ethical mask (Eq.9). Carriers: 432+144 (beats). Phrase: â€œHalt harm.â€</li>
          <li><b>6. Assurance:</b> Coherence (Eq.13). Carriers: 528+369. Phrase: â€œCoherence grows.â€</li>
          <li><b>7. Restoration:</b> Remnant (Eq.5). Carriers: 432. Phrase: â€œKeep the true.â€</li>
          <li><b>8. Source:</b> Return (ğ“¢). Carriers: 137 ref motif. Phrase: â€œReturn to source.â€</li>
          <li><b>9. Language:</b> Token weights (Eq.4b). Carriers: voice-only. Phrase refinement.</li>
          <li><b>10. Lattice:</b> Consequences (Eq.12). Carriers: drum/step beat. â€œGraph the acts.â€</li>
          <li><b>11. Memory:</b> Window (Eq.16). Carriers: slow-breath beat (0.1â€“0.2 Hz).</li>
          <li><b>12. Group:</b> Type-7 field (Eq.6). Carriers: choir PL.</li>
          <li><b>13. Completion:</b> Archive + new Frame (Î”7â†’Î”0).</li>
        </ul>
      </article>

      <article class="card col-12 reveal">
        <h3>Practice Card (each Moon)</h3>
        <ol class="list">
          <li><b>Frame</b> the moonâ€™s scope and ethics.</li>
          <li>Pick <b>2â€“3 carriers</b> (test gate fit).</li>
          <li>Craft a <b>short phrase</b> (1â€“6 words), weight tokens.</li>
          <li><b>Witness</b> with the <span class="mono">Î</span> mini-calculator.</li>
          <li><b>Update</b> only if <span class="mono">Î</span> â†‘; else retune.</li>
          <li><b>Log</b> to the Remnant.</li>
        </ol>
      </article>
    </section>

    <div class="goldline sweep"></div>

    <!-- Ethics -->
    <section class="grid" id="ethics" aria-labelledby="eth-h">
      <article class="card col-12 eq-card reveal">
        <div class="flexbar">
          <h2 id="eth-h">Ethics &amp; Stop Rule â€” Operational Law</h2>
          <div class="eq-tools">
            <button class="chip" data-copy-tex="#eq-eth-body">Copy TeX</button>
            <button class="chip" data-copy-link="#ethics">Link</button>
          </div>
        </div>
        <div class="eq"><div class="eq-scroll" id="eq-eth-body">
          $$ \Xi \;\approx\; \frac{\langle H \cdot I \rangle}{1 + \mathrm{Var}[\mathcal{M}]} \qquad
             \text{If } \frac{\mathrm{Truth}(t+\Delta)}{\mathrm{Distortion}(t+\Delta)} < \frac{\mathrm{Truth}(t)}{\mathrm{Distortion}(t)} \Rightarrow \text{ Halt } \to \text{ Re-align } \to \text{ Resume} $$
        </div></div>
      </article>
    </section>

    <!-- Notes -->
    <section class="grid" id="notes" aria-labelledby="nt-h">
      <article class="card col-12 reveal">
        <h2 id="nt-h">Notes &amp; Cross-links</h2>
        <ul class="list">
          <li><b>Numbers as Keys.</b> 432, 528, 137/144/369 are practical anchors; they are tools, not dogma.</li>
          <li><b>Seven Seals Path.</b> Acknowledgment â†’ Repair â†’ Verification â†’ Remedy â†’ Abatement â†’ Assurance â†’ Restoration.</li>
          <li>Practice lives in <a href="teach.html">Manifest</a>. Overview on <a href="index.html">Home</a>.</li>
        </ul>
      </article>
    </section>

    <footer class="footer">
      Â© <span id="y"></span> Scroll of Fire. All constants are provisional until observed.
    </footer>
    </main>

  <!-- Back to Top -->
  <button class="to-top cta" id="toTop" type="button" aria-label="Back to top" title="Back to top">â†‘</button>

  <!-- Command Palette -->
  <div class="palette" id="palette" role="dialog" aria-modal="true" aria-labelledby="palLabel" hidden>
    <div class="panel">
      <h3 id="palLabel" class="sr-only">Command palette</h3>
      <input id="palInput" type="text" placeholder="Find anythingâ€¦ (Esc to close)" aria-label="Command palette">
      <ul id="palList" aria-live="polite"></ul>
    </div>
  </div>

  <!-- Small layout helper -->
  <style>
    .flexbar{display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap}
    .eq-tools{display:flex; gap:.4rem}
    .chip{font-size:.85rem; padding:.25rem .55rem; border-radius:999px; border:1px solid var(--line); background:var(--bg-elev); opacity:.9}
  </style>

  <!-- Page helpers & feature JS -->
  <script>
    // Year
    (function(){ const y=document.getElementById('y'); if(y) y.textContent=new Date().getFullYear(); })();

    // HERO fit (keeps your aspect-ratio logic and responsive cover/contain chooser)
    (function(){
      const hero=document.getElementById('hero'), img=document.getElementById('heroBanner');
      if(!hero||!img) return;
      function applyAR(){ const iw=img.naturalWidth||2100, ih=img.naturalHeight||900; hero.style.aspectRatio=`${iw} / ${ih}`; }
      function pickFit(){
        if (matchMedia('(max-width:560px)').matches){ hero.style.setProperty('--hero-fit','contain'); return; }
        const iw=img.naturalWidth||2100, ih=img.naturalHeight||900, imageAR=iw/ih;
        const cw=hero.clientWidth||innerWidth, ch=Math.max(1, hero.clientHeight||innerHeight*0.38), containerAR=cw/ch;
        const cover = (Math.abs(containerAR - imageAR) / imageAR < 0.06);
        hero.style.setProperty('--hero-fit', cover ? 'cover' : 'contain');
      }
      function boot(){ applyAR(); pickFit(); }
      if(img.complete) boot(); else img.addEventListener('load', boot, {once:true});
      addEventListener('resize', pickFit, {passive:true});
      addEventListener('orientationchange', pickFit, {passive:true});
      addEventListener('visibilitychange', ()=>!document.hidden && pickFit());
    })();

    // Scroll reveal
    (function(){
      if(!('IntersectionObserver' in window)){ document.querySelectorAll('.reveal').forEach(el=>el.classList.add('in')); return; }
      const io=new IntersectionObserver(es=>{ for(const e of es){ if(e.isIntersecting){ e.target.classList.add('in'); io.unobserve(e.target); } } }, {threshold:.12});
      document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
    })();

    // Back-to-Top
    (function(){
      const btn=document.getElementById('toTop'); if(!btn) return;
      btn.addEventListener('click',()=>{ window.scrollTo({top:0,behavior:'smooth'}) });
      const io=new IntersectionObserver(([e])=>{ btn.classList.toggle('show', !e.isIntersecting); }, {threshold:0.01});
      io.observe(document.querySelector('header.site'));
    })();

    // Quick controls: Echo/HUD/Carrier/Affect/Lights
    (function(){
      const body=document.body, html=document.documentElement;
      const btnEcho=document.getElementById('toggleSimple');
      btnEcho?.addEventListener('click',()=>{
        body.classList.toggle('simple-on');
        btnEcho.setAttribute('aria-pressed', String(body.classList.contains('simple-on')));
      });
      const btnHUD=document.getElementById('toggleGrid'), grid=document.querySelector('.laser-grid');
      btnHUD?.addEventListener('click',()=>{
        const show = grid && grid.style.display !== 'none';
        if(grid) grid.style.display = show ? 'none' : '';
        btnHUD.setAttribute('aria-pressed', String(!show));
      });
      const btnCarrier=document.getElementById('cycleCarrier');
      const carrierAttr=(html.getAttribute('data-carriers')||'').split(',').map(s=>s.trim()).filter(Boolean);
      const skins=(carrierAttr.length?carrierAttr:['432','528','369','144','963']).map(n=>`carrier-${n}`);
      const curSkin=()=> skins.find(s=>html.classList.contains(s)) || skins[0];
      const nextSkin=c=> skins[(skins.indexOf(c)+1)%skins.length];
      btnCarrier?.addEventListener('click',()=>{
        const cur=curSkin(), nxt=nextSkin(cur);
        skins.forEach(s=>html.classList.remove(s)); html.classList.add(nxt);
        btnCarrier.textContent = `Carrier ${nxt.split('-')[1]}`;
      });
      if(btnCarrier) btnCarrier.textContent=`Carrier ${curSkin().split('-')[1]}`;
      const btnAffect=document.getElementById('toggleAffect');
      btnAffect?.addEventListener('click',()=>{
        const off=document.body.classList.toggle('affect-off');
        btnAffect.setAttribute('aria-pressed', String(!off));
      });
      const lights=document.getElementById('heroLights');
      const btnLights=document.getElementById('toggleLights');
      btnLights?.addEventListener('click',()=>{
        const off=lights?.classList.toggle('off');
        btnLights.setAttribute('aria-pressed', String(!off));
      });
    })();

    // Inject on-page search after tabs ("/" to focus)
    (function(){
      const list=document.createElement('div'); list.id='site-suggest'; list.className='mini-toc hidden'; list.setAttribute('role','listbox');
      const label=document.createElement('label'); label.className='meta'; label.textContent='Press / to search this page';
      const input=document.createElement('input'); input.id='site-search'; input.type='search'; input.placeholder='Search text on this pageâ€¦'; input.setAttribute('aria-label','Search this page'); input.autocomplete='off'; input.spellcheck=false;
      const holder=document.createElement('article'); holder.className='card col-12 searchbox reveal'; holder.append(label,input,list);
      const grid=document.createElement('section'); grid.className='grid'; grid.style.margin='8px 0 0'; grid.append(holder);
      const main=document.getElementById('main'); const tabs=main.querySelector('.tabs'); tabs && main.insertBefore(grid, tabs.nextSibling);

      addEventListener('keydown',(e)=>{ if(e.key==='/' && document.activeElement!==input){ e.preventDefault(); input.focus(); input.select(); } });

      const SOURCES=[...document.querySelectorAll('h2[id],h3[id],a.tile'), ...document.querySelectorAll('.eq-card')];
      function items(q){
        const s=q.trim().toLowerCase(); if(!s) return [];
        const out=[];
        for(const el of SOURCES){
          const text=(el.innerText||'').trim();
          if(text.toLowerCase().includes(s)){
            let href='#'; if(el.id) href = `#${el.id}`;
            out.push({text, href}); if(out.length>12) break;
          }
        } return out;
      }
      function render(arr){
        if(!arr.length){ list.classList.add('hidden'); list.innerHTML=''; return; }
        list.innerHTML = arr.map((o,i)=>`<a href="${o.href}" role="option" data-ix="${i}">${o.text}</a>`).join('');
        list.classList.remove('hidden');
      }
      input.addEventListener('input', ()=>render(items(input.value)));
      input.addEventListener('keydown',(e)=>{
        const links=[...list.querySelectorAll('a')]; if(!links.length) return;
        const cur=list.querySelector('.sel'); let i=cur?+cur.dataset.ix:-1;
        if(e.key==='ArrowDown'){ e.preventDefault(); i=Math.min(links.length-1, i+1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); i=Math.max(0, i-1); }
        else if(e.key==='Enter'){ if(cur){ location.hash=cur.getAttribute('href'); list.classList.add('hidden'); } return; }
        else if(e.key==='Escape'){ list.classList.add('hidden'); return; }
        links.forEach(a=>a.classList.remove('sel')); if(i>=0){ links[i].classList.add('sel'); }
      });
      addEventListener('click',(e)=>{ if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden'); });
    })();

    // Smooth in-page scroll for [data-jump]
    document.addEventListener('click', e=>{
      const a = e.target.closest('[data-jump]'); if(!a) return;
      const href = a.getAttribute('href'); if(!href || !href.startsWith('#')) return;
      const tgt = document.querySelector(href); if(!tgt) return;
      e.preventDefault(); tgt.scrollIntoView({behavior:'smooth', block:'start'}); history.pushState(null,'',href);
    });

    // Equation collapse toggles + copy/link tools
    (function eqTools(){
      function copy(text){
        if (navigator.clipboard?.writeText) { navigator.clipboard.writeText(text); return; }
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      function texFrom(sel){
        const el = document.querySelector(sel);
        return el ? (el.textContent||'').trim() : '';
      }
      document.querySelectorAll('.eq').forEach(wrap=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='eq-toggle'; btn.textContent='Collapse';
        btn.addEventListener('click', ()=>{
          const collapsed = wrap.getAttribute('data-collapsed')==='true';
          wrap.setAttribute('data-collapsed', String(!collapsed));
          btn.textContent = collapsed ? 'Collapse' : 'Expand';
        });
        wrap.appendChild(btn);
      });
      document.addEventListener('click', (e)=>{
        const b1=e.target.closest('[data-copy-tex]'); if(b1){
          const raw = texFrom(b1.getAttribute('data-copy-tex')); if(raw){ copy(raw); b1.textContent='Copied'; setTimeout(()=>b1.textContent='Copy TeX', 900); }
          e.preventDefault(); return;
        }
        const b2=e.target.closest('[data-copy-link]'); if(b2){
          const idSel = b2.getAttribute('data-copy-link'); const base = location.origin + location.pathname; const hash = idSel.startsWith('#') ? idSel : ('#'+idSel);
          copy(base+hash); history.pushState(null,'',hash); b2.textContent='Link Copied'; setTimeout(()=>b2.textContent='Link', 900); e.preventDefault(); return;
        }
      });
    })();

    // Voice Reader mini-controls + collapsible bar a11y
    (function(){
      const det = document.getElementById('voice-reader');
      const bar = det?.querySelector('.collapsible__bar');
      bar?.addEventListener('click', (e)=>{
        if (e.target.closest('.chip')) return;
        const open = det.hasAttribute('open'); bar.setAttribute('aria-expanded', String(!open));
      });
      document.getElementById('vr-play-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('vr-play')?.click(); });
      document.getElementById('vr-stop-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('vr-stop')?.click(); });
    })();

    // Command Palette (âŒ˜K / Ctrl+K)
    (function palette(){
      const pal=document.getElementById('palette'), input=document.getElementById('palInput'), list=document.getElementById('palList');
      const OPEN_KEYS=new Set(['k','K']);
      const LINKS=[...document.querySelectorAll('a, .cta')].map(a=>({text:a.textContent.trim(), href:a.getAttribute('href')||'#'})).filter(o=>o.text && o.href);
      function open(){ pal.hidden=false; input.value=''; render(LINKS.slice(0,12)); setTimeout(()=>input.focus(),0); }
      function close(){ pal.hidden=true; }
      function render(items){ list.innerHTML=items.map(o=>`<li><a href="${o.href}">${o.text}</a></li>`).join(''); }
      function filter(q){ q=q.trim().toLowerCase(); if(!q) return LINKS; return LINKS.filter(o=>o.text.toLowerCase().includes(q)); }
      addEventListener('keydown',(e)=>{ const meta=e.ctrlKey||e.metaKey; if(meta && OPEN_KEYS.has(e.key)){ e.preventDefault(); open(); } if(!pal.hidden && e.key==='Escape'){ e.preventDefault(); close(); } });
      pal.addEventListener('click', (e)=>{ if(e.target===pal) close(); });
      input.addEventListener('input', ()=>render(filter(input.value).slice(0,14)));
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const a=list.querySelector('a'); if(a){ location.href=a.getAttribute('href'); close(); } } });
    })();

    // Î driver (ambient glow)
    (function(){
      const root=document.documentElement.style, dot=document.querySelector('.xi-dot'); let xi=.35;
      function step(){
        const target=.25+Math.random()*.6, start=xi, dur=2200+Math.random()*1600, t0=performance.now();
        function tween(t){
          const p=Math.min(1,(t-t0)/dur);
          xi=start+(target-start)*(0.5-0.5*Math.cos(Math.PI*p));
          root.setProperty('--xi', xi.toFixed(3)); if(dot) dot.style.opacity=(0.7+0.3*xi).toFixed(3);
          (p<1)?requestAnimationFrame(tween):requestAnimationFrame(step);
        } requestAnimationFrame(tween);
      } requestAnimationFrame(step);
    })();

    /* Mobile drawer: open/close + a11y */
    (function(){
      const btn = document.getElementById('navToggle');
      const drawer = document.getElementById('navDrawer');
      if(!btn || !drawer) return;
      function open(){ drawer.hidden = false; btn.setAttribute('aria-expanded','true'); }
      function close(){ drawer.hidden = true; btn.setAttribute('aria-expanded','false'); }
      btn.addEventListener('click', ()=> drawer.hidden ? open() : close());
      document.addEventListener('click', (e)=>{
        if (drawer.hidden) return;
        if (e.target === btn) return;
        if (!drawer.contains(e.target)) close();
      });
      addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !drawer.hidden) close(); });
      drawer.addEventListener('click', (e)=>{ const a=e.target.closest('a'); if(a){ close(); } });
    })();

    /* Voice Reader (Web Speech API) â€” upgraded */
    (function(){
      const $ = (id)=>document.getElementById(id);
      const btnPlay   = $('vr-play'), btnPause=$('vr-pause'), btnResume=$('vr-resume'), btnStop=$('vr-stop');
      const btnSel    = $('vr-read-selection'), voiceSel=$('vr-voice'), rateInp=$('vr-rate'), pitchInp=$('vr-pitch');
      const rateVal   = $('vr-rate-val'), pitchVal=$('vr-pitch-val'), startSel=$('vr-start'), speakMath=$('vr-speak-math'), polish=$('vr-polish');
      const statusEl  = $('vr-status'), progressEl=$('vr-progress'), exportBtn=$('vr-export-ssml');

      if (!('speechSynthesis' in window)) {
        if (statusEl) statusEl.textContent = 'Voice playback is not supported in this browser.';
        return;
      }

      // Pronunciation map for cleaner English (expand symbols / jargon)
      const PRON = [
        [/\bÎ\b/g, 'Ksi'],
        [/ğ“˜/g, 'I (Intention)'], [/ğ“›/g, 'L (Language)'], [/ğ“’/g, 'C (Conscious Witness)'], [/ğ“¢/g, 'S (Source)'],
        [/â†’/g, ' to '], [/â†¦/g,' maps to '], [/â‰¥/g,' greater than or equal to '], [/â‰¤/g,' less than or equal to '],
        [/âŠ•/g, ' coherent merge '], [/Â·/g,' '], [/\bPL\b/g, 'phase lock'],
        [/Eq\.(\d+)/g, 'Equation $1'],
        [/Î½/g, 'nu'], [/Ï„/g, 'tau'], [/Ï†/g, 'phi'], [/Î·/g,'eta'], [/Ïƒ/g,'sigma'], [/Î›/g,'Lambda'],
      ];

      // Math verbalization fallback if MathJax not yet rendered
      function verbalizeMath(text){
        // light pass: strip $$ and inline \( \)
        text = text.replace(/\$\$([^$]+)\$\$/g, ' equation: $1 ').replace(/\\\(([^)]+)\\\)/g, ' $1 ');
        return text;
      }

      // Simple English polish
      function polishText(s){
        s = s.replace(/[ \t]+/g,' ')
             .replace(/\s+([,.;:!?])/g,'$1')
             .replace(/\(\s+/g,'(').replace(/\s+\)/g,')')
             .replace(/\sâ€”\s/g,' â€” ')
             .replace(/^\s+|\s+$/g,'');
        return s;
      }

      // Preferred default voice: first en-* (female if present), else first
      let voices=[];
      function populateVoices(){
        voices = speechSynthesis.getVoices().sort((a,b)=> a.name.localeCompare(b.name));
        if (!voiceSel) return;
        const cur = voiceSel.value;
        voiceSel.innerHTML = voices.map(v=>`<option value="${v.name}">${v.name} ${v.lang?('('+v.lang+')'):''}</option>`).join('');
        if (cur) voiceSel.value = cur;
        else {
          const en = voices.filter(v=> /^en\b/i.test(v.lang||''));
          const pick = en.find(v=>/female|Salli|Joanna|Emma|Olivia|Siri|Google UK English Female/i.test(v.name)) || en[0] || voices[0];
          if (pick) voiceSel.value = pick.name;
        }
      }
      populateVoices();
      speechSynthesis.onvoiceschanged = populateVoices;

      // UI bindings
      rateInp?.addEventListener('input', ()=> rateVal.textContent=(+rateInp.value).toFixed(2));
      pitchInp?.addEventListener('input',()=> pitchVal.textContent=(+pitchInp.value).toFixed(2));

      function status(t){ if(statusEl) statusEl.textContent=t; }
      function prog(cur,total){
        if(!progressEl) return;
        if(total<=0){ progressEl.textContent=''; progressEl.setAttribute('aria-hidden','true'); return; }
        const pct = Math.round((cur/total)*100);
        progressEl.textContent = `Reading ${cur} / ${total} (${pct}%)`;
        progressEl.setAttribute('aria-hidden','false');
      }

      function cleanNodeToText(root){
        const clone = root.cloneNode(true);
        // Remove UI
        clone.querySelectorAll('button, .eq-tools, .chip, .meta, .sr-only, .palette, .eq-toggle, .nav, .drawer').forEach(n=>n.remove());
        // Math: keep or drop
        if (speakMath && !speakMath.checked){
          clone.querySelectorAll('.eq, mjx-container').forEach(n=>n.remove());
        } else {
          clone.querySelectorAll('mjx-container').forEach(m=>{
            const alt = m.getAttribute('aria-label') || '';
            m.replaceWith(document.createTextNode(' equation ' + alt + ' '));
          });
          // If TeX still present
          clone.querySelectorAll('.eq').forEach(eq=>{
            const t = eq.innerText || '';
            eq.replaceWith(document.createTextNode(' ' + verbalizeMath(t) + ' '));
          });
        }
        let text = clone.innerText || clone.textContent || '';
        // Apply pronunciation + polish
        for(const [re,rep] of PRON){ text = text.replace(re, rep); }
        if (polish && polish.checked){ text = polishText(text); }
        // Remove menu residues
        text = text.replace(/\b(Copy TeX|Link Copied|Link)\b/g,'')
                   .replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n');
        return text.trim();
      }

      function getSectionOrSelection(){
        const sel = window.getSelection?.();
        if (sel && sel.rangeCount && String(sel).trim().length>0){
          return { text: String(sel).trim(), node: document.activeElement || document.body };
        }
        const id = (startSel?.value || '#p1');
        const sec = document.querySelector(id);
        return { text: cleanNodeToText(sec||document.body), node: sec||document.body };
      }

      // Sentence-aware chunking with abbrev guard
      const ABBR = /\b(?:e\.g|i\.e|vs|Dr|Mr|Mrs|Ms|Prof|Eq|Eqn|Fig)\.$/i;
      function chunkify(str, max=900){
        const raw = str.replace(/\r/g,'').split(/\n{2,}/); // paragraphs
        const out=[];
        for(const p of raw){
          const parts = p.split(/(?<=[.!?])\s+(?=[A-Z(â€œ"'\[])/);
          let buf='';
          for(const part of parts){
            const piece = part.trim();
            if(!piece) continue;
            if(ABBR.test(piece)) { buf += (buf?' ':'') + piece; continue; }
            if ((buf + ' ' + piece).length > max){
              if (buf) out.push(buf.trim());
              buf = piece;
            } else {
              buf += (buf?' ':'') + piece;
            }
          }
          if (buf) out.push(buf.trim());
        }
        return out.length ? out : [str.slice(0,max)];
      }

      // Highlight helper
      let lastHL=null;
      function highlightWithin(node, text){
        if(!node) return;
        try{
          if (lastHL){ lastHL.classList.remove('vr-highlight'); lastHL=null; }
          const key = text.slice(0, 60);
          const p = [...node.querySelectorAll('p, li, h2, h3, article')].find(el=> (el.innerText||'').indexOf(key) >= 0 );
          if (p){ p.classList.add('vr-highlight'); p.scrollIntoView({block:'nearest', behavior:'smooth'}); lastHL=p; }
        }catch{}
      }

      let queue=[], speaking=false, canceled=false, curIndex=0;

      function setButtons(state){
        const {play, pause, resume, stop} = state;
        if (btnPlay)   btnPlay.disabled   = !play;
        if (btnPause)  btnPause.disabled  = !pause;
        if (btnResume) btnResume.disabled = !resume;
        if (btnStop)   btnStop.disabled   = !stop;
      }

      function speakFromText(text, highlightRoot){
        canceled=false; speaking=true; curIndex=0;
        queue = chunkify(text);
        speechSynthesis.cancel(); // reset
        const vName = voiceSel?.value;
        const vObj = voices.find(v=>v.name===vName);
        setButtons({play:false, pause:true, resume:true, stop:false});
        status('Playingâ€¦'); prog(0, queue.length);

        function next(){
          if (canceled) return;
          const seg = queue[curIndex++];
          if (!seg){ done(); return; }
          highlightWithin(highlightRoot, seg);
          const u = new SpeechSynthesisUtterance(seg);
          if (vObj) u.voice = vObj;
          u.rate = rateInp ? +rateInp.value : 1.0;
          u.pitch = pitchInp ? +pitchInp.value : 1.0;
          u.onend = ()=>{ prog(curIndex, queue.length); next(); };
          u.onerror = (e)=>{ console.warn('TTS error', e); next(); };
          speechSynthesis.speak(u);
        }
        next();
      }

      function speak(){
        const { text, node } = getSectionOrSelection();
        if (!text){ status('Nothing to read.'); return; }
        speakFromText(text, node);
      }

      function pause(){ if(!speaking) return; speechSynthesis.pause(); setButtons({play:false,pause:true,resume:false,stop:false}); status('Paused.'); }
      function resume(){ if(!speaking) return; speechSynthesis.resume(); setButtons({play:false,pause:false,resume:true,stop:false}); status('Playingâ€¦'); }
      function stop(){ canceled=true; speechSynthesis.cancel(); done(true); }
      function done(stopped=false){
        speaking=false; setButtons({play:true,pause:true,resume:true,stop:true}); status(stopped?'Stopped.':'Done.'); prog(0,0);
        if (lastHL){ lastHL.classList.remove('vr-highlight'); lastHL=null; }
      }

      btnPlay?.addEventListener('click', speak);
      btnSel?.addEventListener('click', speak);
      btnPause?.addEventListener('click', pause);
      btnResume?.addEventListener('click', resume);
      btnStop?.addEventListener('click', stop);
      $('vr-play-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); speak(); });
      $('vr-stop-mini')?.addEventListener('click', (e)=>{ e.stopPropagation(); stop(); });

      // Export SSML (paragraph aware)
      exportBtn?.addEventListener('click', ()=>{
        const { text } = getSectionOrSelection();
        if (!text){ status('Nothing to export.'); return; }
        const paras = text.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
        const esc = s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const ratePct = rateInp ? Math.round(+rateInp.value * 100) : 100;
        const pitchSt = pitchInp ? Math.round((+pitchInp.value - 1) * 20) : 0;
        const ssml =
`<?xml version="1.0"?>
<speak version="1.1" xml:lang="en-US">
  <prosody rate="${ratePct}%" pitch="${pitchSt}st">
${paras.map(p=>`    <p>${esc(p)}</p>`).join('\n')}
  </prosody>
</speak>`;
        const blob = new Blob([ssml], {type:'application/ssml+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='theory.ssml'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
        status('Exported SSML.');
      });
    })();

    /* Eq.13 inline Î mini-calculator (with spark) */
    (function(){
      const eq13=document.getElementById('eq13'); if(!eq13) return;
      if(eq13.querySelector('.xi-panel')) return;
      const panel=document.createElement('div');
      panel.className='xi-panel';
      panel.innerHTML=`
        <div class="row">
          <label>âŸ¨HÂ·IâŸ© <input id="xi_hi" type="number" min="0" max="1" step="0.01" value="0.62"></label>
          <label>Var[ğ“œ] <input id="xi_var" type="number" min="0" max="2" step="0.01" value="0.30"></label>
          <button id="xi_go" class="cta">Compute Î</button>
          <span id="xi_val" class="xi-big meta">Î = â€”</span>
        </div>
        <div class="xi-bar" style="margin:.4rem 0 .2rem"><span id="xi_bar"></span></div>
        <canvas id="xi_spark" width="420" height="46" aria-label="Î history"></canvas>
      `;
      eq13.appendChild(panel);
      const hi=panel.querySelector('#xi_hi'), va=panel.querySelector('#xi_var'), go=panel.querySelector('#xi_go'), out=panel.querySelector('#xi_val'), barEl=panel.querySelector('#xi_bar');
      const ctx=panel.querySelector('#xi_spark').getContext('2d'); const KEY='sof_theory_xi_hist';
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(_){ return []; } }
      function save(x){ try{ localStorage.setItem(KEY, JSON.stringify(x)); }catch(_){ } }

      function draw(hist){
        const W=ctx.canvas.width, H=ctx.canvas.height;
        ctx.clearRect(0,0,W,H);
        ctx.strokeStyle='rgba(122,243,255,.2)'; ctx.beginPath();
        ctx.moveTo(0,H*.25); ctx.lineTo(W,H*.25); ctx.moveTo(0,H*.5); ctx.lineTo(W,H*.5); ctx.moveTo(0,H*.75); ctx.lineTo(W,H*.75); ctx.stroke();
        if(!hist.length) return;
        const n=hist.length, xs=W/Math.max(1,(n-1));
        ctx.beginPath();
        hist.forEach((o,i)=>{ const x=W-i*xs; const y=H*(1-(o.x*0.9+0.05)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
        ctx.strokeStyle='rgba(243,201,122,.95)'; ctx.lineWidth=2; ctx.stroke();
      }
      function calc(){
        const h=Math.max(0,Math.min(1, +hi.value||0));
        const v=Math.max(0,Math.min(2, +va.value||0));
        const Xi = Math.max(0, Math.min(1, h/(1+v)));
        out.textContent='Î = '+Xi.toFixed(2);
        barEl.style.width=(Xi*100).toFixed(0)+'%';
        const hist=load(); hist.unshift({t:Date.now(),x:Xi}); save(hist.slice(0,64)); draw(hist.slice(0,64));
      }
      go.addEventListener('click',calc); draw(load());
    })();

    /* Echo View upgrade: optionally hide math too */
    (function(){
      const btn=document.getElementById('toggleSimple'); if(!btn) return;
      btn.addEventListener('click',()=>{
        const on=document.body.classList.toggle('echo-hide-math');
        document.querySelectorAll('.eq, mjx-container').forEach(el=> el.style.display=on?'none':'' );
      });
    })();

    /* Nice hash navigation offsets (sticky header) */
    (function(){
      function scrollToHash(){
        if(!location.hash) return;
        const el=document.querySelector(location.hash); if(!el) return;
        const top=el.getBoundingClientRect().top + scrollY - 68; // header offset
        scrollTo({top, behavior:'smooth'});
      }
      if(location.hash) setTimeout(scrollToHash, 60);
      document.addEventListener('click',(e)=>{ const a=e.target.closest('a[href^="#"]'); if(a){ setTimeout(scrollToHash, 10); } });
    })();
  </script>

</body>
</html>
