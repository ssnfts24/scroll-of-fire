<!doctype html>
<html lang="en" dir="ltr">
<head>
  <!-- Resolve relative URLs from project root on GitHub Pages -->
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>
    // When previewing on GitHub remove base so local paths work
    if (location.hostname === "github.com") {
      const b = document.querySelector("base"); if (b) b.remove();
    }
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quickstart / Start Here â€” Scroll of Fire</title>
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/start.html"/>
  <meta name="description" content="Start here. A short orientation to Scroll of Fire: how to run a 60-second session, where to find theory, practice, glossaries, and downloads, and how to keep a witness ledger.">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0b0f">

  <!-- Social -->
  <meta property="og:site_name" content="Scroll of Fire">
  <meta property="og:title" content="Start Here â€” Scroll of Fire">
  <meta property="og:description" content="Pick a carrier, speak one line, measure coherence, and log it in under a minute. Plus a full site map.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/start.html">

  <!-- Fonts + external CSS placeholders (site files) -->
  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-20">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-20" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-20"></noscript>

  <link rel="preload" as="style" href="assets/css/teach.css?v=2025-10-20">
  <link rel="stylesheet" href="assets/css/teach.css?v=2025-10-20" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/teach.css?v=2025-10-20"></noscript>

  <!-- Preload banner -->
  <link rel="preload" as="image" href="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png" imagesizes="100vw" fetchpriority="high">

  <style>
    /* Page-scoped micro-css (visual details not covered by shared CSS) */
    :root{--maxw:1100px}
    body{margin:0}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 16px 90px}
    .title{font-family:"Crimson Pro",serif;font-weight:800;text-align:center;font-size:clamp(28px,3.6vw,40px);margin:.2rem 0}
    .subtitle{text-align:center;color:var(--muted);margin:0 0 14px}
    .hero{border-radius:14px;overflow:hidden;margin:8px 0 16px}
    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .carrier-btn{padding:.6rem .9rem;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);font-weight:600;cursor:pointer;position:relative}
    .carrier-btn[aria-pressed="true"]{box-shadow:0 8px 26px rgba(122,243,255,.12);outline:2px solid rgba(122,243,255,.18)}
    .large-cta{display:inline-flex;gap:.6ch;align-items:center;padding:.7rem 1rem;border-radius:12px;border:1px solid var(--line);background:#0e1116;color:inherit;font-weight:700;cursor:pointer}
    .large-cta[disabled]{opacity:.5;cursor:not-allowed}
    .progress-wrap{display:flex;gap:12px;align-items:center;margin-top:10px}
    .ring{width:84px;height:84px;display:grid;place-items:center;border-radius:999px;background:conic-gradient(rgba(122,243,255,.14) 0% 0%, transparent 0);box-shadow:inset 0 -8px 24px rgba(0,0,0,.6)}
    .ring svg{display:block;width:72px;height:72px}
    .coherence-meter{margin-top:8px}
    label.small{display:block;margin-top:8px;color:var(--muted);font-size:.95rem}
    textarea#phrase{width:100%;min-height:72px;padding:.6rem;border-radius:12px;border:1px solid var(--line);background:var(--bg-elev);color:inherit;resize:vertical}
    .inline-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted.small{color:var(--muted)}
    .card .kicker{font-weight:700;font-size:.82rem;color:var(--muted);letter-spacing:.12em}
    .ledger-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .recent-list{max-height:260px;overflow:auto;padding-top:8px}
    .recent-item{padding:10px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:6px}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:.83rem;color:var(--muted);margin-right:6px}
    .tiny{font-size:.85rem;color:var(--muted)}
    .controls-foot{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .help{margin-top:10px;color:var(--muted);font-size:.95rem}
    .inline-btn{background:linear-gradient(180deg,rgba(122,243,255,.06),rgba(122,243,255,.02));border:1px solid rgba(122,243,255,.12);padding:.5rem .75rem;border-radius:10px;cursor:pointer}
    .inline-btn:active{transform:translateY(1px)}
    /* responsive site map spacing */
    .grid4{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px}
    .span-4{grid-column:span 4} .span-12{grid-column:span 12}
    @media (max-width:980px){.span-4{grid-column:span 12}}
    /* small performance hint styles */
    .user-is-tabbing :focus { outline: 3px solid rgba(122,243,255,.14); outline-offset:3px; border-radius:8px; }
    /* will-change hints */
    #progressArc { will-change: stroke-dasharray, transform; }
  </style>
</head>

<body class="stars">
  <div class="laser-grid" aria-hidden="true"></div>

  <main class="wrap" id="top" role="main">
    <!-- Hero -->
    <figure class="hero hero--contain" aria-hidden="true">
      <img src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png"
           alt="Scroll of Fire â€” gilded sigil banner" width="1600" height="900"
           loading="eager" decoding="async" fetchpriority="high"
           onerror="this.src='assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png'">
    </figure>

    <h1 class="title">âš¡ 60-Second Quickstart â€” Start Here</h1>
    <p class="subtitle">Short, repeatable practice that turns phrasing into witnessable change. Follow the four-step loop below.</p>

    <!-- Tabs (primary nav) -->
    <nav class="tabs" aria-label="Primary navigation">
      <a class="tab" href="index.html">âŒ‚ Home</a>
      <a class="tab" href="theory.html">ğŸ“˜ Theory</a>
      <a class="tab" href="teach.html">ğŸ“ Teach</a>
      <a class="tab tab--primary" aria-current="page" href="start.html">âš¡ Start Here</a>
      <a class="tab" href="ledger.html">ğŸ§¾ Ledger</a>
    </nav>

    <!-- Quickstart UI -->
    <section class="grid2" aria-label="Quickstart flow">
      <!-- LEFT: tool -->
      <article class="card" aria-labelledby="qs-h" role="region">
        <div class="kicker">Quickstart</div>
        <h2 id="qs-h">One line â€¢ One carrier â€¢ One minute</h2>

        <!-- Step 1: carrier -->
        <div>
          <label class="kicker" id="carrierLabel">Step 1 â€” Choose a carrier</label>
          <div class="controls" role="radiogroup" aria-labelledby="carrierLabel">
            <button class="carrier-btn" role="radio" data-carrier="432" aria-pressed="false" aria-checked="false">432 Hz (Ground)</button>
            <button class="carrier-btn" role="radio" data-carrier="528" aria-pressed="false" aria-checked="false">528 Hz (Repair)</button>
            <button class="carrier-btn" role="radio" data-carrier="369" aria-pressed="false" aria-checked="false">369 Hz (Lock-in)</button>
            <button class="carrier-btn" role="radio" data-carrier="none" aria-pressed="true" aria-checked="true">No tone</button>
          </div>
          <div class="help">Tip: starting with <strong>432</strong> is gentle. Choosing <strong>none</strong> still runs the loop â€” carriers are optional.</div>
        </div>

        <!-- Step 2: phrase -->
        <div style="margin-top:12px">
          <label class="kicker">Step 2 â€” Phrase</label>
          <p class="tiny">Keep it short, present-tense, and positively framed. Fewer negations â†’ clearer semantic gradient.</p>
          <textarea id="phrase" placeholder="Example: I hold truth with gentleness." aria-label="Your intention phrase"></textarea>
        </div>

        <!-- Step 3: run controls -->
        <div class="progress-wrap" style="margin-top:12px">
          <div class="ring" aria-hidden="true" id="progressRing">
            <!-- SVG progress ring -->
            <svg viewBox="0 0 36 36" role="img" aria-label="Timer progress">
              <path d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="2"></path>
              <path id="progressArc" d="" fill="none" stroke="#7af3ff" stroke-width="2.6" stroke-linecap="round"></path>
              <text id="timer" x="18" y="21" font-size="6" text-anchor="middle" fill="#e6f9ff">Ready</text>
            </svg>
          </div>

          <div style="flex:1">
            <div class="inline-row">
              <button id="startRun" class="large-cta" aria-pressed="false" title="Start 60 second run (R)">
                â–¶ Start
              </button>
              <button id="stopRun" class="large-cta" aria-pressed="false" disabled title="Stop run (R)">
                â–  Stop
              </button>
              <div style="margin-left:auto;text-align:right">
                <div class="tiny">Session length</div>
                <div class="tiny">60s standard â€” adjustable in preferences</div>
              </div>
            </div>

            <div class="coherence-meter" aria-hidden="false" aria-live="polite">
              <label for="coh" class="small">Step 4 â€” Rate Coherence (felt quality)</label>
              <input id="coh" class="meter" type="range" min="0" max="5" step="0.5" value="0" aria-label="Coherence rating from 0 to 5">
              <div class="tiny muted">0 = chaotic Â· 5 = crisp, truthful, sustained</div>
            </div>
          </div>
        </div>

        <!-- Ledger save row -->
        <div style="margin-top:12px">
          <label class="kicker">Save witness</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <input id="tag" placeholder="tags (comma separated) e.g., morning,432" aria-label="add tags" style="flex:1;padding:.5rem;border-radius:10px;border:1px solid var(--line);background:var(--bg-elev)">
            <button id="saveEntry" class="inline-btn" title="Save to local ledger">ğŸ’¾ Save to Ledger</button>
            <button id="exportEntries" class="inline-btn" title="Export ledger JSON">â¬‡ Export</button>
            <button id="importEntries" class="inline-btn" title="Import ledger JSON">â¬† Import</button>
          </div>
          <div class="help tiny">Saved locally on this device. Use export to back up or share. Use Import to restore a previously exported ledger.</div>
        </div>

        <!-- ledger controls -->
        <div class="ledger-controls" style="margin-top:10px">
          <button id="clearLedger" class="inline-btn">Clear Local Ledger</button>
          <button id="deleteLast" class="inline-btn">Delete Last Entry</button>
          <div style="margin-left:auto;text-align:right">
            <div class="tiny muted">Entries: <span id="entryCount">0</span></div>
          </div>
        </div>

        <div class="help" style="margin-top:12px">
          Short guide: Phrase â†’ Start â†’ hum (if using a carrier) â†’ breathe with longer exhale â†’ stop â†’ rate â†’ save. If coherence drops, stop and re-center (see Ethics â†’ Stop Rule).
        </div>
      </article>

      <!-- RIGHT: Why / recent -->
      <aside class="card" role="complementary" aria-labelledby="why-works">
        <h3 id="why-works">Why this works</h3>
        <ul>
          <li><strong>Carrier selects harmonic lanes</strong> (see Theory Eq.3, Eq.17).</li>
          <li><strong>Phrasing shapes the semantic gradient</strong> (Eq.16) â€” keep verbs strong and negations low.</li>
          <li><strong>Coherence (Î)</strong> is the live quality metric â€” rising Î indicates stable remnant formation.</li>
          <li><strong>Ledger is your experimental record</strong> â€” trends beat anecdotes.</li>
        </ul>

        <div class="goldline" style="margin:12px 0"></div>

        <h4>Recent witness entries</h4>
        <div id="recent" class="recent-list small muted" aria-live="polite">No entries yet.</div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="cta" href="ledger.html">Open full Ledger â†’</a>
          <a class="cta" href="guide.html">Guide â†’</a>
          <a class="cta" href="ethics.html">Ethics â†’</a>
        </div>
      </aside>
    </section>

    <div class="goldline" style="margin-top:18px"></div>

    <!-- Short orientation + site map -->
    <section class="grid4" aria-label="Orientation">
      <article class="card span-12">
        <div class="kicker">Start Here</div>
        <h2>How to use this site in 3 minutes</h2>
        <ol class="list">
          <li><strong>Run a 60s session:</strong> choose carrier, speak your line, breathe, rate coherence, then save.</li>
          <li><strong>Skim Theory:</strong> canonical equations 0â€“17 explain the structure of the Codex.</li>
          <li><strong>Practice with Teach:</strong> the Manifest studio contains the full protocol and A/B test tools.</li>
          <li><strong>Log in Ledger:</strong> collect evidence, A/B, and compare carriers & phrases over time.</li>
        </ol>
        <p class="muted small">Tip: headphones improve perception. Keep phrases kind, precise, and present-tense.</p>
      </article>

      <article class="card span-4">
        <h3>Core</h3>
        <ul class="list">
          <li>âŒ‚ <a href="index.html">Home</a></li>
          <li>ğŸ“˜ <a href="theory.html">Theory</a></li>
          <li>ğŸ“ <a href="teach.html">Teach / Manifest</a></li>
          <li>ğŸ§¾ <a href="ledger.html">Ledger</a></li>
        </ul>
      </article>

      <article class="card span-4">
        <h3>Experiments</h3>
        <ul class="list">
          <li>ğŸ” <a href="ab.html">A/B Carriers</a></li>
          <li>ğŸ”£ <a href="glyphs.html">Glyphs</a></li>
          <li>Î¼ <a href="micro.html">Micro-acts</a></li>
        </ul>
      </article>

      <article class="card span-4">
        <h3>Files</h3>
        <ul class="list">
          <li>â¬‡ <a href="downloads.html">Downloads</a></li>
          <li>ğŸ“œ <a href="manifest.html">Manifest (Longform)</a></li>
          <li>ğŸ“š <a href="glossary.html">Glossary</a></li>
        </ul>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="small muted">Use headphones if possible. Stop if you feel off-balance â€” ethics first.</p>
      <p>Â© <span id="yr">2025</span> Aaron Paul Laird â€” Scroll of Fire</p>
    </footer>
  </main>

  <!-- Page script: optimized timer, audio carriers, ledger, UI polish -->
  <script>
  (function(){
    "use strict";

    /* ---------- utilities & cached nodes ---------- */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const YEAR = $('#yr'); if (YEAR) YEAR.textContent = new Date().getFullYear();

    // Harden external links
    $$('a[target="_blank"]').forEach(a=>{
      const rel = new Set((a.getAttribute("rel")||"").toLowerCase().split(/\s+/).filter(Boolean));
      rel.add("noopener"); rel.add("noreferrer"); a.setAttribute("rel", Array.from(rel).join(" "));
    });

    // Storage key
    const KEY = 'sof_ledger_entries_v1';
    const safeParse = s => { try { return JSON.parse(s||'[]'); } catch { return []; } };

    // read/write with tiny guard
    const read = () => {
      try { return safeParse(localStorage.getItem(KEY)); }
      catch { return []; }
    };
    const write = (arr) => {
      try { localStorage.setItem(KEY, JSON.stringify(arr)); }
      catch (e) { console.warn('save failed', e); }
    };

    // escape helper
    const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // cache nodes used often
    const RECENT = $('#recent'), ENTRY_COUNT = $('#entryCount');
    const START_BTN = $('#startRun'), STOP_BTN = $('#stopRun'), TIMER_TEXT = $('#timer');
    const PROG = document.getElementById('progressArc');
    const PHRASE = $('#phrase'), COH = $('#coh'), TAG_INPUT = $('#tag');
    const CARRIER_BUTTONS = $$('.carrier-btn');

    // small priority rendering: use requestIdleCallback when available for non-critical work
    const idle = window.requestIdleCallback ? window.requestIdleCallback : (fn)=>setTimeout(fn,200);

    /* ---------- render recent entries (low-cost) ---------- */
    function renderRecent(all = read()){
      // schedule low-priority rendering to avoid blocking interaction
      idle(()=> {
        if (!RECENT) return;
        if (!all.length) {
          RECENT.innerHTML = '<div class="tiny muted">No entries yet.</div>';
          ENTRY_COUNT && (ENTRY_COUNT.textContent = '0');
          return;
        }
        ENTRY_COUNT && (ENTRY_COUNT.textContent = String(all.length));
        // render up to 12 items
        const slice = all.slice(0,12);
        RECENT.innerHTML = slice.map((e, idx) => {
          const tags = (e.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
          return `
            <div class="recent-item" data-idx="${idx}">
              <div><strong>${escapeHtml(e.phrase)}</strong></div>
              <div class="tiny muted">${new Date(e.when).toLocaleString()} Â· carrier: ${escapeHtml(e.carrier)} Â· Î: ${escapeHtml(e.coherence)}</div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
                ${tags}
                <div style="margin-left:auto;display:flex;gap:6px">
                  <button class="small-btn inline-btn" data-action="copy" data-idx="${idx}">Copy</button>
                  <button class="small-btn inline-btn" data-action="delete" data-idx="${idx}">Delete</button>
                </div>
              </div>
              ${ e.note ? `<div class="tiny" style="margin-top:6px">Note: ${escapeHtml(e.note)}</div>` : '' }
            </div>`;
        }).join('');
      });
    }

    // initial render
    renderRecent();

    /* ---------- audio: lightweight WebAudio oscillator ---------- */
    let audioCtx = null, osc = null, gainNode = null;
    function ensureAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.0;
        gainNode.connect(audioCtx.destination);
      } catch (e) {
        audioCtx = null;
      }
    }

    function startTone(freq) {
      if (!freq) return;
      ensureAudio();
      if (!audioCtx || osc) return;
      osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = freq;
      osc.connect(gainNode);
      osc.start();
      const t = audioCtx.currentTime;
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.linearRampToValueAtTime(0.08, t + 0.08);
    }

    function stopTone() {
      if (!audioCtx || !osc) return;
      const t = audioCtx.currentTime;
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.linearRampToValueAtTime(0.0001, t + 0.08);
      try { osc.stop(t + 0.09); } catch(e) {}
      osc.disconnect && osc.disconnect();
      osc = null;
    }

    // warm audio on first user gesture (no autoplay)
    function warmAudioOnFirstGesture(){
      const resume = () => {
        try { ensureAudio(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); } catch(e){}
        window.removeEventListener('pointerdown', resume);
        window.removeEventListener('keydown', resume);
      };
      window.addEventListener('pointerdown', resume, {once:true, passive:true});
      window.addEventListener('keydown', resume, {once:true, passive:true});
    }
    warmAudioOnFirstGesture();

    /* ---------- carrier UI ---------- */
    let carrier = 'none';
    CARRIER_BUTTONS.forEach(btn => {
      btn.addEventListener('click', () => {
        CARRIER_BUTTONS.forEach(b => { b.setAttribute('aria-pressed','false'); b.setAttribute('aria-checked','false'); });
        btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-checked','true');
        carrier = btn.dataset.carrier || 'none';
        // audible preview
        if (carrier !== 'none') {
          startTone(Number(carrier));
          setTimeout(()=>stopTone(), 380);
        }
      }, {passive:true});
      // keyboard navigation
      btn.addEventListener('keydown', (e)=>{
        if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
        e.preventDefault();
        const idx = CARRIER_BUTTONS.indexOf(btn);
        const nxt = e.key === 'ArrowRight' ? (idx + 1) % CARRIER_BUTTONS.length : (idx - 1 + CARRIER_BUTTONS.length) % CARRIER_BUTTONS.length;
        CARRIER_BUTTONS[nxt].focus();
        CARRIER_BUTTONS[nxt].click();
      });
    });

    /* ---------- efficient timer using requestAnimationFrame ---------- */
    // Duration adjustable easily
    const DURATION_SECONDS = 60;

    // RAF loop state
    let rafId = null;
    let endTime = 0;   // performance.now() target
    let lastDisplayed = null; // for throttled DOM updates

    // prepare arc path and stroke-dash baseline (circumference of radius 16)
    (function prepareArc(){
      if (!PROG) return;
      const path = "M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32";
      PROG.setAttribute('d', path);
      PROG.setAttribute('stroke-linecap','round');
      // circumference for r=16
      const circumference = 2 * Math.PI * 16;
      PROG.dataset.circ = String(circumference);
      PROG.setAttribute('stroke-dasharray', `0 ${circumference}`);
      PROG.setAttribute('transform','rotate(-90 18 18)');
    })();

    function setProgressFraction(frac){
      // frac 0..1
      const circ = Number(PROG.dataset.circ) || (2*Math.PI*16);
      const dash = Math.max(0, Math.min(1, frac)) * circ;
      // only update attributes if changed to avoid layout thrash
      PROG.setAttribute('stroke-dasharray', `${dash.toFixed(2)} ${circ.toFixed(2)}`);
    }

    function updateTimerText(text){
      if (TIMER_TEXT && TIMER_TEXT.textContent !== text) TIMER_TEXT.textContent = text;
    }

    function rafTick(now) {
      // now is performance.now()
      const remainingMS = Math.max(0, endTime - now);
      const remainingSecs = Math.ceil(remainingMS / 1000);
      const elapsed = Math.max(0, (DURATION_SECONDS * 1000 - remainingMS));
      const frac = elapsed / (DURATION_SECONDS * 1000);

      // throttle DOM writes: only update text when displayed seconds change
      if (lastDisplayed !== remainingSecs) {
        updateTimerText(remainingSecs > 0 ? `${remainingSecs}s` : '0s');
        lastDisplayed = remainingSecs;
      }
      setProgressFraction(frac);

      if (remainingMS <= 0) {
        // finish
        stopRun();
        return;
      }
      rafId = requestAnimationFrame(rafTick);
    }

    let RUNNING = false;

    function startRun(){
      if (RUNNING) return;
      RUNNING = true;
      // resume audio if suspended
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume().catch(()=>{/* ignore */});
      }
      // tone
      if (carrier !== 'none') startTone(Number(carrier));
      // set UI states
      START_BTN.disabled = true; STOP_BTN.disabled = false;
      START_BTN.setAttribute('aria-pressed','true');
      STOP_BTN.setAttribute('aria-pressed','false');
      // set timers
      const now = performance.now();
      endTime = now + DURATION_SECONDS * 1000;
      lastDisplayed = null;
      rafId = requestAnimationFrame(rafTick);
      // small device feedback
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function stopRun(){
      if (!RUNNING) {
        // ensure UI reflects stopped state
        START_BTN.disabled = false; STOP_BTN.disabled = true;
        STOP_BTN.setAttribute('aria-pressed','true');
        START_BTN.setAttribute('aria-pressed','false');
        // reset UI
        updateTimerText('Stopped');
        setProgressFraction(0);
        return;
      }
      RUNNING = false;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      // stop tone
      stopTone();
      // reflect UI
      START_BTN.disabled = false; STOP_BTN.disabled = true;
      START_BTN.setAttribute('aria-pressed','false');
      STOP_BTN.setAttribute('aria-pressed','true');
      updateTimerText('Stopped');
      setProgressFraction(0);
    }

    // wire buttons
    START_BTN && START_BTN.addEventListener('click', startRun);
    STOP_BTN && STOP_BTN.addEventListener('click', stopRun);

    // keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === '/') { e.preventDefault(); PHRASE && PHRASE.focus(); }
      if (e.key === 'r' || e.key === 'R') { if (RUNNING) stopRun(); else startRun(); }
      if (e.key === 'Escape') { if (PHRASE) PHRASE.value = ''; if (COH) COH.value = 0; }
      // tab detection for outlines
      if (e.key === 'Tab') document.body.classList.add('user-is-tabbing');
    }, {passive:true});

    /* ---------- ledger actions ---------- */
    $('#saveEntry').addEventListener('click', () => {
      const phrase = (PHRASE && PHRASE.value || '').trim();
      const coherence = Number(COH && COH.value || 0);
      const tagsRaw = (TAG_INPUT && TAG_INPUT.value || '').trim();
      const tags = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if (!phrase) { alert('Please enter a clear line to save.'); PHRASE && PHRASE.focus(); return; }
      const entry = { when: new Date().toISOString(), carrier, phrase, coherence, tags, note: '' };
      const arr = read(); arr.unshift(entry); write(arr); renderRecent(arr);
      // small visual feedback
      try { if (navigator.vibrate) navigator.vibrate([30]); } catch(e){}
    }, {passive:true});

    $('#exportEntries').addEventListener('click', () => {
      const data = read();
      if (!data.length) return alert('No entries to export.');
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'scroll-of-fire-ledger.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }, {passive:true});

    $('#importEntries').addEventListener('click', () => {
      const input = document.createElement('input'); input.type='file'; input.accept='application/json';
      input.onchange = (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const parsed = JSON.parse(ev.target.result);
            if (!Array.isArray(parsed)) throw Error('Expected array');
            const existing = read();
            const existingIDs = new Set(existing.map(x=>x.when));
            const merged = parsed.concat(existing.filter(x=>!existingIDs.has(x.when)));
            write(merged);
            renderRecent(merged);
            alert('Imported ledger (merged).');
          } catch (err) {
            alert('Import failed: ' + (err.message || err));
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }, {passive:true});

    $('#clearLedger').addEventListener('click', () => {
      if (!confirm('Clear local ledger? This cannot be undone.')) return;
      write([]); renderRecent([]);
    }, {passive:true});

    $('#deleteLast').addEventListener('click', () => {
      const arr = read();
      if (!arr.length) return alert('No entries to delete.');
      if (!confirm('Delete the last (most recent) entry?')) return;
      arr.shift(); write(arr); renderRecent(arr);
    }, {passive:true});

    // copy/delete handlers for recent list (delegation)
    RECENT && RECENT.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      const arr = read();
      if (action === 'copy') {
        const entry = arr[idx];
        if (!entry) return;
        const txt = `${entry.phrase}\ncarrier:${entry.carrier} Â· Î:${entry.coherence} Â· ${new Date(entry.when).toLocaleString()}`;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(txt).then(()=>alert('Copied entry to clipboard.'), ()=>alert('Copy failed.'));
        } else {
          prompt('Copy this text', txt);
        }
      } else if (action === 'delete') {
        if (!confirm('Delete this entry?')) return;
        arr.splice(idx,1); write(arr); renderRecent(arr);
      }
    }, {passive:true});

    /* ---------- coherence slider visual feedback (fast) ---------- */
    COH && COH.addEventListener('input', ()=> {
      const v = Number(COH.value);
      const pct = Math.max(0, Math.min(1, v / 5));
      // map to hue 0 (red)-200 (cyan)
      const hue = Math.round(200 * pct);
      PROG && PROG.setAttribute('stroke', `hsl(${hue} 90% 60%)`);
    }, {passive:true});

    // initial small UI setup: set progress arc, show entries
    (function init(){
      // ensure arc prepared
      if (PROG && !PROG.dataset.circ) {
        const circ = 2*Math.PI*16;
        PROG.dataset.circ = String(circ);
        PROG.setAttribute('stroke-dasharray', `0 ${circ}`);
      }
      renderRecent();
    })();

    // Accessibility: detect tabbing for visible outlines
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Tab') document.body.classList.add('user-is-tabbing'); }, {once:true});

    // keep a small safety: on pagehide, stop sound and RAF
    window.addEventListener('pagehide', ()=>{ stopRun(); if (audioCtx && audioCtx.state === 'running') audioCtx.suspend().catch(()=>{}); }, {passive:true});
    // pause if tab hidden
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) { stopRun(); } }, {passive:true});

  })();
  </script>
</body>
</html>
