<!doctype html>
<html lang="en" dir="ltr" class="sof">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>
    (function () { var host = location.hostname;
      if (host !== "ssnfts24.github.io") { var b = document.querySelector("base"); if (b) b.remove(); }
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quickstart / Start Here — Scroll of Fire</title>
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/start.html"/>
  <meta name="description" content="Run one Codex loop (Σ → ∇φ → ℛ → ΔΣ) with carriers 144/369/432/528/963, rate coherence (Ξ), and save a sealed witness (SHA-256).">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0b0f">

  <!-- Social -->
  <meta property="og:site_name" content="Scroll of Fire">
  <meta property="og:title" content="Start Here — Scroll of Fire">
  <meta property="og:description" content="Pick a carrier (144/369/432/528/963), speak one line, 3-6-9 cadence, rate Ξ, and log a sealed witness.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ssnfts24.github.io/scroll-of-fire/start.html">

  <!-- Site CSS (your existing bundles) -->
  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-20">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-20" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-20"></noscript>

  <link rel="preload" as="style" href="assets/css/teach.css?v=2025-10-20">
  <link rel="stylesheet" href="assets/css/teach.css?v=2025-10-20" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/teach.css?v=2025-10-20"></noscript>

  <!-- Preload banner -->
  <link rel="preload" as="image" href="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png" imagesizes="100vw" fetchpriority="high">

  <style>
    :root{--maxw:1100px}
    body{margin:0}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 16px 90px}
    .title{font-family:"Crimson Pro",serif;font-weight:800;text-align:center;font-size:clamp(28px,3.6vw,40px);margin:.2rem 0}
    .subtitle{text-align:center;color:var(--muted);margin:0 0 14px}
    .hero{border-radius:14px;overflow:hidden;margin:8px 0 16px}
    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .carrier-btn{padding:.6rem .9rem;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);font-weight:600;cursor:pointer;position:relative}
    .carrier-btn small{display:block;font-weight:500;color:var(--muted);line-height:1;margin-top:2px}
    .carrier-btn[aria-pressed="true"]{box-shadow:0 8px 26px rgba(122,243,255,.12);outline:2px solid rgba(122,243,255,.18)}
    .large-cta{display:inline-flex;gap:.6ch;align-items:center;padding:.7rem 1rem;border-radius:12px;border:1px solid var(--line);background:#0e1116;color:inherit;font-weight:700;cursor:pointer}
    .large-cta[disabled]{opacity:.5;cursor:not-allowed}
    .progress-wrap{display:flex;gap:12px;align-items:center;margin-top:10px}
    .ring{width:84px;height:84px;display:grid;place-items:center;border-radius:999px;background:conic-gradient(rgba(122,243,255,.14) 0% 0%, transparent 0);box-shadow:inset 0 -8px 24px rgba(0,0,0,.6)}
    .ring svg{display:block;width:72px;height:72px}
    .coherence-meter{margin-top:8px}
    label.small{display:block;margin-top:8px;color:var(--muted);font-size:.95rem}
    textarea#phrase{width:100%;min-height:72px;padding:.6rem;border-radius:12px;border:1px solid var(--line);background:var(--bg-elev);color:inherit;resize:vertical}
    .inline-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted.small{color:var(--muted)}
    .card .kicker{font-weight:700;font-size:.82rem;color:var(--muted);letter-spacing:.12em}
    .ledger-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .recent-list{max-height:300px;overflow:auto;padding-top:8px}
    .recent-item{padding:10px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:6px}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:.83rem;color:var(--muted);margin-right:6px}
    .tiny{font-size:.85rem;color:var(--muted)}
    .help{margin-top:10px;color:var(--muted);font-size:.95rem}
    .inline-btn{background:linear-gradient(180deg,rgba(122,243,255,.06),rgba(122,243,255,.02));border:1px solid rgba(122,243,255,.12);padding:.5rem .75rem;border-radius:10px;cursor:pointer}
    .inline-btn:active{transform:translateY(1px)}
    .grid4{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px}
    .span-4{grid-column:span 4} .span-12{grid-column:span 12}
    @media (max-width:980px){.span-4{grid-column:span 12}}
    .user-is-tabbing :focus { outline: 3px solid rgba(122,243,255,.14); outline-offset:3px; border-radius:8px; }
    #progressArc { will-change: stroke-dasharray, transform; }
    /* print slip (new window) base */
    .slip{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;max-width:720px;margin:0 auto;padding:24px}
    .slip h1{font-size:20px;margin:0 0 6px}
    .slip .meta{color:#7b8499;font-size:12px;margin-bottom:12px}
    .slip .box{border:1px solid #d8dbe6;border-radius:10px;padding:12px;margin:10px 0}
    .slip .row{display:flex;gap:10px;flex-wrap:wrap}
    .slip .row > div{flex:1}
    .slip code{background:#f5f7fb;border:1px solid #e6e9f3;border-radius:6px;padding:2px 6px}
    @media print {.slip{box-shadow:none}}
  </style>
</head>

<body class="stars carrier-432">
  <div class="laser-grid" aria-hidden="true"></div>

  <main class="wrap" id="top" role="main">
    <figure class="hero hero--contain" aria-hidden="true">
      <img src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png"
           alt="Scroll of Fire — gilded sigil banner" width="1600" height="900"
           loading="eager" decoding="async" fetchpriority="high">
    </figure>

    <h1 class="title">⚡ 60-Second Quickstart — Start Here</h1>
    <p class="subtitle">Run one Codex loop (Σ → ∇φ → ℛ → ΔΣ): phrase, breathe (3-6-9), rate Ξ, save, and seal.</p>

    <nav class="tabs" aria-label="Primary navigation">
      <a class="tab" href="index.html">⌂ Home</a>
      <a class="tab" href="theory.html">📘 Theory</a>
      <a class="tab" href="teach.html">🎓 Teach</a>
      <a class="tab tab--primary" aria-current="page" href="start.html">⚡ Start Here</a>
      <a class="tab" href="ledger.html">🧾 Ledger</a>
    </nav>

    <section class="grid2" aria-label="Quickstart flow">
      <article class="card" aria-labelledby="qs-h" role="region">
        <div class="kicker">Quickstart</div>
        <h2 id="qs-h">One line • One carrier • One minute</h2>

        <!-- Step 1: carrier -->
        <div>
          <label class="kicker" id="carrierLabel">Step 1 — Choose a carrier</label>
          <div class="controls" role="radiogroup" aria-labelledby="carrierLabel">
            <button class="carrier-btn" role="radio" data-carrier="144" aria-pressed="false" aria-checked="false">
              144 Hz — Sanctuary<small>shield / boundary</small>
            </button>
            <button class="carrier-btn" role="radio" data-carrier="369" aria-pressed="false" aria-checked="false">
              369 Hz — Lock-in<small>phase / seal</small>
            </button>
            <button class="carrier-btn" role="radio" data-carrier="432" aria-pressed="true" aria-checked="true">
              432 Hz — Ground<small>root / attune</small>
            </button>
            <button class="carrier-btn" role="radio" data-carrier="528" aria-pressed="false" aria-checked="false">
              528 Hz — Repair<small>mend / restore</small>
            </button>
            <button class="carrier-btn" role="radio" data-carrier="963" aria-pressed="false" aria-checked="false">
              963 Hz — Crown<small>remembrance</small>
            </button>
            <button class="carrier-btn" role="radio" data-carrier="none" aria-pressed="false" aria-checked="false">
              No tone<small>silent run</small>
            </button>
          </div>
          <div class="help">Tip: <strong>432</strong> for first runs; <strong>144</strong> boundary; <strong>369</strong> sealing; <strong>528</strong> repair; <strong>963</strong> remembrance.</div>
        </div>

        <!-- Step 2: phrase -->
        <div style="margin-top:12px">
          <label class="kicker">Step 2 — Phrase (Σ)</label>
          <p class="tiny">Short, present-tense, affirmative. Fewer negations → clearer gradient (∇φ). Breathe 3-6-9 as you speak.</p>
          <textarea id="phrase" placeholder="Example: I hold truth with gentleness." aria-label="Your intention phrase"></textarea>
        </div>

        <!-- Step 3: run controls -->
        <div class="progress-wrap" style="margin-top:12px">
          <div class="ring" aria-hidden="true" id="progressRing">
            <svg viewBox="0 0 36 36" role="img" aria-label="Timer progress">
              <path d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="2"></path>
              <path id="progressArc" d="" fill="none" stroke="#7af3ff" stroke-width="2.6" stroke-linecap="round"></path>
              <text id="timer" x="18" y="21" font-size="6" text-anchor="middle" fill="#e6f9ff">Ready</text>
            </svg>
          </div>

          <div style="flex:1">
            <div class="inline-row">
              <button id="startRun" class="large-cta" aria-pressed="false" title="Start 60 second run (R)">▶ Start</button>
              <button id="stopRun" class="large-cta" aria-pressed="false" disabled title="Stop run (R)">■ Stop</button>
              <div style="margin-left:auto;text-align:right">
                <div class="tiny">Session length</div>
                <div class="tiny">60s standard — adjustable in preferences</div>
              </div>
            </div>

            <div class="coherence-meter" aria-hidden="false" aria-live="polite">
              <label for="coh" class="small">Step 4 — Rate Coherence Ξ (ΔΣ)</label>
              <input id="coh" class="meter" type="range" min="0" max="5" step="0.5" value="0" aria-label="Coherence rating from 0 to 5">
              <div class="tiny muted">0 = chaotic · 5 = crisp, truthful, sustained</div>
            </div>
          </div>
        </div>

        <!-- Save / Export -->
        <div style="margin-top:12px">
          <label class="kicker">Save & Seal</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <input id="tag" placeholder="tags (comma separated) e.g., morning,432,seal" aria-label="add tags" style="flex:1;padding:.5rem;border-radius:10px;border:1px solid var(--line);background:var(--bg-elev)">
            <button id="saveEntry" class="inline-btn" title="Save to local ledger">💾 Save to Ledger</button>
            <button id="exportEntries" class="inline-btn" title="Export ledger JSON (sealed)">⬇ Export JSON</button>
            <button id="exportLastPDF" class="inline-btn" title="Create a printable Witness slip (use Save as PDF)">🧾 Witness PDF</button>
            <button id="importEntries" class="inline-btn" title="Import ledger JSON">⬆ Import</button>
          </div>
          <div class="help tiny">Each save computes a SHA-256 seal over the canonical payload. “Witness PDF” opens a print-ready slip (use your browser’s “Save as PDF”).</div>
        </div>

        <!-- ledger controls -->
        <div class="ledger-controls" style="margin-top:10px">
          <button id="clearLedger" class="inline-btn">Clear Local Ledger</button>
          <button id="deleteLast" class="inline-btn">Delete Last Entry</button>
          <div style="margin-left:auto;text-align:right">
            <div class="tiny muted">Entries: <span id="entryCount">0</span></div>
          </div>
        </div>

        <div class="help" style="margin-top:12px">
          Guide: Σ phrase → ▶ start → breathe 3-6-9 & speak (ℛ) → ■ stop → rate Ξ → save (ΔΣ seal) → export/print. Stop if coherence drops (Ethics → Stop Rule).
        </div>
      </article>

      <!-- RIGHT: Why / recent -->
      <aside class="card" role="complementary" aria-labelledby="why-works">
        <h3 id="why-works">Why this works</h3>
        <ul>
          <li><strong>Carriers</strong> 144/369/432/528/963 bias harmonic lanes; “no tone” still runs.</li>
          <li><strong>Σ → ∇φ → ℛ → ΔΣ</strong> turns phrasing into action, breath/voice phases, then boundary/witness.</li>
          <li><strong>Ξ</strong> is the live quality metric; sealing creates repeatable, cite-able artifacts.</li>
        </ul>

        <div class="goldline" style="margin:12px 0"></div>

        <h4>Recent sealed entries</h4>
        <div id="recent" class="recent-list small muted" aria-live="polite">No entries yet.</div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="cta" href="ledger.html">Open full Ledger →</a>
          <a class="cta" href="guide.html">Guide →</a>
          <a class="cta" href="ethics.html">Ethics →</a>
        </div>
      </aside>
    </section>

    <div class="goldline" style="margin-top:18px"></div>

    <section class="grid4" aria-label="Orientation">
      <article class="card span-12">
        <div class="kicker">Start Here</div>
        <h2>How to use this site in 3 minutes</h2>
        <ol class="list">
          <li><strong>Run a 60s session:</strong> pick a carrier, speak your line, breathe 3-6-9, rate Ξ, save.</li>
          <li><strong>Skim Theory:</strong> canonical equations 0–17 + operators Σ, ∇φ, ℛ, ΔΣ.</li>
          <li><strong>Practice with Teach:</strong> full protocol, A/B, and Circle patterns.</li>
          <li><strong>Log in Ledger:</strong> compare carriers, phrases, and conditions over time.</li>
        </ol>
        <p class="muted small">Headphones help. Keep phrases kind, precise, present-tense. Stop if off-balance.</p>
      </article>

      <article class="card span-4">
        <h3>Core</h3>
        <ul class="list">
          <li>⌂ <a href="index.html">Home</a></li>
          <li>📘 <a href="theory.html">Theory</a></li>
          <li>🎓 <a href="teach.html">Teach / Manifest</a></li>
          <li>🧾 <a href="ledger.html">Ledger</a></li>
        </ul>
      </article>

      <article class="card span-4">
        <h3>Experiments</h3>
        <ul class="list">
          <li>🔁 <a href="ab.html">A/B Carriers</a></li>
          <li>🔣 <a href="glyphs.html">Glyphs</a></li>
          <li>μ <a href="micro.html">Micro-acts</a></li>
        </ul>
      </article>

      <article class="card span-4">
        <h3>Files</h3>
        <ul class="list">
          <li>⬇ <a href="downloads.html">Downloads</a></li>
          <li>📜 <a href="manifest.html">Manifest (Longform)</a></li>
          <li>📚 <a href="glossary.html">Glossary</a></li>
        </ul>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="small muted">Use headphones if possible. Ethics first; stop if you feel off-balance.</p>
      <p>© <span id="yr">2025</span> Aaron Paul Laird — Scroll of Fire</p>
    </footer>
  </main>

  <!-- Page script: carriers, timer, sealed ledger, print-to-PDF witness -->
  <script>
  (function(){
    "use strict";

    /* ---------- utilities & cached nodes ---------- */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const YEAR = $('#yr'); if (YEAR) YEAR.textContent = new Date().getFullYear();

    // LocalStorage keys
    const LEDGER_KEY = 'sof_ledger_entries_v2'; // v2 adds hash + seal
    const PREF      = 'sof_pref_carrier_v1';
    const read = () => { try { return JSON.parse(localStorage.getItem(LEDGER_KEY) || '[]'); } catch { return []; } };
    const write = (arr) => { try { localStorage.setItem(LEDGER_KEY, JSON.stringify(arr)); } catch (e) { console.warn('save failed', e); } };

    // canonical JSON (stable key order)
    function canonicalize(obj){
      if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);
      if (Array.isArray(obj)) return '[' + obj.map(canonicalize).join(',') + ']';
      const keys = Object.keys(obj).sort();
      return '{' + keys.map(k => JSON.stringify(k)+':'+canonicalize(obj[k])).join(',') + '}';
    }

    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const bytes = new Uint8Array(buf);
      return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // nodes
    const RECENT = $('#recent'), ENTRY_COUNT = $('#entryCount');
    const START_BTN = $('#startRun'), STOP_BTN = $('#stopRun'), TIMER_TEXT = $('#timer');
    const PROG = document.getElementById('progressArc');
    const PHRASE = $('#phrase'), COH = $('#coh'), TAG_INPUT = $('#tag');
    const CARRIER_BUTTONS = $$('.carrier-btn');
    const EXPORT_LAST_PDF = $('#exportLastPDF');

    // requestIdle poly
    const idle = window.requestIdleCallback ? window.requestIdleCallback : (fn)=>setTimeout(fn,200);

    /* ---------- audio: WebAudio oscillator ---------- */
    let audioCtx = null, osc = null, gainNode = null;
    function ensureAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.0;
        gainNode.connect(audioCtx.destination);
      } catch (e) { audioCtx = null; }
    }
    function startTone(freq) {
      if (!freq) return;
      ensureAudio();
      if (!audioCtx || osc) return;
      osc = audioCtx.createOscillator();
      osc.type = 'sine'; osc.frequency.value = freq;
      osc.connect(gainNode); osc.start();
      const t = audioCtx.currentTime;
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.linearRampToValueAtTime(0.08, t + 0.08);
    }
    function stopTone() {
      if (!audioCtx || !osc) return;
      const t = audioCtx.currentTime;
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.linearRampToValueAtTime(0.0001, t + 0.08);
      try { osc.stop(t + 0.09); } catch(e) {}
      osc.disconnect && osc.disconnect(); osc = null;
    }
    function warmAudio(){ const resume = () => {
      try { ensureAudio(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); } catch(e){}
      window.removeEventListener('pointerdown', resume); window.removeEventListener('keydown', resume);
    }; window.addEventListener('pointerdown', resume, {once:true, passive:true}); window.addEventListener('keydown', resume, {once:true, passive:true}); }
    warmAudio();

    /* ---------- carriers + skin ---------- */
    const BODY = document.body;
    function setCarrierSkin(code){
      BODY.classList.remove('carrier-144','carrier-369','carrier-432','carrier-528','carrier-963');
      if (code && code !== 'none') BODY.classList.add('carrier-' + code);
    }
    let carrier = '432'; // default
    try {
      const pref = localStorage.getItem(PREF);
      if (pref) carrier = pref;
    } catch(e){}
    // reflect default selection
    CARRIER_BUTTONS.forEach(b=>{
      const on = (b.dataset.carrier === carrier);
      b.setAttribute('aria-pressed', on ? 'true':'false');
      b.setAttribute('aria-checked', on ? 'true':'false');
    });
    setCarrierSkin(carrier);

    CARRIER_BUTTONS.forEach(btn => {
      btn.addEventListener('click', () => {
        CARRIER_BUTTONS.forEach(b => { b.setAttribute('aria-pressed','false'); b.setAttribute('aria-checked','false'); });
        btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-checked','true');
        carrier = btn.dataset.carrier || 'none';
        try { localStorage.setItem(PREF, carrier); } catch(e){}
        setCarrierSkin(carrier);
        if (carrier !== 'none') { startTone(Number(carrier)); setTimeout(()=>stopTone(), 380); } else { stopTone(); }
      }, {passive:true});
      btn.addEventListener('keydown', (e)=>{
        if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
        e.preventDefault();
        const idx = CARRIER_BUTTONS.indexOf(btn);
        const nxt = e.key === 'ArrowRight' ? (idx + 1) % CARRIER_BUTTONS.length : (idx - 1 + CARRIER_BUTTONS.length) % CARRIER_BUTTONS.length;
        CARRIER_BUTTONS[nxt].focus(); CARRIER_BUTTONS[nxt].click();
      });
    });

    /* ---------- timer (rAF) ---------- */
    const DURATION_SECONDS = 60;
    let rafId = null, endTime = 0, lastDisplayed = null;

    (function prepareArc(){
      if (!PROG) return;
      const path = "M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32";
      PROG.setAttribute('d', path); PROG.setAttribute('stroke-linecap','round');
      const circumference = 2 * Math.PI * 16;
      PROG.dataset.circ = String(circumference);
      PROG.setAttribute('stroke-dasharray', `0 ${circumference}`);
      PROG.setAttribute('transform','rotate(-90 18 18)');
    })();

    function setProgressFraction(frac){
      const circ = Number(PROG.dataset.circ) || (2*Math.PI*16);
      const dash = Math.max(0, Math.min(1, frac)) * circ;
      PROG.setAttribute('stroke-dasharray', `${dash.toFixed(2)} ${circ.toFixed(2)}`);
    }
    function updateTimerText(text){ if (TIMER_TEXT && TIMER_TEXT.textContent !== text) TIMER_TEXT.textContent = text; }
    function rafTick(now) {
      const remainingMS = Math.max(0, endTime - now);
      const remainingSecs = Math.ceil(remainingMS / 1000);
      const elapsed = Math.max(0, (DURATION_SECONDS * 1000 - remainingMS));
      const frac = elapsed / (DURATION_SECONDS * 1000);
      if (lastDisplayed !== remainingSecs) { updateTimerText(remainingSecs > 0 ? `${remainingSecs}s` : '0s'); lastDisplayed = remainingSecs; }
      setProgressFraction(frac);
      if (remainingMS <= 0) { stopRun(); return; }
      rafId = requestAnimationFrame(rafTick);
    }
    let RUNNING = false;
    function startRun(){
      if (RUNNING) return; RUNNING = true;
      if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume().catch(()=>{}); }
      if (carrier !== 'none') startTone(Number(carrier));
      START_BTN.disabled = true; STOP_BTN.disabled = false;
      START_BTN.setAttribute('aria-pressed','true'); STOP_BTN.setAttribute('aria-pressed','false');
      endTime = performance.now() + DURATION_SECONDS * 1000; lastDisplayed = null; rafId = requestAnimationFrame(rafTick);
      if (navigator.vibrate) navigator.vibrate(50);
    }
    function stopRun(){
      if (!RUNNING) {
        START_BTN.disabled = false; STOP_BTN.disabled = true;
        STOP_BTN.setAttribute('aria-pressed','true'); START_BTN.setAttribute('aria-pressed','false');
        updateTimerText('Stopped'); setProgressFraction(0); return;
      }
      RUNNING = false;
      if (rafId) cancelAnimationFrame(rafId); rafId = null;
      stopTone();
      START_BTN.disabled = false; STOP_BTN.disabled = true;
      START_BTN.setAttribute('aria-pressed','false'); STOP_BTN.setAttribute('aria-pressed','true');
      updateTimerText('Stopped'); setProgressFraction(0);
    }
    START_BTN && START_BTN.addEventListener('click', startRun);
    STOP_BTN && STOP_BTN.addEventListener('click', stopRun);

    document.addEventListener('keydown', (e) => {
      if (e.key === '/') { e.preventDefault(); PHRASE && PHRASE.focus(); }
      if (e.key === 'r' || e.key === 'R') { if (RUNNING) stopRun(); else startRun(); }
      if (e.key === 'Escape') { if (PHRASE) PHRASE.value = ''; if (COH) COH.value = 0; }
      if (e.key === 'Tab') document.body.classList.add('user-is-tabbing');
    }, {passive:true});

    /* ---------- render recent ---------- */
    function renderRecent(all = read()){
      idle(()=> {
        if (!RECENT) return;
        if (!all.length) {
          RECENT.innerHTML = '<div class="tiny muted">No entries yet.</div>';
          ENTRY_COUNT && (ENTRY_COUNT.textContent = '0');
          return;
        }
        ENTRY_COUNT && (ENTRY_COUNT.textContent = String(all.length));
        const slice = all.slice(0,12);
        RECENT.innerHTML = slice.map((e, idx) => {
          const tags = (e.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
          const shortHash = e.hash ? escapeHtml(e.hash.slice(0,10)) + '…' : '—';
          const sealStage = e.seal?.stage || 'I';
          return `
            <div class="recent-item" data-idx="${idx}">
              <div><strong>${escapeHtml(e.phrase)}</strong></div>
              <div class="tiny muted">${new Date(e.when).toLocaleString()} · carrier: ${escapeHtml(e.carrier)} · Ξ: ${escapeHtml(e.coherence)} · seal ${sealStage} · <code>${shortHash}</code></div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
                ${tags}
                <div style="margin-left:auto;display:flex;gap:6px">
                  <button class="small-btn inline-btn" data-action="pdf" data-idx="${idx}">PDF</button>
                  <button class="small-btn inline-btn" data-action="copy" data-idx="${idx}">Copy</button>
                  <button class="small-btn inline-btn" data-action="delete" data-idx="${idx}">Delete</button>
                </div>
              </div>
              ${ e.note ? `<div class="tiny" style="margin-top:6px">Note: ${escapeHtml(e.note)}</div>` : '' }
            </div>`;
        }).join('');
      });
    }
    renderRecent();

    /* ---------- saving / sealing ---------- */
    async function buildSealedEntry(){
      const phrase = (PHRASE && PHRASE.value || '').trim();
      const coherence = Number(COH && COH.value || 0);
      const tagsRaw = (TAG_INPUT && TAG_INPUT.value || '').trim();
      const tags = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if (!phrase) { alert('Please enter a clear line to save.'); PHRASE && PHRASE.focus(); return null; }
      const payload = {
        when: new Date().toISOString(),
        carrier, phrase, coherence, tags,
        // room for future: node, witnesses, metrics...
      };
      const canon = canonicalize(payload);
      const hash = await sha256Hex(canon);
      const entry = Object.assign({}, payload, {
        hash,
        seal: { stage: 'I', // Seal I: local attestation
                algo: 'SHA-256',
                canonLen: canon.length }
      });
      return entry;
    }

    $('#saveEntry').addEventListener('click', async () => {
      const entry = await buildSealedEntry(); if (!entry) return;
      const arr = read(); arr.unshift(entry); write(arr); renderRecent(arr);
      try { if (navigator.vibrate) navigator.vibrate([30]); } catch(e){}
    }, {passive:true});

    /* ---------- JSON export / import ---------- */
    $('#exportEntries').addEventListener('click', () => {
      const data = read();
      if (!data.length) return alert('No entries to export.');
      const blob = new Blob([JSON.stringify({version:'sof-ledger-v2', entries:data}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'scroll-of-fire-ledger.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }, {passive:true});

    $('#importEntries').addEventListener('click', () => {
      const input = document.createElement('input'); input.type='file'; input.accept='application/json';
      input.onchange = (e) => {
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const parsed = JSON.parse(ev.target.result);
            const list = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.entries) ? parsed.entries : []);
            if (!Array.isArray(list)) throw Error('Expected an array or {entries:[]}.');
            const existing = read();
            const existingIDs = new Set(existing.map(x=>x.hash || x.when));
            const merged = list.concat(existing.filter(x=>!existingIDs.has(x.hash || x.when)));
            write(merged); renderRecent(merged);
            alert('Imported ledger (merged).');
          } catch (err) { alert('Import failed: ' + (err.message || err)); }
        };
        reader.readAsText(file);
      };
      input.click();
    }, {passive:true});

    $('#clearLedger').addEventListener('click', () => {
      if (!confirm('Clear local ledger? This cannot be undone.')) return;
      write([]); renderRecent([]);
    }, {passive:true});

    $('#deleteLast').addEventListener('click', () => {
      const arr = read();
      if (!arr.length) return alert('No entries to delete.');
      if (!confirm('Delete the last (most recent) entry?')) return;
      arr.shift(); write(arr); renderRecent(arr);
    }, {passive:true});

    // List delegation: copy / delete / PDF
    RECENT && RECENT.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button'); if (!btn) return;
      const action = btn.dataset.action; const idx = Number(btn.dataset.idx);
      const arr = read(); const entry = arr[idx];
      if (!entry) return;

      if (action === 'copy') {
        const txt = `${entry.phrase}\ncarrier:${entry.carrier} · Ξ:${entry.coherence} · ${new Date(entry.when).toLocaleString()} · hash:${entry.hash}`;
        if (navigator.clipboard) navigator.clipboard.writeText(txt).then(()=>alert('Copied entry to clipboard.'), ()=>alert('Copy failed.'));
        else prompt('Copy this text', txt);
      } else if (action === 'delete') {
        if (!confirm('Delete this entry?')) return;
        arr.splice(idx,1); write(arr); renderRecent(arr);
      } else if (action === 'pdf') {
        openWitnessSlip(entry);
      }
    }, {passive:true});

    /* ---------- Print-to-PDF witness slip ---------- */
    function openWitnessSlip(entry){
      const win = window.open('', '_blank', 'noopener,noreferrer,width=820,height=900');
      if (!win) { alert('Pop-up blocked. Please allow pop-ups for PDF.'); return; }
      const html = `
<!doctype html><html><head><meta charset="utf-8"><title>Witness — Scroll of Fire</title>
<meta name="color-scheme" content="light dark">
<style>${document.querySelector('style')?.textContent || ''}</style>
</head><body>
  <div class="slip">
    <h1>Scroll of Fire — Witness Slip</h1>
    <div class="meta">Sealed at: ${new Date().toLocaleString()}</div>
    <div class="box">
      <div class="row">
        <div><strong>Phrase (Σ)</strong><br>${escapeHtml(entry.phrase)}</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><strong>Carrier</strong><br>${escapeHtml(entry.carrier)}</div>
        <div><strong>Ξ</strong><br>${escapeHtml(entry.coherence)}</div>
        <div><strong>When</strong><br>${new Date(entry.when).toLocaleString()}</div>
      </div>
      ${entry.tags?.length ? `<div style="margin-top:8px"><strong>Tags</strong><br>${entry.tags.map(t=>`<code>${escapeHtml(t)}</code>`).join(' ')}</div>`:''}
    </div>
    <div class="box">
      <div class="row">
        <div><strong>Seal Stage</strong><br>${escapeHtml(entry.seal?.stage || 'I')}</div>
        <div><strong>Algorithm</strong><br>${escapeHtml(entry.seal?.algo || 'SHA-256')}</div>
      </div>
      <div style="margin-top:8px"><strong>Hash</strong><br><code>${escapeHtml(entry.hash)}</code></div>
      <div class="meta" style="margin-top:6px">Canonical payload length: ${entry.seal?.canonLen || '—'} bytes</div>
    </div>
    <div style="margin-top:12px;font-size:12px;color:#7b8499">
      Generated by Start Here (Σ → ∇φ → ℛ → ΔΣ). Store this with your ledger JSON.
    </div>
  </div>
  <script>window.addEventListener('load',()=>{ setTimeout(()=>window.print(), 200); });</script>
</body></html>`;
      win.document.open(); win.document.write(html); win.document.close();
    }

    EXPORT_LAST_PDF && EXPORT_LAST_PDF.addEventListener('click', () => {
      const arr = read();
      if (!arr.length) return alert('No entries yet.');
      openWitnessSlip(arr[0]); // most recent
    }, {passive:true});

    /* ---------- visual feedback ---------- */
    COH && COH.addEventListener('input', ()=> {
      const v = Number(COH.value);
      const pct = Math.max(0, Math.min(1, v / 5));
      const hue = Math.round(200 * pct);
      PROG && PROG.setAttribute('stroke', `hsl(${hue} 90% 60%)`);
    }, {passive:true});

    // init
    (function init(){
      if (PROG && !PROG.dataset.circ) {
        const circ = 2*Math.PI*16;
        PROG.dataset.circ = String(circ);
        PROG.setAttribute('stroke-dasharray', `0 ${circ}`);
      }
      renderRecent();
    })();

    // safety
    window.addEventListener('pagehide', ()=>{ if (RUNNING) { stopRun(); } if (audioCtx && audioCtx.state === 'running') audioCtx.suspend().catch(()=>{}); }, {passive:true});
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) { stopRun(); } }, {passive:true});
  })();
  </script>
</body>
</html>
