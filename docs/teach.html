<!doctype html>
<html lang="en" dir="ltr" class="sof">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>
    // If running from github.com (file viewer), remove <base> so assets resolve.
    if (location.hostname === "github.com") {
      const b = document.querySelector("base"); if (b) b.remove();
    }
  </script>
  <meta charset="utf-8" />
  <title>Manifest — Remnant Visual Exercise · Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f"><meta name="color-scheme" content="dark">
  <meta name="description" content="RVE: compose intention (𝓘), align a carrier Πν, run 𝓘→𝓛→𝓒→𝓢, breathe, compute Ξ, drill focus, consult Ethics (Eq.9), and seal to a private Witness Ledger." />
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/teach.html" />
  <meta property="og:title" content="Manifest — Remnant Visual Exercise · Scroll of Fire">
  <meta property="og:description" content="Create. Witness. Seal. Carrier tuning, observer pacing, breath ring, Ξ meter, drills, neuro maps, and private ledger — with Eq.9 safety mask.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-26">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-26" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-26"></noscript>

  <link rel="preload" as="image" href="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png" imagesizes="100vw">

  <style>
    :root{--maxw:1180px}
    body{margin:0}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:20px 16px 120px}
    .title{
      font-family:"Crimson Pro",serif;font-weight:800;text-align:center;
      font-size:clamp(28px,3.6vw,44px);margin:8px 0 4px;letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#cfefff 60%,#a7f6ff);
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .subtitle{text-align:center;color:var(--muted);margin:0 0 12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-9{grid-column:span 9}.col-12{grid-column:span 12}
    @media (max-width:980px){.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-9,.col-12{grid-column:span 12}}

    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
    .lab-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .lab-btn{padding:.6rem .85rem;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);font-weight:700;cursor:pointer}
    .lab-btn[disabled]{opacity:.5;cursor:not-allowed}
    .lab-btn.primary{box-shadow:0 8px 24px rgba(122,243,255,.12)}
    .lab-input{width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:inherit}
    .hint,.meta{color:#9aa4be}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0)}

    .tabs-wrap{position:relative}
    .pill-rail{
      display:flex; gap:6px; align-items:center; overflow:auto; scroll-snap-type:x mandatory;
      padding:0 40px;
      mask-image:linear-gradient(90deg,transparent 0, #000 32px, #000 calc(100% - 32px), transparent 100%);
      -webkit-mask-image:linear-gradient(90deg,transparent 0, #000 32px, #000 calc(100% - 32px), transparent 100%);
    }
    .pill{flex:0 0 auto; scroll-snap-align:start; padding:.5rem .8rem;border-radius:999px;border:1px solid var(--line);cursor:pointer;white-space:nowrap}
    .pill.active{border-color:var(--accent);box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 45%, transparent)}
    .tab{display:none}.tab.active{display:block}
    .chev{
      position:absolute; top:50%; transform:translateY(-50%);
      width:32px; height:32px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.04); display:grid; place-items:center; cursor:pointer;
    }
    .chev.left{left:4px} .chev.right{right:4px}
    .chev[disabled]{opacity:.4;cursor:not-allowed}

    /* REMNANT */
    .stage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e15}
    #trace{display:block;width:100%;height:420px;background:radial-gradient(240px 180px at 50% 50%, #0e1420, #080b12)}
    .hud{position:absolute;inset:auto 10px 10px 10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
    .chip{font-size:.82rem;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);pointer-events:auto}

    .control-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .control-grid > * {grid-column:span 12}
    @media (min-width:760px){ .control-grid .span-3{grid-column:span 3} .control-grid .span-4{grid-column:span 4} .control-grid .span-6{grid-column:span 6} .control-grid .span-8{grid-column:span 8}}

    .ring-bg{fill:none;stroke:#1f1f28;stroke-width:6}
    .ring-fg{fill:none;stroke:url(#gradRing);stroke-width:6;stroke-linecap:round;stroke-dasharray:0 283}
    .ring-num{font:800 18px/1 Inter;fill:#eae7df}
    .ring-sub{font:600 10px/1 Inter;fill:#b8b3a6}

    .hero{margin:8px auto 0; max-width:1280px; border-radius:16px; overflow:hidden; background:#0b0f14}
    .hero-frame{position:relative}
    .hero-img{display:block; width:100%; height:auto; object-fit:contain; aspect-ratio:21/9}
    .hero-overlay{position:absolute; inset:0; background:radial-gradient(ellipse at 50% 70%, rgba(10,16,22,.35), transparent 70%); pointer-events:none}
    .hero-glow{position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, rgba(122,243,255,.15), rgba(243,201,122,.06) 70%, transparent 100%); mix-blend-mode:screen; opacity:.45; animation:heroPulse 12s ease-in-out infinite; pointer-events:none}
    @keyframes heroPulse{0%,100%{opacity:.35;transform:scale(1);filter:blur(0)}50%{opacity:.6;transform:scale(1.05);filter:blur(2px)}}
    @media (prefers-reduced-motion: reduce){ .hero-glow{animation:none;opacity:.28} }

    .thumb{height:40px;width:auto;border:1px solid var(--line);border-radius:6px;vertical-align:middle;cursor:pointer}
    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999}
    .lightbox.open{display:flex}
    .lightbox img{max-width:min(92vw,1200px); max-height:88vh; border-radius:12px; border:1px solid #2a3242; box-shadow:0 16px 48px rgba(0,0,0,.6)}

    .visible{opacity:1;transform:none}
    .card{opacity:.96;transform:translateY(6px);transition:opacity .25s ease-out, transform .25s ease-out}

    body.stars {
      background:
        radial-gradient(800px 600px at 50% 30%, rgba(15,25,40,.6), transparent 80%),
        linear-gradient(180deg, #05060a 0%, #0b0e14 80%);
      overflow-x:hidden;
    }
    canvas#trace {
      background:
        radial-gradient(circle at 50% 50%, #0a0e15 0%, #06080d 80%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
      box-shadow: inset 0 0 40px rgba(122,243,255,.12), 0 0 120px rgba(122,243,255,.08);
    }
    .stage::after {
      content:""; position:absolute; inset:0;
      background:radial-gradient(ellipse at 50% 60%, rgba(122,243,255,.08), transparent 70%);
      pointer-events:none;
    }
    .table-wrap{overflow:auto}
  </style>
</head>

<body class="stars">
  <!-- Banner -->
  <figure class="hero" aria-label="Scroll of Fire banner">
    <div class="hero-frame">
      <img
        src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png"
        alt="Scroll of Fire — sigil banner"
        width="2100" height="900"
        decoding="async"
        loading="eager"
        fetchpriority="high"
        class="hero-img">
      <div class="hero-overlay"></div>
      <div class="hero-glow"></div>
    </div>
  </figure>

  <main class="wrap" id="main" role="main">
    <header class="page-head fancy-head">
      <h1 class="title">✨ Manifest — <em>Remnant Visual Exercise</em></h1>
      <p class="subtitle">Compose a line (𝓘), tune Π<sub>ν</sub>, run 𝓘→𝓛→𝓒→𝓢, breathe, track Ξ, drill focus, consult Ethics (Eq.9), and <b>seal</b> the remnant to witness.</p>

      <nav class="crumbs" aria-label="Breadcrumb" style="display:flex;gap:8px;justify-content:center;margin-top:10px;margin-bottom:14px">
        <a class="lab-btn" href="index.html">← Back to Codex</a>
        <a class="lab-btn" href="theory.html">📘 Theory</a>
      </nav>

      <section class="card" style="margin-top:10px">
        <div class="tabs-wrap" role="navigation" aria-label="Manifest tabs">
          <button class="chev left" id="tabsPrev" aria-label="Scroll tabs left" type="button">‹</button>
          <div class="pill-rail" id="pillRail" role="tablist" tabindex="0" aria-label="Sections">
            <button class="pill active" data-tab="remnant"  role="tab" aria-selected="true"  type="button">🜚 Remnant</button>
            <button class="pill"        data-tab="observer" role="tab" aria-selected="false" type="button">⏱ Observer</button>
            <button class="pill"        data-tab="voice"    role="tab" aria-selected="false" type="button">🎙 Carrier</button>
            <button class="pill"        data-tab="phrase"   role="tab" aria-selected="false" type="button">🔡 Phrase</button>
            <button class="pill"        data-tab="breath"   role="tab" aria-selected="false" type="button">🌬 Breath</button>
            <button class="pill"        data-tab="coherence"role="tab" aria-selected="false" type="button">📈 Ξ</button>
            <button class="pill"        data-tab="drills"   role="tab" aria-selected="false" type="button">🧭 Drills</button>
            <button class="pill"        data-tab="timer"    role="tab" aria-selected="false" type="button">⏳ Timer</button>
            <button class="pill"        data-tab="deck"     role="tab" aria-selected="false" type="button">🎴 Deck</button>
            <button class="pill"        data-tab="ledger"   role="tab" aria-selected="false" type="button">📒 Ledger</button>
            <button class="pill"        data-tab="ethics"   role="tab" aria-selected="false" type="button">🛡 Ethics</button>
            <button class="pill"        data-tab="maps"     role="tab" aria-selected="false" type="button">🧠 Maps</button>
          </div>
          <button class="chev right" id="tabsNext" aria-label="Scroll tabs right" type="button">›</button>
        </div>
      </section>
    </header>

    <!-- ========================================================= -->
    <!-- =================== REMNANT (EXPANDED) ================== -->
    <!-- ========================================================= -->
    <section id="tab-remnant" class="tab active" role="tabpanel" aria-labelledby="remnant-tab">
      <article class="grid">
        <div class="card col-9">
          <h2>🜚 Remnant — Visual Exercise, Autopilot, & Seal</h2>

          <!-- Stage -->
          <div class="stage">
            <canvas id="trace" aria-label="Remnant trace"></canvas>
            <div class="hud">
              <div class="lab-row">
                <span class="chip" id="hudCarrier">Πν: —</span>
                <span class="chip" id="hudBreath">Breath: —</span>
                <span class="chip" id="hudXi">Ξ: —</span>
              </div>
              <div class="lab-row">
                <button class="chip" id="seedBtn" type="button">Seed</button>
                <button class="chip" id="clearBtn" type="button">Clear</button>
                <button class="chip" id="dlTrace" type="button">PNG</button>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="control-grid" style="margin-top:10px">
            <label class="span-3">Mode
              <select id="visMode" class="lab-input" aria-label="Visual mode">
                <option value="0">Flow (particle bloom)</option>
                <option value="1">Lattice (Lissajous net)</option>
                <option value="2">Torus (donut points)</option>
                <option value="3">Poly (icosahedron)</option>
                <option value="4">Rose (k-petaled)</option>
                <option value="5">Spiro (trochoid)</option>
                <option value="6">Lissajous Grid (multi-phase)</option>
                <option value="7">Vortex (toroidal flow)</option>
                <option value="8">Orbitals (Bohr-ish)</option>
                <option value="9">Phi Weave (golden lattice)</option>
                <option value="10">Aurora (noise ribbons)</option>
                <option value="11">Chladni (modal nodes)</option>
                <option value="12">Gyre (double-spiral)</option>
                <option value="13">Bloomfield (diffusive)</option>
              </select>
            </label>

            <label class="span-3">Density <input id="visDensity" type="range" min="40" max="1200" value="220" class="lab-input" aria-label="Density"></label>
            <label class="span-3">Speed <input id="visSpeed" type="range" min="0" max="240" value="90" class="lab-input" aria-label="Speed"></label>
            <label class="span-3">Afterglow <input id="visFade" type="range" min="2" max="40" value="14" class="lab-input" aria-label="Motion blur/decay"></label>

            <div class="span-6">
              <div class="lab-row" role="radiogroup" aria-label="Carrier">
                <button class="lab-btn tone" data-carrier="432" type="button">432</button>
                <button class="lab-btn tone" data-carrier="528" type="button">528</button>
                <button class="lab-btn tone" data-carrier="369" type="button">369</button>
                <button class="lab-btn tone" data-carrier="144" type="button">144</button>
                <button class="lab-btn tone" data-carrier="963" type="button">963</button>
                <button class="lab-btn tone" data-carrier="none" type="button">None</button>
              </div>
              <div class="lab-row">
                <label><input type="checkbox" id="binaural"> Binaural ±4 Hz</label>
                <label><input type="checkbox" id="carrierGate"> Keep carrier on</label>
                <label><input type="checkbox" id="sym" checked> Mirror symmetry</label>
                <label><input type="checkbox" id="noise" checked> Subtle noise</label>
              </div>
            </div>

            <div class="span-6">
              <div class="lab-row">
                <label>Colorway
                  <select id="palette" class="lab-input" style="width:auto">
                    <option value="aqua-gold">Aqua → Gold (default)</option>
                    <option value="rose-ember">Rose → Ember</option>
                    <option value="violet-ice">Violet → Ice</option>
                    <option value="forest-sun">Forest → Sun</option>
                    <option value="mono">Mono (elegant)</option>
                  </select>
                </label>
                <label>Stroke <input id="stroke" type="range" min="1" max="5" value="2" class="lab-input" style="width:120px"></label>
                <button id="savePreset" class="lab-btn" type="button">Save Preset</button>
                <button id="loadPreset" class="lab-btn" type="button">Load</button>
              </div>
              <div class="lab-row">
                <button id="autoRun" class="lab-btn primary" type="button">Auto-Pilot (𝓘→𝓛→𝓒→𝓢, 48s)</button>
                <button id="rmnSeal" class="lab-btn" type="button">Seal → Ledger</button>
                <button id="newSeed" class="lab-btn" type="button">New Seed</button>
                <label><input type="checkbox" id="lockSeed"> Lock seed</label>
              </div>
            </div>

            <input id="rmnLine" class="lab-input span-12" placeholder="Your intention line (𝓘)…" aria-label="Intention line">

            <div class="span-12">
              <details class="card">
                <summary><strong>Advanced</strong> (carrier mix, phase, vortex bias, orbital count)</summary>
                <div class="grid" style="margin-top:8px">
                  <label class="lab-input col-6">Carrier Mix (0–1) <input id="cMix" type="range" min="0" max="1" step="0.01" value="0.65"></label>
                  <label class="lab-input col-6">Phase Bias (−1..1) <input id="cPhase" type="range" min="-1" max="1" step="0.01" value="0.00"></label>
                  <label class="lab-input col-6">Vortex Bias (0–1) <input id="vBias" type="range" min="0" max="1" step="0.01" value="0.42"></label>
                  <label class="lab-input col-6">Orbitals (3–24) <input id="orbitals" type="range" min="3" max="24" step="1" value="8"></label>
                </div>
              </details>
            </div>

            <p class="hint span-12">
              Guidance: Torus/Poly with 4-7-8 for calm; Rose/Spiro during Focus; Vortex/Aurora for energy reset; Chladni for tone-locking with mic.
            </p>
          </div>
        </div>

        <aside class="card col-3">
          <h3>Operator map</h3>
          <ol class="list compact">
            <li>𝓘 <b>Intend</b> — one clear line on Π<sub>ν</sub>.</li>
            <li>𝓛 <b>Light/Language</b> — speak it once, steady.</li>
            <li>𝓒 <b>Conscious Witness</b> — one undeniable detail.</li>
            <li>𝓢 <b>Source/Seal</b> — seal, rest, update later.</li>
          </ol>
          <div class="divider"></div>
          <h3>Export</h3>
          <p class="meta">PNG embeds metadata: mode, seed, carrier, Ξ, and your 𝓘 (as tEXt). Private to this device.</p>
          <div class="lab-row"><button id="dlTraceMeta" class="lab-btn" type="button">PNG + meta</button></div>
          <div class="divider"></div>
          <p class="meta">Hotkeys: 1–9 tabs • S start/stop observer • P save PNG • R randomize.</p>
        </aside>
      </article>
    </section>

    <!-- ========= PART 1/3 will continue with the rest of tabs in Part 2/3 ========= -->

    <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);

    /* ---------- Tabs / rails / keys (shared) ---------- */
    const tabBtns=$$(".pill"), tabs=$$(".tab");
    const rail=$("#pillRail"), prev=$("#tabsPrev"), next=$("#tabsNext");
    function switchTo(id){
      if(!id) return;
      tabs.forEach(t=>t.classList.toggle("active", t.id==="tab-"+id));
      tabBtns.forEach(b=>{
        const onTab = b.dataset.tab===id;
        b.classList.toggle("active", onTab);
        b.setAttribute("aria-selected", onTab ? "true" : "false");
      });
      const btn=tabBtns.find(b=>b.dataset.tab===id);
      if(btn){ btn.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"}); btn.focus({preventScroll:true}); }
    }
    tabBtns.forEach(b=>on(b,"click",()=>switchTo(b.dataset.tab)));
    function updateChev(){
      if(!rail) return;
      prev.disabled = rail.scrollLeft<=4;
      next.disabled = (rail.scrollLeft + rail.clientWidth) >= (rail.scrollWidth-4);
    }
    on(prev,"click",()=>{ rail.scrollBy({left:-rail.clientWidth*0.7,behavior:"smooth"}); });
    on(next,"click",()=>{ rail.scrollBy({left: rail.clientWidth*0.7,behavior:"smooth"}); });
    on(rail,"scroll",updateChev,{passive:true}); updateChev();
    on(rail,"keydown",(e)=>{
      if(e.key==="ArrowRight"){ e.preventDefault(); const i=Math.max(0,tabBtns.findIndex(b=>b.classList.contains("active"))); const n=tabBtns[(i+1)%tabBtns.length]; n.click(); }
      if(e.key==="ArrowLeft"){ e.preventDefault(); const i=Math.max(0,tabBtns.findIndex(b=>b.classList.contains("active"))); const n=tabBtns[(i-1+tabBtns.length)%tabBtns.length]; n.click(); }
    });
    on(document,"keydown",(e)=>{ if(e.target.matches("input,textarea")) return;
      const map={1:"remnant",2:"observer",3:"voice",4:"phrase",5:"breath",6:"coherence",7:"drills",8:"timer",9:"deck",0:"ledger"};
      if(map[e.key]){ e.preventDefault(); switchTo(map[e.key]); }
      if((e.key==="P"||e.key==="p") && $("#trace")){ e.preventDefault(); $("#dlTrace").click(); }
      if((e.key==="R"||e.key==="r")){ e.preventDefault(); $("#newSeed")?.click(); }
      if((e.key==="S"||e.key==="s")){ e.preventDefault(); /* Observer wiring comes in Part 2 */ }
    });

    /* ---------- Hero reveal ---------- */
    $("#yr") && ($("#yr").textContent = new Date().getFullYear());
    if('IntersectionObserver' in window){
      const io=new IntersectionObserver(es=>es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); } }), {threshold:.08});
      $$(".card").forEach(c=>io.observe(c));
    } else { $$(".card").forEach(c=>c.classList.add('visible')); }

    /* ---------- Local helpers ---------- */
    function toast(msg){
      const el=document.createElement("div"); el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }
    const PREFERS_RM = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    /* ===================== Remnant Super-Engine ===================== */
    let AC=null, carrier="none";
    function ensureAC(){ if(AC) return AC; try{ AC=new (window.AudioContext||window.webkitAudioContext)(); }catch{} return AC; }
    window.addEventListener("pointerdown",()=>{ if(AC && AC.state==="suspended"){ AC.resume(); } },{once:true,passive:true});

    // carrier osc pair
    let G=null, PAN_L=null, PAN_R=null, OSC_L=null, OSC_R=null;
    function initAudio(){
      if(!ensureAC()) return;
      if(G) return;
      G=AC.createGain(); G.gain.value=0.00006; G.connect(AC.destination);
      PAN_L = AC.createStereoPanner ? AC.createStereoPanner() : null;
      PAN_R = AC.createStereoPanner ? AC.createStereoPanner() : null;
      if(PAN_L && PAN_R){ PAN_L.pan.value=-0.66; PAN_R.pan.value=0.66; PAN_L.connect(G); PAN_R.connect(G); }
    }
    function stopOsc(){ try{OSC_L?.stop();OSC_R?.stop();}catch(_){} OSC_L=null; OSC_R=null; }
    function playCarrier(freq, dur=0.5, vol=0.06){
      initAudio(); if(!AC||!freq) return;
      stopOsc();
      const binaural = $("#binaural")?.checked;
      const fL = binaural ? freq-2 : freq, fR = binaural ? freq+2 : freq;
      const oL=AC.createOscillator(), gL=AC.createGain(); oL.type="sine"; oL.frequency.value=fL; gL.gain.value=0.0001;
      const oR=AC.createOscillator(), gR=AC.createGain(); oR.type="sine"; oR.frequency.value=fR; gR.gain.value=0.0001;
      oL.connect(gL).connect(PAN_L||G); oR.connect(gR).connect(PAN_R||G);
      const t=AC.currentTime; const gate=$("#carrierGate")?.checked ? dur*10 : dur;
      gL.gain.linearRampToValueAtTime(vol,t+0.06); gL.gain.linearRampToValueAtTime(0.0001,t+gate);
      gR.gain.linearRampToValueAtTime(vol,t+0.06); gR.gain.linearRampToValueAtTime(0.0001,t+gate);
      oL.start(); oR.start(); oL.stop(t+gate+0.04); oR.stop(t+gate+0.04);
      OSC_L=oL; OSC_R=oR;
    }
    $$(".tone").forEach(b=>on(b,"click",()=>{
      const c=b.dataset.carrier||"none"; carrier=c; $("#hudCarrier").textContent="Πν: "+c;
      if(c!=="none") playCarrier(+c,0.7,0.07);
    }));

    // Canvas
    const canvas=$("#trace"), ctx=canvas?.getContext?.("2d");
    function fit(){
      if(!canvas||!ctx) return;
      const r=canvas.getBoundingClientRect();
      canvas.width=r.width;
      canvas.height=Math.max(360, Math.min(560, Math.round(r.width*0.40)));
    }
    fit(); addEventListener("resize", fit, {passive:true});
    if('ResizeObserver' in window){ new ResizeObserver(()=>fit()).observe(canvas.parentElement); }

    // Palettes
    const pals={
      "aqua-gold": t=>t<.5?`rgba(122,243,255,${0.18+0.7*t})`:`rgba(243,201,122,${0.18+0.7*(t-.5)})`,
      "rose-ember": t=>t<.5?`rgba(255,98,150,${0.18+0.7*t})`:`rgba(255,176,94,${0.18+0.7*(t-.5)})`,
      "violet-ice": t=>t<.5?`rgba(170,120,255,${0.18+0.7*t})`:`rgba(170,235,255,${0.18+0.7*(t-.5)})`,
      "forest-sun": t=>t<.5?`rgba(96,201,140,${0.18+0.7*t})`:`rgba(244,212,92,${0.18+0.7*(t-.5)})`,
      "mono":      t=>`rgba(230,230,230,${0.15+0.75*t})`,
    };
    function pal(t){ return pals[$("#palette")?.value||"aqua-gold"](Math.max(0,Math.min(1,t))); }

    // Controls
    const visMode=$("#visMode"), visDensity=$("#visDensity"), visSpeed=$("#visSpeed"), visFade=$("#visFade");
    const sym=$("#sym"), noise=$("#noise"), stroke=$("#stroke"), orbitals=$("#orbitals");
    const cMix=$("#cMix"), cPhase=$("#cPhase"), vBias=$("#vBias");
    let phi=0, seed=Math.random()*1000, mode=+visMode.value|0;
    if(!Number.isFinite(mode) || mode<0) mode = 0;

    // Noise helpers
    function rng(){ const x=Math.sin(seed++)*43758.5453; return x-Math.floor(x); }
    function n2d(x,y){ const s=Math.sin(x*12.9898+y*78.233)*43758.5453; return s-Math.floor(s); }

    function speed(){ return (+visSpeed.value/90); }
    function count(def){ const d=+visDensity.value; return Math.max(20, Math.floor(d*(def/220))); }

    function clearFrame(){
      const f=+visFade.value; ctx.fillStyle=`rgba(10,14,21,${f/200})`; ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    /* -------------------- Visual Modes (14) -------------------- */
    function drawFlow(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const base = carrier==="none"? 0.7 : ((parseFloat(carrier)%1000)/1000);
      const n=count(220), r0=Math.min(W,H)*0.24, st=+stroke.value;
      for(let i=0;i<n;i++){
        const a=i/n*Math.PI*2 + phi*0.0007*speed();
        const b=Math.sin(i*0.17 + seed*0.07 + phi*0.001);
        const r=r0*(0.72 + 0.3*Math.sin(phi*0.0018*speed() + i*0.05 + base*6));
        const x=W/2+Math.cos(a)*r*(1+0.08*b);
        const y=H/2+Math.sin(a*(1.0+0.02*Math.cos(phi*0.0026*speed())) )*r*(1-0.05*b);
        ctx.fillStyle=pal((i%100)/100);
        const rad=st*(0.6+0.9*(0.5+0.5*b));
        if(sym.checked){
          ctx.beginPath(); ctx.arc(x,y,rad,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(W-x,y,rad,0,Math.PI*2); ctx.fill();
        }else{ ctx.beginPath(); ctx.arc(x,y,rad,0,Math.PI*2); ctx.fill(); }
      }
      phi+=(["In","—","Out","—"].includes($("#hudBreath").textContent.split(": ")[1])?1.6:1.1)*speed();
    }

    function drawLattice(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const base= carrier==="none"?0.5:((+carrier%360)/360);
      const a=1+Math.round(base*5), b=2+Math.round(base*7);
      const R=Math.min(W,H)*0.36, steps=count(640);
      ctx.beginPath();
      for(let i=0;i<steps;i++){
        const th=i/steps*Math.PI*2;
        const x=W/2+R*Math.sin(a*th + phi*0.0012*speed());
        const y=H/2+R*Math.sin(b*th + phi*0.0016*speed());
        (i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      }
      ctx.lineWidth=+stroke.value; ctx.strokeStyle=pal(.8); ctx.stroke();
      if(sym.checked){ ctx.save(); ctx.translate(W,0); ctx.scale(-1,1); ctx.stroke(); ctx.restore(); }
      phi+=1.5*speed();
    }

    function drawTorus(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const R=Math.min(W,H)*0.26, r=R*0.36, n=count(180), st=+stroke.value;
      const a=phi*0.002*speed(), b=phi*0.0013*speed();
      const cb=Math.cos(b), sb=Math.sin(b), ca=Math.cos(a), sa=Math.sin(a);
      for(let i=0;i<n;i++){
        const u=i/n*Math.PI*2, ny=28;
        for(let j=0;j<ny;j++){
          const v=j/ny*Math.PI*2;
          let x=(R + r*Math.cos(v))*Math.cos(u);
          let y=(R + r*Math.cos(v))*Math.sin(u);
          let z=r*Math.sin(v);
          let X =  x*cb + z*sb; let Z = -x*sb + z*cb;
          let Y =  y*ca - Z*sa; Z =  y*sa + Z*ca;
          const d=500/(600+Z);
          const px=W/2+X*d, py=H/2+Y*d;
          const t=(Z+R)/(2*R + r);
          ctx.fillStyle = pal(t);
          ctx.fillRect(px,py,st,st);
          if(sym.checked) ctx.fillRect(W-px,py,st,st);
        }
      }
      phi += 1.35*speed();
    }

    function drawPoly(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const PHI=(1+Math.sqrt(5))/2, s=Math.min(W,H)*0.22, st=+stroke.value;
      const vtx=[[-1,PHI,0],[1,PHI,0],[-1,-PHI,0],[1,-PHI,0],[0,-1,PHI],[0,1,PHI],[0,-1,-PHI],[0,1,-PHI],[PHI,0,-1],[PHI,0,1],[-PHI,0,-1],[-PHI,0,1]].map(v=>v.map(n=>n*s/PHI));
      const edges=[[0,1],[0,7],[0,11],[1,7],[1,9],[2,3],[2,6],[2,11],[3,6],[3,9],[4,5],[4,9],[4,11],[5,9],[5,11],[6,7],[6,8],[7,8],[8,9],[8,10],[10,11],[10,7],[10,6],[11,0]];
      const ax=phi*0.0018*speed(), ay=phi*0.0011*speed(), az=phi*0.0015*speed();
      const cx=Math.cos(ax), sx=Math.sin(ax), cy=Math.cos(ay), sy=Math.sin(ay), cz=Math.cos(az), sz=Math.sin(az);
      function rot([x,y,z]){ let Y1= y*cx - z*sx, Z1= y*sx + z*cx; let X2= x*cy + Z1*sy, Z2= -x*sy + Z1*cy, Y2=Y1; let X3= X2*cz - Y2*sz, Y3= X2*sz + Y2*cz, Z3=Z2; return [X3,Y3,Z3]; }
      const pv=vtx.map(v=>rot(v)).map(([x,y,z])=>{ const d=500/(600+z); return [W/2+x*d, H/2+y*d, z]; });
      ctx.lineWidth=st;
      edges.forEach(([i,j])=>{
        const zi=pv[i][2], zj=pv[j][2], t=((zi+zj)/2 + s)/(2*s);
        ctx.strokeStyle=pal(Math.max(0,Math.min(1,t)));
        ctx.beginPath(); ctx.moveTo(pv[i][0],pv[i][1]); ctx.lineTo(pv[j][0],pv[j][1]); ctx.stroke();
        if(sym.checked){ ctx.beginPath(); ctx.moveTo(W-pv[i][0],pv[i][1]); ctx.lineTo(W-pv[j][0],pv[j][1]); ctx.stroke(); }
      });
      phi += 1.15*speed();
    }

    function drawRose(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const base = carrier==="none"? 3 : (Math.max(2, Math.round((+carrier%1000)/120)));
      const k = base + ((seed|0)%3);
      const R = Math.min(W,H)*0.38, n = count(820), st=+stroke.value;
      ctx.beginPath();
      for(let i=0;i<=n;i++){
        const th = i/n*Math.PI*2*2;
        const r = R * Math.cos(k*th + phi*0.0012*speed());
        const x = W/2 + r*Math.cos(th), y= H/2 + r*Math.sin(th);
        (i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      }
      ctx.lineWidth=st; ctx.strokeStyle=pal(.75); ctx.stroke();
      if(sym.checked){ ctx.save(); ctx.translate(W,0); ctx.scale(-1,1); ctx.stroke(); ctx.restore(); }
      phi += 1.25*speed();
    }

    function drawSpiro(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const R = Math.min(W,H)*0.34;
      const r = R * (0.25 + 0.15*Math.sin(seed*0.01));
      const d = r * (0.8 + 0.3*Math.cos(seed*0.013));
      const ext = 2*Math.PI*(r? (R/r): 8);
      const steps = count(1200), st=+stroke.value;
      ctx.beginPath();
      for(let i=0;i<=steps;i++){
        const t = i/steps*ext + phi*0.001*speed() + cPhase.value*0.6;
        const x = (R-r)*Math.cos(t) + d*Math.cos(((R-r)/r)*t);
        const y = (R-r)*Math.sin(t) - d*Math.sin(((R-r)/r)*t);
        (i?ctx.lineTo(W/2+x,H/2+y):ctx.moveTo(W/2+x,H/2+y));
      }
      ctx.lineWidth=st; ctx.strokeStyle=pal(.6); ctx.stroke();
      phi += 1.1*speed();
    }

    function drawLissaGrid(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const cols=6, rows=4, pad=14, st=+stroke.value;
      const cw=(W - pad*(cols+1))/cols, ch=(H - pad*(rows+1))/rows;
      const a=2 + ((seed|0)%5), b=3 + ((seed>>2)%5);
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          ctx.beginPath();
          const x0=pad + c*(cw+pad), y0=pad + r*(ch+pad), n=160;
          for(let i=0;i<=n;i++){
            const t=i/n*Math.PI*2;
            const x = x0 + cw/2 + cw*0.42*Math.sin(a*t + 0.6*c + phi*0.0016*speed());
            const y = y0 + ch/2 + ch*0.42*Math.sin(b*t + 0.4*r + phi*0.0012*speed());
            (i?ctx.lineTo(x,y):ctx.moveTo(x,y));
          }
          ctx.lineWidth=st; ctx.strokeStyle = pal((c/cols*0.5 + r/rows*0.5)); ctx.stroke();
        }
      }
      phi += 1.25*speed();
    }

    const vortexP=[];
    function drawVortex(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const N = count(360), st=+stroke.value, vb=+vBias.value;
      while(vortexP.length<N){ vortexP.push({a: Math.random()*Math.PI*2, r: 0.1+Math.random()*0.9, z: (Math.random()-0.5)*2, s: 0.5+Math.random()*1.4}); }
      for(let i=0;i<N;i++){
        const p=vortexP[i];
        p.a += 0.008 * p.s * speed() * (0.5+vb);
        p.z += 0.006 * Math.sin(seed*0.01+i) * speed() * (0.5+vb*0.5);
        if(p.z>1.2) p.z=-1.2;
        const R = Math.min(W,H)*0.32;
        const r0 = R*(0.35 + 0.25*Math.sin(p.a*3 + phi*0.002));
        const x = (R + r0*Math.cos(p.a)) * Math.cos(p.a*0.6);
        const y = (R + r0*Math.cos(p.a)) * Math.sin(p.a*0.6);
        const z = r0*Math.sin(p.a) + p.z*R*0.25;
        const d=500/(600+z);
        const px=W/2 + x*d, py=H/2 + y*d;
        const t=(z+R)/(2*R);
        ctx.fillStyle=pal(Math.max(0,Math.min(1,t)));
        ctx.fillRect(px,py,st,st);
        if(sym.checked) ctx.fillRect(W-px,py,st,st);
      }
      phi += 1.45*speed();
    }

    function drawOrbitals(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const k=+orbitals.value, R=Math.min(W,H)*0.36, st=+stroke.value, mix=+cMix.value;
      for(let i=0;i<k;i++){
        const a=i/k*Math.PI*2 + phi*0.0009*speed();
        const r=R*(0.45+0.35*Math.sin(a*mix + seed*0.02));
        const x=W/2 + r*Math.cos(a), y=H/2 + r*Math.sin(a + cPhase.value);
        ctx.fillStyle=pal((i%k)/k); ctx.fillRect(x,y,st,st);
        if(sym.checked) ctx.fillRect(W-x,y,st,st);
      }
      phi += 1.05*speed();
    }

    function drawPhiWeave(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const PHI=(1+Math.sqrt(5))/2, st=+stroke.value;
      const loops=count(260);
      ctx.beginPath();
      for(let i=0;i<loops;i++){
        const t=i/loops*Math.PI*2;
        const r = Math.min(W,H)*0.38 * (0.5+0.5*Math.sin(PHI*t + phi*0.0014*speed()));
        const x=W/2 + r*Math.cos(t), y=H/2 + r*Math.sin(PHI*t);
        (i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      }
      ctx.lineWidth=st; ctx.strokeStyle=pal(.7); ctx.stroke();
      phi += 1.2*speed();
    }

    function drawAurora(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const bands=6, st=+stroke.value;
      for(let b=0;b<bands;b++){
        ctx.beginPath();
        for(let x=0;x<=W;x+=2){
          const y = H*0.5 + Math.sin((x*0.01)+(b*0.7)+phi*0.008*speed())*H*0.12 + (noise.checked? (n2d(x*0.02,b+seed*0.01)-0.5)*14 : 0);
          (x?ctx.lineTo(x,y):ctx.moveTo(x,y));
        }
        ctx.lineWidth=st; ctx.strokeStyle=pal(b/bands); ctx.stroke();
      }
      phi += 1.3*speed();
    }

    function drawChladni(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const m=3+((seed|0)%5), n=2+((seed>>3)%5), st=+stroke.value;
      const S=12;
      for(let y=0;y<H;y+=S){
        for(let x=0;x<W;x+=S){
          const v = Math.sin(m*Math.PI*x/W + phi*0.002*speed()) * Math.sin(n*Math.PI*y/H + cPhase.value);
          const t=(v+1)/2; ctx.fillStyle=pal(t);
          if(Math.abs(v)<0.02) { ctx.fillRect(x,y,st,st); if(sym.checked) ctx.fillRect(W-x,y,st,st); }
        }
      }
      phi += 1.15*speed();
    }

    function drawGyre(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const n=count(900), st=+stroke.value;
      for(let i=0;i<n;i++){
        const t=i/n*Math.PI*8 + phi*0.0018*speed();
        const r=Math.min(W,H)*0.02 + i/n*Math.min(W,H)*0.38;
        const x=W/2 + r*Math.cos(t), y=H/2 + r*Math.sin(t);
        ctx.fillStyle=pal(i/n); ctx.fillRect(x,y,st,st);
        if(sym.checked) ctx.fillRect(W-x,y,st,st);
      }
      phi += 1.35*speed();
    }

    function drawBloomfield(){
      const W=canvas.width,H=canvas.height; clearFrame();
      const n=count(640), st=+stroke.value;
      for(let i=0;i<n;i++){
        const a = i/n*Math.PI*2, r = (i/n)**0.5 * Math.min(W,H)*0.42;
        const jitter = noise.checked ? (rng()-0.5)*6 : 0;
        const x=W/2 + (r+jitter)*Math.cos(a+phi*0.0008*speed());
        const y=H/2 + (r+jitter)*Math.sin(a+phi*0.0011*speed());
        ctx.fillStyle=pal(i/n); ctx.fillRect(x,y,st,st);
        if(sym.checked) ctx.fillRect(W-x,y,st,st);
      }
      phi += 1.1*speed();
    }

    const modes=[
      drawFlow, drawLattice, drawTorus, drawPoly, drawRose, drawSpiro, drawLissaGrid, drawVortex,
      drawOrbitals, drawPhiWeave, drawAurora, drawChladni, drawGyre, drawBloomfield
    ];

    // Animation / rendering
    let anim=!PREFERS_RM, frameId=0;
    function drawOnce(){ const fn = modes[mode] || modes[0]; fn(); }
    function render(){
      if(!ctx) return;
      const fn = modes[mode] || modes[0];
      fn();
      if(anim) frameId=requestAnimationFrame(render);
    }
    function seedTrace(frames=40){
      const fn = modes[mode] || modes[0];
      for(let k=0;k<frames;k++){ fn(); }
    }

    // UI wiring + instant repaint when not animating
    function repaint(){ if(anim) return; drawOnce(); }

    on($("#visMode"),"change",()=>{ mode=+visMode.value|0; if(!Number.isFinite(mode)||mode<0||mode>=modes.length) mode=0; repaint(); });
    ["input","change"].forEach(evt=>{
      on($("#visDensity"),evt,repaint);
      on($("#visSpeed"),evt,repaint);
      on($("#visFade"),evt,repaint);
      on($("#stroke"),evt,repaint);
      on($("#palette"),evt,repaint);
      on($("#sym"),evt,repaint);
      on($("#noise"),evt,repaint);
      on($("#orbitals"),evt,repaint);
      on($("#cMix"),evt,repaint);
      on($("#cPhase"),evt,repaint);
      on($("#vBias"),evt,repaint);
    });

    on($("#clearBtn"),"click",()=>{ if(ctx){ ctx.clearRect(0,0,canvas.width,canvas.height); repaint(); } });
    on($("#seedBtn"),"click",()=>{ seed = (Math.random()*1000)|0; toast("Seeded"); repaint(); });
    on($("#newSeed"),"click",()=>{ if(!$("#lockSeed").checked){ seed = (Math.random()*10000)|0; toast("New seed"); repaint(); }});
    on($("#dlTrace"),"click",()=>downloadPNG(false));
    on($("#dlTraceMeta"),"click",()=>downloadPNG(true));

    function dataURLToBlob(dataURL){
      const parts = dataURL.split(','), mime = parts[0].match(/:(.*?);/)[1], bstr = atob(parts[1]); let n=bstr.length; const u8=new Uint8Array(n);
      while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8],{type:mime});
    }
    async function downloadPNG(withMeta){
      try{
        const url=canvas.toDataURL("image/png");
        const meta = {
          when: new Date().toISOString(),
          mode: visMode.options[visMode.selectedIndex].text,
          modeId: mode,
          seed, carrier: carrier==="none"?"":carrier,
          palette: $("#palette").value,
          Xi: ($("#hudXi").textContent||"").replace(/.*?([\d.]+)$/,"$1"),
          I: ($("#rmnLine").value||"").trim()
        };
        const a=document.createElement("a");
        a.href=url;
        a.download = withMeta ? `remnant-${meta.modeId}-${seed}-${(meta.I||"line").slice(0,24).replace(/\W+/g,'_')}.png` : `remnant-trace.png`;
        a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
        if(withMeta){ console.log("Remnant meta", meta); }
      }catch(_){ toast("Download failed"); }
    }

    // Start up (respect reduced motion)
    if(anim){ render(); } else { drawOnce(); }

    // Presets
    const PRESET_KEY="sof_remnant_preset_v1";
    function savePreset(){
      const P = {
        mode:+visMode.value, density:+visDensity.value, speed:+visSpeed.value, fade:+visFade.value,
        sym:sym.checked, noise:noise.checked, stroke:+stroke.value, palette:$("#palette").value,
        orbitals:+orbitals.value, cMix:+cMix.value, cPhase:+cPhase.value, vBias:+vBias.value
      };
      localStorage.setItem(PRESET_KEY, JSON.stringify(P)); toast("Preset saved");
    }
    function loadPreset(){
      try{
        const P=JSON.parse(localStorage.getItem(PRESET_KEY)||"{}"); if(!P||!("mode" in P)) return toast("No preset");
        visMode.value=P.mode; visDensity.value=P.density; visSpeed.value=P.speed; visFade.value=P.fade;
        sym.checked=P.sym; noise.checked=P.noise; stroke.value=P.stroke; $("#palette").value=P.palette;
        orbitals.value=P.orbitals; cMix.value=P.cMix; cPhase.value=P.cPhase; vBias.value=P.vBias;
        mode=P.mode; if(!Number.isFinite(mode)||mode<0||mode>=modes.length) mode=0;
        toast("Preset loaded"); repaint();
      }catch{ toast("Load failed"); }
    }
    on($("#savePreset"),"click",savePreset);
    on($("#loadPreset"),"click",loadPreset);

    // Auto-Pilot: runs 𝓘→𝓛→𝓒→𝓢 (12s each ×4)
    on($("#autoRun"),"click",()=>{
      const line=($("#rmnLine").value||"").trim(); if(!line) return toast("Write an intention line");
      seedTrace(35);
      if(carrier!=="none") playCarrier(+carrier,0.8,0.07);
      let phase=0;
      const t0=Date.now();
      const iv=setInterval(()=>{
        phase=(phase+1)%4;
        $("#hudBreath").textContent="Breath: " + (["In","—","Out","—"][phase]);
        if(phase===0){ visMode.value="4"; mode=4; }
        if(phase===1){ visMode.value="1"; mode=1; }
        if(phase===2){ visMode.value="0"; mode=0; }
        if(phase===3){ visMode.value="7"; mode=7; }
        if(!anim) drawOnce();
        if(Date.now()-t0>48000){ clearInterval(iv); $("#hudBreath").textContent="Breath: —"; toast("Auto-Pilot done"); }
      }, 12000);
    });

    // Expose switchTo for later tabs (Ethics/Deck hooks)
    window.switchTo = switchTo;

  })();
  </script>
<!-- ================= END PART 1/3 ================= -->

    <!-- ================= START PART 2/3 ================= -->

    <!-- =================== OBSERVER =================== -->
    <section id="tab-observer" class="tab" role="tabpanel" aria-labelledby="observer-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>⏱ Observer — Paced 4-Phase Loop</h2>

          <ol class="list">
            <li><b>𝓘 Intend:</b> speak your 𝓘 once on tone.</li>
            <li><b>𝓛 Look:</b> find one undeniable detail in perception.</li>
            <li><b>𝓒 Coalesce:</b> soften jaw/shoulders; allow the exhale to quiet.</li>
            <li><b>𝓢 Seal:</b> whisper “thank you”, rest a beat, no grasping.</li>
          </ol>

          <div class="lab-row">
            <div style="width:140px;height:140px;display:grid;place-items:center">
              <svg viewBox="0 0 100 100" aria-label="Observer ring">
                <defs>
                  <linearGradient id="gradRing" x1="0" x2="1">
                    <stop offset="0" stop-color="#7af3ff"/>
                    <stop offset="1" stop-color="#f3c97a"/>
                  </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" class="ring-bg"/>
                <circle cx="50" cy="50" r="45" class="ring-fg" id="obsArc" pathLength="283"/>
                <text x="50" y="48" text-anchor="middle" class="ring-num" id="obsPhase">Ready</text>
                <text x="50" y="64" text-anchor="middle" class="ring-sub" id="obsCount">—</text>
              </svg>
            </div>

            <div style="flex:1">
              <div class="lab-row">
                <button id="obsStart" class="lab-btn primary" type="button">Start</button>
                <button id="obsStop" class="lab-btn" disabled type="button">Stop</button>
                <button id="obsMark" class="lab-btn" type="button">Mark detail</button>
              </div>

              <div class="lab-row">
                <label>Seconds/phase
                  <input id="obsSec" type="number" value="10" min="3" max="300" class="lab-input" style="width:110px">
                </label>
                <label>Rounds
                  <input id="obsRounds" type="number" value="3" min="1" max="60" class="lab-input" style="width:90px">
                </label>
                <label><input id="obsTone" type="checkbox"> Click at phase change</label>
              </div>

              <textarea id="obsNotes" rows="3" class="lab-input" placeholder="Witness note (undeniable detail)…"></textarea>
              <div class="lab-row">
                <button id="obsToLedger" class="lab-btn" type="button">Send to Ledger</button>
              </div>

              <p class="hint" id="coachObs">Coach: inhale on 𝓘, see on 𝓛, soften on 𝓒, exhale/thank on 𝓢.</p>
            </div>
          </div>
        </div>

        <aside class="card col-5">
          <h3>Carrier now</h3>
          <p id="toneNow" class="meta">Πν: none</p>
          <div class="divider"></div>
          <h3>Modes that pair well</h3>
          <p class="meta">𝓘→ Rose · 𝓛→ Lattice · 𝓒→ Flow · 𝓢→ Vortex</p>
          <p class="meta">If clarity drops (Eq.9), stop and re-center.</p>
        </aside>
      </article>
    </section>

    <!-- ===================== CARRIER ===================== -->
    <section id="tab-voice" class="tab" role="tabpanel" aria-labelledby="voice-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🎙 Carrier — Tone, Wave, Spectrum</h2>

          <div class="lab-row">
            <button id="micOn" class="lab-btn" type="button">Enable Mic</button>
            <button id="micOff" class="lab-btn" disabled type="button">Stop</button>
            <span id="freqRead" class="meta" aria-live="polite">—</span>
            <button id="useTone" class="lab-btn" disabled type="button">Use this tone</button>
          </div>

          <canvas id="wave" width="880" height="140" aria-label="Waveform"></canvas>
          <canvas id="fft"  width="880" height="140" aria-label="Spectrum"></canvas>

          <p class="hint">Tip: hum ~3s; when the dominant peak holds steady, “Use this tone.” Check “Binaural ±4 Hz” in Remnant if desired.</p>
        </div>

        <aside class="card col-5">
          <h3>Presets</h3>
          <div class="lab-row">
            <button class="lab-btn tone" data-carrier="432" type="button">432</button>
            <button class="lab-btn tone" data-carrier="528" type="button">528</button>
            <button class="lab-btn tone" data-carrier="369" type="button">369</button>
            <button class="lab-btn tone" data-carrier="144" type="button">144</button>
            <button class="lab-btn tone" data-carrier="963" type="button">963</button>
            <button class="lab-btn tone" data-carrier="none" type="button">None</button>
          </div>
          <p class="meta">Mic stays local in your browser (no upload).</p>
        </aside>
      </article>
    </section>

    <!-- ====================== PHRASE ====================== -->
    <section id="tab-phrase" class="tab" role="tabpanel" aria-labelledby="phrase-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🔡 Phrase — Tune Meaning (Eq.4 / 4b)</h2>

          <textarea id="phraseIn" rows="3" class="lab-input" placeholder="Type your line…"></textarea>

          <div class="lab-row">
            <button id="phraseTune" class="lab-btn" type="button">Tune</button>
            <button id="phraseClear" class="lab-btn" type="button">Clear</button>
            <button id="phraseToI" class="lab-btn" type="button">Use as 𝓘</button>
          </div>

          <p><b>Suggestion:</b> <span id="phraseOut" class="meta">—</span></p>

          <details class="card" style="margin-top:8px">
            <summary><strong>Heuristics</strong></summary>
            <ul class="list">
              <li>Prefer present-tense, affirmative verbs.</li>
              <li>Constrain nouns to concrete, observable elements.</li>
              <li>Delete hedges (try, maybe, hopefully, sort of).</li>
              <li>Replace negations with direct aims.</li>
            </ul>
          </details>

          <p class="hint" id="coachPhrase">Coach: fewer negations → cleaner gradient; strong verbs + concrete nouns.</p>
        </div>

        <aside class="card col-5">
          <h3>Micro-templates</h3>
          <p>I speak simply and act kindly.</p>
          <p>We finish one helpful thing today.</p>
          <p>Light reveals; love restores.</p>
        </aside>
      </article>
    </section>

    <!-- ======================= BREATH ======================= -->
    <section id="tab-breath" class="tab" role="tabpanel" aria-labelledby="breath-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🌬 Breath — Pacing Ring</h2>

          <div class="lab-row">
            <label>Pattern
              <select id="breathPat" class="lab-input" style="width:auto">
                <option value="4-4-4-4">Box 4-4-4-4</option>
                <option value="4-7-8">4-7-8</option>
                <option value="5-5-5-5">5-5-5-5</option>
                <option value="6-0-6-0">6-0-6-0 (smooth)</option>
              </select>
            </label>
            <button id="breathStart" class="lab-btn" type="button">Start</button>
            <button id="breathStop" class="lab-btn" disabled type="button">Stop</button>
          </div>

          <div style="width:140px;height:140px;display:grid;place-items:center;margin-top:6px">
            <svg viewBox="0 0 100 100" aria-label="Breath ring">
              <circle cx="50" cy="50" r="45" class="ring-bg"/>
              <circle cx="50" cy="50" r="45" class="ring-fg" id="breathArc" pathLength="283"/>
              <text x="50" y="56" text-anchor="middle" class="ring-num" id="breathPhase">Ready</text>
            </svg>
          </div>

          <p class="hint">Longer, quieter exhales tend to smooth the field. If dizzy, stop and switch to gentle nose-breathing.</p>
        </div>

        <aside class="card col-5">
          <h3>Use with Observer</h3>
          <p>Inhale — 𝓘 · See — 𝓛 · Soften — 𝓒 · Exhale/Seal — 𝓢</p>
          <p class="meta">You can keep the carrier humming quietly during longer cycles.</p>
        </aside>
      </article>
    </section>

    <!-- ===================== COHERENCE ===================== -->
    <section id="tab-coherence" class="tab" role="tabpanel" aria-labelledby="coherence-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>📈 Coherence (Ξ) — Quick Estimate</h2>

          <div class="lab-row">
            <label>⟨H·I⟩ <input id="hi" type="number" min="0" max="1" step="0.01" value="0.62" class="lab-input" style="width:110px"></label>
            <label>Var[𝓜] <input id="varM" type="number" min="0" max="2" step="0.01" value="0.30" class="lab-input" style="width:110px"></label>
            <button id="xiCalc" class="lab-btn" type="button">Compute Ξ</button>
            <output id="xiOut" class="meta" aria-live="polite">Ξ = —</output>
          </div>

          <canvas id="xiSpark" width="520" height="72" aria-label="Ξ history"></canvas>

          <details class="card" style="margin-top:8px">
            <summary><strong>Notes</strong></summary>
            <ul class="list">
              <li>⟨H·I⟩ is a proxy for how aligned your Habit × Intention are (0..1).</li>
              <li>Var[𝓜] is a proxy for mental variance (lower is steadier).</li>
              <li>We use Ξ ≈ ⟨H·I⟩ / (1 + Var[𝓜]) clamped to [0..1] for practical tracking.</li>
            </ul>
          </details>
        </div>

        <aside class="card col-5">
          <h3>Stop Rule (Eq.9)</h3>
          <p>If clarity falls or tension rises, <b>halt</b>. Re-center (carriers/breath/phrase), then resume.</p>
          <p class="meta">Your Ξ samples are stored locally and render as a sparkline.</p>
        </aside>
      </article>
    </section>
<!-- ================= CONTENT END OF PART 2/3; ENGINE CONTINUES BELOW ================= -->

  <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);
    function toast(msg){
      const el=document.createElement("div"); el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }

    /* ===================== OBSERVER ENGINE ===================== */
    const obsArc=$("#obsArc"), obsPhase=$("#obsPhase"), obsCount=$("#obsCount");
    const obsStart=$("#obsStart"), obsStop=$("#obsStop"), obsMark=$("#obsMark");
    const obsSec=$("#obsSec"), obsRounds=$("#obsRounds"), obsNotes=$("#obsNotes");
    let obsTimer=null, obsIdx=0, obsRound=0, obsRem=0, obsPhases=["𝓘","𝓛","𝓒","𝓢"], obsTotal=0, obsTick=0;

    function beep(vol=0.01, freq=880, len=0.08){
      try{
        const AC = window.AudioContext? new AudioContext(): null; if(!AC) return;
        const o=AC.createOscillator(), g=AC.createGain();
        o.type="square"; o.frequency.value=freq; g.gain.value=0.0001; o.connect(g).connect(AC.destination);
        const t=AC.currentTime; o.start(t); g.gain.linearRampToValueAtTime(vol,t+0.005); g.gain.linearRampToValueAtTime(0.0001,t+len); o.stop(t+len+0.02);
        setTimeout(()=>AC.close(), 200);
      }catch(_){}
    }
    function obsReset(){
      obsArc?.setAttribute("stroke-dasharray","0 283");
      if(obsPhase) obsPhase.textContent="Ready";
      if(obsCount) obsCount.textContent="—";
      obsIdx=0; obsRound=0; obsRem=0; obsTick=0;
      $("#hudBreath") && ($("#hudBreath").textContent="Breath: —");
    }
    function obsRun(){
      const p=Math.max(3,Math.min(300,+obsSec.value||10));
      const r=Math.max(1,Math.min(60,+obsRounds.value||3));
      obsTotal = p*4*r; obsIdx=0; obsRound=1; obsRem=p; obsTick=0;
      if(obsPhase) obsPhase.textContent=obsPhases[0];
      if(obsCount) obsCount.textContent=`Round 1/${r}`;
      obsStart.disabled=true; obsStop.disabled=false;

      if($("#obsTone")?.checked) beep(0.02,660,0.1);

      obsTimer=setInterval(()=>{
        obsTick++; obsRem--;
        const frac=obsTick/obsTotal, dash=283*frac; obsArc?.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        const breathMap=["In","—","Out","—"]; const b=breathMap[obsIdx]; $("#hudBreath") && ($("#hudBreath").textContent="Breath: "+b);

        if(obsRem<=0){
          obsIdx++;
          if($("#obsTone")?.checked) beep(0.02, 660 + (obsIdx===0?0:obsIdx*40), 0.09);
          if(obsIdx>=4){ obsIdx=0; obsRound++;
            if(obsRound>r){
              clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true;
              if(obsPhase) obsPhase.textContent="Done";
              if(obsCount) obsCount.textContent=`${r}/${r}`;
              $("#hudBreath") && ($("#hudBreath").textContent="Breath: —");
              return;
            }
            if(obsCount) obsCount.textContent=`Round ${obsRound}/${r}`;
          }
          obsRem=p; if(obsPhase) obsPhase.textContent=obsPhases[obsIdx];
        }
      },1000);
    }
    on(obsStart,"click",obsRun);
    on(obsStop,"click",()=>{ clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true; obsReset(); });
    on(obsMark,"click",()=>{
      const prev = obsNotes.value.trim();
      const stamp = new Date().toLocaleTimeString();
      obsNotes.value = (prev? prev+"\n":"") + `[${stamp}] One undeniable detail observed.`;
    });
    on($("#obsToLedger"),"click",()=>{
      const phrase=($("#rmnLine")?.value||$("#lgLine")?.value||"").trim();
      const note=(obsNotes?.value||"").trim();
      if(!phrase){ toast("Write 𝓘 first"); return; }
      const entry={
        when:new Date().toISOString(),
        carrier:($("#hudCarrier")?.textContent||"").replace(/^Πν:\s*/,""),
        phrase, coherence:($("#xiOut")?.textContent||"").replace(/.*?([\d.]+)$/,"$1"),
        tags:["observer"], note
      };
      try{
        const data=JSON.parse(localStorage.getItem("sof_ledger_entries_v5")||"[]");
        data.unshift(entry); localStorage.setItem("sof_ledger_entries_v5", JSON.stringify(data));
        toast("Observer note → Ledger");
        if(window.switchTo) window.switchTo("ledger");
      }catch(_){ toast("Couldn’t write ledger"); }
    });

    /* ====================== CARRIER ENGINE ====================== */
    let micStream=null, analyser=null, wave=$("#wave"), fft=$("#fft");
    on($("#micOn"),"click", async ()=>{
      try{
        const AC = new (window.AudioContext||window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({
          audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}, video:false
        });
        micStream=stream;
        const src = AC.createMediaStreamSource(stream);
        analyser = AC.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
        src.connect(analyser);
        $("#micOff").disabled=false; $("#useTone").disabled=false;
        drawAudio(AC);
        toast("Mic on");
      }catch(err){ toast("Mic failed"); }
    });
    on($("#micOff"),"click",()=>{
      try{ micStream?.getTracks().forEach(t=>t.stop()); }catch(_){}
      analyser=null; $("#micOff").disabled=true; $("#useTone").disabled=true; toast("Mic off");
    });
    on($("#useTone"),"click",()=>{
      const fr = $("#freqRead")?.textContent.match(/~(\d+)\s*Hz/);
      const f = fr? +fr[1] : 432;
      // mirror to Remnant’s carrier buttons by setting text and pinging a tone button if present
      const btn = Array.from(document.querySelectorAll(".lab-btn.tone")).find(b=>b.dataset.carrier===String(f));
      if(btn) btn.click(); // plays via Part 1 engine
      $("#toneNow") && ($("#toneNow").textContent="Πν: "+f);
      toast("Carrier set to "+f+" Hz");
    });
    function drawAudio(AC){
      const wctx=wave.getContext("2d"), fctx=fft.getContext("2d");
      const wf=new Uint8Array(analyser.fftSize), ff=new Uint8Array(analyser.frequencyBinCount);
      (function loop(){
        if(!analyser) return;
        analyser.getByteTimeDomainData(wf); analyser.getByteFrequencyData(ff);
        const W=wave.width,H=wave.height; wctx.clearRect(0,0,W,H);
        wctx.fillStyle="#0b1016"; wctx.fillRect(0,0,W,H); wctx.beginPath(); wctx.moveTo(0,H/2);
        for(let x=0;x<W;x++){ const i=Math.floor(x/W*wf.length); const v=(wf[i]-128)/128; wctx.lineTo(x,H/2+v*H*0.4); }
        wctx.strokeStyle="#7af3ff"; wctx.lineWidth=2; wctx.stroke();
        const WF=fft.width, HF=fft.height; fctx.clearRect(0,0,WF,HF);
        let maxi=0,maxv=0; for(let i=4;i<ff.length;i++){ if(ff[i]>maxv){ maxv=ff[i]; maxi=i; } }
        const freq = maxi * (AC.sampleRate / analyser.fftSize);
        for(let i=0;i<ff.length;i++){
          const v=ff[i]/255; const x=i/ff.length*WF; const y=HF*(1-v);
          fctx.fillStyle=v>.8?"#f3c97a":v>.5?"#a7f6ff":"#6aa0ff33"; fctx.fillRect(x,y,WF/ff.length,HF-y);
        }
        $("#freqRead") && ($("#freqRead").textContent = isFinite(freq) ? `~${Math.round(freq)} Hz (peak)` : "—");
        requestAnimationFrame(loop);
      })();
    }

    /* ======================== PHRASE ======================== */
    on($("#phraseTune"),"click",()=>{
      const s = ($("#phraseIn")?.value||"").trim();
      if(!s) return toast("Type a line first");
      const simpler = s
        .replace(/\b(don't|do not|can't|cannot|won't|will not)\b/gi,"")
        .replace(/\b(try|maybe|sort of|kinda|hopefully|attempt to)\b/gi,"")
        .replace(/\s{2,}/g," ")
        .trim();
      $("#phraseOut").textContent = simpler || s;
    });
    on($("#phraseClear"),"click",()=>{ if($("#phraseIn")) $("#phraseIn").value=""; if($("#phraseOut")) $("#phraseOut").textContent="—"; });
    on($("#phraseToI"),"click",()=>{
      const t=$("#phraseOut")?.textContent?.trim()||$("#phraseIn")?.value?.trim();
      if(!t) return toast("Nothing tuned yet");
      $("#rmnLine") && ($("#rmnLine").value=t);
      $("#lgLine") && ($("#lgLine").value=t);
      toast("Phrase → 𝓘");
    });

    /* ========================= BREATH ========================= */
    const breathArc=$("#breathArc"), breathPhaseEl=$("#breathPhase");
    let bTimer=null, bT0=0, bPat=[4,4,4,4];
    on($("#breathPat"),"change",e=>{ bPat=e.target.value.split("-").map(n=>+n||0); });
    on($("#breathStart"),"click",()=>{
      if(bTimer) return;
      bT0=performance.now(); $("#breathStop").disabled=false; $("#breathStart").disabled=true;
      const total=bPat.reduce((a,b)=>a+b,0)*1000 || 1;
      bTimer=setInterval(()=>{
        const t=(performance.now()-bT0)%total;
        let acc=0, idx=0;
        for(let i=0;i<4;i++){ acc+=bPat[i]*1000; if(t<acc){ idx=i; break; } }
        const prev=acc-bPat[idx]*1000;
        const dash=283*((prev+(t-prev))/total); breathArc?.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        const ph=["In","Hold","Out","Hold"][idx]; if(breathPhaseEl) breathPhaseEl.textContent=ph;
        $("#hudBreath") && ($("#hudBreath").textContent="Breath: "+ph);
      },1000/30);
    });
    on($("#breathStop"),"click",()=>{
      clearInterval(bTimer); bTimer=null; $("#breathStart").disabled=false; $("#breathStop").disabled=true;
      if(breathPhaseEl) breathPhaseEl.textContent="Ready"; $("#hudBreath") && ($("#hudBreath").textContent="Breath: —");
    });

    /* ======================== COHERENCE ======================== */
    const xiOut=$("#xiOut"), xiSparkCtx=$("#xiSpark")?.getContext("2d"); let xiHist=load("sof_xi_hist_v1",[]);
    function load(k,fb){ try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): fb; }catch(_){return fb;} }
    function save(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch(_){} }

    function drawXi(){
      if(!xiSparkCtx) return;
      const W=xiSparkCtx.canvas.width, H=xiSparkCtx.canvas.height;
      xiSparkCtx.clearRect(0,0,W,H);
      xiSparkCtx.strokeStyle="rgba(122,243,255,.25)";
      xiSparkCtx.beginPath();
      xiSparkCtx.moveTo(0,H*0.25); xiSparkCtx.lineTo(W,H*0.25);
      xiSparkCtx.moveTo(0,H*0.5); xiSparkCtx.lineTo(W,H*0.5);
      xiSparkCtx.moveTo(0,H*0.75); xiSparkCtx.lineTo(W,H*0.75);
      xiSparkCtx.stroke();
      if(!xiHist.length) return;
      const n=xiHist.length, xs=W/(n-1);
      xiSparkCtx.beginPath();
      for(let i=0;i<n;i++){
        const y=H*(1-(xiHist[i].x*0.9+0.05)); const x=W-i*xs;
        (i?xiSparkCtx.lineTo(x,y):xiSparkCtx.moveTo(x,y));
      }
      xiSparkCtx.strokeStyle="rgba(243,201,122,.9)"; xiSparkCtx.lineWidth=2; xiSparkCtx.stroke();
    }
    drawXi();

    on($("#xiCalc"),"click",()=>{
      const hi=Math.max(0,Math.min(1,+($("#hi")?.value||0)));
      const v =Math.max(0,Math.min(2,+($("#varM")?.value||0.0001)));
      const Xi = Math.max(0, Math.min(1, hi/(1+v)));
      if(xiOut) xiOut.textContent = "Ξ = " + Xi.toFixed(2);
      $("#hudXi") && ($("#hudXi").textContent ="Ξ: " + Xi.toFixed(2));
      xiHist.unshift({t:Date.now(), x:Xi}); xiHist=xiHist.slice(0,80); save("sof_xi_hist_v1",xiHist); drawXi();
    });

  })();
  </script>

<!-- ================= END PART 2/3 ================= -->

    <!-- ================= START PART 3/3 ================= -->

    <!-- ======================== TIMER ======================== -->
    <section id="tab-timer" class="tab" role="tabpanel" aria-labelledby="timer-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>⏳ Focus Timer — 25/5 cycles</h2>

          <div class="lab-row">
            <label>Focus (min)
              <input id="tmFocus" type="number" value="25" min="5" max="120" class="lab-input" style="width:100px">
            </label>
            <label>Break (min)
              <input id="tmBreak" type="number" value="5" min="3" max="60" class="lab-input" style="width:100px">
            </label>
            <label>Cycles
              <input id="tmCycles" type="number" value="2" min="1" max="16" class="lab-input" style="width:90px">
            </label>
          </div>

          <div class="lab-row">
            <button id="tmStart" class="lab-btn primary" type="button">Start</button>
            <button id="tmStop" class="lab-btn" disabled type="button">Stop</button>
            <output id="tmOut" class="meta">—</output>
          </div>

          <p class="hint">Tip: check “Keep carrier on” in Remnant to let Π<sub>ν</sub> hum during Focus blocks.</p>
        </div>

        <aside class="card col-5">
          <h3>Streak</h3>
          <p class="meta">Daily check-in:
            <button id="streakMark" class="lab-btn" type="button">Mark Today</button>
            <span id="streakOut" class="meta">—</span>
          </p>
          <p class="hint">Streaks are local to this device.</p>
        </aside>
      </article>
    </section>

    <!-- ========================= DECK ========================= -->
    <section id="tab-deck" class="tab" role="tabpanel" aria-labelledby="deck-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🎴 Intention Deck</h2>
          <div class="lab-row">
            <button id="drawCard" class="lab-btn primary" type="button">Draw</button>
            <span id="cardText" class="meta">—</span>
            <button id="useCard" class="lab-btn" type="button">Use as 𝓘</button>
          </div>

          <details class="card" style="margin-top:8px">
            <summary><strong>About</strong></summary>
            <p class="meta">Draw → Prime → Focus → Seal → Ledger. Use Deck to get moving when 𝓘 won’t come.</p>
          </details>
        </div>

        <aside class="card col-5">
          <h3>Exercise Picker</h3>
          <div class="lab-row">
            <button class="lab-btn" data-ex="prime60" type="button">Prime 60</button>
            <button class="lab-btn" data-ex="focus15" type="button">Focus 15</button>
            <button class="lab-btn" data-ex="seal60" type="button">Seal 60</button>
          </div>
          <p class="hint">You can customize the deck in code (CARDS array).</p>
        </aside>
      </article>
    </section>

    <!-- ========================= LEDGER ========================= -->
    <section id="tab-ledger" class="tab" role="tabpanel" aria-labelledby="ledger-tab">
      <article class="grid">
        <div class="card col-12">
          <h2>📒 Witness Ledger <small class="meta">(private on this device)</small></h2>

          <div class="lab-row">
            <input id="lgLine" class="lab-input" placeholder="Intention (𝓘)…">
            <input id="lgCarrier" class="lab-input" placeholder="Carrier (432/528/369/144/963)">
            <select id="lgQ" class="lab-input" style="width:auto">
              <option value="">Ξ quality…</option><option>Low</option><option>Medium</option><option>High</option>
            </select>
            <input id="lgTags" class="lab-input" placeholder="tags (comma)">
          </div>

          <textarea id="lgWit" rows="3" class="lab-input" placeholder="Witness (what changed, what lingered)…"></textarea>

          <div class="lab-row">
            <button id="lgAdd" class="lab-btn primary" type="button">Add</button>
            <button id="lgExport" class="lab-btn" type="button">Export .json</button>
            <input type="file" id="lgImportFile" accept="application/json" hidden>
            <button id="lgImport" class="lab-btn" type="button">Import .json</button>
            <input id="lgFilter" class="lab-input" placeholder="Filter…" style="margin-left:auto;max-width:240px">
          </div>

          <div class="table-wrap" style="margin-top:8px">
            <table id="lgTable">
              <thead><tr><th>Date</th><th>Intention</th><th>Carrier</th><th>Ξ</th><th>Tags</th><th>Witness</th><th>Remnant</th><th></th></tr></thead>
              <tbody id="lgRows"></tbody>
            </table>
          </div>
        </div>
      </article>
    </section>

    <!-- ========================= ETHICS ========================= -->
    <section id="tab-ethics" class="tab" role="tabpanel" aria-labelledby="ethics-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🛡 Ethics — Eq.9 Safety Mask</h2>

          <p class="meta">The mask is a triage. If any “Red” triggers, <b>halt</b>, re-center, and only continue after resolving the cause.</p>

          <div class="grid">
            <div class="card col-12">
              <h3>Self-check (choose one)</h3>
              <div class="lab-row">
                <label><input type="radio" name="eth" value="green" checked> Green — clear, kind, consent in place</label>
                <label><input type="radio" name="eth" value="yellow"> Yellow — unclear, pressured, tired</label>
                <label><input type="radio" name="eth" value="red"> Red — harm, deception, compulsion</label>
              </div>
              <p id="ethCoach" class="hint">Green: proceed with normal cycles.</p>
            </div>

            <div class="card col-12">
              <h3>Stop rules</h3>
              <ul class="list">
                <li>Clarity falling, tension rising, breath becoming shallow → stop.</li>
                <li>Any move that reduces another’s dignity or consent → stop.</li>
                <li>Grandiosity, magical guarantees, or compulsive checking → stop.</li>
              </ul>
              <p class="meta">Return to breath (4-7-8 or 6-0-6-0), pick “None” or 432 Hz, shorten 𝓘.</p>
            </div>
          </div>
        </div>

        <aside class="card col-5">
          <h3>Mask to Ledger</h3>
          <p class="meta">You can mark the mask state alongside a Ledger entry.</p>
          <div class="lab-row">
            <button id="ethMark" class="lab-btn" type="button">Append mask → Ledger note</button>
          </div>
          <p class="hint">This stays on your device only.</p>
        </aside>
      </article>
    </section>

    <!-- ========================== MAPS ========================== -->
    <section id="tab-maps" class="tab" role="tabpanel" aria-labelledby="maps-tab">
      <article class="grid">
        <div class="card col-7">
          <h2>🧠 Maps — Bias Interrupt, Anchors, Memory Grid</h2>

          <details class="card">
            <summary><strong>Bias Interrupt</strong> (3-step)</summary>
            <ol class="list">
              <li>Name the pull (e.g., catastrophizing, mind-reading, confirmation bias).</li>
              <li>Counter with a neutral micro-fact in reach (something observable).</li>
              <li>Return to the one-line 𝓘; continue on breath.</li>
            </ol>
            <div class="lab-row">
              <input id="biasName" class="lab-input" placeholder="Bias label…">
              <input id="biasFact" class="lab-input" placeholder="Neutral micro-fact…">
              <button id="biasStamp" class="lab-btn" type="button">Stamp to Ledger</button>
            </div>
          </details>

          <details class="card">
            <summary><strong>Anchor Matrix</strong> (Senses × Phrases)</summary>
            <div class="grid">
              <textarea id="anchSee"  class="lab-input col-6" rows="2" placeholder="SEE anchor (e.g., a specific doorway or tree)"></textarea>
              <textarea id="anchHear" class="lab-input col-6" rows="2" placeholder="HEAR anchor (e.g., fan hum, birds)"></textarea>
              <textarea id="anchFeel" class="lab-input col-6" rows="2" placeholder="FEEL anchor (e.g., ring on finger)"></textarea>
              <textarea id="anchSay"  class="lab-input col-6" rows="2" placeholder="SAY anchor (e.g., ‘Here we are. One thing.’)"></textarea>
            </div>
            <div class="lab-row" style="margin-top:6px">
              <button id="anchorSave" class="lab-btn" type="button">Save Anchors</button>
              <button id="anchorLoad" class="lab-btn" type="button">Load</button>
            </div>
          </details>

          <details class="card">
            <summary><strong>Memory Grid</strong> (3×3 palace)</summary>
            <div class="grid">
              <textarea class="lab-input col-4" rows="2" id="m00" placeholder="0,0"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m01" placeholder="0,1"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m02" placeholder="0,2"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m10" placeholder="1,0"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m11" placeholder="1,1"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m12" placeholder="1,2"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m20" placeholder="2,0"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m21" placeholder="2,1"></textarea>
              <textarea class="lab-input col-4" rows="2" id="m22" placeholder="2,2"></textarea>
            </div>
            <div class="lab-row" style="margin-top:6px">
              <button id="memSave" class="lab-btn" type="button">Save Grid</button>
              <button id="memLoad" class="lab-btn" type="button">Load</button>
              <button id="memClear" class="lab-btn" type="button">Clear</button>
            </div>
          </details>
        </div>

        <aside class="card col-5">
          <h3>Use</h3>
          <ul class="list">
            <li>Interrupt → Anchor → 1-Line → Exhale.</li>
            <li>Place key 𝓘 nouns in the 3×3 and rehearse clockwise.</li>
            <li>Pair an anchor with a soft exhale: “let the exhale do the work”.</li>
          </ul>
        </aside>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="meta">© <span id="yr">2025</span> Aaron Paul Laird — Scroll of Fire • BY-NC 4.0</p>
    </footer>
  </main>

  <!-- ======================= GLOBAL ENGINE ======================= -->
  <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);

    function toast(msg){
      const el=document.createElement("div"); el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }
    function load(k,fb){ try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): fb; }catch(_){return fb;} }
    function save(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch(_){} }

    /* ======================== TIMER ENGINE ======================== */
    const tmStart=$("#tmStart"), tmStop=$("#tmStop"), tmOut=$("#tmOut");
    let tmInt=null, tmPhase="idle", tmEnd=0, tmCycle=0, tmPlan=0, tmF=25, tmB=5;

    function tmTick(){
      const rem=tmEnd-Date.now();
      if(rem<=0){
        if(tmPhase==="focus"){
          tmPhase="break"; tmEnd=Date.now()+tmB*60*1000; toast("Break");
        }else if(tmPhase==="break"){
          tmCycle++;
          if(tmCycle>=tmPlan){ tmStop.click(); toast("Done"); return; }
          tmPhase="focus"; tmEnd=Date.now()+tmF*60*1000; toast("Focus");
        }
      }
      const s=Math.max(0,Math.ceil((tmEnd-Date.now())/1000));
      tmOut.value = `${tmPhase} — ${Math.floor(s/60)}:${String(s%60).padStart(2,"0")} · ${tmCycle+1}/${tmPlan}`;
    }
    on(tmStart,"click",()=>{
      tmF=Math.max(5,Math.min(120,+($("#tmFocus")?.value||25)));
      tmB=Math.max(3,Math.min(60,+($("#tmBreak")?.value||5)));
      tmPlan=Math.max(1,Math.min(16,+($("#tmCycles")?.value||2)));
      tmCycle=0; tmPhase="focus"; tmEnd=Date.now()+tmF*60*1000;
      tmStart.disabled=true; tmStop.disabled=false;
      tmInt=setInterval(tmTick, 500); toast("Focus");
    });
    on(tmStop,"click",()=>{ clearInterval(tmInt); tmInt=null; tmStart.disabled=false; tmStop.disabled=true; tmPhase="idle"; tmOut.value="—"; });

    // Streak
    const STREAK_KEY="sof_streak_v1";
    function daysSinceEpoch(date=new Date()){ return Math.floor(date.getTime()/86400000); }
    function readStreak(){ return load(STREAK_KEY,{last:-1,count:0}); }
    function writeStreak(v){ save(STREAK_KEY,v); }
    function showStreak(){ const s=readStreak(); $("#streakOut") && ($("#streakOut").textContent = `streak: ${s.count}`); }
    on($("#streakMark"),"click",()=>{
      const d=daysSinceEpoch(), s=readStreak();
      if(s.last===d) return toast("Already marked today");
      if(s.last===d-1) s.count++; else s.count=1;
      s.last=d; writeStreak(s); showStreak(); toast("Marked");
    });
    showStreak();

    /* ========================= DECK ENGINE ========================= */
    const CARDS=[
      "One helpful thing, done calmly.",
      "Speak simply. Act kindly.",
      "Small moves. True aim.",
      "Steady breath, steady hand.",
      "See one undeniable detail.",
      "Return to the line.",
      "Let the exhale do the work.",
      "Clarity before speed.",
      "Finish clean, thank gently.",
      "I place my attention where it helps.",
      "One page. One call. One commit.",
      "I keep the promise I can keep today."
    ];
    on($("#drawCard"),"click",()=>{
      const i=Math.floor(Math.random()*CARDS.length);
      $("#cardText") && ($("#cardText").textContent=CARDS[i]);
    });
    on($("#useCard"),"click",()=>{
      const t=$("#cardText")?.textContent?.trim(); if(!t) return;
      $("#rmnLine") && ($("#rmnLine").value=t);
      $("#lgLine") && ($("#lgLine").value=t);
      toast("Card → 𝓘");
    });
    $$("#tab-deck [data-ex]").forEach(b=>on(b,"click",()=>{
      const k=b.getAttribute("data-ex");
      if(k==="prime60") toast("Prime 60: 10 slow breaths; speak 𝓘 once per breath.");
      if(k==="focus15") { $("#tmFocus").value=15; $("#tmBreak").value=5; $("#tmCycles").value=1; $("#tmStart").click(); }
      if(k==="seal60") toast("Seal 60: name one undeniable change; whisper thanks; add to Ledger.");
    }));

    /* ======================== LEDGER ENGINE ======================== */
    const LGKEY="sof_ledger_entries_v5";
    function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function readLedger(){ return load(LGKEY,[]); }
    function writeLedger(arr){ save(LGKEY,arr); }

    // Lightbox
    const lb=document.createElement("div"); lb.className="lightbox"; lb.innerHTML='<img alt="Remnant">'; document.body.appendChild(lb);
    lb.addEventListener("click",()=>lb.classList.remove("open"));

    function renderLedger(){
      const rows=$("#lgRows"), q=($("#lgFilter")?.value||"").toLowerCase();
      const all=readLedger();
      const list = q ? all.filter(x=>JSON.stringify(x).toLowerCase().includes(q)) : all;
      if(!rows) return;
      rows.innerHTML = list.map((e,i)=>`<tr>
        <td>${new Date(e.when).toLocaleString()}</td>
        <td>${esc(e.phrase)}</td><td>${esc(e.carrier||"—")}</td><td>${esc(e.coherence||"—")}</td>
        <td>${esc((e.tags||[]).join(", "))}</td>
        <td>${esc(e.note||"")}</td>
        <td>${e._traceDataUri ? `<img src="${e._traceDataUri}" class="thumb" alt="Remnant" data-idx="${i}">` : "—"}</td>
        <td><button class="lab-btn" data-del="${i}">✕</button></td>
      </tr>`).join("");
      $$("#lgRows [data-del]").forEach(b=>on(b,"click",()=>{ const all=readLedger(); all.splice(+b.dataset.del,1); writeLedger(all); renderLedger(); }));
      $$("#lgRows img.thumb").forEach(img=>on(img,"click",()=>{
        const all=readLedger(); const i=+img.dataset.idx; const src=all[i]._traceDataUri; if(src){ lb.querySelector("img").src=src; lb.classList.add("open"); }
      }));
    }
    function addLedger(entry, png){
      const all=readLedger();
      if(png){ entry._traceDataUri = png; }
      all.unshift(entry); writeLedger(all); renderLedger();
      $("#lgLine") && ($("#lgLine").value = entry.phrase || $("#lgLine").value);
      $("#lgCarrier") && ($("#lgCarrier").value = entry.carrier || $("#lgCarrier").value);
      $("#lgWit") && ($("#lgWit").value = (entry.note||""));
    }
    on($("#lgAdd"),"click",()=>{
      const phrase=($("#lgLine")?.value||"").trim(); if(!phrase) return toast("Write an intention line");
      const entry={
        when:new Date().toISOString(),
        carrier:($("#lgCarrier")?.value||"").trim(),
        phrase,
        coherence:$("#lgQ")?.value||"",
        tags:($("#lgTags")?.value||"").split(",").map(s=>s.trim()).filter(Boolean),
        note:($("#lgWit")?.value||"").trim()
      };
      addLedger(entry);
      if($("#lgWit")) $("#lgWit").value="";
      toast("Added to Ledger");
    });
    on($("#lgExport"),"click",()=>{
      const blob=new Blob([JSON.stringify(readLedger(),null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="scroll-of-fire-ledger.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
    });
    on($("#lgImport"),"click",()=>$("#lgImportFile")?.click());
    on($("#lgImportFile"),"change",async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const txt=await f.text(); const data=JSON.parse(txt);
        if(Array.isArray(data)){ writeLedger(data.concat(readLedger())); renderLedger(); toast("Imported"); }
      }catch(_){ toast("Import failed"); }
      e.target.value="";
    });
    on($("#lgFilter"),"input",renderLedger);
    renderLedger();

    // Expose a small helper to capture the current Remnant as PNG into Ledger
    window._sealRemnantToLedger = function(){
      try{
        const canvas=document.getElementById("trace");
        const url=canvas.toDataURL("image/png");
        addLedger({
          when:new Date().toISOString(),
          carrier:($("#hudCarrier")?.textContent||"").replace(/^Πν:\s*/,""),
          phrase:($("#rmnLine")?.value||"").trim(),
          coherence:($("#xiOut")?.textContent||"").replace(/.*?([\d.]+)$/,"$1"),
          tags:["seal","remnant"],
          note: ""
        }, url);
        toast("Sealed to Ledger");
        if(window.switchTo) window.switchTo("ledger");
      }catch(_){ toast("Seal failed"); }
    };

    /* Hook up Remnant’s “Seal → Ledger” button from Part 1 if present */
    on($("#rmnSeal"),"click",()=>window._sealRemnantToLedger && window._sealRemnantToLedger());

    /* ======================== ETHICS ENGINE ======================== */
    const ETH_KEY="sof_eth_mask_state_v1";
    function currentMask(){
      const val = (document.querySelector('input[name="eth"]:checked')||{}).value||"green";
      return val;
    }
    function updateCoach(){
      const v=currentMask(), el=$("#ethCoach");
      if(!el) return;
      if(v==="green") el.textContent="Green: proceed with normal cycles.";
      if(v==="yellow") el.textContent="Yellow: shorten cycles, lighten aims, re-check breath.";
      if(v==="red") el.textContent="Red: halt. Switch to breath-only. Restore dignity/consent. Return later.";
      save(ETH_KEY,{v,ts:Date.now()});
    }
    $$('input[name="eth"]').forEach(r=>on(r,"change",updateCoach));
    const ethSaved = load(ETH_KEY,null);
    if(ethSaved && ethSaved.v){
      const r=document.querySelector(`input[name="eth"][value="${ethSaved.v}"]`); if(r){ r.checked=true; updateCoach(); }
    } else { updateCoach(); }
    on($("#ethMark"),"click",()=>{
      const v=currentMask();
      const note = `Ethics mask: ${v.toUpperCase()} @ ${new Date().toLocaleString()}`;
      const e = readLedger()[0];
      if(!e){ $("#lgWit") && ($("#lgWit").value = note); toast("No entries yet — appended to Witness field."); return; }
      e.note = (e.note? e.note+"\n":"") + note; const all=readLedger(); all[0]=e; writeLedger(all); renderLedger(); toast("Mask appended to latest Ledger entry");
    });

    /* ========================== MAPS ENGINE ========================== */
    const ANCH_KEY="sof_anchor_matrix_v1";
    const MEM_KEY ="sof_memory_grid_v1";

    on($("#biasStamp"),"click",()=>{
      const bias=($("#biasName")?.value||"").trim();
      const fact=($("#biasFact")?.value||"").trim();
      const phrase=($("#rmnLine")?.value||"").trim();
      if(!bias && !fact) return toast("Add a bias + micro-fact first");
      addLedger({
        when:new Date().toISOString(),
        carrier:($("#hudCarrier")?.textContent||"").replace(/^Πν:\s*/,""),
        phrase: phrase || "—",
        coherence:($("#xiOut")?.textContent||"").replace(/.*?([\d.]+)$/,"$1"),
        tags:["maps","bias"],
        note:`Bias: ${bias||"—"} | Fact: ${fact||"—"}`
      });
      toast("Bias interrupt → Ledger");
      if(window.switchTo) window.switchTo("ledger");
    });

    on($("#anchorSave"),"click",()=>{
      const data={
        see: $("#anchSee")?.value||"", hear: $("#anchHear")?.value||"",
        feel: $("#anchFeel")?.value||"", say: $("#anchSay")?.value||""
      };
      save(ANCH_KEY,data); toast("Anchors saved");
    });
    on($("#anchorLoad"),"click",()=>{
      const d=load(ANCH_KEY,null);
      if(!d) return toast("No anchors saved");
      $("#anchSee") && ($("#anchSee").value=d.see||"");
      $("#anchHear")&& ($("#anchHear").value=d.hear||"");
      $("#anchFeel")&& ($("#anchFeel").value=d.feel||"");
      $("#anchSay") && ($("#anchSay").value=d.say||"");
      toast("Anchors loaded");
    });

    on($("#memSave"),"click",()=>{
      const grid=[]; for(let r=0;r<3;r++){ const row=[]; for(let c=0;c<3;c++){ row.push(($("#m"+r+""+c)?.value||"")); } grid.push(row); }
      save(MEM_KEY,grid); toast("Grid saved");
    });
    on($("#memLoad"),"click",()=>{
      const grid=load(MEM_KEY,null); if(!grid) return toast("No grid saved");
      for(let r=0;r<3;r++) for(let c=0;c<3;c++){ const id="#m"+r+""+c; if($(id)) $(id).value = grid?.[r]?.[c]||""; }
      toast("Grid loaded");
    });
    on($("#memClear"),"click",()=>{
      for(let r=0;r<3;r++) for(let c=0;c<3;c++){ const id="#m"+r+""+c; if($(id)) $(id).value = ""; }
      toast("Grid cleared");
    });

  })();
  </script>
</body>
</html>
<!-- ================= END PART 3/3 ================= -->
