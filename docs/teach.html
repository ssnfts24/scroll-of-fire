<!doctype html>
<html lang="en" dir="ltr" class="sof">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>if(location.hostname==="github.com"){const b=document.querySelector("base");if(b)b.remove();}</script>
  <meta charset="utf-8" />
  <title>Manifest â€” Remnant Visual Exercise Â· Scroll of Fire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f"><meta name="color-scheme" content="dark">
  <meta name="description" content="Remnant Visual Exercise (RVE): compose intention (ğ“˜), align a carrier Î Î½, run the observer loop (ğ“˜â†’ğ“›â†’ğ“’â†’ğ“¢), breathe, compute Î, and seal to the private Witness Ledger â€” ethics first." />
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/teach.html" />
  <meta property="og:title" content="Manifest â€” Remnant Visual Exercise Â· Scroll of Fire">
  <meta property="og:description" content="Create. Witness. Seal. Live remnant trace, carrier tuning, breath pacing, Î meter, and a private ledger â€” Eq.9 safety mask on.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-23">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-23" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-23"></noscript>

  <style>
    :root{--maxw:1180px}
    body{margin:0}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:20px 16px 90px}
    .title{
      font-family:"Crimson Pro",serif;font-weight:800;text-align:center;
      font-size:clamp(28px,3.6vw,44px);margin:8px 0 4px;letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#cfefff 60%,#a7f6ff);
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .subtitle{text-align:center;color:var(--muted);margin:0 0 12px}

    /* Layout */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-7{grid-column:span 7}.col-12{grid-column:span 12}
    @media (max-width:980px){.col-4,.col-5,.col-7,.col-12{grid-column:span 12}}

    /* Cards & inputs */
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
    .lab-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .lab-btn{padding:.6rem .85rem;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);font-weight:700;cursor:pointer}
    .lab-btn[disabled]{opacity:.5;cursor:not-allowed}
    .lab-btn.primary{box-shadow:0 8px 24px rgba(122,243,255,.12)}
    .lab-input{width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:inherit}
    .hint,.meta{color:#9aa4be}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0)}

    /* Tabs */
    .pill-tabs{display:flex;gap:6px;align-items:center}
    .pill{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--line);cursor:pointer}
    .pill.active{border-color:var(--accent);box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 45%, transparent)}
    .tab{display:none}.tab.active{display:block}

    /* REMNANT (visual) */
    .stage{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0a0e15}
    #trace{display:block;width:100%;height:380px;background:radial-gradient(220px 160px at 50% 50%, #0e1420, #080b12)}
    .stage .hud{position:absolute;inset:auto 10px 10px 10px;display:flex;justify-content:space-between;gap:8px;pointer-events:none}
    .chip{font-size:.82rem;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);pointer-events:auto}

    /* Rings */
    .ring-bg{fill:none;stroke:#1f1f28;stroke-width:6}
    .ring-fg{fill:none;stroke:url(#gradRing);stroke-width:6;stroke-linecap:round;stroke-dasharray:0 283}
    .ring-num{font:800 18px/1 Inter;fill:#eae7df}
    .ring-sub{font:600 10px/1 Inter;fill:#b8b3a6}

    /* Banner hero â€” show full image (no crop) */
    .hero{margin:8px auto 0; max-width:1200px; border-radius:16px; overflow:hidden; background:#0b0f14}
    .hero img{display:block; width:100%; height:auto; object-fit:contain} /* full image, not cropped */

    /* Ledger thumbnails + lightbox */
    .thumb{height:40px; width:auto; border:1px solid var(--line); border-radius:6px; vertical-align:middle; cursor:pointer}
    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999}
    .lightbox.open{display:flex}
    .lightbox img{max-width:min(92vw,1200px); max-height:88vh; border-radius:12px; border:1px solid #2a3242; box-shadow:0 16px 48px rgba(0,0,0,.6)}

    /* Gentle reveal */
    .visible{opacity:1;transform:none}
    .card{opacity:.96;transform:translateY(6px);transition:opacity .25s ease-out, transform .25s ease-out}
  </style>
</head>

<body class="stars">
  <!-- Banner (full image, no crop) -->
  <figure class="hero" aria-label="Scroll of Fire banner">
    <img src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png" alt="Scroll of Fire â€” sigil banner" width="2100" height="900" decoding="async" loading="eager">
  </figure>

  <main class="wrap" id="main" role="main">
    <header class="page-head fancy-head">
      <h1 class="title">âœ¨ Manifest â€” <em>Remnant Visual Exercise</em></h1>
      <p class="subtitle">Compose a line (ğ“˜), tune your carrier Î <sub>Î½</sub>, run ğ“˜â†’ğ“›â†’ğ“’â†’ğ“¢, breathe, feel Î rise, then <b>seal</b> the remnant to witness.</p>

      <!-- Top nav / tabs -->
      <section class="card" style="margin-top:10px">
        <div class="pill-tabs" role="tablist" aria-label="Manifest tabs">
          <button class="pill active" data-tab="remnant"  role="tab" aria-selected="true">ğŸœš Remnant (Visual)</button>
          <button class="pill"        data-tab="observer" role="tab" aria-selected="false">â± Observer</button>
          <button class="pill"        data-tab="voice"    role="tab" aria-selected="false">ğŸ™ Voice</button>
          <button class="pill"        data-tab="phrase"   role="tab" aria-selected="false">ğŸ”¡ Phrase</button>
          <button class="pill"        data-tab="breath"   role="tab" aria-selected="false">ğŸŒ¬ Breath</button>
          <button class="pill"        data-tab="coherence"role="tab" aria-selected="false">ğŸ“ˆ Î</button>
          <button class="pill"        data-tab="ledger"   role="tab" aria-selected="false">ğŸ“’ Ledger</button>
          <span class="flex" aria-hidden="true"></span>
          <label class="hint"><input id="coach" type="checkbox"> Coach mode</label>
        </div>
      </section>
    </header>

    <!-- =================== TABS =================== -->

    <!-- REMNANT (Visual Exercise) -->
    <section id="tab-remnant" class="tab active" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸœš Remnant â€” visual exercise & seal</h2>

          <!-- Stage -->
          <div class="stage">
            <canvas id="trace" aria-label="Remnant trace"></canvas>

            <div class="hud">
              <div class="lab-row">
                <button class="chip" id="visToggle">Visual: Flow</button>
                <button class="chip" id="seedBtn">Seed</button>
                <button class="chip" id="clearBtn">Clear</button>
                <button class="chip" id="dlTrace">Download Trace</button>
              </div>
              <div class="lab-row">
                <span class="chip" id="hudCarrier">Î Î½: â€”</span>
                <span class="chip" id="hudBreath">Breath: â€”</span>
                <span class="chip" id="hudXi">Î: â€”</span>
              </div>
            </div>
          </div>

          <div class="lab-row" style="margin-top:8px">
            <input id="rmnLine" class="lab-input" placeholder="Your intention line (ğ“˜)â€¦">
            <div class="lab-row" role="radiogroup" aria-label="Carrier">
              <button class="lab-btn tone" data-carrier="432">432</button>
              <button class="lab-btn tone" data-carrier="528">528</button>
              <button class="lab-btn tone" data-carrier="369">369</button>
              <button class="lab-btn tone" data-carrier="144">144</button>
              <button class="lab-btn tone" data-carrier="963">963</button>
              <button class="lab-btn tone" data-carrier="none">None</button>
            </div>
          </div>

          <div class="lab-row">
            <button id="rmnRun" class="lab-btn primary">Run (1Ã—12s)</button>
            <button id="rmnSeal" class="lab-btn">Seal â†’ Ledger</button>
          </div>
          <p class="hint">Seed draws a soft trace from your carrier & breath. Seal stores the line, carrier, Î, and a thumbnail remnant in the Ledger. Download saves a PNG.</p>
        </div>

        <aside class="card col-5">
          <h3>Operator map (quick)</h3>
          <ol class="list compact">
            <li>ğ“˜ <b>Intend</b> â€” one clear line on Î <sub>Î½</sub>.</li>
            <li>ğ“› <b>Light/Language</b> â€” speak it once, steady.</li>
            <li>ğ“’ <b>Conscious Witness</b> â€” one undeniable detail.</li>
            <li>ğ“¢ <b>Source/Return</b> â€” seal, rest, update later.</li>
          </ol>
          <p class="meta">Eq.9 safety mask: stop if clarity drops or harm rises.</p>
        </aside>
      </article>
    </section>

    <!-- OBSERVER -->
    <section id="tab-observer" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>â± Observer â€” 4 steps</h2>
          <ol class="list">
            <li><b>ğ“˜ Intend:</b> say your line once on the tone.</li>
            <li><b>ğ“› Look:</b> one undeniable detail.</li>
            <li><b>ğ“’ Coalesce:</b> soften jaw/shoulders; longer exhale.</li>
            <li><b>ğ“¢ Seal:</b> whisper â€œthank youâ€, rest a beat.</li>
          </ol>

          <div class="lab-row">
            <div style="width:116px;height:116px;display:grid;place-items:center">
              <svg viewBox="0 0 100 100" aria-label="Observer ring">
                <defs><linearGradient id="gradRing" x1="0" x2="1"><stop offset="0" stop-color="#7af3ff"/><stop offset="1" stop-color="#f3c97a"/></linearGradient></defs>
                <circle cx="50" cy="50" r="45" class="ring-bg"/>
                <circle cx="50" cy="50" r="45" class="ring-fg" id="obsArc" pathLength="283"/>
                <text x="50" y="48" text-anchor="middle" class="ring-num" id="obsPhase">Ready</text>
                <text x="50" y="64" text-anchor="middle" class="ring-sub" id="obsCount">â€”</text>
              </svg>
            </div>
            <div>
              <div class="lab-row">
                <button id="obsStart" class="lab-btn primary">Start (3Ã—10s)</button>
                <button id="obsStop" class="lab-btn" disabled>Stop</button>
              </div>
              <div class="lab-row">
                <label>Seconds/phase <input id="obsSec" type="number" value="10" min="3" max="120" class="lab-input" style="width:100px"></label>
                <label>Rounds <input id="obsRounds" type="number" value="3" min="1" max="20" class="lab-input" style="width:90px"></label>
              </div>
              <p class="hint" id="coachObs">Coach: inhale on ğ“˜, see on ğ“›, soften on ğ“’, exhale/thank on ğ“¢.</p>
            </div>
          </div>
        </div>

        <aside class="card col-5">
          <h3>Carrier now</h3>
          <p id="toneNow" class="meta">Î Î½: none</p>
          <p class="meta">Keep Eq.9: if Truth/Distortion worsens â†’ stop, re-align, resume.</p>
        </aside>
      </article>
    </section>

    <!-- VOICE -->
    <section id="tab-voice" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ™ Voice â€” find a steady carrier Î <sub>Î½</sub></h2>
          <div class="lab-row">
            <button id="micOn" class="lab-btn">Enable Mic</button>
            <button id="micOff" class="lab-btn" disabled>Stop</button>
            <span id="freqRead" class="meta" aria-live="polite">â€”</span>
            <button id="useTone" class="lab-btn" disabled>Use this tone</button>
          </div>
          <canvas id="wave" width="800" height="140" aria-label="Waveform"></canvas>
          <canvas id="fft"  width="800" height="140" aria-label="Spectrum"></canvas>
        </div>

        <aside class="card col-5">
          <h3>Presets</h3>
          <div class="lab-row">
            <button class="lab-btn tone" data-carrier="432">432</button>
            <button class="lab-btn tone" data-carrier="528">528</button>
            <button class="lab-btn tone" data-carrier="369">369</button>
            <button class="lab-btn tone" data-carrier="144">144</button>
            <button class="lab-btn tone" data-carrier="963">963</button>
            <button class="lab-btn tone" data-carrier="none">None</button>
          </div>
          <p class="hint">Hum softly ~3s. When the peak holds steady, â€œUse this tone.â€</p>
        </aside>
      </article>
    </section>

    <!-- PHRASE -->
    <section id="tab-phrase" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ”¡ Phrase â€” tune meaning (Eq.4/4b)</h2>
          <textarea id="phraseIn" rows="3" class="lab-input" placeholder="Type your lineâ€¦"></textarea>
          <div class="lab-row">
            <button id="phraseTune" class="lab-btn">Tune</button>
            <button id="phraseClear" class="lab-btn">Clear</button>
          </div>
          <p><b>Suggestion:</b> <span id="phraseOut" class="meta">â€”</span></p>
          <p class="hint" id="coachPhrase">Coach: fewer negations â†’ cleaner gradient; strong verbs + concrete nouns.</p>
        </div>

        <aside class="card col-5">
          <h3>Micro-templates</h3>
          <p>I speak simply and act kindly.</p>
          <p>We finish one helpful thing today.</p>
          <p>Light reveals; love restores.</p>
        </aside>
      </article>
    </section>

    <!-- BREATH -->
    <section id="tab-breath" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸŒ¬ Breath â€” pacing ring</h2>
          <div class="lab-row">
            <label>Pattern
              <select id="breathPat" class="lab-input" style="width:auto">
                <option value="4-4-4-4">Box 4-4-4-4</option>
                <option value="4-7-8">4-7-8</option>
                <option value="5-5-5-5">5-5-5-5</option>
              </select>
            </label>
            <button id="breathStart" class="lab-btn">Start</button>
            <button id="breathStop" class="lab-btn" disabled>Stop</button>
          </div>
          <div style="width:116px;height:116px;display:grid;place-items:center;margin-top:6px">
            <svg viewBox="0 0 100 100" aria-label="Breath ring">
              <circle cx="50" cy="50" r="45" class="ring-bg"/>
              <circle cx="50" cy="50" r="45" class="ring-fg" id="breathArc" pathLength="283"/>
              <text x="50" y="56" text-anchor="middle" class="ring-num" id="breathPhase">Ready</text>
            </svg>
          </div>
          <p class="hint">Longer, quieter exhales tend to smooth the field. Stop if dizzy.</p>
        </div>

        <aside class="card col-5">
          <h3>Use with Observer</h3>
          <p>Inhale â€” ğ“˜ Â· See â€” ğ“› Â· Soften â€” ğ“’ Â· Exhale/Seal â€” ğ“¢</p>
        </aside>
      </article>
    </section>

    <!-- COHERENCE -->
    <section id="tab-coherence" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ“ˆ Coherence (Î)</h2>
          <div class="lab-row">
            <label>âŸ¨HÂ·IâŸ© <input id="hi" type="number" min="0" max="1" step="0.01" value="0.62" class="lab-input" style="width:110px"></label>
            <label>Var[ğ“œ] <input id="varM" type="number" min="0" max="2" step="0.01" value="0.30" class="lab-input" style="width:110px"></label>
            <button id="xiCalc" class="lab-btn">Compute Î</button>
            <output id="xiOut" class="meta">Î = â€”</output>
          </div>
          <canvas id="xiSpark" width="500" height="70" aria-label="Î history"></canvas>
        </div>

        <aside class="card col-5">
          <h3>Stop Rule (Eq.9)</h3>
          <p>If clarity falls or tension rises, <b>halt</b>. Re-center (carriers/breath/phrase), then resume.</p>
        </aside>
      </article>
    </section>

    <!-- LEDGER -->
    <section id="tab-ledger" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-12">
          <h2>ğŸ“’ Witness Ledger <small class="meta">(private on this device)</small></h2>
          <div class="lab-row">
            <input id="lgLine" class="lab-input" placeholder="Intention (ğ“˜)â€¦">
            <input id="lgCarrier" class="lab-input" placeholder="Carrier (432/528/369/144/963)">
            <select id="lgQ" class="lab-input" style="width:auto"><option value="">Î qualityâ€¦</option><option>Low</option><option>Medium</option><option>High</option></select>
            <input id="lgTags" class="lab-input" placeholder="tags (comma)">
          </div>
          <textarea id="lgWit" rows="3" class="lab-input" placeholder="Witness (what changed, what lingered)â€¦"></textarea>

          <div class="lab-row">
            <button id="lgAdd" class="lab-btn primary">Add</button>
            <button id="lgExport" class="lab-btn">Export .json</button>
            <input type="file" id="lgImportFile" accept="application/json" hidden>
            <button id="lgImport" class="lab-btn">Import .json</button>
            <input id="lgFilter" class="lab-input" placeholder="Filterâ€¦" style="margin-left:auto;max-width:240px">
          </div>

          <div class="table-wrap" style="margin-top:8px">
            <table id="lgTable">
              <thead><tr><th>Date</th><th>Intention</th><th>Carrier</th><th>Î</th><th>Tags</th><th>Witness</th><th>Remnant</th><th></th></tr></thead>
              <tbody id="lgRows"></tbody>
            </table>
          </div>
        </div>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="meta">Â© <span id="yr">2025</span> Aaron Paul Laird â€” Scroll of Fire â€¢ BY-NC 4.0</p>
    </footer>
  </main>

  <!-- ======= RVE Engine (client-only) ======= -->
  <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);

    /* -------- Tabs -------- */
    const tabBtns=$$(".pill"), tabs=$$(".tab");
    function switchTo(id){ tabs.forEach(t=>t.classList.toggle("active", t.id==="tab-"+id)); tabBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===id)); }
    tabBtns.forEach(b=>on(b,"click",()=>switchTo(b.dataset.tab)));
    on(document,"keydown",(e)=>{ if(e.target.matches("input,textarea")) return; const map={1:"remnant",2:"observer",3:"voice",4:"phrase",5:"breath",6:"coherence",7:"ledger"}; if(map[e.key]){ e.preventDefault(); switchTo(map[e.key]); } });

    /* -------- Reveal -------- */
    if('IntersectionObserver' in window){
      const io=new IntersectionObserver(es=>es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); } }), {threshold:.08});
      $$(".card").forEach(c=>io.observe(c));
    } else { $$(".card").forEach(c=>c.classList.add('visible')); }

    /* -------- Year -------- */
    $("#yr").textContent=new Date().getFullYear();

    /* -------- Local storage helpers -------- */
    const LGKEY="sof_ledger_entries_v4";
    function load(k,fb){ try{return JSON.parse(localStorage.getItem(k)||"");}catch(_){return fb;} }
    function save(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch(_){} }

    /* -------- Carrier tone engine -------- */
    let AC=null, G=null, OSC=null, carrier="none";
    function ensureAC(){ if(AC) return AC; try{ AC=new (window.AudioContext||window.webkitAudioContext)(); G=AC.createGain(); G.gain.value=0.00012; G.connect(AC.destination);}catch(_){ } return AC; }
    function blip(freq, dur=0.28, vol=0.05){
      if(!ensureAC()||!freq) return;
      if(OSC){ try{OSC.stop();}catch(_){ } OSC=null; }
      const o=AC.createOscillator(), g=AC.createGain();
      o.type="sine"; o.frequency.value=freq; g.gain.value=0.0001; o.connect(g).connect(G);
      const t=AC.currentTime; g.gain.linearRampToValueAtTime(vol,t+0.03); g.gain.linearRampToValueAtTime(0.0001,t+dur); o.start(); o.stop(t+dur+0.02); OSC=o;
    }
    window.addEventListener("pointerdown",()=>{ if(AC && AC.state==="suspended"){ AC.resume(); } },{once:true,passive:true});
    $$(".tone").forEach(b=>on(b,"click",()=>{
      const c=b.dataset.carrier||"none"; carrier=c; $("#toneNow").textContent="Î Î½: "+c; $("#hudCarrier").textContent="Î Î½: "+c;
      if(c!=="none") blip(+c);
    }));

    /* -------- Remnant visual trace -------- */
    const canvas=$("#trace"), ctx=canvas.getContext("2d");
    function fit(){ const r=canvas.getBoundingClientRect(); canvas.width=r.width; canvas.height=380; }
    fit(); addEventListener("resize", fit, {passive:true});

    let phi=0, seed=Math.random()*1000, mode=0; // 0: flow, 1: lattice
    let breathPhase="â€”"; $("#hudBreath").textContent="Breath: â€”";

    function palette(t){
      const a="rgba(122,243,255,", b="rgba(243,201,122,";
      return t<0.5? a+(0.15+0.6*t)+")" : b+(0.15+0.6*(t-0.5)) +")";
    }

    function drawFlow(t){
      const W=canvas.width,H=canvas.height;
      ctx.fillStyle="rgba(10,14,21,0.10)"; ctx.fillRect(0,0,W,H);
      const base = carrier==="none"? 0.7 : ( (parseFloat(carrier)%1000)/1000 );
      const n=140, r0=Math.min(W,H)*0.22;
      for(let i=0;i<n;i++){
        const a = i/n * Math.PI*2 + phi*0.0006;
        const b = Math.sin(i*0.17 + seed*0.1 + phi*0.001);
        const r = r0 * (0.7 + 0.3*Math.sin(phi*0.002 + i*0.05 + base*6));
        const x = W/2 + Math.cos(a)*r*(1+0.08*b);
        const y = H/2 + Math.sin(a*(1.0+0.02*Math.cos(phi*0.003)) )*r*(1-0.05*b);
        ctx.fillStyle = palette((i%100)/100);
        ctx.beginPath(); ctx.arc(x,y, 0.8 + 1.4*(0.5+0.5*b), 0, Math.PI*2); ctx.fill();
      }
      phi += (breathPhase==="In"? 1.6 : breathPhase==="Out"? 2.2 : 1.0);
    }

    function drawLattice(t){
      const W=canvas.width,H=canvas.height;
      ctx.fillStyle="rgba(10,14,21,0.14)"; ctx.fillRect(0,0,W,H);
      const base = carrier==="none"? 0.5 : ((+carrier%360)/360);
      const a = 1 + Math.round(base*5), b = 2 + Math.round(base*7);
      const R = Math.min(W,H)*0.36, steps = 420;
      ctx.beginPath();
      for(let i=0;i<steps;i++){
        const th = i/steps * Math.PI*2;
        const x = W/2 + R*Math.sin(a*th + phi*0.0012);
        const y = H/2 + R*Math.sin(b*th + phi*0.0016);
        (i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      }
      ctx.strokeStyle="rgba(243,201,122,.85)"; ctx.lineWidth=1.4; ctx.stroke();
      phi += 1.5;
    }

    let anim=true;
    (function loop(t){ if(!anim) return; (mode?drawLattice:drawFlow)(t); requestAnimationFrame(loop); })();

    on($("#visToggle"),"click",()=>{ mode = (mode+1)%2; $("#visToggle").textContent = "Visual: " + (mode? "Lattice":"Flow"); });
    on($("#clearBtn"),"click",()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); });
    on($("#seedBtn"),"click",()=>{ seed = Math.random()*1000; });
    on($("#dlTrace"),"click",()=>{
      try{
        const url=canvas.toDataURL("image/png");
        const a=document.createElement("a"); a.href=url; a.download="remnant-trace.png"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
      }catch(_){ toast("Download failed"); }
    });

    function seedTrace(){ for(let k=0;k<40;k++){ (mode?drawLattice:drawFlow)(performance.now()+k*16); } }
    function canvasPNG(){ try{ return canvas.toDataURL("image/png"); }catch(_){ return ""; } }

    /* -------- RVE Run & Seal -------- */
    on($("#rmnRun"),"click",()=>{
      seedTrace();
      switchTo("observer"); $("#obsSec").value=12; $("#obsRounds").value=1; $("#obsStart").click();
      switchTo("remnant");
    });

    on($("#rmnSeal"),"click",()=>{
      const line=($("#rmnLine").value||"").trim();
      if(!line) return toast("Write an intention line");
      const png = canvasPNG();
      addLedger({
        when:new Date().toISOString(),
        carrier:carrier==="none"?"":carrier,
        phrase:line,
        coherence:($("#xiOut").textContent||"").replace(/.*?([\d.]+)$/, "$1"),
        tags:["seal","remnant"],
        note:""
      }, png);
      toast("Sealed to Ledger");
      switchTo("ledger");
    });

    /* -------- Observer loop -------- */
    const obsArc=$("#obsArc"), obsPhase=$("#obsPhase"), obsCount=$("#obsCount");
    const obsStart=$("#obsStart"), obsStop=$("#obsStop");
    const obsSec=$("#obsSec"), obsRounds=$("#obsRounds");
    let obsTimer=null, obsIdx=0, obsRound=0, obsRem=0, obsPhases=["ğ“˜","ğ“›","ğ“’","ğ“¢"], obsTotal=0, obsTick=0;
    function obsReset(){ obsArc.setAttribute("stroke-dasharray","0 283"); obsPhase.textContent="Ready"; obsCount.textContent="â€”"; obsIdx=0; obsRound=0; obsRem=0; obsTick=0; }
    function click(vol=0.01){
      if(!ensureAC()) return; const o=AC.createOscillator(), g=AC.createGain();
      o.type="square"; o.frequency.value=880; g.gain.value=0.0001; o.connect(g).connect(AC.destination);
      const t=AC.currentTime; o.start(t); g.gain.linearRampToValueAtTime(vol,t+0.005); g.gain.linearRampToValueAtTime(0.0001,t+0.06); o.stop(t+0.08);
    }
    function obsRun(){
      const p=+obsSec.value||10, r=+obsRounds.value||3;
      obsTotal = p*4*r; obsIdx=0; obsRound=1; obsRem=p; obsTick=0;
      obsPhase.textContent=obsPhases[0]; obsCount.textContent=`Round 1/${r}`;
      obsStart.disabled=true; obsStop.disabled=false;
      obsTimer=setInterval(()=>{
        obsTick++; obsRem--;
        const frac=obsTick/obsTotal, dash=283*frac; obsArc.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        breathPhase = ["In","â€”","Out","â€”"][obsIdx]; $("#hudBreath").textContent="Breath: "+breathPhase;
        if(obsRem<=0){
          obsIdx++; click(0.008);
          if(obsIdx>=4){ obsIdx=0; obsRound++;
            if(obsRound>r){ clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true; obsPhase.textContent="Done"; obsCount.textContent=`${r}/${r}`; breathPhase="â€”"; $("#hudBreath").textContent="Breath: â€”"; return; }
            obsCount.textContent=`Round ${obsRound}/${r}`;
          }
          obsRem=p; obsPhase.textContent=obsPhases[obsIdx];
        }
      },1000);
    }
    on(obsStart,"click",obsRun);
    on(obsStop,"click",()=>{ clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true; obsReset(); breathPhase="â€”"; $("#hudBreath").textContent="Breath: â€”"; });

    /* -------- Voice (mic) -------- */
    let micStream=null, analyser=null, wave=$("#wave"), fft=$("#fft");
    on($("#micOn"),"click", async ()=>{
      try{
        if(!ensureAC()) return;
        micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false},video:false});
        const src = AC.createMediaStreamSource(micStream);
        analyser = AC.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
        src.connect(analyser);
        $("#micOff").disabled=false; $("#useTone").disabled=false;
        drawAudio(); toast("Mic on");
      }catch(err){ toast("Mic failed"); }
    });
    on($("#micOff"),"click",()=>{
      try{ micStream?.getTracks().forEach(t=>t.stop()); }catch(_){}
      analyser=null; $("#micOff").disabled=true; $("#useTone").disabled=true; toast("Mic off");
    });
    on($("#useTone"),"click",()=>{
      const fr = $("#freqRead").textContent.match(/~(\d+)\s*Hz/);
      const f = fr? +fr[1] : 432; carrier=String(f); blip(f); $("#toneNow").textContent="Î Î½: "+carrier; $("#hudCarrier").textContent="Î Î½: "+carrier;
    });

    function drawAudio(){
      if(!analyser) return;
      const wctx=wave.getContext("2d"), fctx=fft.getContext("2d");
      const wf=new Uint8Array(analyser.fftSize), ff=new Uint8Array(analyser.frequencyBinCount);
      (function loop(){
        if(!analyser) return;
        analyser.getByteTimeDomainData(wf); analyser.getByteFrequencyData(ff);
        const W=wave.width,H=wave.height; wctx.clearRect(0,0,W,H);
        wctx.fillStyle="#0b1016"; wctx.fillRect(0,0,W,H); wctx.beginPath(); wctx.moveTo(0,H/2);
        for(let x=0;x<W;x++){ const i=Math.floor(x/W*wf.length); const v=(wf[i]-128)/128; wctx.lineTo(x,H/2+v*H*0.4); }
        wctx.strokeStyle="#7af3ff"; wctx.lineWidth=2; wctx.stroke();
        const WF=fft.width, HF=fft.height; fctx.clearRect(0,0,WF,HF);
        let maxi=0,maxv=0; for(let i=4;i<ff.length;i++){ if(ff[i]>maxv){ maxv=ff[i]; maxi=i; } }
        const freq = maxi * (AC.sampleRate / analyser.fftSize) ;
        for(let i=0;i<ff.length;i++){ const v=ff[i]/255; const x=i/ff.length*WF; const y=HF*(1-v); fctx.fillStyle=v>.8?"#f3c97a":v>.5?"#a7f6ff":"#6aa0ff33"; fctx.fillRect(x,y,WF/ff.length,HF-y); }
        $("#freqRead").textContent = isFinite(freq) ? `~${Math.round(freq)} Hz (peak)` : "â€”";
        requestAnimationFrame(loop);
      })();
    }

    /* -------- Phrase -------- */
    on($("#phraseTune"),"click",()=>{
      const s = ($("#phraseIn").value||"").trim();
      if(!s) return toast("Type a line first");
      const simpler = s
        .replace(/\b(don't|do not|can't|cannot|won't|will not)\b/gi,"")
        .replace(/\b(try|maybe|sort of|kinda|hopefully)\b/gi,"")
        .replace(/\s{2,}/g," ")
        .trim();
      $("#phraseOut").textContent = simpler || s;
      const cl=$("#rmnLine"); if(cl && !cl.value) cl.value = simpler || s;
    });
    on($("#phraseClear"),"click",()=>{$("#phraseIn").value="";$("#phraseOut").textContent="â€”";});

    /* -------- Breath ring -------- */
    const breathArc=$("#breathArc"), breathPhaseEl=$("#breathPhase");
    let bTimer=null, bT0=0, bPat=[4,4,4,4];
    on($("#breathPat"),"change",e=>{ bPat=e.target.value.split("-").map(n=>+n||4);});
    on($("#breathStart"),"click",()=>{
      if(bTimer) return;
      bT0=performance.now(); $("#breathStop").disabled=false; $("#breathStart").disabled=true;
      const total=bPat.reduce((a,b)=>a+b,0)*1000;
      bTimer=setInterval(()=>{
        const t=(performance.now()-bT0)%total;
        let acc=0, idx=0; for(let i=0;i<4;i++){ acc+=bPat[i]*1000; if(t<acc){ idx=i; break; } }
        const prev=acc-bPat[idx]*1000;
        const dash=283*((prev+(t-prev))/total); breathArc.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        const ph=["In","Hold","Out","Hold"][idx]; breathPhaseEl.textContent=ph; breathPhase = ph; $("#hudBreath").textContent="Breath: "+ph;
      },1000/30);
    });
    on($("#breathStop"),"click",()=>{ clearInterval(bTimer); bTimer=null; $("#breathStart").disabled=false; $("#breathStop").disabled=true; breathPhaseEl.textContent="Ready"; breathPhase="â€”"; $("#hudBreath").textContent="Breath: â€”"; });

    /* -------- Î meter -------- */
    const xiOut=$("#xiOut"), xiSpark=$("#xiSpark").getContext("2d"); let xiHist=load("sof_xi_hist_v1",[]);
    function drawXi(){
      const ctx=xiSpark, W=ctx.canvas.width, H=ctx.canvas.height;
      ctx.clearRect(0,0,W,H); ctx.strokeStyle="rgba(122,243,255,.25)";
      ctx.beginPath(); ctx.moveTo(0,H*0.25); ctx.lineTo(W,H*0.25); ctx.moveTo(0,H*0.5); ctx.lineTo(W,H*0.5); ctx.moveTo(0,H*0.75); ctx.lineTo(W,H*0.75); ctx.stroke();
      if(!xiHist.length) return;
      const n=xiHist.length, xs=W/(n-1);
      ctx.beginPath(); for(let i=0;i<n;i++){ const y=H*(1-(xiHist[i].x*0.9+0.05)); const x=W-i*xs; (i?ctx.lineTo(x,y):ctx.moveTo(x,y)); }
      ctx.strokeStyle="rgba(243,201,122,.9)"; ctx.lineWidth=2; ctx.stroke();
    }
    drawXi();
    on($("#xiCalc"),"click",()=>{
      const hi=+$("#hi").value||0, v=+$("#varM").value||0.0001;
      const Xi = Math.max(0, Math.min(1, hi/(1+v)));
      xiOut.textContent = "Î = " + Xi.toFixed(2);
      $("#hudXi").textContent ="Î: " + Xi.toFixed(2);
      xiHist.unshift({t:Date.now(), x:Xi}); xiHist=xiHist.slice(0,60); save("sof_xi_hist_v1",xiHist); drawXi();
    });

    /* -------- Ledger -------- */
    function readLedger(){ return load(LGKEY,[]); }
    function writeLedger(arr){ save(LGKEY,arr); }
    function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    // Lightbox
    const lb=document.createElement("div"); lb.className="lightbox"; lb.innerHTML='<img alt="Remnant">'; document.body.appendChild(lb);
    lb.addEventListener("click",()=>lb.classList.remove("open"));

    function renderLedger(){
      const rows=$("#lgRows"), q=($("#lgFilter").value||"").toLowerCase(); const all=readLedger();
      const list = q ? all.filter(x=>JSON.stringify(x).toLowerCase().includes(q)) : all;
      rows.innerHTML = list.map((e,i)=>`<tr>
        <td>${new Date(e.when).toLocaleString()}</td>
        <td>${esc(e.phrase)}</td><td>${esc(e.carrier||"â€”")}</td><td>${esc(e.coherence||"â€”")}</td>
        <td>${esc((e.tags||[]).join(", "))}</td>
        <td>${esc(e.note||"")}</td>
        <td>${e._traceDataUri ? `<img src="${e._traceDataUri}" class="thumb" alt="Remnant" data-idx="${i}">` : "â€”"}</td>
        <td><button class="lab-btn" data-del="${i}">âœ•</button></td>
      </tr>`).join("");
      // actions
      $$("#lgRows [data-del]").forEach(b=>on(b,"click",()=>{ const all=readLedger(); all.splice(+b.dataset.del,1); writeLedger(all); renderLedger(); }));
      $$("#lgRows img.thumb").forEach(img=>on(img,"click",()=>{
        const all=readLedger(); const i=+img.dataset.idx; const src=all[i]._traceDataUri; if(src){ lb.querySelector("img").src=src; lb.classList.add("open"); }
      }));
    }
    function addLedger(entry, png){
      const all=readLedger();
      if(png){ entry._traceDataUri = png; }
      all.unshift(entry); writeLedger(all); renderLedger();
      $("#lgLine").value = entry.phrase || $("#lgLine").value;
      $("#lgCarrier").value = entry.carrier || $("#lgCarrier").value;
      $("#lgWit").value = (entry.note||"");
    }
    on($("#lgAdd"),"click",()=>{
      const phrase=($("#lgLine").value||"").trim(); if(!phrase) return toast("Write an intention line");
      const entry={
        when:new Date().toISOString(),
        carrier:($("#lgCarrier").value||"").trim(),
        phrase,
        coherence:$("#lgQ").value||"",
        tags:($("#lgTags").value||"").split(",").map(s=>s.trim()).filter(Boolean),
        note:($("#lgWit").value||"").trim()
      };
      addLedger(entry);
      $("#lgWit").value="";
    });
    on($("#lgExport"),"click",()=>{
      const blob=new Blob([JSON.stringify(readLedger(),null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="scroll-of-fire-ledger.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
    });
    on($("#lgImport"),"click",()=>$("#lgImportFile").click());
    on($("#lgImportFile"),"change",async e=>{
      const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const data=JSON.parse(txt); if(Array.isArray(data)){ writeLedger(data.concat(readLedger())); renderLedger(); toast("Imported"); } }catch(_){ toast("Import failed"); } e.target.value="";
    });
    on($("#lgFilter"),"input",renderLedger);
    renderLedger();

    /* -------- RVE â†” Observer hotkey -------- */
    on(document,"keydown",(e)=>{ if((e.key==="S"||e.key==="s") && !e.target.matches("input,textarea")){ e.preventDefault(); const btn = $("#obsStart").disabled ? $("#obsStop") : $("#obsStart"); btn.click(); } });

    /* -------- Tiny toast -------- */
    function toast(msg){
      const el=document.createElement("div"); el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }
  })();
  </script>
</body>
</html>
