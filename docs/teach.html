<!doctype html>
<html lang="en" dir="ltr" class="sof">
<head>
  <base href="https://ssnfts24.github.io/scroll-of-fire/">
  <script>if(location.hostname==="github.com"){const b=document.querySelector("base");if(b)b.remove();}</script>
  <meta charset="utf-8" />
  <title>Manifest â€” Play the Codex (Practice Studio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f"><meta name="color-scheme" content="dark light">
  <meta name="description" content="Game-like practice: pick a carrier, run a simple loop, breathe, rate coherence (Î), and log your witness. Earn XP, complete daily quests, and level upâ€”ethics first." />
  <link rel="canonical" href="https://ssnfts24.github.io/scroll-of-fire/teach.html" />
  <meta property="og:title" content="Manifest â€” Play the Codex">
  <meta property="og:description" content="Make practice fun: daily quests, XP, achievements. Simple steps anyone can follow.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Crimson+Pro:wght@400;700;800&display=swap" rel="stylesheet">

  <link rel="preload" as="style" href="assets/css/codex.css?v=2025-10-21">
  <link rel="stylesheet" href="assets/css/codex.css?v=2025-10-21" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="assets/css/codex.css?v=2025-10-21"></noscript>

  <style>
    :root{--maxw:1180px}
    body{margin:0}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:20px 16px 90px}
    .title{font-family:"Crimson Pro",serif;font-weight:800;text-align:center;
      font-size:clamp(28px,3.6vw,44px);margin:8px 0 4px;letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#cfefff 60%,#a7f6ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{text-align:center;color:var(--muted);margin:0 0 12px}

    /* Layout */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-7{grid-column:span 7}.col-12{grid-column:span 12}
    @media (max-width:980px){.col-4,.col-5,.col-7,.col-12{grid-column:span 12}}

    /* Cards & buttons */
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
    .lab-btn{padding:.6rem .85rem;border-radius:10px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);font-weight:700;cursor:pointer}
    .lab-btn.primary{box-shadow:0 8px 24px rgba(122,243,255,.12)}
    .lab-btn[disabled]{opacity:.5;cursor:not-allowed}
    .lab-row{display:flex;gap:10px;flex-wrap:wrap}
    .lab-input{width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:inherit}
    .hint{color:#9aa4be;font-size:.92rem}
    .meta{color:#9aa4be}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0)}

    /* Tabs */
    .pill-tabs{display:flex;gap:6px;align-items:center}
    .pill{padding:.5rem .8rem;border-radius:999px;border:1px solid var(--line);cursor:pointer}
    .pill.active{border-color:var(--accent);box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 45%, transparent)}
    .tab{display:none}.tab.active{display:block}

    /* Progress ring (XP/Level) */
    .level-hud{display:flex;align-items:center;gap:12px;justify-content:center}
    .level-ring{width:84px;height:84px;display:grid;place-items:center}
    .level-ring svg{width:84px;height:84px;display:block}
    .ring-bg{fill:none;stroke:#1f1f28;stroke-width:6}
    .ring-fg{fill:none;stroke:url(#gradXP);stroke-width:6;stroke-linecap:round;stroke-dasharray:0 283}
    .level-num{font:800 18px/1 Inter;fill:#eae7df}
    .level-sub{font:600 10px/1 Inter;fill:#b8b3a6}

    /* Achievements & badges */
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{padding:.35rem .6rem;border:1px solid var(--line);border-radius:999px}
    .badge.lit{border-color:#f3c97a;color:#fbe7b4;background:rgba(243,201,122,.1)}

    /* Confetti */
    #confetti{position:fixed;inset:0;pointer-events:none}

    /* Friendly copies */
    .friendly p{margin:.35rem 0}
  </style>
</head>

<body class="stars">
  <canvas id="confetti" width="1920" height="1080" aria-hidden="true"></canvas>
  <main class="wrap" id="main" role="main">
    <!-- Banner -->
    <figure class="hero hero--contain" aria-hidden="true" style="margin-bottom:8px">
      <img src="assets/file_0000000052e861f98b087ad0b80cbefc%20(1).png" alt="Scroll of Fire â€” sigil banner"
           width="1600" height="900" loading="eager" decoding="async">
    </figure>

    <header class="page-head fancy-head">
      <h1 class="title">âœ¨ Manifest â€” <em>Play the Codex</em></h1>
      <p class="subtitle">No jargon. Three actions: pick a tone, say one helpful line, notice one real thing. Log it. Earn XP.</p>

      <!-- Top nav / tabs -->
      <section class="card" style="margin-top:10px">
        <div class="pill-tabs" role="tablist" aria-label="Manifest tabs">
          <button class="pill active" data-tab="quests"    role="tab" aria-selected="true">ğŸ¯ Quests</button>
          <button class="pill"        data-tab="observer"  role="tab" aria-selected="false">â± Observer</button>
          <button class="pill"        data-tab="voice"     role="tab" aria-selected="false">ğŸ™ Voice</button>
          <button class="pill"        data-tab="phrase"    role="tab" aria-selected="false">ğŸ”¡ Phrase</button>
          <button class="pill"        data-tab="breath"    role="tab" aria-selected="false">ğŸŒ¬ Breath</button>
          <button class="pill"        data-tab="coherence" role="tab" aria-selected="false">ğŸ“ˆ Î</button>
          <button class="pill"        data-tab="ledger"    role="tab" aria-selected="false">ğŸ“’ Ledger</button>
          <span class="flex" aria-hidden="true"></span>
          <label class="hint"><input id="coach" type="checkbox"> Coach mode</label>
        </div>

        <!-- Level HUD -->
        <div class="level-hud" style="margin-top:8px">
          <div class="level-ring">
            <svg viewBox="0 0 100 100" aria-label="Level progress">
              <defs>
                <linearGradient id="gradXP" x1="0" x2="1">
                  <stop offset="0" stop-color="#7af3ff"/><stop offset="1" stop-color="#f3c97a"/>
                </linearGradient>
              </defs>
              <circle cx="50" cy="50" r="45" class="ring-bg"/>
              <circle cx="50" cy="50" r="45" class="ring-fg" id="xpArc" pathLength="283"/>
              <text x="50" y="48" text-anchor="middle" class="level-num" id="lvlNum">1</text>
              <text x="50" y="64" text-anchor="middle" class="level-sub" id="xpText">0 / 50</text>
            </svg>
          </div>
          <div class="friendly">
            <p><b>Level up by doing:</b> run the loop, breathe once, tune a phrase, compute Î, add a witness, try carriers.</p>
            <p class="meta">Ethics first. Stop if you feel worse (Stop Rule).</p>
          </div>
        </div>
      </section>
    </header>

    <!-- =================== TABS =================== -->

    <!-- Quests / Onboarding -->
    <section id="tab-quests" class="tab active" role="tabpanel">
      <article class="grid">
        <div class="card col-7 friendly">
          <h2>ğŸ¯ Daily Quests</h2>
          <ol id="questList" class="list">
            <!-- Filled by JS -->
          </ol>
          <div class="lab-row">
            <button id="btnResetQuests" class="lab-btn">Reset today</button>
            <button id="btnCompleteAll" class="lab-btn">Mark all done</button>
          </div>
          <p class="hint">Quests reset every day. Completing all gives a bonus and lights a badge.</p>
        </div>

        <aside class="card col-5 friendly">
          <h3>ğŸ”° Tiny Tutorial (2 minutes)</h3>
          <ol class="list compact">
            <li>Pick a <b>carrier</b> (tone) you like.</li>
            <li>Say one short, kind lineâ€”present tense.</li>
            <li>Run the <b>Observer</b> loop once.</li>
            <li>Notice one real change. <b>Log it</b> in the Ledger.</li>
          </ol>
          <div class="badges" style="margin-top:8px">
            <span id="bSeed" class="badge" title="7-Day Seed">ğŸŒ± 7-day</span>
            <span id="bOrbit" class="badge" title="33-Day Orbit">ğŸ›°ï¸ 33-day</span>
            <span id="bClosure" class="badge" title="144 Closure">ğŸœš 144</span>
            <span id="bAllTones" class="badge" title="Tried all five carriers">ğŸµ All Tones</span>
            <span id="bFirstLedger" class="badge" title="First Ledger entry">ğŸ§¾ First Witness</span>
          </div>
        </aside>
      </article>
    </section>

    <!-- Observer -->
    <section id="tab-observer" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>â± Observer â€” 4 steps, gentle pace</h2>
          <ol class="list">
            <li><b>ğ“˜ Intend:</b> say your line once on the tone.</li>
            <li><b>ğ“› Look:</b> spot one undeniable detail.</li>
            <li><b>ğ“’ Coalesce:</b> drop the shoulders, longer exhale.</li>
            <li><b>ğ“¢ Seal:</b> whisper â€œthank youâ€ and rest for a beat.</li>
          </ol>

          <div class="lab-row" style="margin:.5rem 0">
            <div role="radiogroup" aria-label="Carrier">
              <button class="lab-btn tone" data-carrier="432">432 Ground</button>
              <button class="lab-btn tone" data-carrier="528">528 Repair</button>
              <button class="lab-btn tone" data-carrier="369">369 Lock-in</button>
              <button class="lab-btn tone" data-carrier="144">144 Sanctuary</button>
              <button class="lab-btn tone" data-carrier="963">963 Crown</button>
              <button class="lab-btn tone" data-carrier="none">No tone</button>
            </div>
            <span id="toneNow" class="meta" aria-live="polite">Carrier: none</span>
          </div>

          <label for="intentLine" class="sr-only">Your line</label>
          <input id="intentLine" class="lab-input" placeholder="One short, kind lineâ€¦">

          <!-- Ring -->
          <div class="lab-row" style="align-items:center;margin-top:8px">
            <div style="width:116px;height:116px;display:grid;place-items:center">
              <svg viewBox="0 0 100 100" aria-label="Observer ring">
                <circle cx="50" cy="50" r="45" class="ring-bg"/>
                <circle cx="50" cy="50" r="45" class="ring-fg" id="obsArc" pathLength="283"/>
                <text x="50" y="48" text-anchor="middle" class="level-num" id="obsPhase">Ready</text>
                <text x="50" y="64" text-anchor="middle" class="level-sub" id="obsCount">â€”</text>
              </svg>
            </div>

            <div>
              <div class="lab-row">
                <button id="obsStart" class="lab-btn primary">Start (3Ã—10s)</button>
                <button id="obsStop" class="lab-btn" disabled>Stop</button>
              </div>
              <div class="lab-row">
                <label>Seconds/phase <input id="obsSec" type="number" value="10" min="3" max="120" class="lab-input" style="width:100px"></label>
                <label>Rounds <input id="obsRounds" type="number" value="3" min="1" max="20" class="lab-input" style="width:90px"></label>
              </div>
              <p class="hint" id="coachObs">Coach: breathe in on ğ“˜, see on ğ“›, soften on ğ“’, thank on ğ“¢.</p>
            </div>
          </div>
        </div>

        <aside class="card col-5 friendly">
          <h3>Why this works (simple)</h3>
          <p>One tone = fewer distractions. One clear line = clean direction. One real detail = proof you can point to. Thatâ€™s enough to start.</p>
          <p class="meta">If you feel worse, stop and reset. Care is the rule.</p>
        </aside>
      </article>
    </section>

    <!-- Voice -->
    <section id="tab-voice" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ™ Voice â€” find a comfy tone</h2>
          <div class="lab-row">
            <button id="micOn" class="lab-btn">Enable Mic</button>
            <button id="micOff" class="lab-btn" disabled>Stop</button>
            <span id="freqRead" class="meta" aria-live="polite">â€”</span>
            <button id="useTone" class="lab-btn" disabled>Use this tone</button>
          </div>
          <canvas id="wave" width="800" height="140" aria-label="Waveform"></canvas>
          <canvas id="fft"  width="800" height="140" aria-label="Spectrum"></canvas>
        </div>

        <aside class="card col-5 friendly">
          <h3>Presets</h3>
          <div class="lab-row">
            <button class="lab-btn tone" data-carrier="432">432</button>
            <button class="lab-btn tone" data-carrier="528">528</button>
            <button class="lab-btn tone" data-carrier="369">369</button>
            <button class="lab-btn tone" data-carrier="144">144</button>
            <button class="lab-btn tone" data-carrier="963">963</button>
          </div>
          <p class="hint">Softly hum for ~3 seconds. When it looks steady, tap â€œUse this toneâ€.</p>
        </aside>
      </article>
    </section>

    <!-- Phrase -->
    <section id="tab-phrase" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ”¡ Phrase â€” make it clean</h2>
          <textarea id="phraseIn" rows="3" class="lab-input" placeholder="Type your lineâ€¦"></textarea>
          <div class="lab-row">
            <button id="phraseTune" class="lab-btn">Tune</button>
            <button id="phraseClear" class="lab-btn">Clear</button>
          </div>
          <p><b>Suggestion:</b> <span id="phraseOut" class="meta">â€”</span></p>
          <p class="hint" id="coachPhrase">Coach: fewer negations, strong verbs, concrete nouns.</p>
        </div>

        <aside class="card col-5 friendly">
          <h3>Examples</h3>
          <p>I speak simply and act kindly.</p>
          <p>We finish one helpful thing today.</p>
          <p>Light reveals; love restores.</p>
        </aside>
      </article>
    </section>

    <!-- Breath -->
    <section id="tab-breath" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸŒ¬ Breath â€” gentle pacing</h2>
          <div class="lab-row">
            <label>Pattern
              <select id="breathPat" class="lab-input" style="width:auto">
                <option value="4-4-4-4">Box 4-4-4-4</option>
                <option value="4-7-8">4-7-8</option>
                <option value="5-5-5-5">5-5-5-5</option>
              </select>
            </label>
            <button id="breathStart" class="lab-btn">Start</button>
            <button id="breathStop" class="lab-btn" disabled>Stop</button>
          </div>
          <div style="width:116px;height:116px;display:grid;place-items:center;margin-top:6px">
            <svg viewBox="0 0 100 100" aria-label="Breath ring">
              <circle cx="50" cy="50" r="45" class="ring-bg"/>
              <circle cx="50" cy="50" r="45" class="ring-fg" id="breathArc" pathLength="283"/>
              <text x="50" y="56" text-anchor="middle" class="level-num" id="breathPhase">Ready</text>
            </svg>
          </div>
          <p class="hint">Longer, quieter exhales often feel better. Stop if dizzy.</p>
        </div>

        <aside class="card col-5 friendly">
          <h3>Use with the loop</h3>
          <p>Inhale â€” ğ“˜ Â· See â€” ğ“› Â· Soften â€” ğ“’ Â· Exhale â€” ğ“¢</p>
        </aside>
      </article>
    </section>

    <!-- Coherence -->
    <section id="tab-coherence" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-7">
          <h2>ğŸ“ˆ Coherence (Î)</h2>
          <div class="lab-row">
            <label>âŸ¨HÂ·IâŸ© <input id="hi" type="number" min="0" max="1" step="0.01" value="0.62" class="lab-input" style="width:110px"></label>
            <label>Var[ğ“œ] <input id="varM" type="number" min="0" max="2" step="0.01" value="0.30" class="lab-input" style="width:110px"></label>
            <button id="xiCalc" class="lab-btn">Compute Î</button>
            <output id="xiOut" class="meta">Î = â€”</output>
          </div>
          <canvas id="xiSpark" width="500" height="70" aria-label="Î history"></canvas>
        </div>

        <aside class="card col-5 friendly">
          <h3>Stop Rule</h3>
          <p>If your sense of truth goes down, stop, breathe, and try later. Care beats intensity.</p>
        </aside>
      </article>
    </section>

    <!-- Ledger -->
    <section id="tab-ledger" class="tab" role="tabpanel">
      <article class="grid">
        <div class="card col-12">
          <h2>ğŸ“’ Witness Ledger <small class="meta">(private on this device)</small></h2>
          <div class="lab-row">
            <input id="lgLine" class="lab-input" placeholder="Intention (one line)â€¦">
            <input id="lgCarrier" class="lab-input" placeholder="Carrier (432/528/369/144/963)">
            <select id="lgQ" class="lab-input" style="width:auto"><option value="">Î qualityâ€¦</option><option>Low</option><option>Medium</option><option>High</option></select>
            <input id="lgTags" class="lab-input" placeholder="tags (comma)">
          </div>
          <textarea id="lgWit" rows="3" class="lab-input" placeholder="Witness (what changed, what lingered)â€¦"></textarea>

          <div class="lab-row">
            <button id="lgAdd" class="lab-btn primary">Add</button>
            <button id="lgExport" class="lab-btn">Export .json</button>
            <input type="file" id="lgImportFile" accept="application/json" hidden>
            <button id="lgImport" class="lab-btn">Import .json</button>
            <input id="lgFilter" class="lab-input" placeholder="Filterâ€¦" style="margin-left:auto;max-width:240px">
          </div>

          <div class="table-wrap" style="margin-top:8px">
            <table id="lgTable">
              <thead><tr><th>Date</th><th>Intention</th><th>Carrier</th><th>Î</th><th>Tags</th><th>Witness</th><th></th></tr></thead>
              <tbody id="lgRows"></tbody>
            </table>
          </div>

          <div class="badges" style="margin-top:8px">
            <span id="bdg7" class="badge">ğŸŒ± Ã—7</span>
            <span id="bdg33" class="badge">ğŸ›°ï¸ Ã—33</span>
            <span id="bdg144" class="badge">ğŸœš Ã—144</span>
          </div>
        </div>
      </article>
    </section>

    <footer class="footer">
      <div class="divider" aria-hidden="true"></div>
      <p class="meta">Â© <span id="yr">2025</span> Aaron Paul Laird â€” Scroll of Fire â€¢ BY-NC 4.0</p>
    </footer>
  </main>

  <!-- ======= Game Engine (client-only) ======= -->
  <script>
  (function(){
    "use strict";
    const $ =(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const on=(t,e,f,o)=>t&&t.addEventListener(e,f,o);
    const raf=(f)=>(window.requestAnimationFrame||setTimeout)(f,16);

    /* ---------------- TABS ---------------- */
    const tabBtns=$$(".pill"), tabs=$$(".tab");
    function switchTo(id){
      tabs.forEach(t=>t.classList.toggle("active", t.id==="tab-"+id));
      tabBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
    }
    tabBtns.forEach(b=>on(b,"click",()=>switchTo(b.dataset.tab)));

    /* ---------------- LEVEL / XP ---------------- */
    const XPKEY="sof_game_xp_v1";
    const SKEY="sof_game_state_v1";
    const LGKEY="sof_ledger_entries_v2";
    const QSKEY="sof_daily_quests_v1";

    const xpArc=$("#xpArc"), lvlNum=$("#lvlNum"), xpText=$("#xpText");
    const confetti=$("#confetti"), ctxC=confetti.getContext("2d");

    let state = load(SKEY,{level:1,xp:0,carriersTried:{},firstLedger:false,lastQuestDate:null,streakDays:0,xiHistory:[]});
    save(SKEY,state);

    function load(k,fallback){ try{ return JSON.parse(localStorage.getItem(k)||""); }catch(_){ return fallback; } }
    function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} }

    function lvlCap(lvl){ return 50 + (lvl-1)*25; } // 50,75,100...
    function addXP(n, why=""){
      let cap=lvlCap(state.level);
      state.xp += n;
      let leveled=false;
      while(state.xp>=cap){ state.xp -= cap; state.level++; cap=lvlCap(state.level); leveled=true; }
      save(SKEY,state);
      drawXP();
      if(leveled){ celebrate(); toast(`Level up! You are now level ${state.level}.`); }
      else if(why){ toast(`+${n} XP Â· ${why}`); }
    }
    function drawXP(){
      const cap=lvlCap(state.level), frac=Math.max(0,Math.min(1,state.xp/cap));
      const dash=283*frac; xpArc.setAttribute("stroke-dasharray", `${dash} ${283-dash}`);
      lvlNum.textContent=String(state.level); xpText.textContent = `${state.xp} / ${cap}`;
    }
    drawXP();

    /* ---------------- CONFETTI ---------------- */
    function celebrate(){
      const W=confetti.width=innerWidth, H=confetti.height=innerHeight;
      const parts=Array.from({length:140},()=>({
        x:Math.random()*W, y:-20, vy:1+Math.random()*3, vx:(Math.random()-.5)*2,
        r:3+Math.random()*4, a:1, s:Math.random()*2*Math.PI
      }));
      let t=0;
      (function loop(){
        ctxC.clearRect(0,0,W,H);
        parts.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.s+=0.1; p.a*=0.996;
          ctxC.globalAlpha=Math.max(0,p.a);
          ctxC.fillStyle = (t%2)? "#7af3ff" : "#f3c97a";
          ctxC.beginPath(); ctxC.arc(p.x,p.y,p.r,0,Math.PI*2); ctxC.fill();
        });
        t++; if (t<220) requestAnimationFrame(loop);
      })();
    }

    /* ---------------- TOAST (simple) ---------------- */
    function toast(msg){
      const el=document.createElement("div");
      el.textContent=msg;
      Object.assign(el.style,{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",
        background:"#0e131c",color:"#e6f9ff",padding:"8px 12px",border:"1px solid #2a3242",borderRadius:"10px",
        boxShadow:"0 10px 28px rgba(0,0,0,.35)",zIndex:9999,opacity:0,transition:"opacity .2s"});
      document.body.appendChild(el); requestAnimationFrame(()=>{el.style.opacity=1});
      setTimeout(()=>{el.style.opacity=0; setTimeout(()=>el.remove(),250);},1800);
    }

    /* ---------------- COACH MODE ---------------- */
    const coach=$("#coach");
    on(coach,"change",()=>toast(coach.checked?"Coach on":"Coach off"));

    /* ---------------- DAILY QUESTS ---------------- */
    const QUESTS_BASE=[
      {id:"q1", text:"Run the Observer loop once", xp:20},
      {id:"q2", text:"Do one breath cycle", xp:15},
      {id:"q3", text:"Tune a phrase", xp:15},
      {id:"q4", text:"Compute Î once", xp:15},
      {id:"q5", text:"Add one Ledger entry", xp:25},
    ];
    function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
    function loadQuests(){
      const q=load(QSKEY,{date:todayKey(),done:{}});
      if(q.date!==todayKey()) return {date:todayKey(),done:{}};
      return q;
    }
    let quests=loadQuests(); save(QSKEY,quests);

    function renderQuests(){
      const wrap=$("#questList"); wrap.innerHTML="";
      QUESTS_BASE.forEach(q=>{
        const li=document.createElement("li");
        const c=document.createElement("input"); c.type="checkbox"; c.checked=!!quests.done[q.id];
        on(c,"change",()=>{
          quests.done[q.id]=c.checked; save(QSKEY,quests);
          if(c.checked) addXP(q.xp, q.text);
          checkDailyComplete();
        });
        const label=document.createElement("label"); label.style.marginLeft="8px"; label.textContent=q.text+"  Â· "+q.xp+" XP";
        li.appendChild(c); li.appendChild(label); wrap.appendChild(li);
      });
      checkDailyComplete();
    }
    function checkDailyComplete(){
      const allDone=QUESTS_BASE.every(q=>quests.done[q.id]);
      if(allDone && !quests.done.__bonus){
        quests.done.__bonus=true; save(QSKEY,quests);
        addXP(30,"Daily Bonus");
        // streak
        bumpStreak();
      }
    }
    function bumpStreak(){
      // naive streak by lastQuestDate
      const d=todayKey();
      if(state.lastQuestDate!==d){
        const yesterday=new Date(Date.now()-86400000).toISOString().slice(0,10);
        state.streakDays = (state.lastQuestDate===yesterday) ? (state.streakDays+1) : 1;
        state.lastQuestDate=d; save(SKEY,state);
        lightStreakBadges();
      }
    }
    function lightStreakBadges(){
      $("#bSeed").classList.toggle("lit", state.streakDays>=7);
      $("#bOrbit").classList.toggle("lit", state.streakDays>=33);
      $("#bClosure").classList.toggle("lit", state.streakDays>=144);
      $("#bdg7").classList.toggle("lit", state.streakDays>=7);
      $("#bdg33").classList.toggle("lit", state.streakDays>=33);
      $("#bdg144").classList.toggle("lit", state.streakDays>=144);
    }
    renderQuests(); lightStreakBadges();
    on($("#btnResetQuests"),"click",()=>{ quests={date:todayKey(),done:{}}; save(QSKEY,quests); renderQuests(); toast("Quests reset"); });
    on($("#btnCompleteAll"),"click",()=>{ QUESTS_BASE.forEach(q=>quests.done[q.id]=true); save(QSKEY,quests); renderQuests(); });

    /* ---------------- AUDIO CORE ---------------- */
    let AC=null, G=null, OSC=null;
    function ensureAC(){ if(AC) return AC; try{ AC=new (window.AudioContext||window.webkitAudioContext)(); G=AC.createGain(); G.gain.value=0.0001; G.connect(AC.destination);}catch(_){ } return AC; }
    function tone(freq, dur=0.35, vol=0.06){
      if(!ensureAC()||!freq) return;
      if(OSC){ try{OSC.stop();}catch(_){ } OSC=null; }
      const o=AC.createOscillator(); o.type="sine"; o.frequency.value=freq; o.connect(G);
      const t=AC.currentTime; G.gain.cancelScheduledValues(t);
      G.gain.linearRampToValueAtTime(vol, t+0.03);
      G.gain.linearRampToValueAtTime(0.0001, t+dur);
      o.start(); o.stop(t+dur+0.02); OSC=o;
    }
    function click(vol=0.01){
      if(!ensureAC()) return;
      const o=AC.createOscillator(); o.type="square"; o.frequency.value=880;
      const g=AC.createGain(); g.gain.value=0.0001; o.connect(g).connect(AC.destination);
      const t=AC.currentTime; o.start(t); g.gain.linearRampToValueAtTime(vol,t+0.005); g.gain.linearRampToValueAtTime(0.0001,t+0.06); o.stop(t+0.08);
    }
    window.addEventListener("pointerdown",()=>{ if(AC && AC.state==="suspended"){ AC.resume(); } },{once:true,passive:true});

    /* ---------------- OBSERVER LOOP ---------------- */
    const obsArc=$("#obsArc"), obsPhase=$("#obsPhase"), obsCount=$("#obsCount");
    const obsStart=$("#obsStart"), obsStop=$("#obsStop");
    const obsSec=$("#obsSec"), obsRounds=$("#obsRounds");

    let obsTimer=null, obsIdx=0, obsRound=0, obsRem=0, obsPhases=["ğ“˜","ğ“›","ğ“’","ğ“¢"], obsTotal=0, obsTick=0;
    function obsReset(){
      obsArc.setAttribute("stroke-dasharray","0 283");
      obsPhase.textContent="Ready"; obsCount.textContent="â€”";
      obsIdx=0; obsRound=0; obsRem=0; obsTick=0;
    }
    function obsRun(){
      const p=+obsSec.value||10, r=+obsRounds.value||3;
      obsTotal = p*4*r; obsIdx=0; obsRound=1; obsRem=p; obsTick=0;
      obsPhase.textContent=obsPhases[0]; obsCount.textContent=`Round 1/${r}`;
      obsStart.disabled=true; obsStop.disabled=false;
      obsTimer=setInterval(()=>{
        obsTick++; obsRem--;
        const frac=obsTick/obsTotal, dash=283*frac; obsArc.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        if(obsRem<=0){
          obsIdx++; click(0.008);
          if(obsIdx>=4){ obsIdx=0; obsRound++; if(obsRound>r){ clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true; obsPhase.textContent="Done"; obsCount.textContent=`${r}/${r}`; addXP(20,"Observer run"); return; } obsCount.textContent=`Round ${obsRound}/${r}`; }
          obsRem=p; obsPhase.textContent=obsPhases[obsIdx];
        }
      },1000);
    }
    on(obsStart,"click",obsRun);
    on(obsStop,"click",()=>{ clearInterval(obsTimer); obsStart.disabled=false; obsStop.disabled=true; obsReset(); });

    /* ---------------- TONES (CARRIERS) ---------------- */
    let carrier="none";
    const toneNow=$("#toneNow");
    $$(".tone").forEach(b=>on(b,"click",()=>{
      const c=b.dataset.carrier||"none"; carrier=c;
      if(c!=="none"){ tone(+c,0.28,0.05); }
      toneNow.textContent = "Carrier: " + c;
      // achievements
      if(c!=="none"){ state.carriersTried[c]=true; save(SKEY,state);
        const all=["432","528","369","144","963"].every(x=>state.carriersTried[x]);
        $("#bAllTones").classList.toggle("lit", all);
        if(all) addXP(20,"Tried all tones");
        else addXP(5,"Tried a tone");
      }
    }));

    /* ---------------- VOICE (MIC) ---------------- */
    let micStream=null, analyser=null, wave=$("#wave"), fft=$("#fft");
    on($("#micOn"),"click", async ()=>{
      try{
        if(!ensureAC()) return;
        micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false},video:false});
        const src = AC.createMediaStreamSource(micStream);
        analyser = AC.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
        src.connect(analyser);
        $("#micOff").disabled=false; $("#useTone").disabled=false;
        drawAudio();
        toast("Mic on");
      }catch(err){ toast("Mic failed"); }
    });
    on($("#micOff"),"click",()=>{
      try{ micStream?.getTracks().forEach(t=>t.stop()); }catch(_){}
      analyser=null; $("#micOff").disabled=true; $("#useTone").disabled=true; toast("Mic off");
    });
    on($("#useTone"),"click",()=>{
      const fr = $("#freqRead").textContent.match(/~(\d+)\s*Hz/);
      const f = fr? +fr[1] : 432; carrier=String(f); tone(f); toneNow.textContent="Carrier: "+carrier; addXP(10,"Set mic tone");
    });

    function drawAudio(){
      if(!analyser) return;
      const wctx=wave.getContext("2d"), fctx=fft.getContext("2d");
      const wf=new Uint8Array(analyser.fftSize), ff=new Uint8Array(analyser.frequencyBinCount);
      (function loop(){
        if(!analyser) return;
        analyser.getByteTimeDomainData(wf); analyser.getByteFrequencyData(ff);
        // waveform
        const W=wave.width,H=wave.height; wctx.clearRect(0,0,W,H);
        wctx.fillStyle="#0b1016"; wctx.fillRect(0,0,W,H); wctx.beginPath(); wctx.moveTo(0,H/2);
        for(let x=0;x<W;x++){ const i=Math.floor(x/W*wf.length); const v=(wf[i]-128)/128; wctx.lineTo(x,H/2+v*H*0.4); }
        wctx.strokeStyle="#7af3ff"; wctx.lineWidth=2; wctx.stroke();
        // spectrum + â€œnear keyâ€
        const WF=fft.width, HF=fft.height; fctx.clearRect(0,0,WF,HF);
        let maxi=0,maxv=0; for(let i=4;i<ff.length;i++){ if(ff[i]>maxv){ maxv=ff[i]; maxi=i; } }
        const freq = maxi * (AC.sampleRate / analyser.fftSize) ;
        for(let i=0;i<ff.length;i++){ const v=ff[i]/255; const x=i/ff.length*WF; const y=HF*(1-v); fctx.fillStyle=v>.8?"#f3c97a":v>.5?"#a7f6ff":"#6aa0ff33"; fctx.fillRect(x,y,WF/ff.length,HF-y); }
        $("#freqRead").textContent = isFinite(freq) ? `~${Math.round(freq)} Hz (peak)` : "â€”";
        requestAnimationFrame(loop);
      })();
    }

    /* ---------------- PHRASE ---------------- */
    on($("#phraseTune"),"click",()=>{
      const s = ($("#phraseIn").value||"").trim();
      if(!s) return toast("Type a line first");
      const simpler = s
        .replace(/\b(don't|do not|can't|cannot|won't|will not)\b/gi,"")
        .replace(/\b(try|maybe|sort of|kinda|hopefully)\b/gi,"")
        .replace(/\s{2,}/g," ")
        .trim();
      $("#phraseOut").textContent = simpler || s;
      addXP(10,"Phrase tuned");
    });
    on($("#phraseClear"),"click",()=>{$("#phraseIn").value="";$("#phraseOut").textContent="â€”";});

    /* ---------------- BREATH ---------------- */
    const breathArc=$("#breathArc"), breathPhase=$("#breathPhase"), bStart=$("#breathStart"), bStop=$("#breathStop");
    let bTimer=null, bT0=0, bPat=[4,4,4,4], bIdx=0;
    on($("#breathPat"),"change",e=>{ bPat=e.target.value.split("-").map(n=>+n||4);});
    on(bStart,"click",()=>{
      if(bTimer) return;
      bT0=performance.now(); bIdx=0; bStop.disabled=false; bStart.disabled=true;
      const total=bPat.reduce((a,b)=>a+b,0)*1000;
      bTimer=setInterval(()=>{
        const t=(performance.now()-bT0)%total;
        let acc=0, idx=0; for(let i=0;i<4;i++){ acc+=bPat[i]*1000; if(t<acc){ idx=i; break; } }
        const prev=acc-bPat[idx]*1000, p=(t-prev)/(bPat[idx]*1000);
        const dash=283*((prev+t-prev)/total); breathArc.setAttribute("stroke-dasharray",`${dash} ${283-dash}`);
        breathPhase.textContent=["In","Hold","Out","Hold"][idx];
      },1000/30);
    });
    on(bStop,"click",()=>{ clearInterval(bTimer); bTimer=null; bStart.disabled=false; bStop.disabled=true; breathPhase.textContent="Ready"; addXP(15,"Breath cycle"); });

    /* ---------------- COHERENCE ---------------- */
    const xiOut=$("#xiOut"), xiSpark=$("#xiSpark").getContext("2d");
    on($("#xiCalc"),"click",()=>{
      const hi=+$("#hi").value||0, v=+$("#varM").value||0.0001;
      const Xi = Math.max(0, Math.min(1, (hi)/(1+v)));
      xiOut.textContent = "Î = " + Xi.toFixed(2);
      state.xiHistory.unshift({t:Date.now(), x:Xi}); state.xiHistory=state.xiHistory.slice(0,60); save(SKEY,state);
      drawXi(); addXP(10,"Î computed");
    });
    function drawXi(){
      const ctx=xiSpark, W=ctx.canvas.width, H=ctx.canvas.height;
      ctx.clearRect(0,0,W,H); ctx.strokeStyle="rgba(122,243,255,.25)";
      ctx.beginPath(); ctx.moveTo(0,H*0.25); ctx.lineTo(W,H*0.25); ctx.moveTo(0,H*0.5); ctx.lineTo(W,H*0.5); ctx.moveTo(0,H*0.75); ctx.lineTo(W,H*0.75); ctx.stroke();
      if(!state.xiHistory.length) return;
      const n=state.xiHistory.length, xs=W/(n-1);
      ctx.beginPath(); for(let i=0;i<n;i++){ const y=H*(1-(state.xiHistory[i].x*0.9+0.05)); const x=W-i*xs; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
      ctx.strokeStyle="rgba(243,201,122,.9)"; ctx.lineWidth=2; ctx.stroke();
    }
    drawXi();

    /* ---------------- LEDGER ---------------- */
    function readLedger(){ return load(LGKEY,[]); }
    function writeLedger(arr){ save(LGKEY,arr); }
    function renderLedger(){
      const rows=$("#lgRows"), q=($("#lgFilter").value||"").toLowerCase(); const all=readLedger();
      const list = q ? all.filter(x=>JSON.stringify(x).toLowerCase().includes(q)) : all;
      rows.innerHTML = list.map((e,i)=>`<tr>
        <td>${new Date(e.when).toLocaleString()}</td>
        <td>${esc(e.phrase)}</td><td>${esc(e.carrier||"â€”")}</td><td>${esc(e.coherence||"â€”")}</td>
        <td>${esc((e.tags||[]).join(", "))}</td><td>${esc(e.note||"")}</td>
        <td><button class="lab-btn" data-del="${i}">âœ•</button></td>
      </tr>`).join("");
      $$("#lgRows [data-del]").forEach(b=>on(b,"click",()=>{ const all=readLedger(); all.splice(+b.dataset.del,1); writeLedger(all); renderLedger(); }));
      // achievements
      $("#bFirstLedger").classList.toggle("lit", readLedger().length>0);
    }
    function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    on($("#lgAdd"),"click",()=>{
      const phrase=($("#lgLine").value||"").trim(); if(!phrase) return toast("Write an intention line");
      const entry={
        when:new Date().toISOString(),
        carrier:($("#lgCarrier").value||"").trim(),
        phrase,
        coherence:$("#lgQ").value||"",
        tags:($("#lgTags").value||"").split(",").map(s=>s.trim()).filter(Boolean),
        note:($("#lgWit").value||"").trim()
      };
      const all=readLedger(); all.unshift(entry); writeLedger(all); renderLedger(); addXP(25,"Ledger entry");
      $("#lgWit").value=""; $("#lgLine").value=""; // tidy
    });
    on($("#lgExport"),"click",()=>{
      const blob=new Blob([JSON.stringify(readLedger(),null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="scroll-of-fire-ledger.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
    });
    on($("#lgImport"),"click",()=>$("#lgImportFile").click());
    on($("#lgImportFile"),"change",async e=>{
      const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const data=JSON.parse(txt); if(Array.isArray(data)){ writeLedger(data.concat(readLedger())); renderLedger(); toast("Imported"); addXP(5,"Imported ledger"); } }catch(_){ toast("Import failed"); } e.target.value="";
    });
    on($("#lgFilter"),"input",renderLedger);
    renderLedger();

    /* ---------------- KEYBOARD NAV ---------------- */
    on(document,"keydown",(e)=>{
      if(e.target.matches("input,textarea")) return;
      const map={1:"quests",2:"observer",3:"voice",4:"phrase",5:"breath",6:"coherence",7:"ledger"};
      if(map[e.key]){ e.preventDefault(); switchTo(map[e.key]); }
      if(e.key==="S"||e.key==="s"){ if(!obsStart.disabled) obsStart.click(); else if(!obsStop.disabled) obsStop.click(); }
    });

    /* ---------------- YEAR ---------------- */
    $("#yr").textContent = new Date().getFullYear();

  })();
  </script>
</body>
</html>
